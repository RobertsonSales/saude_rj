<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SaÃºde-BR (+) Localizador de Unidades de SaÃºde PÃºblica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* CSS original (mantido integralmente) */
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€ */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€ */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* â”€â”€â”€ FILTER PANEL â”€â”€â”€ */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,168,120,0.1);
    }
    select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6E85' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--radius-sm);
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,168,120,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,168,120,0.4);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover { background: #fff; border-color: var(--teal); color: var(--teal); }
    .btn-navy {
      background: var(--navy);
      color: #fff;
      box-shadow: 0 4px 12px rgba(11,31,58,0.25);
    }
    .btn-navy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(11,31,58,0.35); }
    .btn-amber {
      background: linear-gradient(135deg, var(--amber) 0%, #F7BE50 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(245,166,35,0.35);
    }
    .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(245,166,35,0.45); }
    .btn-geo {
      background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21,101,192,0.3);
    }
    .btn-geo:hover { transform: translateY(-1px); }
    .btn-sm { padding: 7px 14px; font-size: 0.78rem; }
    .btn-icon { width: 34px; height: 34px; padding: 0; justify-content: center; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* â”€â”€â”€ GEO SECTION â”€â”€â”€ */
    .geo-section {
      background: linear-gradient(135deg, var(--blue-pale), #d8e8ff);
      border: 1px solid rgba(21,101,192,0.2);
      border-radius: var(--radius);
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .geo-info { flex: 1; }
    .geo-info h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--blue);
    }
    .geo-info p { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .geo-radius-row { display: flex; align-items: center; gap: 10px; }
    .geo-radius-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .geo-radius-input {
      width: 80px;
      background: #fff;
      border: 1.5px solid rgba(21,101,192,0.3);
      border-radius: 8px;
      padding: 7px 10px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      text-align: center;
    }

    /* â”€â”€â”€ DASHBOARD CARDS â”€â”€â”€ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--teal));
    }
    .stat-card-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    .stat-card-value {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      line-height: 1;
      color: var(--navy);
      transition: all 0.5s;
    }
    .stat-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .stat-card-sublabel { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }

    /* â”€â”€â”€ RESULTS SECTION â”€â”€â”€ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .results-count {
      background: var(--teal-pale);
      color: var(--teal);
      font-size: 0.78rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 8px;
    }
    .export-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* â”€â”€â”€ GROUP SECTIONS â”€â”€â”€ */
    .group-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .group-header {
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .group-header:hover { background: var(--bg); }
    .group-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .group-pill {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.78rem;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .group-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .group-meta { font-size: 0.78rem; color: var(--text-muted); }
    .group-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--navy);
      min-width: 60px;
      text-align: right;
    }
    .group-arrow { color: var(--text-muted); transition: transform 0.3s; }
    .group-arrow.open { transform: rotate(90deg); }

    .group-body {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: none;
    }
    .group-body.open { display: block; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    /* â”€â”€â”€ UNIT CARDS â”€â”€â”€ */
    .unit-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-card-accent {
      position: absolute;
      top: 0; left: 0;
      width: 4px;
      height: 100%;
    }
    .unit-card-inner { padding-left: 8px; }
    .unit-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--navy);
      line-height: 1.3;
    }
    .unit-type-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .unit-info-row svg { flex-shrink: 0; margin-top: 1px; color: var(--text-light); }
    .unit-cnes {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 10px;
      font-family: 'Outfit', sans-serif;
    }
    .unit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }
    .unit-tag {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-tag-urgencia { background: var(--red-pale); color: var(--red); }
    .unit-tag-ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .unit-tag-maternidade { background: var(--purple-pale); color: var(--purple); }
    .unit-tag-especializado { background: var(--amber-pale); color: #C07A00; }
    .unit-tag-federal { background: #E8F0FE; color: var(--blue); }
    .unit-tag-estadual { background: #FFF8EC; color: #9C6E00; }
    .unit-tag-municipal { background: var(--teal-pale); color: #006B4F; }
    .unit-distance { background: var(--blue-pale); color: var(--blue); }
    .unit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 4px;
    }
    .unit-actions .btn-icon {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      transition: all 0.2s;
    }
    .unit-actions .btn-icon:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-pale); }
    .unit-actions .btn-icon.whatsapp:hover { border-color: #25D366; color: #25D366; background: #E8FBF0; }
    .unit-actions .btn-icon.maps:hover { border-color: #EA4335; color: #EA4335; background: #FDECEA; }
    .unit-actions .btn-icon.search:hover { border-color: #4285F4; color: #4285F4; background: #E8F0FE; }
    .unit-actions .btn-icon.phone:hover { border-color: #0B1F3A; color: #0B1F3A; background: #EDF1F7; }

    /* â”€â”€â”€ LOADING / EMPTY / ERROR â”€â”€â”€ */
    .status-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 60px 40px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .status-box .status-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }
    .status-box h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .status-box p { font-size: 0.88rem; color: var(--text-muted); max-width: 400px; margin: 0 auto; }

    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--teal-pale);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-wrap {
      max-width: 360px;
      margin: 16px auto 0;
      background: var(--border);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    /* â”€â”€â”€ SEARCH PROGRESS CARD â”€â”€â”€ */
    .search-progress-card {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
      border-radius: var(--radius);
      padding: 20px 28px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 20px;
      border: 1px solid rgba(0,168,120,0.25);
      box-shadow: var(--shadow-md);
      animation: slideDown 0.3s ease;
    }
    .search-progress-card.visible { display: flex; }
    .search-progress-spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(0,200,150,0.25);
      border-top-color: var(--teal-light);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    .search-progress-info { flex: 1; min-width: 0; }
    .search-progress-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.92rem;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-progress-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      min-height: 16px;
    }
    .search-progress-bar-wrap {
      flex: 1;
      max-width: 260px;
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .search-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .search-progress-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--teal-light);
      min-width: 48px;
      text-align: right;
      flex-shrink: 0;
    }

    /* â”€â”€â”€ PDF PREVIEW MODAL â”€â”€â”€ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(11,31,58,0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.visible { display: flex; }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 1400px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover { background: var(--red-pale); color: var(--red); }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
      background: var(--bg);
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .btn-whatsapp {
      background: linear-gradient(135deg, #25D366, #128C7E);
      color: white;
    }
    .btn-whatsapp:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(37,211,102,0.4);
    }

    /* â”€â”€â”€ NOTIFICATION â”€â”€â”€ */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--navy);
      color: #fff;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 340px;
    }
    .notification.success { background: var(--teal); }
    .notification.error { background: var(--red); }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* â”€â”€â”€ FOOTER â”€â”€â”€ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .footer a { color: var(--teal); text-decoration: none; }

    /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
    @media (max-width: 640px) {
      .main-wrapper { padding: 16px 14px 40px; }
      .header-inner { padding: 14px 16px; }
      .header-titles h1 { font-size: 1.2rem; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: 1fr; }
      .geo-section { flex-direction: column; align-items: stretch; }
      .modal-content { max-height: 95vh; }
    }

    /* â”€â”€â”€ NIVEL COLORS â”€â”€â”€ */
    .nivel-primaria { --nivel-color: #00A878; }
    .nivel-secundaria { --nivel-color: #1565C0; }
    .nivel-terciaria { --nivel-color: #E53935; }
  </style>
</head>
<body>

<!-- â•â•â• HEADER (inalterado) â•â•â• -->
<header>
  <div class="header-inner">
    <div class="logo-mark">
      <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 4v20M4 14h20" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
        <circle cx="14" cy="14" r="12" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
      </svg>
    </div>
    <div class="header-titles">
      <h1>SaÃºde(+)<span>BR</span> &mdash; Seu Localizador de Unidades de SaÃºde</h1>
      <p>Dados em tempo real via OpenStreetMap + Nominatim â€¢ Apenas unidades vinculadas ao SUS</p>
    </div>
    <span class="header-badge">ğŸŸ¢ Online</span>
  </div>
</header>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main-wrapper">

  <!-- â”€â”€â”€ FILTROS (modificado para exibiÃ§Ã£o sequencial) â”€â”€â”€ -->
  <div class="filter-section">
    <div class="filter-header" onclick="toggleFilter()">
      <div class="filter-header-left">
        <div class="filter-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </div>
        <div>
          <div class="filter-title">Filtros de Busca</div>
          <div class="filter-subtitle">Estado, municÃ­pio, perfil de atenÃ§Ã£o e formas de acolhimento</div>
        </div>
      </div>
      <button class="filter-toggle-btn" id="filterToggleBtn">
        <span>Expandir</span>
        <span class="filter-toggle-arrow" id="filterArrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </button>
    </div>

    <div class="filter-body" id="filterBody">
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Estado (UF)</label>
          <select class="form-control" id="selectEstado" onchange="onEstadoChange()">
            <option value="">â€” Selecione â€”</option>
          </select>
        </div>
        <div class="form-group" id="grupoMunicipio" style="display: none;">
          <label class="form-label">MunicÃ­pio</label>
          <select class="form-control" id="selectMunicipio" onchange="onMunicipioChange()" disabled>
            <option value="">â€” Selecione o estado primeiro â€”</option>
          </select>
        </div>
        <div class="form-group" id="grupoBairro" style="display: none;">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" id="inputBairro" placeholder="Ex: Centro, Jardim..." oninput="applyLocalFilters()">
        </div>
        <div class="form-group" id="grupoNivel" style="display: none;">
          <label class="form-label">Perfil / NÃ­vel de AtenÃ§Ã£o</label>
          <select class="form-control" id="selectNivel" onchange="applyLocalFilters()">
            <option value="">Todos os NÃ­veis</option>
            <option value="primaria">AtenÃ§Ã£o PrimÃ¡ria</option>
            <option value="secundaria">AtenÃ§Ã£o SecundÃ¡ria</option>
            <option value="terciaria">AtenÃ§Ã£o TerciÃ¡ria</option>
          </select>
        </div>
        <div class="form-group" id="grupoAcolhimento" style="display: none;">
          <label class="form-label">Forma de Acolhimento</label>
          <select class="form-control" id="selectAcolhimento" onchange="applyLocalFilters()">
            <option value="">Todas as Formas</option>
            <option value="ambulatorial">Atendimento Ambulatorial</option>
            <option value="urgencia">UrgÃªncia / EmergÃªncia</option>
            <option value="maternidade">Maternidade</option>
            <option value="especializado">Atendimento Especializado</option>
            <option value="samu">SAMU</option>
          </select>
        </div>
        <div class="form-group" id="grupoGestao" style="display: none;">
          <label class="form-label">Esfera de GestÃ£o</label>
          <select class="form-control" id="selectGestao" onchange="applyLocalFilters()">
            <option value="">Todas</option>
            <option value="Municipal">Municipal</option>
            <option value="Estadual">Estadual</option>
            <option value="Federal">Federal</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="buscarPorMunicipio()" id="btnBuscarMunicipio">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          Buscar por MunicÃ­pio
        </button>
        <button class="btn btn-secondary" onclick="limparFiltros()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.57"/></svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ GEOLOCALIZAÃ‡ÃƒO â”€â”€â”€ -->
  <div class="geo-section">
    <div style="font-size: 1.8rem;">ğŸ“</div>
    <div class="geo-info">
      <h3>Busca por Proximidade GeogrÃ¡fica</h3>
      <p id="geoStatus">Detecta automaticamente sua localizaÃ§Ã£o via GPS e busca unidades no raio (km) configurado abaixo:</p>
    </div>
    <div class="geo-radius-row">
      <span class="geo-radius-label">Raio (km):</span>
      <input type="number" class="geo-radius-input form-control" id="geoRaio" value="6" min="0.5" max="50" step="0.5">
    </div>
    <button class="btn btn-geo" onclick="usarGeolocalizacao()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>
      Buscar Unidades Perto de Mim
    </button>
  </div>

  <!-- â”€â”€â”€ SEARCH PROGRESS CARD â”€â”€â”€ -->
  <div class="search-progress-card" id="searchProgressCard">
    <div class="search-progress-spinner"></div>
    <div class="search-progress-info">
      <div class="search-progress-title" id="spTitle">Consultando OpenStreetMap...</div>
      <div class="search-progress-hint" id="spHint">Iniciando conexÃ£o...</div>
    </div>
    <div class="search-progress-bar-wrap">
      <div class="search-progress-bar" id="spBar" style="width:5%"></div>
    </div>
    <div class="search-progress-count" id="spCount">0</div>
  </div>

  <!-- â”€â”€â”€ DASHBOARD â”€â”€â”€ -->
  <div class="dashboard" id="dashboard">
    <div class="stat-card" style="--card-accent: var(--teal);">
      <div class="stat-card-icon" style="background: var(--teal-pale); color: var(--teal);">ğŸ¥</div>
      <div class="stat-card-value" id="statTotal">â€”</div>
      <div class="stat-card-label">Total de Unidades</div>
      <div class="stat-card-sublabel">encontradas</div>
    </div>
    <div class="stat-card" style="--card-accent: #00A878;">
      <div class="stat-card-icon" style="background: #E8F8F3; color: #00A878;">ğŸ </div>
      <div class="stat-card-value" id="statPrimaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o PrimÃ¡ria</div>
      <div class="stat-card-sublabel">UBS, Postos, ESF/PSF, CAPS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--blue);">
      <div class="stat-card-icon" style="background: var(--blue-pale); color: var(--blue);">ğŸ”¬</div>
      <div class="stat-card-value" id="statSecundaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o SecundÃ¡ria</div>
      <div class="stat-card-sublabel">UPA, AME, CEO, CER, PoliclÃ­nica</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">ğŸ¨</div>
      <div class="stat-card-value" id="statTerciaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o TerciÃ¡ria</div>
      <div class="stat-card-sublabel">Hospitais de referÃªncia</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">ğŸš¨</div>
      <div class="stat-card-value" id="statUrgencia">â€”</div>
      <div class="stat-card-label">UrgÃªncia/EmergÃªncia</div>
      <div class="stat-card-sublabel">UPAs, PS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--purple);">
      <div class="stat-card-icon" style="background: var(--purple-pale); color: var(--purple);">ğŸ¤±</div>
      <div class="stat-card-value" id="statMaternidade">â€”</div>
      <div class="stat-card-label">Maternidades</div>
      <div class="stat-card-sublabel">Parto e neonatal</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--amber);">
      <div class="stat-card-icon" style="background: var(--amber-pale); color: var(--amber);">ğŸ¦´</div>
      <div class="stat-card-value" id="statEspecializado">â€”</div>
      <div class="stat-card-label">Especializado</div>
      <div class="stat-card-sublabel">Ortopedia, cardiologia</div>
    </div>
    <div class="stat-card" style="--card-accent: #9C27B0;">
      <div class="stat-card-icon" style="background: #F3E5F5; color: #9C27B0;">ğŸ›ï¸</div>
      <div class="stat-card-value" id="statAmbulatorial">â€”</div>
      <div class="stat-card-label">Ambulatorial</div>
      <div class="stat-card-sublabel">Consultas/exames</div>
    </div>
  </div>

  <!-- â”€â”€â”€ RESULTADOS â”€â”€â”€ -->
  <div id="resultsSection">
    <div class="status-box">
      <span class="status-icon">ğŸ”</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione estado e municÃ­pio nos filtros e clique em <strong>Buscar por MunicÃ­pio</strong>, ou use <strong>Buscar Unidades Perto de Mim</strong> para detecÃ§Ã£o automÃ¡tica.</p>
    </div>
  </div>

</div><!-- /main-wrapper -->

<!-- â•â•â• PDF PREVIEW MODAL â•â•â• -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ“„ VisualizaÃ§Ã£o do RelatÃ³rio PDF</h3>
      <button class="modal-close" onclick="closePDFModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="12"/><line x1="6" y1="6" x2="18" y2="12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" id="pdfModalBody">
      <!-- PDF content will be injected here -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePDFModal()">Fechar</button>
      <button class="btn btn-whatsapp" onclick="compartilharPDFWhatsApp()">
        <span>ğŸ“±</span>
        Compartilhar WhatsApp
      </button>
      <button class="btn btn-primary" onclick="downloadPDF()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Baixar PDF
      </button>
    </div>
  </div>
</div>

<footer class="footer">
  Dados obtidos via <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a> e <a href="https://nominatim.org" target="_blank">Nominatim</a> â€” Fonte pÃºblica colaborativa &nbsp;|&nbsp; SaÃºde-BR - Localizador de Unidades SUS )
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURAÃ‡ÃƒO E CONSTANTES (mantido igual)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
    NOMINATIM: {
        ENDPOINT: 'https://nominatim.openstreetmap.org',
        EMAIL: 'contato@saudebr.gov.br'
    },
    IBGE: 'https://servicodados.ibge.gov.br/api/v1/localidades',
    OVERPASS: 'https://overpass-api.de/api/interpreter'
};

// â”€â”€ INCLUIR_TIPOS: valores de amenity= e healthcare= buscados no Overpass â”€â”€â”€
// Restritos a tipos que correspondem a estabelecimentos SUS ou potencialmente
// SUS. Tipos genÃ©ricos como "doctors", "medical", "centre", "health" foram
// removidos pois trazem consultÃ³rios e clÃ­nicas privadas para o pool.
const INCLUIR_TIPOS = [
    // amenity= tipicamente pÃºblicos
    'hospital', 'clinic', 'health_post', 'health_centre',
    'polyclinic', 'birthing_center', 'maternity',
    'urgent_care', 'emergency_ward', 'health_center', 'health_station',
    'primary_healthcare', 'community_health_worker', 'phc',
    // healthcare= (passa pelo filtro EXCLUIR abaixo)
    'hospital', 'clinic', 'dentist',
].filter((v, i, a) => a.indexOf(v) === i).join('|');   // deduplica

// â”€â”€ EXCLUIR_TIPOS: valores de healthcare= explicitamente nÃ£o-SUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// dentist NÃƒO estÃ¡ aqui â€” CEOs (Centros de Especialidades OdontolÃ³gicas) sÃ£o SUS
const EXCLUIR_TIPOS = 'pharmacy|optometrist|laboratory|sample_collection|physiotherapist|psychotherapist|audiologist|alternative|medical_imaging|blood_donation|veterinary|cosmetics|beauty';

let allUnits = [];
let filteredUnits = [];
let currentGeoPosition = null;
let estados = [];
let municipiosPorEstado = {};
let buscaAtiva = false;
let reverseGeocodeCache = new Map();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FUNÃ‡Ã•ES AUXILIARES (mantidas iguais)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function norm(str) {
    if (!str) return '';
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function deduplicar(unidades) {
    // Passo 1: agrupar por cÃ³digo CNES (identificador Ãºnico oficial).
    // Quando a mesma unidade aparece tanto no CNES estÃ¡tico quanto no OSM,
    // mantÃ©m-se o registro com mais dados (coordenadas, telefone, website).
    const porCNES = new Map();
    const semCNES = [];

    unidades.forEach(u => {
        if (u.cnes) {
            if (!porCNES.has(u.cnes)) {
                porCNES.set(u.cnes, { ...u });
            } else {
                const ex = porCNES.get(u.cnes);
                // Enriquecer com dados do OSM: lat/lon, telefone, website, email
                if (!ex.lat && u.lat) {
                    ex.lat = u.lat;
                    ex.lon = u.lon;
                    ex.distancia = u.distancia;
                    ex.mapsLink = u.mapsLink || (u.lat ? `https://www.google.com/maps?q=${u.lat},${u.lon}` : '');
                }
                if (!ex.telefone && u.telefone) ex.telefone = u.telefone;
                if (!ex.website  && u.website)  ex.website  = u.website;
                if (!ex.email    && u.email)    ex.email    = u.email;
            }
        } else {
            semCNES.push(u);
        }
    });

    // Passo 2: unidades sem cÃ³digo CNES, deduplicar por nome normalizado
    const porNome = new Map();
    semCNES.forEach(u => {
        const chave = norm(u.nome);
        if (!porNome.has(chave)) {
            porNome.set(chave, u);
        } else {
            const ex = porNome.get(chave);
            if (!ex.lat && u.lat) { ex.lat = u.lat; ex.lon = u.lon; }
        }
    });

    return [...porCNES.values(), ...porNome.values()];
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// â”€â”€ Cache de resultados Overpass: evita refazer a mesma query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _overpassCache = new Map();

// consultarOverpass: AbortController garante timeout real no fetch;
// em caso de falha tenta espelhos alternativos *em paralelo* no mobile.
const OVERPASS_MIRRORS = [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter',
    'https://maps.mail.ru/osm/tools/overpass/api/interpreter'
];

// Timeout padrÃ£o reduzido: 30 s por tentativa (antes: 90 s).
// No mobile, 90 s sÃ³ serve para fazer o usuÃ¡rio desistir.
async function consultarOverpass(query, timeoutMs = 30000) {
    // Cache: mesma query jÃ¡ resolvida nesta sessÃ£o â†’ resposta instantÃ¢nea
    if (_overpassCache.has(query)) return _overpassCache.get(query);

    let lastErr;
    for (const endpoint of OVERPASS_MIRRORS) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const resp = await fetch(endpoint, {
                method: 'POST',
                body: query,
                signal: controller.signal,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });
            clearTimeout(timer);
            if (resp.ok) {
                const json = await resp.json();
                _overpassCache.set(query, json);   // armazena no cache
                return json;
            }
            const txt = await resp.text().catch(() => resp.status);
            lastErr = new Error(`HTTP ${resp.status}: ${String(txt).slice(0, 120)}`);
        } catch (e) {
            clearTimeout(timer);
            lastErr = e;
            console.warn(`Overpass ${endpoint} falhou:`, e.message || e);
            // Sem pausa entre mirrors: no mobile, cada milissegundo conta
        }
    }
    throw lastErr || new Error('Todos os servidores Overpass falharam');
}

function showSearchProgress(visible) {
    const card = document.getElementById('searchProgressCard');
    if (visible) card.classList.add('visible');
    else card.classList.remove('visible');
}

function updateSearchProgress(percent, title, hint) {
    document.getElementById('spBar').style.width = `${percent}%`;
    document.getElementById('spTitle').textContent = title;
    document.getElementById('spHint').textContent = hint;
    document.getElementById('spCount').textContent = filteredUnits.length;
}

function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
    notif.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VÃNCULO SUS â€” EXIGE PROVA POSITIVA DE PERTENCIMENTO Ã€ REDE PÃšBLICA
//
//  LÃ³gica:  (A) sem prova positiva â†’ rejeita
//           (B) indÃ­cio de serviÃ§o privado â†’ rejeita (prevalece sobre A)
//           (C) prova inequÃ­voca de gestÃ£o pÃºblica â†’ aceita
//           (D) nome tipicamente SUS â†’ aceita
//
//  âš   Tags OSM como healthcare=clinic ou amenity=hospital NÃƒO sÃ£o prova
//     suficiente por si sÃ³s â€” clÃ­nicas e hospitais privados usam as mesmas
//     tags no OpenStreetMap.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isVinculadoSUS(tags, nome) {
    // â”€â”€ A: CNES Ã© registro exclusivo do sistema pÃºblico brasileiro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (tags['ref:CNES'] || tags['ref:cnes']) return true;

    const nomeNorm = norm(nome);
    const op       = norm(tags.operator || '');
    const brand    = norm(tags.brand    || '');
    const funding  = norm(tags.funding  || tags['healthcare:funding'] || '');
    const desc     = norm(tags.description || '');

    // â”€â”€ B: ExclusÃ£o imediata â€” qualquer marcador inequÃ­voco de serviÃ§o privado
    const marcadoresPrivados = [
        // planos e operadoras privadas
        'unimed', 'amil', 'bradesco saude', 'sulamerica saude', 'notredame',
        'hapvida', 'prevent senior', 'clinipam', 'golden cross', 'mediservice',
        'sompo', 'care plus', 'assim saude', 'omint', 'saude caixa', 'cassi',
        'postal saude', 'petrobras saude', 'eletros',
        // designaÃ§Ãµes explÃ­citas de serviÃ§o privado
        'particular', 'privado', 'clinica particular', 'hospital privado',
        'plano de saude', 'convenio', 'empresa privada',
        // redes hospitalares privadas conhecidas
        'rede dor', 'hospital samaritano', 'hospital sirio libanes',
        'hospital albert einstein', 'hospital mater dei', 'hospital lifecenter',
        'hospital nine july', 'hospital nove de julho', 'hospital sao luiz',
        'hospital total cor', 'hospital leforte', 'hospital israelita',
        'hospital alemao oswaldo cruz', 'hospital santa catarina',
        'hospital pro matre', 'hospital sao camilo',
    ];
    for (const p of marcadoresPrivados) {
        if (op.includes(p) || nomeNorm.includes(p) || brand.includes(p) || funding.includes(p)) {
            return false;
        }
    }

    // â”€â”€ C: AceitaÃ§Ã£o imediata â€” prova inequÃ­voca de gestÃ£o pÃºblica â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Tags OSM explÃ­citas de operador pÃºblico
    if (tags['operator:type'] === 'public' || tags['operator:type'] === 'government') return true;
    if (tags.ownership === 'public' || tags.government) return true;
    if (funding === 'public' || funding === 'government' || funding === 'sus') return true;

    // Operador contÃ©m nome de instituiÃ§Ã£o pÃºblica brasileira
    const opPublico = [
        'prefeitura', 'secretaria', 'ministerio', 'governo do estado',
        'governo municipal', 'governo federal', 'municipio de', 'estado de',
        'autarquia', 'fundacao', 'sus', 'datasus', 'ebserh'
    ];
    for (const p of opPublico) {
        if (op.includes(p)) return true;
    }
    // "municipal" e "estadual" e "federal" no operador (mas nÃ£o no nome,
    // pois "Hospital Municipal SÃ£o Lucas" Ã© verificado abaixo)
    if (op.includes('municipal') || op.includes('estadual') || op.includes('federal')) return true;

    // â”€â”€ D: Nome identifica inequivocamente uma unidade SUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //
    // Siglas de 2-4 letras: exigem fronteira de palavra para evitar falsos
    // positivos ("ame" dentro de "amei", "esf" dentro de "esforÃ§o", etc.)
    const siglasRegex = [
        /\bubs\b/, /\bupa\b/, /\bcaps\b/, /\bcms\b/,
        /\besf\b/, /\bpsf\b/, /\bceo\b/, /\bcer\b/,
        /\bame\b/, /\bsamu\b/, /\bcafs\b/,
    ];
    for (const r of siglasRegex) {
        if (r.test(nomeNorm)) return true;
    }

    // ExpressÃµes compostas (sem risco de falso positivo pela extensÃ£o)
    const nomesPublicos = [
        // AtenÃ§Ã£o PrimÃ¡ria
        'unidade basica de saude', 'unidade basica',
        'posto de saude',
        'clinica da familia', 'clinica de familia',
        'centro de saude', 'centro municipal de saude',
        'equipe de saude da familia', 'saude da familia',
        'programa saude da familia',
        'centro de atencao psicossocial',
        'agente comunitario de saude',
        // AtenÃ§Ã£o SecundÃ¡ria
        'unidade de pronto atendimento', 'unidade pronto atendimento',
        'ambulatorio medico de especialidades',
        'centro de especialidades odontologicas',
        'coordenacao regional de emergencia',
        'unidade mista de saude', 'unidade mista',
        'servico de atendimento movel de urgencia',
        'policlinica',
        // AtenÃ§Ã£o TerciÃ¡ria
        'hospital municipal', 'hospital estadual', 'hospital federal',
        'hospital geral', 'hospital universitario', 'hospital de ensino',
        'hospital escola', 'hospital regional', 'hospital de referencia',
        'hospital das clinicas', 'hospital de clinicas',
        'hospital infantil', 'hospital pediatrico',
        'hospital oncologico', 'hospital cardiologico', 'hospital especializado',
        'hospital de urgencia', 'hospital de emergencia',
        'santa casa', 'misericordia',
        'centro de reabilitacao',
        'maternidade municipal', 'maternidade estadual', 'maternidade federal',
        'maternidade escola',
        // Institutos pÃºblicos conhecidos
        'instituto nacional de cancer', 'inca',
        'instituto nacional de traumatologia', 'into',
        'instituto nacional de cardiologia',
        'hospital das forcas armadas',
        'hupe', 'huap', 'husm', 'hucff', 'hucam',    // HUs conhecidos
        'ebserh',
    ];
    for (const p of nomesPublicos) {
        if (nomeNorm.includes(p) || desc.includes(p)) return true;
    }

    // Maternidade sem qualificador: aceita apenas se nÃ£o contiver indicadores
    // de serviÃ§o privado (jÃ¡ verificados acima) e tiver outro indÃ­cio pÃºblico
    if (nomeNorm.startsWith('maternidade') && op && !op.includes('privado')) return true;

    // â”€â”€ Sem prova positiva â†’ rejeita â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETERMINAR ESFERA DE GESTÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function determinarGestao(tags, nome) {
    const op       = norm(tags.operator || '');
    const nomeNorm = norm(nome);

    // Federal
    const isFederal =
        op.includes('federal') || op.includes('ministerio') ||
        op.includes('uniao') || op.includes('governo federal') ||
        op.includes('ebserh') || op.includes('marinha') ||
        op.includes('exercito') || op.includes('aeronautica') ||
        nomeNorm.includes('federal') ||
        nomeNorm.includes('hospital das forcas armadas') ||
        nomeNorm.includes('ebserh') ||
        ['inca', 'into', 'hupe', 'huap', 'husm', 'hucff', 'hucam'].some(s => nomeNorm.includes(s)) ||
        tags['government'] === 'federal';
    if (isFederal) return 'Federal';

    // Estadual
    const isEstadual =
        op.includes('estadual') || op.includes('governo do estado') ||
        op.includes('governo estadual') || op.includes('estado de') ||
        nomeNorm.includes('estadual') ||
        tags['government'] === 'state';
    if (isEstadual) return 'Estadual';

    // Municipal (default para unidades SUS sem qualificador de esfera)
    return 'Municipal';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLASSIFICAÃ‡ÃƒO DE NÃVEL E PERFIL â€” CORRIGIDA CONFORME REQUISITOS SUS
//
//  ORDEM DE PRIORIDADE (regras pelo nome ANTES das tags OSM):
//  1. PrimÃ¡rio â€” UBS, Postos, ClÃ­nicas da FamÃ­lia, ESF/PSF, CAPS/CAPS-AD
//  2. SecundÃ¡rio â€” UPAs 24h (TODAS), AME, CEO, PoliclÃ­nicas, Unidades Mistas, CER
//  3. TerciÃ¡rio â€” Hospitais, Santas Casas, Especializados, ReabilitaÃ§Ã£o
//
//  âš ï¸  As regras pelo nome tÃªm prioridade sobre tags OSM (ex.: uma UPA com
//      tag healthcare=hospital continua sendo SecundÃ¡rio).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function classificarNivel(tags, nome) {
    const n    = norm(nome + ' ' + (tags.description || ''));
    const nomeN = norm(nome);
    const healthcare = (tags.healthcare || tags.amenity || '').toLowerCase();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PASSO 1 â€” Detectores de PRIMÃRIO (nome prevalece sobre tags)
    //  UBS Â· Postos Â· ClÃ­nicas da FamÃ­lia Â· ESF/PSF Â· CAPS/CAPS-AD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ehUBS        = nomeN.startsWith('ubs') ||
                          n.includes('unidade basica de saude') ||
                          n.includes('unidade basica');
    const ehPosto      = n.includes('posto de saude') || n.includes('posto saude');
    const ehClinicaFam = n.includes('clinica da familia') || n.includes('clinica de familia');
    const ehESF        = nomeN.startsWith('esf ') || nomeN === 'esf' ||
                          n.includes(' esf ') || n.includes('saude da familia') ||
                          n.includes('equipe de saude da familia');
    const ehPSF        = nomeN.startsWith('psf ') || nomeN === 'psf' ||
                          n.includes(' psf ') || n.includes('programa saude da familia');
    const ehCAPSAD     = n.includes('caps-ad') || n.includes('caps ad') ||
                          n.includes('centro de atencao psicossocial alcool') ||
                          n.includes('caps ad ii') || n.includes('caps ad iii');
    // CAPS genÃ©rico: apenas se nÃ£o for CAPS-AD e o token 'caps' aparecer isolado
    const ehCAPS       = !ehCAPSAD && (
                            nomeN.startsWith('caps ') || nomeN === 'caps' ||
                            / caps[ /-]/.test(nomeN) ||
                            n.includes('centro de atencao psicossocial')
                          );
    const ehCentroSaude = n.includes('centro de saude') ||
                           n.includes('centro municipal de saude');
    const ehCMS         = nomeN.startsWith('cms ') || nomeN === 'cms' ||
                           / cms[ /]/.test(nomeN);
    const ehCAFS        = n.includes('cafs');

    // Indicador final primÃ¡rio
    const ehPrimaria = ehUBS || ehPosto || ehClinicaFam || ehESF || ehPSF ||
                        ehCAPSAD || ehCAPS || ehCentroSaude || ehCMS || ehCAFS;

    if (ehPrimaria) {
        let perfil = 'Unidade de SaÃºde';
        if      (ehUBS)          perfil = 'UBS';
        else if (ehPosto)        perfil = 'Posto de SaÃºde';
        else if (ehClinicaFam)   perfil = 'ClÃ­nica da FamÃ­lia';
        else if (ehESF || ehPSF) perfil = 'ESF/PSF';
        else if (ehCAPSAD)       perfil = 'CAPS-AD';
        else if (ehCAPS)         perfil = 'CAPS';
        else if (ehCMS || ehCentroSaude) perfil = 'Centro de SaÃºde';
        else if (ehCAFS)         perfil = 'CAFS';
        return { nivel: 'primaria', perfil };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PASSO 2 â€” Detectores de SECUNDÃRIO (nome prevalece sobre tags)
    //  UPAs 24h Â· AME Â· CEO Â· Unidades Mistas Â· PoliclÃ­nicas Â· CER
    //  SAMU Â· Pronto-Atendimento independente
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // UPA â€” Unidade de Pronto Atendimento (TODAS vÃ£o para secundÃ¡rio)
    const ehUPA = nomeN.startsWith('upa ') || nomeN === 'upa' ||
                   nomeN.endsWith(' upa')   || / upa[ /]/.test(nomeN) ||
                   n.includes('unidade de pronto atendimento') ||
                   n.includes('unidade pronto atendimento')    ||
                   healthcare === 'urgent_care';

    // AME â€” AmbulatÃ³rio MÃ©dico de Especialidades
    const ehAME = nomeN.startsWith('ame ') || nomeN === 'ame' ||
                   / ame[ /]/.test(nomeN)   ||
                   n.includes('ambulatorio medico de especialidades');

    // CEO â€” Centro de Especialidades OdontolÃ³gicas
    const ehCEO = nomeN.startsWith('ceo ') || nomeN === 'ceo' ||
                   / ceo[ /]/.test(nomeN)   ||
                   n.includes('centro de especialidades odontologicas');

    // Unidade Mista de SaÃºde
    const ehUnidadeMista = n.includes('unidade mista de saude') || n.includes('unidade mista');

    // PoliclÃ­nica
    const ehPoliclinica = n.includes('policlinica') || healthcare === 'polyclinic';

    // CER â€” CoordenaÃ§Ã£o Regional de EmergÃªncia
    const ehCER = nomeN.startsWith('cer ') || nomeN === 'cer' ||
                   nomeN.endsWith(' cer')   ||
                   n.includes('coordenacao regional de emergencia') ||
                   n.includes('coordenacao de emergencia regional');

    // SAMU â€” ServiÃ§o de Atendimento MÃ³vel de UrgÃªncia
    const ehSAMU = n.includes('samu') ||
                    n.includes('servico de atendimento movel de urgencia');

    // Pronto-Atendimento independente (nÃ£o hospitalar)
    const ehProntoAtendimento = (n.includes('pronto atendimento') ||
                                  n.includes('pronto-atendimento')) &&
                                  !nomeN.startsWith('hospital');

    // ClÃ­nica de Especialidades via OSM
    const ehClinicaEspecialidades = healthcare === 'clinic' &&
                                     (n.includes('especialidades') ||
                                      n.includes('ambulatorio de referencia'));

    const ehSecundaria = ehUPA || ehAME || ehCEO || ehUnidadeMista ||
                          ehPoliclinica || ehCER || ehSAMU ||
                          ehProntoAtendimento || ehClinicaEspecialidades;

    if (ehSecundaria) {
        let perfil = 'Unidade de MÃ©dia Complexidade';
        if      (ehUPA)              perfil = 'UPA 24h';
        else if (ehAME)              perfil = 'AME';
        else if (ehCEO)              perfil = 'CEO';
        else if (ehCER)              perfil = 'CER';
        else if (ehSAMU)             perfil = 'SAMU';
        else if (ehPoliclinica)      perfil = 'PoliclÃ­nica';
        else if (ehUnidadeMista)     perfil = 'Unidade Mista';
        else if (ehProntoAtendimento) perfil = 'Pronto Atendimento';
        return { nivel: 'secundaria', perfil };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PASSO 3 â€” Detectores de TERCIÃRIO (Alta Complexidade)
    //  Hospitais Gerais/UniversitÃ¡rios Â· Santas Casas Â·
    //  Hospitais Especializados Â· Centros de ReabilitaÃ§Ã£o
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Tag OSM definitiva de hospital
    const ehHospitalOSM    = healthcare === 'hospital';
    // Nome comeÃ§a com "hospital"
    const nomeComeÃ§aHospital = nomeN.startsWith('hospital');
    // Santa Casa / MisericÃ³rdia
    const ehSantaCasa      = n.includes('santa casa') || n.includes('misericordia');
    // Tipos de hospitais especializados (combinaÃ§Ãµes precisas)
    const ehHospEspecializado =
        n.includes('hospital geral')           || n.includes('hospital universitario')  ||
        n.includes('hospital de ensino')        || n.includes('hospital escola')          ||
        n.includes('hospital federal')          || n.includes('hospital estadual')        ||
        n.includes('hospital regional')         || n.includes('hospital de referencia')   ||
        n.includes('hospital de base')          || n.includes('hospital das clinicas')    ||
        n.includes('hospital de clinicas')      || n.includes('hospital municipal')       ||
        n.includes('hospital infantil')         || n.includes('hospital pediatrico')      ||
        n.includes('hospital de urgencia')      || n.includes('hospital de emergencia')   ||
        n.includes('hospital beneficencia')     || n.includes('hospital oncologico')      ||
        n.includes('hospital cardiologico')     || n.includes('hospital especializado');
    // Institutos especializados de saÃºde (contexto mÃ©dico claro)
    const ehInstituto = n.includes('instituto') && (
        n.includes('oncologia') || n.includes('cancer')         ||
        n.includes('cardiologia')|| n.includes('cardiovascular') ||
        n.includes('neurologia') || n.includes('ortopedia')     ||
        n.includes('reabilitacao')|| n.includes('psiquiatria')  ||
        n.includes('medicina')   || n.includes('pediatria')     ||
        n.includes('materno')    || n.includes('saude publica')
    );
    // Especialidades hospitalares diretas
    const ehOncologico    = n.includes('oncologico') || n.includes('hospital do cancer') ||
                             n.includes('inca')        || n.includes('into');
    const ehCardiologico  = n.includes('cardiologico') || n.includes('cardiovascular');
    const ehMaternidade   = nomeN.startsWith('maternidade') ||
                             (n.includes('maternidade') &&
                              !n.includes('posto') && !n.includes('ubs'));
    const ehReabilitacao  = n.includes('centro de reabilitacao') ||
                             (n.includes('reabilitacao') && nomeComeÃ§aHospital);

    const ehTerciaria = ehHospitalOSM     || nomeComeÃ§aHospital || ehSantaCasa     ||
                         ehHospEspecializado || ehInstituto        || ehOncologico    ||
                         ehCardiologico      || ehMaternidade       || ehReabilitacao;

    if (ehTerciaria) {
        let perfil = 'Hospital Geral';
        if      (ehOncologico)                                        perfil = 'Hospital OncolÃ³gico';
        else if (ehCardiologico)                                       perfil = 'Hospital CardiolÃ³gico';
        else if (ehReabilitacao || n.includes('centro de reabilitacao')) perfil = 'Centro de ReabilitaÃ§Ã£o';
        else if (n.includes('universitario') || n.includes('ensino') ||
                 n.includes('escola'))                                 perfil = 'Hospital UniversitÃ¡rio';
        else if (ehSantaCasa)                                          perfil = 'Santa Casa';
        else if (ehMaternidade)                                        perfil = 'Maternidade';
        else if (n.includes('infantil') || n.includes('pediatrico'))   perfil = 'Hospital Infantil/PediÃ¡trico';
        else if (ehInstituto)                                          perfil = 'Instituto Especializado';
        return { nivel: 'terciaria', perfil };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PASSO 4 â€” FALLBACK: PrimÃ¡rio genÃ©rico via tags OSM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let perfil = 'Unidade de SaÃºde';
    if      (healthcare === 'health_post')    perfil = 'Posto de SaÃºde';
    else if (healthcare === 'health_centre')  perfil = 'Centro de SaÃºde';
    else if (healthcare === 'doctors')        perfil = 'ConsultÃ³rio/ClÃ­nica';

    return { nivel: 'primaria', perfil };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETERMINAR ACOLHIMENTO (AJUSTADO) â€” mantido igual
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function determinarAcolhimento(unit) {
    const n = norm(unit.nome + ' ' + unit.perfil);

    // SAMU â€” serviÃ§o mÃ³vel de urgÃªncia
    if (n.includes('samu') || n.includes('servico de atendimento movel')) {
        return 'samu';
    }
    // UrgÃªncia / EmergÃªncia
    if (n.includes('upa')    || n.includes('urgencia')   || n.includes('emergencia') ||
        n.includes('pronto socorro')  || n.includes('pronto atendimento') ||
        n.includes('cer ')  || unit.perfil === 'CER'     || unit.perfil === 'UPA 24h') {
        return 'urgencia';
    }
    // Maternidade / ObstetrÃ­cia
    if (n.includes('maternidade') || n.includes('obstetricia') || n.includes('parto')) {
        return 'maternidade';
    }
    // Especializado
    if (n.includes('ortopedia')   || n.includes('cardiologia') || n.includes('oncologia') ||
        n.includes('especializado')|| n.includes('instituto')  ||
        unit.perfil === 'AME'      || unit.perfil === 'CEO'     ||
        unit.perfil === 'Hospital OncolÃ³gico' || unit.perfil === 'Hospital CardiolÃ³gico' ||
        unit.perfil === 'Instituto Especializado') {
        return 'especializado';
    }
    // Hospitais gerais e santas casas â†’ urgÃªncia/emergÃªncia por padrÃ£o
    if (unit.nivel === 'terciaria') {
        return 'urgencia';
    }
    return 'ambulatorial';
}

function getTextoAcolhimento(acolhimento) {
    const textos = {
        'ambulatorial': 'Atendimento Ambulatorial',
        'urgencia': 'UrgÃªncia/EmergÃªncia',
        'maternidade': 'Maternidade',
        'especializado': 'Atendimento Especializado',
        'samu': 'SAMU'
    };
    return textos[acolhimento] || 'Atendimento Geral';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORMATAR TELEFONE (mantido igual)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatarTelefoneBR(telefone) {
    if (!telefone) return '';
    let numeros = telefone.replace(/\D/g, '');
    if (numeros.startsWith('55')) {
        if (numeros.length === 12 || numeros.length === 13) {
            numeros = numeros.substring(2);
        }
    }
    if (numeros.length === 10) {
        return `(${numeros.substring(0,2)}) ${numeros.substring(2,6)}-${numeros.substring(6)}`;
    } else if (numeros.length === 11) {
        return `(${numeros.substring(0,2)}) ${numeros.substring(2,7)}-${numeros.substring(7)}`;
    } else {
        return telefone;
    }
}

function limparNumeroParaLigacao(telefone) {
    if (!telefone) return '';
    let numeros = telefone.replace(/\D/g, '');
    if (numeros.startsWith('55') && (numeros.length === 12 || numeros.length === 13)) {
        numeros = numeros.substring(2);
    }
    return numeros;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LINK WHATSAPP (mantido igual)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gerarLinkCompartilhamentoWhatsApp(unit) {
    const mapsLink = unit.mapsLink || `https://www.google.com/maps?q=${unit.lat},${unit.lon}`;
    const searchQuery = encodeURIComponent(`${unit.nome} ${unit.cidade || ''} ${unit.uf || ''} saÃºde`);
    const searchLink = `https://www.google.com/search?q=${searchQuery}`;
    const texto = 
        `*${unit.nome}*\n` +
        `ğŸ“ ${unit.enderecoCompleto || unit.endereco || ''} ${unit.bairro ? ' - ' + unit.bairro : ''}\n` +
        `ğŸ™ï¸ ${unit.cidade || ''} - ${unit.uf || ''}\n` +
        `ğŸ“ ${unit.telefoneFormatado || unit.telefone || 'NÃ£o informado'}\n` +
        `ğŸ¥ ${unit.perfil}\n` +
        `ğŸ—ºï¸ Ver no mapa: ${mapsLink}\n` +
        `ğŸ”— Mais informaÃ§Ãµes: ${searchLink}`;
    return `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CNES ESTÃTICO â€” carrega arquivos gerados pelo script Python em data/cnes/
//  Cada arquivo UF.json contÃ©m todas as unidades SUS daquele estado.
//  O Vercel os serve como assets estÃ¡ticos â€” sem API, sem CORS, 100% confiÃ¡vel.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** Converte um registro do JSON estÃ¡tico CNES para o formato interno do app. */
function montarUnidadeCNESEstatico(u, cidade, uf) {
    const tel = u.tel || '';
    const unit = {
        nome:              u.nome,
        cidade:            cidade || '',
        uf:                uf || '',
        bairro:            u.bairro || '',
        perfil:            u.perfil || 'Unidade de SaÃºde',
        nivel:             u.nivel  || 'primaria',
        lat:               null,
        lon:               null,
        telefone:          tel,
        email:             '',
        endereco:          u.logradouro || '',
        osmId:             '',
        osmType:           '',
        website:           '',
        distancia:         null,
        gestao:            u.gestao || 'Municipal',
        cnes:              u.cnes   || '',
        enderecoCompleto:  [u.logradouro, u.bairro, u.cep ? `CEP ${u.cep}` : ''].filter(Boolean).join(' â€” '),
        telefoneFormatado: formatarTelefoneBR(tel),
        mapsLink:          '',
        fonte:             'CNES',
    };
    unit.acolhimento = determinarAcolhimento(unit);
    return unit;
}

/**
 * Carrega e filtra o arquivo JSON estÃ¡tico do estado correspondente.
 * @param {string} uf        - Sigla do estado (ex: 'RJ')
 * @param {string} ibge7     - CÃ³digo IBGE de 7 dÃ­gitos do municÃ­pio
 * @param {string} cidade    - Nome do municÃ­pio (para preencher o campo cidade)
 * @returns {Promise<Array>} - Array de unidades no formato interno do app
 */
async function buscarCNESEstatico(uf, ibge7, cidade) {
    try {
        // O CNES usa cÃ³digos IBGE de 6 dÃ­gitos (sem dÃ­gito verificador).
        // O IBGE API retorna 7 dÃ­gitos. Truncamos para compatibilidade.
        const ibge6 = String(ibge7).substring(0, 6);
        const url   = `/data/cnes/${uf}.json`;

        const resp = await fetch(url, { cache: 'default' });
        if (!resp.ok) {
            console.warn(`CNES estÃ¡tico: arquivo ${url} nÃ£o encontrado (HTTP ${resp.status})`);
            return [];
        }

        const todos = await resp.json();
        const filtrados = todos.filter(u => u.ibge6 === ibge6);

        console.info(`CNES estÃ¡tico [${uf}]: ${filtrados.length} unidades em ibge6=${ibge6}`);
        return filtrados.map(u => montarUnidadeCNESEstatico(u, cidade, uf));

    } catch (e) {
        console.warn('CNES estÃ¡tico indisponÃ­vel:', e.message);
        return [];
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONTAR UNIDADE (mantido igual)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// montarUnidade Ã© sÃ­ncrona: nÃ£o hÃ¡ nenhum await interno.
// Declarar como async criava uma microtask desnecessÃ¡ria por elemento chamado,
// o que em lotes de 300+ resultados acumula overhead real em CPUs de celular.
function montarUnidade(tags, lat, lon, osmId, osmType, uf = null, cidade = null, distancia = null) {
    const nome = (tags.name || tags['name:pt'] || '').trim();
    if (!nome) return null;
    
    if (!isVinculadoSUS(tags, nome)) return null;
    
    const classif = classificarNivel(tags, nome);
    const gestao = determinarGestao(tags, nome);

    const enderecoCompleto = [tags['addr:street'], tags['addr:housenumber'], tags['addr:neighbourhood']].filter(Boolean).join(', ');
    const telefone = tags.phone || tags['contact:phone'] || '';
    const email = tags.email || tags['contact:email'] || '';
    const website = tags.website || tags['contact:website'] || '';

    const unit = {
        nome,
        cidade: cidade || tags['addr:city'] || '',
        uf: uf || '',
        bairro: tags['addr:neighbourhood'] || tags['addr:suburb'] || '',
        perfil: classif.perfil,
        nivel: classif.nivel,
        lat,
        lon,
        telefone,
        email,
        endereco: enderecoCompleto,
        osmId,
        osmType,
        website,
        distancia,
        gestao,
        cnes: tags['ref:CNES'] || tags['ref:cnes'] || '',
        enderecoCompleto,
        telefoneFormatado: formatarTelefoneBR(telefone),
        mapsLink: lat && lon ? `https://www.google.com/maps?q=${lat},${lon}` : ''
    };
    unit.acolhimento = determinarAcolhimento(unit);
    return unit;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOLOCALIZAÃ‡ÃƒO (CORRIGIDA) â€” mantido igual
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function usarGeolocalizacao() {
    if (!navigator.geolocation) {
        showNotification('GeolocalizaÃ§Ã£o nÃ£o suportada pelo navegador', 'error');
        return;
    }

    showSearchProgress(true);
    updateSearchProgress(10, 'Obtendo sua localizaÃ§Ã£o...', 'Aguarde autorizaÃ§Ã£o GPS');
    buscaAtiva = true;

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            try {
                if (!buscaAtiva) return;

                currentGeoPosition = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };

                updateSearchProgress(20, 'LocalizaÃ§Ã£o obtida!', `Lat: ${currentGeoPosition.lat.toFixed(4)}, Lon: ${currentGeoPosition.lon.toFixed(4)}`);

                const raio = parseFloat(document.getElementById('geoRaio').value) || 6;

                // reverseGeocode e busca Overpass correm em PARALELO.
                // No fluxo anterior, reverseGeocode bloqueava o inÃ­cio da busca.
                updateSearchProgress(30, 'Buscando unidades e municÃ­pio...', 'Consultas em paralelo');
                const [units, location] = await Promise.all([
                    buscarUnidadesProximas(
                        currentGeoPosition.lat, currentGeoPosition.lon, raio, '', ''
                    ),
                    reverseGeocode(currentGeoPosition.lat, currentGeoPosition.lon)
                        .catch(() => null)   // nÃ£o-crÃ­tico: busca continua mesmo sem cidade
                ]);

                if (!buscaAtiva) return;

                const cidade = location?.cidade || 'sua localizaÃ§Ã£o';
                const uf     = location?.uf     || '';

                // Preenche cidade/uf nos resultados se reverseGeocode retornou
                if (cidade && cidade !== 'sua localizaÃ§Ã£o') {
                    units.forEach(u => {
                        if (!u.cidade) u.cidade = cidade;
                        if (!u.uf)     u.uf     = uf;
                    });
                }

                units.forEach(u => {
                    if (u.lat && u.lon) {
                        u.distancia = calcularDistancia(
                            currentGeoPosition.lat,
                            currentGeoPosition.lon,
                            u.lat,
                            u.lon
                        );
                    }
                });
                units.sort((a, b) => (a.distancia || 999) - (b.distancia || 999));

                allUnits = units;
                if (!buscaAtiva) return;
                applyLocalFilters();

                updateSearchProgress(100, 'ConcluÃ­do!', `${allUnits.length} unidades no raio de ${raio}km`);
                setTimeout(() => {
                    showSearchProgress(false);
                    showNotification(`${allUnits.length} unidades encontradas prÃ³ximas a vocÃª`, 'success');
                    document.getElementById('geoStatus').textContent =
                        `ğŸ“ Sua localizaÃ§Ã£o: ${cidade} â€¢ ${allUnits.length} unidades no raio de ${raio}km`;
                }, 800);

            } catch (err) {
                console.error('Erro na busca por proximidade:', err);
                buscaAtiva = false;
                showSearchProgress(false);
                showNotification('Erro ao buscar unidades prÃ³ximas: ' + (err.message || 'falha na conexÃ£o'), 'error');
            }
        },
        (error) => {
            showSearchProgress(false);
            let msg = 'Erro ao obter localizaÃ§Ã£o';
            if (error.code === error.PERMISSION_DENIED) msg = 'PermissÃ£o de localizaÃ§Ã£o negada';
            else if (error.code === error.POSITION_UNAVAILABLE) msg = 'LocalizaÃ§Ã£o indisponÃ­vel';
            else if (error.code === error.TIMEOUT) msg = 'Tempo esgotado ao obter localizaÃ§Ã£o';
            showNotification(msg, 'error');
        },
        {
            // enableHighAccuracy: false â†’ usa WiFi/antenas celulares em vez do chip GPS.
            // No Brasil urbano Ã© igualmente preciso e 4-5Ã— mais rÃ¡pido (1-3 s vs 10-30 s).
            enableHighAccuracy: false,
            timeout: 8000,
            maximumAge: 120000   // aceita posiÃ§Ã£o com atÃ© 2 min de idade â€” evita novo fix desnecessÃ¡rio
        }
    );
}

async function buscarUnidadesProximas(lat, lon, raioKm, uf, cidade) {
    const R = raioKm * 1000;
    const around = `around:${R},${lat},${lon}`;
    // Sem relation[...]: relations sÃ£o raras no OSM brasileiro e muito custosas
    // no servidor Overpass. "qt" ordena por quadtile (mais rÃ¡pido server-side).
    const query = `
[out:json][timeout:45];
(
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${around});
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${around});
  node["amenity"~"^(${INCLUIR_TIPOS})$"](${around});
  way["amenity"~"^(${INCLUIR_TIPOS})$"](${around});
);
out center tags qt;
    `.trim();

    updateSearchProgress(40, 'Consultando OpenStreetMap...', 'Buscando unidades de saÃºde');

    try {
        const dados = await consultarOverpass(query);
        const elementos = dados.elements || [];
        if (!buscaAtiva) return [];
        
        updateSearchProgress(60, 'Processando resultados...', `${elementos.length} candidatos encontrados`);

        const unidades = [];
        for (let i = 0; i < elementos.length; i++) {
            if (!buscaAtiva) return unidades;
            const el = elementos[i];
            const tags = el.tags || {};
            const elLat = el.lat ?? el.center?.lat;
            const elLon = el.lon ?? el.center?.lon;
            if (!elLat || !elLon) continue;
            const distancia = calcularDistancia(lat, lon, elLat, elLon);
            if (distancia > raioKm) continue;
            const u = montarUnidade(tags, elLat, elLon, el.id, el.type === 'node' ? 'node' : 'way', uf, cidade, distancia);
            if (u) unidades.push(u);
            if (i % 10 === 0) {
                const pct = 60 + Math.round((i + 1) / elementos.length * 25);
                updateSearchProgress(pct, 'Processando...', `${unidades.length} unidades vÃ¡lidas encontradas`);
            }
        }
        return deduplicar(unidades);
    } catch (error) {
        console.error('Erro no Overpass:', error);
        throw error;
    }
}

async function reverseGeocode(lat, lon) {
    const cacheKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
    if (reverseGeocodeCache.has(cacheKey)) return reverseGeocodeCache.get(cacheKey);
    try {
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=pt-BR`;
        const response = await fetch(url, {
            headers: { 'User-Agent': `SaudeBR-Localizador/4.5 (${CONFIG.NOMINATIM.EMAIL})` }
        });
        if (!response.ok) return null;
        const data = await response.json();
        if (data && data.address) {
            const cidade = data.address.city || data.address.town || data.address.municipality || data.address.county;
            const uf = data.address.state;
            const estadoSigla = data.address['ISO3166-2-lvl4']?.split('-')[1] || uf;
            const result = { cidade, uf: estadoSigla, estado: uf };
            reverseGeocodeCache.set(cacheKey, result);
            return result;
        }
    } catch (error) {
        console.error('Erro no reverse geocoding:', error);
    }
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUSCA POR MUNICÃPIO (REFATORADA COM FILTRO POR CIDADE CONDICIONAL) â€” mantido igual
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buscarPorMunicipio() {
    const uf = document.getElementById('selectEstado').value;
    const codigoIBGE = document.getElementById('selectMunicipio').value;
    if (!uf || !codigoIBGE) {
        showNotification('Selecione estado e municÃ­pio', 'error');
        return;
    }

    const selectMunicipio = document.getElementById('selectMunicipio');
    const nomeMunicipio = selectMunicipio.options[selectMunicipio.selectedIndex]?.text || 'municÃ­pio selecionado';

    showSearchProgress(true);
    updateSearchProgress(5, 'Iniciando busca dupla...', `CNES oficial + OpenStreetMap para ${nomeMunicipio}`);
    buscaAtiva = true;

    try {
        // â”€â”€ 1. CNES estÃ¡tico (rÃ¡pido â€” arquivo local no Vercel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        updateSearchProgress(10, 'Carregando registro CNES oficial...', `data/cnes/${uf}.json`);
        const [unitsCNES, municipio] = await Promise.all([
            buscarCNESEstatico(uf, codigoIBGE, nomeMunicipio),
            getMunicipioData(uf, codigoIBGE, nomeMunicipio),
        ]);
        if (!buscaAtiva) return;

        // Mostra resultado do CNES imediatamente enquanto OSM processa
        if (unitsCNES.length > 0) {
            allUnits = unitsCNES;
            applyLocalFilters();
            updateSearchProgress(40, `CNES: ${unitsCNES.length} unidades carregadas`,
                'Enriquecendo com coordenadas via OpenStreetMap...');
        } else {
            updateSearchProgress(40, 'Dados CNES indisponÃ­veis (arquivo nÃ£o gerado ainda)',
                'Usando apenas OpenStreetMap...');
        }

        // â”€â”€ 2. OpenStreetMap (enriquece com GPS, telefone, website) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let unitsOSM = [];
        if (municipio && municipio.latitude && municipio.longitude) {
            updateSearchProgress(50, 'Consultando OpenStreetMap...', `${municipio.nome} â€” coordenadas GPS`);
            try {
                unitsOSM = await buscarUnidadesNoMunicipio(municipio, uf);
            } catch (e) {
                console.warn('OSM falhou, usando apenas CNES:', e.message);
                showNotification('OpenStreetMap indisponÃ­vel. Resultados apenas do CNES oficial.', 'info');
            }
        }
        if (!buscaAtiva) return;

        // â”€â”€ 3. Mescla e deduplica â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CNES primeiro (dados oficiais) + OSM depois (enriquecimento)
        // deduplicar() usa o cÃ³digo CNES como chave primÃ¡ria e
        // transfere lat/lon/telefone/website do OSM para o registro CNES.
        const todasUnidades = [...unitsCNES, ...unitsOSM];
        if (todasUnidades.length === 0) {
            updateSearchProgress(100, 'Nenhuma unidade SUS encontrada',
                'Execute o script gerar_dados_cnes.py para gerar os arquivos estÃ¡ticos');
            setTimeout(() => showSearchProgress(false), 3000);
            showNotification(
                'Nenhuma unidade SUS encontrada. Os arquivos CNES estÃ¡ticos podem nÃ£o ter sido gerados ainda. '
                + 'Veja as instruÃ§Ãµes no README.', 'error');
            return;
        }

        allUnits = deduplicar(todasUnidades);
        if (!buscaAtiva) return;
        applyLocalFilters();

        const nCNES = allUnits.filter(u => u.fonte === 'CNES').length;
        const nOSM  = allUnits.filter(u => u.fonte !== 'CNES').length;
        const comGPS = allUnits.filter(u => u.lat).length;
        updateSearchProgress(100, 'Busca concluÃ­da!',
            `${allUnits.length} unidades (CNES: ${nCNES}, OSM: ${nOSM}) â€¢ ${comGPS} com GPS`);
        setTimeout(() => {
            showSearchProgress(false);
            showNotification(
                `${allUnits.length} unidades SUS em ${municipio?.nome || nomeMunicipio}`, 'success');
        }, 800);

    } catch (error) {
        console.error('Erro na busca por municÃ­pio:', error);
        buscaAtiva = false;
        showSearchProgress(false);
        showNotification('Erro ao buscar unidades: ' + (error.message || 'falha na conexÃ£o'), 'error');
    }
}

async function getMunicipioData(uf, codigoIBGE, nomeMunicipio) {
    if (municipiosPorEstado[uf]) {
        const mun = municipiosPorEstado[uf].find(m => m.id === codigoIBGE);
        if (mun && mun.latitude && mun.longitude) return mun;
    }

    try {
        const nomeBusca = encodeURIComponent(`${nomeMunicipio}, ${uf}, Brasil`);
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/search?q=${nomeBusca}&format=json&limit=1&countrycodes=br&polygon_geojson=0&addressdetails=1`;
        const response = await fetch(url, {
            headers: { 'User-Agent': `SaudeBR-Localizador/4.5 (${CONFIG.NOMINATIM.EMAIL})` }
        });
        if (!response.ok) return null;
        const data = await response.json();
        if (data.length > 0) {
            // Extrair bounding box [minlat, maxlat, minlon, maxlon] â†’ [sul, norte, oeste, leste]
            let bbox = null;
            if (data[0].boundingbox && data[0].boundingbox.length === 4) {
                const bb = data[0].boundingbox.map(parseFloat);
                bbox = [bb[0], bb[1], bb[2], bb[3]];
            }
            const mun = {
                id: codigoIBGE,
                nome: nomeMunicipio,
                latitude: parseFloat(data[0].lat),
                longitude: parseFloat(data[0].lon),
                osmId: data[0].osm_id,
                osmType: data[0].osm_type,
                geojson: data[0].geojson,
                bbox
            };
            if (!municipiosPorEstado[uf]) municipiosPorEstado[uf] = [];
            const index = municipiosPorEstado[uf].findIndex(m => m.id === codigoIBGE);
            if (index >= 0) municipiosPorEstado[uf][index] = mun;
            else municipiosPorEstado[uf].push(mun);
            return mun;
        }
    } catch (error) {
        console.warn('Erro ao buscar coordenadas do municÃ­pio:', error);
    }
    return null;
}

// FunÃ§Ã£o auxiliar: constrÃ³i a query Overpass para um escopo.
// escopo pode ser:
//   â€¢ "area(NNNN)->.a;"   â†’ busca dentro de relaÃ§Ã£o administrativa
//   â€¢ ""                  â†’ __AREA__ serÃ¡ substituÃ­do pelo bbox "sul,oeste,norte,leste"
function buildHealthQuery(escopo, areaVar) {
    // Sem relation[...]: quase nÃ£o existe no OSM brasileiro e Ã© muito custoso.
    // timeout reduzido para 45 s; "qt" = quadtile sort (mais rÃ¡pido server-side).
    return `
[out:json][timeout:45];
${escopo}
(
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${areaVar});
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${areaVar});
  node["amenity"~"^(${INCLUIR_TIPOS})$"](${areaVar});
  way["amenity"~"^(${INCLUIR_TIPOS})$"](${areaVar});
);
out center tags qt;
    `.trim();
}

async function buscarUnidadesNoMunicipio(municipio, uf) {
    let elementos = [];
    let usandoArea = false;

    // â”€â”€â”€ PASSO 1: relaÃ§Ã£o administrativa OSM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // A relaÃ§Ã£o administrativa Ã© a forma mais precisa: busca apenas dentro do
    // polÃ­gono real do municÃ­pio, sem ruÃ­do de cidades vizinhas.
    if (municipio.osmId && municipio.osmType === 'relation') {
        const osmIdNum = parseInt(municipio.osmId, 10);
        const areaId   = 3600000000 + osmIdNum;          // padrÃ£o Overpass para relations
        updateSearchProgress(30, 'Consultando Ã¡rea municipal...', `RelaÃ§Ã£o OSM #${osmIdNum}`);
        const queryArea = buildHealthQuery(`area(${areaId})->.a;`, 'area.a');
        try {
            const dados = await consultarOverpass(queryArea);
            elementos    = dados.elements || [];
            usandoArea   = elementos.length > 0;
            if (usandoArea) updateSearchProgress(50, 'Ãrea municipal OK', `${elementos.length} candidatos`);
        } catch (e) {
            console.warn('Falha na relaÃ§Ã£o administrativa:', e.message || e);
        }
    }

    // â”€â”€â”€ PASSO 2: fallback por bounding box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Usado quando: municÃ­pio sem relaÃ§Ã£o OSM, ou relaÃ§Ã£o nÃ£o produziu resultados.
    // O bbox do Nominatim Ã© preciso; se nÃ£o disponÃ­vel, calcula raio de 25 km.
    if (elementos.length === 0) {
        updateSearchProgress(35, 'Usando bounding box...', 'Calculando Ã¡rea do municÃ­pio');
        const lat = municipio.latitude;
        const lon = municipio.longitude;
        let sul, norte, oeste, leste;
        if (municipio.bbox && municipio.bbox.length === 4) {
            [sul, norte, oeste, leste] = municipio.bbox;
        } else {
            const raio = 25;
            const dLat = raio / 111;
            const dLon = raio / (111 * Math.cos(lat * Math.PI / 180));
            sul   = (lat - dLat).toFixed(6);
            norte = (lat + dLat).toFixed(6);
            oeste = (lon - dLon).toFixed(6);
            leste = (lon + dLon).toFixed(6);
        }
        const bboxStr  = `${sul},${oeste},${norte},${leste}`;
        const queryBbox = buildHealthQuery('', bboxStr);
        try {
            const dados = await consultarOverpass(queryBbox);
            elementos    = dados.elements || [];
            if (elementos.length > 0) updateSearchProgress(50, 'Candidatos encontrados (bbox)', `${elementos.length} itens`);
        } catch (e) {
            console.warn('Overpass bbox falhou:', e.message || e);
        }
    }

    if (elementos.length === 0) return [];

    updateSearchProgress(55, 'Filtrando e classificando...', `${elementos.length} candidatos`);

    // â”€â”€â”€ PASSO 3: processar em paralelo SEM reverseGeocode individual â”€â”€â”€â”€â”€â”€â”€
    // Quando usandoArea = true  â†’ aceita todos (o Overpass jÃ¡ limitou ao municÃ­pio).
    // Quando usandoArea = false â†’ aceita unidades cujo addr:city bate com o nome
    //                             OU (sem addr:city) estejam dentro de 30km do centro,
    //                             evitando centenas de chamadas Nominatim por elemento.
    const raioAceitacaoKm = 30;
    const BATCH = 50;
    const unidades = [];

    for (let i = 0; i < elementos.length; i += BATCH) {
        if (!buscaAtiva) return [];
        const batch = elementos.slice(i, i + BATCH);

        const promises = batch.map(async (el) => {
            const tags = el.tags || {};
            const elLat = el.lat ?? el.center?.lat;
            const elLon = el.lon ?? el.center?.lon;
            if (!elLat || !elLon) return null;

            if (!usandoArea) {
                // Filtro espacial leve: descarta unidades fora do raio de aceitaÃ§Ã£o
                const dist = calcularDistancia(municipio.latitude, municipio.longitude, elLat, elLon);
                if (dist > raioAceitacaoKm) return null;

                // Verifica cidade somente se addr:city estiver disponÃ­vel na tag
                // (evita flood de requisiÃ§Ãµes Nominatim)
                const addrCity = norm(tags['addr:city'] || '');
                if (addrCity && addrCity !== norm(municipio.nome)) return null;
            }

            return montarUnidade(tags, elLat, elLon, el.id,
                el.type === 'node' ? 'node' : (el.type === 'relation' ? 'relation' : 'way'),
                uf, municipio.nome);
        });

        const results = await Promise.all(promises);
        for (const u of results) { if (u) unidades.push(u); }

        const pct = 55 + Math.round(((i + BATCH) / elementos.length) * 40);
        updateSearchProgress(Math.min(pct, 95), 'Processando...', `${unidades.length} unidades SUS vÃ¡lidas`);
    }

    return deduplicar(unidades);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTERFACE - FILTROS SEQUENCIAIS (mantido igual)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilter() {
    const body = document.getElementById('filterBody');
    const arrow = document.getElementById('filterArrow');
    const btn = document.getElementById('filterToggleBtn');
    body.classList.toggle('open');
    arrow.classList.toggle('open');
    btn.querySelector('span').textContent = body.classList.contains('open') ? 'Recolher' : 'Expandir';
}

async function carregarEstados() {
    const select = document.getElementById('selectEstado');
    try {
        const response = await fetch(`${CONFIG.IBGE}/estados?orderBy=nome`);
        estados = await response.json();
        estados.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(est => {
            const opt = document.createElement('option');
            opt.value = est.sigla;
            opt.textContent = `${est.sigla} â€” ${est.nome}`;
            select.appendChild(opt);
        });
    } catch (error) {
        console.error('Erro ao carregar estados:', error);
        showNotification('Erro ao carregar estados', 'error');
    }
}

async function onEstadoChange() {
    const select = document.getElementById('selectEstado');
    const grupoMun = document.getElementById('grupoMunicipio');
    const selectMun = document.getElementById('selectMunicipio');
    const uf = select.value;

    if (!uf) {
        grupoMun.style.display = 'none';
        selectMun.disabled = true;
        selectMun.innerHTML = '<option value="">â€” Selecione o estado primeiro â€”</option>';
        document.getElementById('grupoBairro').style.display = 'none';
        document.getElementById('grupoNivel').style.display = 'none';
        document.getElementById('grupoAcolhimento').style.display = 'none';
        document.getElementById('grupoGestao').style.display = 'none';
        return;
    }

    grupoMun.style.display = 'block';
    selectMun.disabled = true;
    selectMun.innerHTML = '<option value="">Carregando municÃ­pios...</option>';

    try {
        const response = await fetch(`${CONFIG.IBGE}/estados/${uf}/municipios?orderBy=nome`);
        const municipios = await response.json();
        municipiosPorEstado[uf] = municipios.map(m => ({
            id: String(m.id),
            nome: m.nome,
            latitude: null,
            longitude: null,
            osmId: null,
            osmType: null,
            geojson: null,
            bbox: null
        }));
        selectMun.innerHTML = '<option value="">â€” Selecione um municÃ­pio â€”</option>';
        municipiosPorEstado[uf].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(mun => {
            const opt = document.createElement('option');
            opt.value = mun.id;
            opt.textContent = mun.nome;
            selectMun.appendChild(opt);
        });
        selectMun.disabled = false;
    } catch (error) {
        console.error('Erro ao carregar municÃ­pios:', error);
        showNotification('Erro ao carregar municÃ­pios', 'error');
        selectMun.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

function onMunicipioChange() {
    const selectMun = document.getElementById('selectMunicipio');
    if (selectMun.value) {
        document.getElementById('grupoBairro').style.display = 'block';
        document.getElementById('grupoNivel').style.display = 'block';
        document.getElementById('grupoAcolhimento').style.display = 'block';
        document.getElementById('grupoGestao').style.display = 'block';
    } else {
        document.getElementById('grupoBairro').style.display = 'none';
        document.getElementById('grupoNivel').style.display = 'none';
        document.getElementById('grupoAcolhimento').style.display = 'none';
        document.getElementById('grupoGestao').style.display = 'none';
    }
}

function limparFiltros() {
    document.getElementById('selectEstado').value = '';
    document.getElementById('selectMunicipio').innerHTML = '<option value="">â€” Selecione o estado primeiro â€”</option>';
    document.getElementById('selectMunicipio').disabled = true;
    document.getElementById('grupoMunicipio').style.display = 'none';
    document.getElementById('grupoBairro').style.display = 'none';
    document.getElementById('grupoNivel').style.display = 'none';
    document.getElementById('grupoAcolhimento').style.display = 'none';
    document.getElementById('grupoGestao').style.display = 'none';
    document.getElementById('inputBairro').value = '';
    document.getElementById('selectNivel').value = '';
    document.getElementById('selectAcolhimento').value = '';
    document.getElementById('selectGestao').value = '';
    allUnits = [];
    filteredUnits = [];
    renderResults();
    showNotification('Filtros limpos', 'success');
}

function applyLocalFilters() {
    const bairro      = document.getElementById('inputBairro').value.toLowerCase().trim();
    const nivel       = document.getElementById('selectNivel').value;
    const acolhimento = document.getElementById('selectAcolhimento').value;
    const gestao      = document.getElementById('selectGestao').value;

    filteredUnits = allUnits.filter(u => {
        if (bairro && u.bairro && !u.bairro.toLowerCase().includes(bairro)) return false;
        if (nivel       && u.nivel       !== nivel)       return false;
        if (acolhimento && u.acolhimento !== acolhimento) return false;
        if (gestao      && u.gestao      !== gestao)      return false;
        return true;
    });

    // â”€â”€â”€ OrdenaÃ§Ã£o por modo de busca â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // GeolocalizaÃ§Ã£o â†’ agrupa por nÃ­vel e, dentro de cada nÃ­vel, por distÃ¢ncia
    // MunicÃ­pio      â†’ agrupa por nÃ­vel e, dentro de cada nÃ­vel, por nome Aâ†’Z
    //
    // NÃ­veis: primaria=1 (AtenÃ§Ã£o BÃ¡sica), secundaria=2 (MÃ©dia Complexidade),
    //         terciaria=3 (Alta Complexidade)
    const nivelOrdem  = { primaria: 1, secundaria: 2, terciaria: 3 };
    const modoGeo     = filteredUnits.some(u => u.distancia != null && u.distancia >= 0);

    filteredUnits.sort((a, b) => {
        // 1Âº critÃ©rio: nÃ­vel de complexidade crescente (PrimÃ¡rio â†’ SecundÃ¡rio â†’ TerciÃ¡rio)
        const nivelDiff = (nivelOrdem[a.nivel] || 9) - (nivelOrdem[b.nivel] || 9);
        if (nivelDiff !== 0) return nivelDiff;

        // 2Âº critÃ©rio:
        //   â€¢ Modo geogrÃ¡fico â†’ distÃ¢ncia crescente (mais prÃ³xima primeiro)
        //   â€¢ Modo municÃ­pio  â†’ nome em ordem alfabÃ©tica (A â†’ Z)
        if (modoGeo) {
            return (a.distancia ?? 9999) - (b.distancia ?? 9999);
        }
        return norm(a.nome).localeCompare(norm(b.nome));
    });

    renderResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERIZAÃ‡ÃƒO COM LAZY LOADING
//
//  Problema anterior: container.innerHTML = htmlGigante renderizava todos os
//  cards de uma vez. Para 360 resultados no Rio, isso congela a thread
//  principal por atÃ© 2 s em celulares de entrada.
//
//  SoluÃ§Ã£o: renderiza apenas os primeiros BATCH_SIZE cards de cada grupo.
//  Um IntersectionObserver monitora um sentinela invisÃ­vel no fim de cada
//  grupo e, quando ele aparece na tela, carrega o prÃ³ximo lote.
//  O usuÃ¡rio sÃ³ percebe o carregamento incremental se rolar rÃ¡pido â€”
//  na prÃ¡tica, a interface responde instantaneamente.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RENDER_BATCH = 20;   // cards iniciais por grupo
const RENDER_MORE  = 20;   // cards adicionais por scroll

// IntersectionObserver reutilizado entre renderizaÃ§Ãµes
let _lazyObserver = null;

function renderResults() {
    updateDashboard();

    // Desconecta observer anterior para evitar vazamentos
    if (_lazyObserver) { _lazyObserver.disconnect(); _lazyObserver = null; }

    const container = document.getElementById('resultsSection');
    if (filteredUnits.length === 0) {
        container.innerHTML = `
            <div class="status-box">
                <span class="status-icon">ğŸ”</span>
                <h3>Nenhuma unidade encontrada</h3>
                <p>Tente ajustar os filtros ou realizar uma nova busca.</p>
            </div>
        `;
        return;
    }

    const groups = {
        'primaria':   filteredUnits.filter(u => u.nivel === 'primaria'),
        'secundaria': filteredUnits.filter(u => u.nivel === 'secundaria'),
        'terciaria':  filteredUnits.filter(u => u.nivel === 'terciaria')
    };

    // CabeÃ§alho com botÃµes de exportaÃ§Ã£o
    const header = document.createElement('div');
    header.className = 'results-header';
    header.innerHTML = `
        <div>
            <h2 class="results-title">
                Resultados
                <span class="results-count">${filteredUnits.length}</span>
            </h2>
        </div>
        <div class="export-row">
            <button class="btn btn-amber btn-sm" onclick="exportToExcel()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                </svg>
                Exportar Excel
            </button>
            <button class="btn btn-navy btn-sm" onclick="visualizarPDF()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                </svg>
                Visualizar PDF
            </button>
        </div>
    `;

    // Limpa e re-popula o container usando DocumentFragment (uma sÃ³ operaÃ§Ã£o DOM)
    const fragment = document.createDocumentFragment();
    fragment.appendChild(header);

    const groupConfigs = [
        { key: 'primaria',   label: 'AtenÃ§Ã£o PrimÃ¡ria',   color: '#00A878', icon: 'ğŸ ',
          desc: 'UBS Â· Postos de SaÃºde Â· ClÃ­nicas da FamÃ­lia Â· ESF/PSF Â· CAPS/CAPS-AD' },
        { key: 'secundaria', label: 'AtenÃ§Ã£o SecundÃ¡ria',  color: '#1565C0', icon: 'ğŸ”¬',
          desc: 'UPAs 24h Â· AME Â· CEO Â· PoliclÃ­nicas Â· Unidades Mistas Â· CER' },
        { key: 'terciaria',  label: 'AtenÃ§Ã£o TerciÃ¡ria',   color: '#E53935', icon: 'ğŸ¨',
          desc: 'Hospitais Gerais Â· UniversitÃ¡rios Â· Santas Casas Â· Especializados Â· ReabilitaÃ§Ã£o' }
    ];

    // Cria o IntersectionObserver compartilhado para todos os grupos
    _lazyObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            const sentinel = entry.target;
            _lazyObserver.unobserve(sentinel);

            const grid      = sentinel.dataset.grid;
            const groupKey  = sentinel.dataset.groupKey;
            const rendered  = parseInt(sentinel.dataset.rendered, 10);
            const color     = sentinel.dataset.color;

            const gridEl    = document.getElementById(grid);
            if (!gridEl) return;

            // Unidades deste grupo (jÃ¡ filtradas e ordenadas em filteredUnits)
            const allInGroup = filteredUnits.filter(u => u.nivel === groupKey);
            const next       = allInGroup.slice(rendered, rendered + RENDER_MORE);

            if (next.length === 0) return;

            // Renderiza o prÃ³ximo lote
            const frag = document.createDocumentFragment();
            next.forEach((u, i) => {
                const tmp = document.createElement('div');
                tmp.innerHTML = renderUnitCard(u, color, rendered + i);
                frag.appendChild(tmp.firstElementChild);
            });

            const newRendered = rendered + next.length;

            // Se ainda hÃ¡ mais, adiciona novo sentinela
            if (newRendered < allInGroup.length) {
                const newSentinel = _makeSentinel(grid, groupKey, newRendered, color);
                frag.appendChild(newSentinel);
                _lazyObserver.observe(newSentinel);
            }

            // Remove o sentinela antigo e insere o novo conteÃºdo
            sentinel.remove();
            gridEl.appendChild(frag);
        });
    }, { rootMargin: '200px' });   // prÃ©-carrega 200 px antes de aparecer na tela

    groupConfigs.forEach(cfg => {
        if (!groups[cfg.key] || groups[cfg.key].length === 0) return;
        fragment.appendChild(renderGroup(cfg, groups[cfg.key]));
    });

    container.innerHTML = '';
    container.appendChild(fragment);
}

function _makeSentinel(gridId, groupKey, rendered, color) {
    const s = document.createElement('div');
    s.className = 'lazy-sentinel';
    s.dataset.grid     = gridId;
    s.dataset.groupKey = groupKey;
    s.dataset.rendered = rendered;
    s.dataset.color    = color;
    s.style.cssText    = 'height:1px;grid-column:1/-1;';
    return s;
}

function renderGroup(config, units) {
    const groupId = `group-${config.key}`;
    const modoGeo = units.some(u => u.distancia != null && u.distancia >= 0);
    const sortInfo = modoGeo
        ? 'ğŸ“ Ordenadas por proximidade (mais prÃ³xima primeiro)'
        : 'ğŸ”¤ Ordenadas por nome (A â†’ Z)';

    // Renderiza apenas o primeiro lote â€” o resto virÃ¡ pelo IntersectionObserver
    const primeiroLote = units.slice(0, RENDER_BATCH);
    let cardsHTML = primeiroLote.map((u, idx) => renderUnitCard(u, config.color, idx)).join('');

    const section = document.createElement('div');
    section.className = 'group-section';
    section.innerHTML = `
        <div class="group-header" onclick="toggleGroup('${groupId}')">
            <div class="group-header-left">
                <span class="group-pill" style="background: ${config.color}22; color: ${config.color};">${config.icon}</span>
                <div>
                    <div class="group-name">${config.label}</div>
                    <div class="group-meta">
                        ${units.length} unidade${units.length !== 1 ? 's' : ''} encontrada${units.length !== 1 ? 's' : ''}
                        &nbsp;&middot;&nbsp;<span style="font-size:0.7rem;color:var(--teal);">${sortInfo}</span>
                    </div>
                    <div style="font-size:0.68rem;color:var(--text-light);margin-top:2px;">${config.desc || ''}</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="group-count">${units.length}</div>
                <span class="group-arrow" id="${groupId}-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
                </span>
            </div>
        </div>
        <div class="group-body" id="${groupId}">
            <div class="cards-grid" id="${groupId}-grid">
                ${cardsHTML}
            </div>
        </div>
    `;

    // Se hÃ¡ mais cards alÃ©m do primeiro lote, adiciona sentinela e registra observer
    if (units.length > RENDER_BATCH) {
        const gridEl   = section.querySelector(`#${groupId}-grid`);
        const sentinel = _makeSentinel(`${groupId}-grid`, config.key, RENDER_BATCH, config.color);
        gridEl.appendChild(sentinel);
        // Observer serÃ¡ registrado depois que a section for inserida no DOM,
        // por isso usamos requestAnimationFrame para garantir visibilidade
        requestAnimationFrame(() => {
            if (_lazyObserver) _lazyObserver.observe(sentinel);
        });
    }

    return section;
}

function renderUnitCard(unit, accentColor, idx) {
    const gestaoClass = {
        'Municipal': 'municipal',
        'Estadual': 'estadual',
        'Federal': 'federal'
    }[unit.gestao] || 'municipal';
    
    let tagsHTML = '';
    if (unit.gestao) {
        tagsHTML += `<span class="unit-tag unit-tag-${gestaoClass}">${unit.gestao}</span>`;
    }
    const acolhimentoClass = {
        'ambulatorial': 'ambulatorial',
        'urgencia': 'urgencia',
        'maternidade': 'maternidade',
        'especializado': 'especializado',
        'samu': 'urgencia'
    }[unit.acolhimento] || 'ambulatorial';
    tagsHTML += `<span class="unit-tag unit-tag-${acolhimentoClass}">${getTextoAcolhimento(unit.acolhimento)}</span>`;
    if (unit.distancia !== null && unit.distancia !== undefined) {
        tagsHTML += `<span class="unit-tag unit-distance">${unit.distancia.toFixed(1)} km</span>`;
    }
    if (unit.cnes) {
        tagsHTML += `<span class="unit-tag" style="background: #0B1F3A; color: white;">CNES ${unit.cnes}</span>`;
    }

    let nomeExibido = unit.nome;
    if (unit.perfil === 'UPA' && unit.bairro) {
        if (!norm(unit.nome).includes(norm(unit.bairro))) {
            nomeExibido = `${unit.nome} (${unit.bairro})`;
        }
    }

    let actionsHTML = '';
    if (unit.mapsLink) {
        actionsHTML += `
            <button class="btn-icon maps" onclick="window.open('${unit.mapsLink}', '_blank')" title="Ver no Google Maps">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                </svg>
            </button>
        `;
    }

    const searchQuery = encodeURIComponent(`${unit.nome} ${unit.cidade || ''} ${unit.uf || ''} saÃºde`);
    const infoUrl = `https://www.google.com/search?q=${searchQuery}`;
    actionsHTML += `
        <button class="btn-icon search" onclick="window.open('${infoUrl}', '_blank')" title="Mais informaÃ§Ãµes">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
        </button>
    `;

    if (unit.telefone) {
        const telLigacao = limparNumeroParaLigacao(unit.telefone);
        actionsHTML += `
            <button class="btn-icon phone" onclick="window.location.href='tel:${telLigacao}'" title="Ligar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
            </button>
        `;
    }
    const whatsappLink = gerarLinkCompartilhamentoWhatsApp(unit);
    actionsHTML += `
        <button class="btn-icon whatsapp" onclick="window.open('${whatsappLink}', '_blank')" title="Compartilhar no WhatsApp">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
            </svg>
        </button>
    `;
    if (unit.email) {
        actionsHTML += `
            <button class="btn-icon" onclick="window.location.href='mailto:${unit.email}'" title="Enviar e-mail">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                </svg>
            </button>
        `;
    }

    return `
        <div class="unit-card" data-unit-idx="${idx}">
            <div class="unit-card-accent" style="background: ${accentColor};"></div>
            <div class="unit-card-inner">
                <div class="unit-card-header">
                    <h3 class="unit-name">${nomeExibido}</h3>
                </div>
                ${unit.perfil ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>${unit.perfil}</span>
                    </div>
                ` : ''}
                ${unit.cidade && unit.uf ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${unit.cidade} - ${unit.uf}</span>
                    </div>
                ` : ''}
                ${unit.enderecoCompleto || unit.endereco ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${unit.enderecoCompleto || unit.endereco} ${unit.bairro ? ' - ' + unit.bairro : ''}</span>
                    </div>
                ` : ''}
                ${unit.telefoneFormatado ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <span>${unit.telefoneFormatado}</span>
                    </div>
                ` : ''}
                ${unit.email ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span>${unit.email}</span>
                    </div>
                ` : ''}
                ${unit.cnes && !tagsHTML.includes('CNES') ? `<div class="unit-cnes">CNES: ${unit.cnes}</div>` : ''}
                <div class="unit-tags">${tagsHTML}</div>
                ${actionsHTML ? `<div class="unit-actions">${actionsHTML}</div>` : ''}
            </div>
        </div>
    `;
}

function toggleGroup(groupId) {
    const body = document.getElementById(groupId);
    const arrow = document.getElementById(`${groupId}-arrow`);
    body.classList.toggle('open');
    arrow.classList.toggle('open');
}

function updateDashboard() {
    document.getElementById('statTotal').textContent = filteredUnits.length;
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria').length;
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria').length;
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria').length;
    const urgencia = filteredUnits.filter(u => u.acolhimento === 'urgencia').length;
    const maternidade = filteredUnits.filter(u => u.acolhimento === 'maternidade').length;
    const especializado = filteredUnits.filter(u => u.acolhimento === 'especializado').length;
    const ambulatorial = filteredUnits.filter(u => u.acolhimento === 'ambulatorial').length;
    document.getElementById('statPrimaria').textContent = primaria;
    document.getElementById('statSecundaria').textContent = secundaria;
    document.getElementById('statTerciaria').textContent = terciaria;
    document.getElementById('statUrgencia').textContent = urgencia;
    document.getElementById('statMaternidade').textContent = maternidade;
    document.getElementById('statEspecializado').textContent = especializado;
    document.getElementById('statAmbulatorial').textContent = ambulatorial;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORTAÃ‡ÃƒO EXCEL (mantida igual)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportToExcel() {
    if (filteredUnits.length === 0) {
        showNotification('Nenhuma unidade para exportar', 'error');
        return;
    }
    const data = filteredUnits.map(u => ({
        'Nome': u.nome,
        'Perfil': u.perfil,
        'NÃ­vel de AtenÃ§Ã£o': u.nivel === 'primaria' ? 'PrimÃ¡ria' : u.nivel === 'secundaria' ? 'SecundÃ¡ria' : 'TerciÃ¡ria',
        'Tipo de Acolhimento': getTextoAcolhimento(u.acolhimento),
        'Cidade': u.cidade,
        'UF': u.uf,
        'Bairro': u.bairro || '',
        'EndereÃ§o': u.endereco || '',
        'Telefone': u.telefoneFormatado || u.telefone || '',
        'E-mail': u.email || '',
        'GestÃ£o': u.gestao || '',
        'CNES': u.cnes || '',
        'DistÃ¢ncia (km)': u.distancia ? u.distancia.toFixed(2) : '',
        'Latitude': u.lat || '',
        'Longitude': u.lon || '',
        'Website': u.website || ''
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Unidades de SaÃºde');
    const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showNotification(`Arquivo Excel exportado: ${fileName}`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PDF (com cidade/UF nos cards) â€” mantido igual
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gerarPaginaHTML(units, tituloNivel, iconeNivel, corClasse, paginaAtual, totalPaginas, totalUnidades, dataAtual) {
    const cardsHTML = units.map(u => {
        const endereco = u.enderecoCompleto || u.endereco || '';
        const bairro = u.bairro ? ` - ${u.bairro}` : '';
        const telefone = u.telefoneFormatado || u.telefone || 'NÃ£o informado';
        const acolhimentoClass = u.acolhimento || 'ambulatorial';
        const acolhimentoTexto = getTextoAcolhimento(u.acolhimento);
        const distancia = u.distancia ? `<div class="pdf-unit-detail"><span>ğŸ§­</span> <span>${u.distancia.toFixed(1)} km</span></div>` : '';
        const cnes = u.cnes ? `<div style="font-size:0.55rem; margin-top:2px;">CNES: ${u.cnes}</div>` : '';
        // Linha de cidade/UF
        const localizacao = (u.cidade && u.uf) ? `<div class="pdf-unit-detail"><span>ğŸ™ï¸</span> <span>${u.cidade} - ${u.uf}</span></div>` : '';
        // Mapeia acolhimento para classe CSS (urgente, ambulatorial, maternidade, especializado)
        let badgeClass = '';
        if (u.acolhimento === 'urgencia') badgeClass = 'urgente';
        else if (u.acolhimento === 'ambulatorial') badgeClass = 'ambulatorial';
        else if (u.acolhimento === 'maternidade') badgeClass = 'maternidade';
        else if (u.acolhimento === 'especializado') badgeClass = 'especializado';
        else badgeClass = 'ambulatorial';

        return `
            <div class="pdf-unit-card">
                <div class="pdf-unit-name">${u.nome}</div>
                <div class="pdf-unit-detail"><span>ğŸ“</span> <span>${endereco}${bairro}</span></div>
                ${localizacao}
                <div class="pdf-unit-detail"><span>ğŸ“</span> <span>${telefone}</span></div>
                ${u.email ? `<div class="pdf-unit-detail"><span>ğŸ“§</span> <span>${u.email}</span></div>` : ''}
                <div class="pdf-unit-detail"><span>ğŸ¥</span> <span>${u.perfil}</span></div>
                ${distancia}
                <span class="pdf-unit-badge ${badgeClass}">${acolhimentoTexto}</span>
                ${cnes}
            </div>
        `;
    }).join('');

    return `
        <div class="pdf-page" style="width: 800px; background: white; font-family: 'Outfit', 'Fira Sans', sans-serif; padding: 10px; box-sizing: border-box;">
            <div class="pdf-header" style="background: linear-gradient(135deg, #0B1F3A, #132D50); color: white; padding: 8px 12px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="font-size: 1.2rem; font-weight: 800; margin:0;">SaÃºde<span style="color: #00C896;"> - BR</span> â€” Unidades PÃºblicas de SaÃºde</h1>
                    <p style="font-size: 0.6rem; opacity:0.8;">Dados do OpenStreetMap â€¢ Apenas unidades pÃºblicas</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.1rem; font-weight:800; color:#00C896;">${totalUnidades}</div>
                    <div style="font-size:0.5rem; opacity:0.7;">Total de Unidades</div>
                </div>
            </div>
            <div class="pdf-nivel-header" style="display: flex; align-items: center; gap: 6px; background: ${corClasse === 'primaria' ? 'linear-gradient(135deg, #00A878, #00C896)' : corClasse === 'secundaria' ? 'linear-gradient(135deg, #1565C0, #2196f3)' : 'linear-gradient(135deg, #E53935, #f44336)'}; color: white; padding: 6px 10px; border-radius: 6px; margin: 8px 0;">
                <span style="font-size: 1.2rem;">${iconeNivel}</span>
                <span style="flex:1; font-weight:700; font-size:0.8rem;">${tituloNivel}</span>
                <span style="font-weight:800; font-size:1rem;">${units.length}</span>
            </div>
            <div class="pdf-cards-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">${cardsHTML}</div>
            <div class="pdf-footer" style="display: flex; justify-content: space-between; font-size: 0.55rem; color: #5A6E85; border-top: 1px solid #D8E2EE; padding-top: 4px; margin-top: 8px;">
                <span>ğŸ” Gerado pelo SaÃºde-BR Localizador de Unidades de SaÃºde</span>
                <span>PÃ¡gina ${paginaAtual} de ${totalPaginas} â€¢ ${dataAtual}</span>
            </div>
        </div>
    `;
}

const pdfStyles = `
    <style>
        .pdf-unit-card {
            background: #f8fafd;
            border: 1px solid #D8E2EE;
            border-radius: 6px;
            padding: 6px;
            font-size: 0.65rem;
            break-inside: avoid;
            page-break-inside: avoid;
        }
        .pdf-unit-name {
            font-weight: 700;
            font-size: 0.75rem;
            color: #0B1F3A;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pdf-unit-detail {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.6rem;
            color: #5A6E85;
            margin-bottom: 2px;
        }
        .pdf-unit-detail span:first-child { min-width: 14px; }
        .pdf-unit-badge {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.55rem;
            font-weight: 600;
            margin-top: 3px;
        }
        .pdf-unit-badge.urgente { background: #FDECEA; color: #E53935; }
        .pdf-unit-badge.ambulatorial { background: #E8F8F3; color: #00A878; }
        .pdf-unit-badge.maternidade { background: #F3E5F5; color: #6A1B9A; }
        .pdf-unit-badge.especializado { background: #FFF8EC; color: #C07A00; }
    </style>
`;

async function gerarPDFCompleto() {
    const dataAtual = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria');
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria');
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria');
    const grupos = [
        { units: primaria, titulo: 'AtenÃ§Ã£o PrimÃ¡ria', icone: 'ğŸ ', cor: 'primaria' },
        { units: secundaria, titulo: 'AtenÃ§Ã£o SecundÃ¡ria', icone: 'ğŸ”¬', cor: 'secundaria' },
        { units: terciaria, titulo: 'AtenÃ§Ã£o TerciÃ¡ria', icone: 'ğŸ¨', cor: 'terciaria' }
    ].filter(g => g.units.length > 0);
    const CARDS_POR_PAGINA = 8;
    const paginasHTML = [];
    let paginaGlobal = 1;
    for (const grupo of grupos) {
        const units = grupo.units;
        for (let i = 0; i < units.length; i += CARDS_POR_PAGINA) {
            const fatia = units.slice(i, i + CARDS_POR_PAGINA);
            paginasHTML.push(gerarPaginaHTML(fatia, grupo.titulo, grupo.icone, grupo.cor, paginaGlobal, 0, filteredUnits.length, dataAtual));
            paginaGlobal++;
        }
    }
    const totalPaginas = paginasHTML.length;
    let htmlFinal = pdfStyles;
    for (let i = 0; i < paginasHTML.length; i++) {
        const item = paginasHTML[i];
        const htmlComNumero = item.replace('PÃ¡gina 0 de 0', `PÃ¡gina ${i+1} de ${totalPaginas}`);
        htmlFinal += htmlComNumero;
        if (i < paginasHTML.length - 1) htmlFinal += '<div style="page-break-before: always; height: 0;"></div>';
    }
    return htmlFinal;
}

async function visualizarPDF() {
    if (filteredUnits.length === 0) { showNotification('Nenhuma unidade para gerar PDF', 'error'); return; }
    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando visualizaÃ§Ã£o do PDF...', 'Preparando conteÃºdo');
    try {
        const html = await gerarPDFCompleto();
        document.getElementById('pdfModalBody').innerHTML = html;
        document.getElementById('pdfModal').classList.add('visible');
        showSearchProgress(false);
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar visualizaÃ§Ã£o do PDF', 'error');
        showSearchProgress(false);
    }
}

function closePDFModal() { document.getElementById('pdfModal').classList.remove('visible'); }

async function downloadPDF() {
    if (filteredUnits.length === 0) return;
    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando PDF...', 'Processando pÃ¡ginas');
    try {
        const { jsPDF } = window.jspdf;
        const htmlString = await gerarPDFCompleto();
        const container = document.createElement('div');
        container.innerHTML = htmlString;
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.top = '0';
        container.style.width = '800px';
        container.style.background = 'white';
        document.body.appendChild(container);
        const paginas = Array.from(container.children).filter(el => el.classList.contains('pdf-page'));
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
        for (let i = 0; i < paginas.length; i++) {
            updateSearchProgress(20 + Math.round((i / paginas.length) * 70), `Renderizando pÃ¡gina ${i+1} de ${paginas.length}...`, 'Aguarde, pode levar alguns segundos');
            const pageDiv = paginas[i];
            pageDiv.style.width = '800px';
            pageDiv.style.height = 'auto';
            pageDiv.style.margin = '0';
            pageDiv.style.padding = '10px';
            const canvas = await html2canvas(pageDiv, { scale: 1.5, backgroundColor: '#ffffff', logging: false, allowTaint: true, useCORS: true, windowWidth: 800, windowHeight: pageDiv.scrollHeight });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const width = imgWidth * ratio;
            const height = imgHeight * ratio;
            const x = (pdfWidth - width) / 2;
            const y = (pdfHeight - height) / 2;
            if (i > 0) pdf.addPage();
            pdf.addImage(imgData, 'JPEG', x, y, width, height);
        }
        document.body.removeChild(container);
        const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        showSearchProgress(false);
        showNotification(`PDF baixado: ${fileName}`, 'success');
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar PDF', 'error');
        showSearchProgress(false);
    }
}

async function compartilharPDFWhatsApp() {
    if (filteredUnits.length === 0) { showNotification('Nenhuma unidade para compartilhar', 'error'); return; }
    showSearchProgress(true);
    updateSearchProgress(10, 'Preparando PDF para WhatsApp...', 'Gerando pÃ¡ginas...');
    try {
        const { jsPDF } = window.jspdf;
        const htmlString = await gerarPDFCompleto();
        const container = document.createElement('div');
        container.innerHTML = htmlString;
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.top = '0';
        container.style.width = '800px';
        container.style.background = 'white';
        document.body.appendChild(container);
        const paginas = Array.from(container.children).filter(el => el.classList.contains('pdf-page'));
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
        for (let i = 0; i < paginas.length; i++) {
            updateSearchProgress(20 + Math.round((i / paginas.length) * 70), `Renderizando pÃ¡gina ${i+1} de ${paginas.length}...`, 'Convertendo imagem...');
            const pageDiv = paginas[i];
            pageDiv.style.width = '800px';
            pageDiv.style.height = 'auto';
            pageDiv.style.margin = '0';
            pageDiv.style.padding = '10px';
            const canvas = await html2canvas(pageDiv, { scale: 1.5, backgroundColor: '#ffffff', logging: false, allowTaint: true, useCORS: true, windowWidth: 800, windowHeight: pageDiv.scrollHeight });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const width = imgWidth * ratio;
            const height = imgHeight * ratio;
            const x = (pdfWidth - width) / 2;
            const y = (pdfHeight - height) / 2;
            if (i > 0) pdf.addPage();
            pdf.addImage(imgData, 'JPEG', x, y, width, height);
        }
        document.body.removeChild(container);
        const pdfBlob = pdf.output('blob');
        updateSearchProgress(95, 'Pronto!', 'Preparando compartilhamento...');
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], 'SaudeBR_Unidades.pdf', { type: 'application/pdf' })] })) {
            const file = new File([pdfBlob], 'SaudeBR_Unidades.pdf', { type: 'application/pdf' });
            await navigator.share({
                title: 'RelatÃ³rio de Unidades de SaÃºde',
                text: 'Confira as unidades de saÃºde prÃ³ximas.',
                files: [file]
            });
            showNotification('Compartilhado com sucesso!', 'success');
        } else {
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const link = document.createElement('a');
            link.href = pdfUrl;
            link.download = 'SaudeBR_Unidades.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(pdfUrl);
            alert('âœ… PDF gerado com sucesso!\n\nPara compartilhar no WhatsApp:\n1ï¸âƒ£ Clique em OK e aguarde o download\n2ï¸âƒ£ Abra o WhatsApp\n3ï¸âƒ£ Selecione a conversa desejada\n4ï¸âƒ£ Clique no Ã­cone ğŸ“ (anexar)\n5ï¸âƒ£ Escolha "Documento"\n6ï¸âƒ£ Selecione o arquivo baixado');
        }
        showSearchProgress(false);
        showNotification('PDF pronto para compartilhamento!', 'success');
    } catch (error) {
        console.error('Erro ao gerar PDF para WhatsApp:', error);
        showNotification('Erro ao gerar PDF para WhatsApp', 'error');
        showSearchProgress(false);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INICIALIZAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
    carregarEstados();
    console.log('SaÃºde-BR Localizador de Unidades de SaÃºde - SUS');
});

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('visible');
    });
});
</script>

</body>
</html>

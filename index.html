<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Unidades de Saúde Pública</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        h1 {
            color: #007bff;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn {
            border-radius: 5px;
        }
        .accordion-button {
            font-weight: bold;
        }
        .total-card {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            text-align: center;
        }
        .total-number {
            font-size: 2em;
            color: #28a745;
        }
        .pdf-page-break {
            page-break-before: always;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Consulta de Unidades de Saúde Pública no Brasil</h1>
        
        <!-- Formulário de Filtros Retrátil -->
        <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#filtroForm" aria-expanded="false" aria-controls="filtroForm">
            Filtros de Busca
        </button>
        <div class="collapse" id="filtroForm">
            <div class="card card-body mb-4">
                <form id="filtroFormInner">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="estado">Estado (UF):</label>
                            <input type="text" class="form-control" id="estado" placeholder="Ex: RJ">
                        </div>
                        <div class="col-md-3">
                            <label for="municipio">Município:</label>
                            <input type="text" class="form-control" id="municipio" placeholder="Ex: Rio de Janeiro">
                        </div>
                        <div class="col-md-3">
                            <label for="bairro">Bairro:</label>
                            <input type="text" class="form-control" id="bairro" placeholder="Ex: Centro">
                        </div>
                        <div class="col-md-3">
                            <label for="perfil">Perfil de Atenção:</label>
                            <select class="form-control" id="perfil">
                                <option value="">Todos</option>
                                <option value="primaria">Primária</option>
                                <option value="secundaria">Secundária</option>
                                <option value="terciaria">Terciária</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="acolhimento">Forma de Acolhimento:</label>
                            <select class="form-control" id="acolhimento">
                                <option value="">Todas</option>
                                <option value="ambulatorial">Ambulatorial</option>
                                <option value="urgencia">Urgência/Emergência</option>
                                <option value="maternidade">Maternidade</option>
                                <option value="traumatologia">Traumatologia</option>
                            </select>
                        </div>
                        <div class="col-md-3 mt-4">
                            <button type="button" class="btn btn-success" onclick="buscarUnidades()">Buscar</button>
                            <button type="button" class="btn btn-secondary" onclick="limparFiltros()">Limpar Filtros</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Botão para Busca por Proximidade -->
        <button class="btn btn-info mb-3" onclick="buscarPorProximidade()">Buscar por Proximidade (mín. 6 km)</button>
        
        <!-- Dashboard Totalizadores -->
        <div id="totalizadores" class="row mb-4"></div>
        
        <!-- Grupos Retráteis de Unidades -->
        <div id="unidadesContainer" class="accordion"></div>
        
        <!-- Botões de Exportação -->
        <div class="mt-4">
            <button class="btn btn-primary" onclick="exportarExcel()">Exportar para Excel</button>
            <button class="btn btn-danger" onclick="gerarPDF()">Gerar PDF (A5 Horizontal)</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://apidadosabertos.saude.gov.br/cnes/estabelecimentos';
        let unidades = [];
        let userLocation = null;

        // Mapeamento de perfis e acolhimentos baseado em códigos de tipo (exemplos; ajustar conforme dados reais)
        const perfilMap = {
            '1': 'terciaria', // Hospital Geral
            '36': 'primaria', // UBS
            // Adicionar mais mapeamentos baseados em documentação CNES
        };
        const acolhimentoMap = {
            'ambulatorial': ['4', '5'], // Códigos exemplo
            // Adicionar mais
        };

        // Função para buscar unidades com filtros
        async function buscarUnidades() {
            unidades = [];
            const estado = document.getElementById('estado').value.toUpperCase();
            const municipio = document.getElementById('municipio').value;
            const bairro = document.getElementById('bairro').value.toLowerCase();
            const perfil = document.getElementById('perfil').value;
            const acolhimento = document.getElementById('acolhimento').value;

            let params = new URLSearchParams();
            if (estado) params.append('codigo_uf', getCodigoUF(estado)); // Função para mapear UF para código IBGE
            if (municipio) params.append('codigo_municipio', getCodigoMunicipio(municipio)); // Similar
            params.append('limit', 100);
            params.append('offset', 0);

            try {
                const response = await fetch(`${API_BASE}?${params}`);
                const data = await response.json();
                unidades = data // Assumir array de estabelecimentos
                    .filter(unit => (!bairro || unit.bairro.toLowerCase().includes(bairro))
                        && (!perfil || perfilMap[unit.codigo_tipo_unidade] === perfil)
                        && (!acolhimento || acolhimentoMap[acolhimento].includes(unit.tipo_acolhimento))); // Ajustar campos
                exibirUnidades();
            } catch (error) {
                console.error('Erro ao buscar unidades:', error);
            }
        }

        // Função para busca por proximidade
        function buscarPorProximidade() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    await buscarUnidades(); // Fetch all in state or broad, then filter
                    unidades = unidades.filter(unit => calculateDistance(userLocation, { lat: unit.latitude, lng: unit.longitude }) <= 6);
                    exibirUnidades();
                }, error => console.error('Erro na geolocalização:', error));
            } else {
                alert('Geolocalização não suportada.');
            }
        }

        // Fórmula Haversine para distância (em km)
        function calculateDistance(coord1, coord2) {
            const R = 6371;
            const dLat = deg2rad(coord2.lat - coord1.lat);
            const dLon = deg2rad(coord2.lng - coord1.lng);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(coord1.lat)) * Math.cos(deg2rad(coord2.lat)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Exibir unidades em grupos retráteis
        function exibirUnidades() {
            const container = document.getElementById('unidadesContainer');
            container.innerHTML = '';
            const grupos = groupByPerfilAcolhimento(unidades); // Função para agrupar
            Object.keys(grupos).forEach((grupo, index) => {
                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                accordionItem.innerHTML = `
                    <h2 class="accordion-header" id="heading${index}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                            ${grupo} (${grupos[grupo].length})
                        </button>
                    </h2>
                    <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}">
                        <div class="accordion-body">
                            ${grupos[grupo].map(unit => createCard(unit)).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(accordionItem);
            });
            exibirTotalizadores(grupos);
        }

        // Criar card para unidade
        function createCard(unit) {
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">${unit.nome}</h5>
                        <p class="card-text">Endereço: ${unit.endereco}<br>Contato: ${unit.telefone || 'N/A'}</p>
                        <a href="${unit.url || `https://www.google.com/search?q=${encodeURIComponent(unit.nome + ' ' + unit.endereco)}`}" target="_blank" class="btn btn-sm btn-info">Página Web</a>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(unit.nome + ' ' + unit.endereco)}" target="_blank" class="btn btn-sm btn-secondary">Google Search</a>
                        <a href="https://maps.google.com/?q=${encodeURIComponent(unit.endereco)}" target="_blank" class="btn btn-sm btn-primary">Google Maps</a>
                        <a href="https://wa.me/?text=${encodeURIComponent(`Unidade: ${unit.nome}, Endereço: ${unit.endereco}`)}" target="_blank" class="btn btn-sm btn-success">Compartilhar WhatsApp</a>
                    </div>
                </div>
            `;
        }

        // Exibir totalizadores
        function exibirTotalizadores(grupos) {
            const totalContainer = document.getElementById('totalizadores');
            totalContainer.innerHTML = '';
            Object.keys(grupos).forEach(grupo => {
                const card = document.createElement('div');
                card.className = 'col-md-3 total-card';
                card.innerHTML = `
                    <h5>${grupo}</h5>
                    <div class="total-number">${grupos[grupo].length}</div>
                `;
                totalContainer.appendChild(card);
            });
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtroFormInner').reset();
            unidades = [];
            exibirUnidades();
        }

        // Exportar para Excel
        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            const ws_data = [["Nome", "Endereço", "Contato", "Perfil", "Acolhimento", "Link Web"]];
            unidades.forEach(unit => {
                ws_data.push([unit.nome, unit.endereco, unit.telefone, perfilMap[unit.codigo_tipo_unidade], /* acolhimento */]);
            });
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Unidades");
            XLSX.writeFile(wb, 'unidades_saude.xlsx');
        }

        // Gerar PDF A5 Horizontal com layout independente
        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
            doc.setFontSize(12);
            doc.text('Relatório de Unidades de Saúde', 10, 10);
            let y = 20;
            unidades.forEach((unit, index) => {
                if (y > 100) { // Quebra de página inteligente
                    doc.addPage();
                    y = 10;
                }
                doc.text(`${unit.nome}`, 10, y);
                doc.text(`Endereço: ${unit.endereco}`, 10, y+10);
                doc.text(`Contato: ${unit.telefone}`, 10, y+20);
                y += 30;
            });
            doc.save('unidades_saude.pdf');
        }

        // Funções auxiliares: getCodigoUF, getCodigoMunicipio (implementar com mapa ou outra API se necessário; exemplo estático)
        function getCodigoUF(uf) {
            const map = { 'RJ': 33 }; // IBGE codes
            return map[uf] || '';
        }

        function getCodigoMunicipio(municipio) {
            // Implementar mapeamento ou fetch de API IBGE para códigos
            return ''; // Placeholder
        }

        function groupByPerfilAcolhimento(unidades) {
            const grupos = {};
            unidades.forEach(unit => {
                const perfil = perfilMap[unit.codigo_tipo_unidade] || 'Desconhecido';
                const acolhimento = Object.keys(acolhimentoMap).find(key => acolhimentoMap[key].includes(unit.tipo_acolhimento)) || 'Desconhecido';
                const key = `${perfil} - ${acolhimento}`;
                if (!grupos[key]) grupos[key] = [];
                grupos[key].push(unit);
            });
            return grupos;
        }

        // Inicializar
        window.onload = () => {
            // Carregar tipos de unidades se necessário
        };
    </script>
</body>
</html>

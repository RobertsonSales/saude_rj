<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sa√∫deBR ‚Äî Localizador CNES de Unidades de Sa√∫de P√∫blica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* ‚îÄ‚îÄ‚îÄ FILTER PANEL ‚îÄ‚îÄ‚îÄ */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,168,120,0.1);
    }
    select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6E85' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--radius-sm);
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,168,120,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,168,120,0.4);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover { background: #fff; border-color: var(--teal); color: var(--teal); }
    .btn-navy {
      background: var(--navy);
      color: #fff;
      box-shadow: 0 4px 12px rgba(11,31,58,0.25);
    }
    .btn-navy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(11,31,58,0.35); }
    .btn-amber {
      background: linear-gradient(135deg, var(--amber) 0%, #F7BE50 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(245,166,35,0.35);
    }
    .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(245,166,35,0.45); }
    .btn-geo {
      background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21,101,192,0.3);
    }
    .btn-geo:hover { transform: translateY(-1px); }
    .btn-danger { background: var(--red-pale); color: var(--red); border: 1.5px solid rgba(229,57,53,0.2); }
    .btn-danger:hover { background: var(--red); color: #fff); }
    .btn-sm { padding: 7px 14px; font-size: 0.78rem; }
    .btn-icon { width: 34px; height: 34px; padding: 0; justify-content: center; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* ‚îÄ‚îÄ‚îÄ GEO SECTION ‚îÄ‚îÄ‚îÄ */
    .geo-section {
      background: linear-gradient(135deg, var(--blue-pale), #d8e8ff);
      border: 1px solid rgba(21,101,192,0.2);
      border-radius: var(--radius);
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .geo-info { flex: 1; }
    .geo-info h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--blue);
    }
    .geo-info p { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .geo-radius-row { display: flex; align-items: center; gap: 10px; }
    .geo-radius-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .geo-radius-input {
      width: 80px;
      background: #fff;
      border: 1.5px solid rgba(21,101,192,0.3);
      border-radius: 8px;
      padding: 7px 10px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      text-align: center;
    }

    /* ‚îÄ‚îÄ‚îÄ DASHBOARD CARDS ‚îÄ‚îÄ‚îÄ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--teal));
    }
    .stat-card-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    .stat-card-value {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      line-height: 1;
      color: var(--navy);
      transition: all 0.5s;
    }
    .stat-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .stat-card-sublabel { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }

    /* ‚îÄ‚îÄ‚îÄ RESULTS SECTION ‚îÄ‚îÄ‚îÄ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .results-count {
      background: var(--teal-pale);
      color: var(--teal);
      font-size: 0.78rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 8px;
    }
    .export-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ‚îÄ‚îÄ‚îÄ GROUP SECTIONS ‚îÄ‚îÄ‚îÄ */
    .group-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .group-header {
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .group-header:hover { background: var(--bg); }
    .group-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .group-pill {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.78rem;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .group-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .group-meta { font-size: 0.78rem; color: var(--text-muted); }
    .group-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--navy);
      min-width: 60px;
      text-align: right;
    }
    .group-arrow { color: var(--text-muted); transition: transform 0.3s; }
    .group-arrow.open { transform: rotate(90deg); }

    .group-body {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: none;
    }
    .group-body.open { display: block; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    /* ‚îÄ‚îÄ‚îÄ UNIT CARDS ‚îÄ‚îÄ‚îÄ */
    .unit-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-card-accent {
      position: absolute;
      top: 0; left: 0;
      width: 4px;
      height: 100%;
    }
    .unit-card-inner { padding-left: 8px; }
    .unit-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--navy);
      line-height: 1.3;
    }
    .unit-type-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .unit-info-row svg { flex-shrink: 0; margin-top: 1px; color: var(--text-light); }
    .unit-cnes {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 10px;
      font-family: 'Outfit', sans-serif;
    }
    .unit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }
    .unit-tag {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-tag-urgencia { background: var(--red-pale); color: var(--red); }
    .unit-tag-ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .unit-tag-maternidade { background: var(--purple-pale); color: var(--purple); }
    .unit-tag-traumatologia { background: var(--amber-pale); color: #C07A00; }
    .unit-tag-federal { background: #E8F0FE; color: var(--blue); }
    .unit-tag-estadual { background: #FFF8EC; color: #9C6E00; }
    .unit-tag-municipal { background: var(--teal-pale); color: #006B4F; }
    .unit-distance { background: var(--blue-pale); color: var(--blue); }
    .unit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 4px;
    }
    .unit-actions .btn-icon {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      transition: all 0.2s;
    }
    .unit-actions .btn-icon:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-pale); }
    .unit-actions .btn-icon.whatsapp:hover { border-color: #25D366; color: #25D366; background: #E8FBF0; }
    .unit-actions .btn-icon.maps:hover { border-color: #EA4335; color: #EA4335; background: #FDECEA; }
    .unit-actions .btn-icon.search:hover { border-color: #4285F4; color: #4285F4; background: #E8F0FE; }

    /* ‚îÄ‚îÄ‚îÄ LOADING / EMPTY / ERROR ‚îÄ‚îÄ‚îÄ */
    .status-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 60px 40px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .status-box .status-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }
    .status-box h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .status-box p { font-size: 0.88rem; color: var(--text-muted); max-width: 400px; margin: 0 auto; }

    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--teal-pale);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-wrap {
      max-width: 360px;
      margin: 16px auto 0;
      background: var(--border);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    /* ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD ‚îÄ‚îÄ‚îÄ */
    .search-progress-card {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
      border-radius: var(--radius);
      padding: 20px 28px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 20px;
      border: 1px solid rgba(0,168,120,0.25);
      box-shadow: var(--shadow-md);
      animation: slideDown 0.3s ease;
    }
    .search-progress-card.visible { display: flex; }
    .search-progress-spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(0,200,150,0.25);
      border-top-color: var(--teal-light);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    .search-progress-info { flex: 1; min-width: 0; }
    .search-progress-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.92rem;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-progress-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      min-height: 16px;
    }
    .search-progress-bar-wrap {
      flex: 1;
      max-width: 260px;
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .search-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .search-progress-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--teal-light);
      min-width: 48px;
      text-align: right;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ PDF PREVIEW MODAL ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(11,31,58,0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.visible { display: flex; }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover { background: var(--red-pale); color: var(--red); }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .pdf-preview-frame {
      width: 100%;
      min-height: 500px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: #f5f5f5;
    }

    /* ‚îÄ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ‚îÄ */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--navy);
      color: #fff;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 340px;
    }
    .notification.success { background: var(--teal); }
    .notification.error { background: var(--red); }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .footer a { color: var(--teal); text-decoration: none; }

    /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      .main-wrapper { padding: 16px 14px 40px; }
      .header-inner { padding: 14px 16px; }
      .header-titles h1 { font-size: 1.2rem; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: 1fr; }
      .geo-section { flex-direction: column; align-items: stretch; }
      .modal-content { max-height: 95vh; }
    }

    /* ‚îÄ‚îÄ‚îÄ NIVEL COLORS ‚îÄ‚îÄ‚îÄ */
    .nivel-primaria { --nivel-color: #00A878; }
    .nivel-secundaria { --nivel-color: #1565C0; }
    .nivel-terciaria { --nivel-color: #E53935; }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header>
  <div class="header-inner">
    <div class="logo-mark">
      <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 4v20M4 14h20" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
        <circle cx="14" cy="14" r="12" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
      </svg>
    </div>
    <div class="header-titles">
      <h1>Sa√∫de<span>BR</span> &mdash; Localizador CNES</h1>
      <p>Dados em tempo real ‚Ä¢ Minist√©rio da Sa√∫de / DATASUS ‚Ä¢ Todas as esferas de gest√£o</p>
    </div>
    <span class="header-badge">üü¢ Online</span>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main-wrapper">

  <!-- ‚îÄ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ‚îÄ -->
  <div class="filter-section">
    <div class="filter-header" onclick="toggleFilter()">
      <div class="filter-header-left">
        <div class="filter-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </div>
        <div>
          <div class="filter-title">Filtros de Busca</div>
          <div class="filter-subtitle">Estado, munic√≠pio, perfil de aten√ß√£o e formas de acolhimento</div>
        </div>
      </div>
      <button class="filter-toggle-btn" id="filterToggleBtn">
        <span>Expandir</span>
        <span class="filter-toggle-arrow" id="filterArrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </button>
    </div>

    <div class="filter-body" id="filterBody">
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Estado (UF)</label>
          <select class="form-control" id="selectEstado" onchange="onEstadoChange()">
            <option value="">‚Äî Selecione ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Munic√≠pio</label>
          <select class="form-control" id="selectMunicipio" onchange="onMunicipioChange()" disabled>
            <option value="">‚Äî Selecione o estado primeiro ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" id="inputBairro" placeholder="Ex: Centro, Jardim..." oninput="applyLocalFilters()">
        </div>
        <div class="form-group">
          <label class="form-label">Perfil / N√≠vel de Aten√ß√£o</label>
          <select class="form-control" id="selectNivel" onchange="applyLocalFilters()">
            <option value="">Todos os N√≠veis</option>
            <option value="primaria">Aten√ß√£o Prim√°ria</option>
            <option value="secundaria">Aten√ß√£o Secund√°ria</option>
            <option value="terciaria">Aten√ß√£o Terci√°ria</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Forma de Acolhimento</label>
          <select class="form-control" id="selectAcolhimento" onchange="applyLocalFilters()">
            <option value="">Todas as Formas</option>
            <option value="ambulatorial">Atendimento Ambulatorial</option>
            <option value="urgencia">Urg√™ncia / Emerg√™ncia</option>
            <option value="maternidade">Maternidade</option>
            <option value="traumatologia">Traumatologia</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Esfera de Gest√£o</label>
          <select class="form-control" id="selectGestao" onchange="applyLocalFilters()">
            <option value="">Todas</option>
            <option value="M">Municipal</option>
            <option value="E">Estadual</option>
            <option value="F">Federal</option>
            <option value="D">Dupla</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="buscarUnidades()" id="btnBuscar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          Buscar Unidades
        </button>
        <button class="btn btn-secondary" onclick="limparFiltros()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.57"/></svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ GEOLOCALIZA√á√ÉO ‚îÄ‚îÄ‚îÄ -->
  <div class="geo-section">
    <div style="font-size: 1.8rem;">üìç</div>
    <div class="geo-info">
      <h3>Busca por Proximidade Geogr√°fica</h3>
      <p id="geoStatus">Detecta automaticamente sua localiza√ß√£o via GPS e busca unidades no raio configurado.</p>
    </div>
    <div class="geo-radius-row">
      <span class="geo-radius-label">Raio (km):</span>
      <input type="number" class="geo-radius-input form-control" id="geoRaio" value="6" min="0.5" max="50" step="0.5">
    </div>
    <button class="btn btn-geo" onclick="usarGeolocalizacao()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>
      Usar Minha Localiza√ß√£o
    </button>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD ‚îÄ‚îÄ‚îÄ -->
  <div class="search-progress-card" id="searchProgressCard">
    <div class="search-progress-spinner"></div>
    <div class="search-progress-info">
      <div class="search-progress-title" id="spTitle">Consultando CNES/DATASUS...</div>
      <div class="search-progress-hint" id="spHint">Iniciando conex√£o...</div>
    </div>
    <div class="search-progress-bar-wrap">
      <div class="search-progress-bar" id="spBar" style="width:5%"></div>
    </div>
    <div class="search-progress-count" id="spCount">0</div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ -->
  <div class="dashboard" id="dashboard">
    <div class="stat-card" style="--card-accent: var(--teal);">
      <div class="stat-card-icon" style="background: var(--teal-pale); color: var(--teal);">üè•</div>
      <div class="stat-card-value" id="statTotal">‚Äî</div>
      <div class="stat-card-label">Total de Unidades</div>
      <div class="stat-card-sublabel">encontradas</div>
    </div>
    <div class="stat-card" style="--card-accent: #00A878;">
      <div class="stat-card-icon" style="background: #E8F8F3; color: #00A878;">üè†</div>
      <div class="stat-card-value" id="statPrimaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Prim√°ria</div>
      <div class="stat-card-sublabel">UBS, ESF, CAPS...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--blue);">
      <div class="stat-card-icon" style="background: var(--blue-pale); color: var(--blue);">üî¨</div>
      <div class="stat-card-value" id="statSecundaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Secund√°ria</div>
      <div class="stat-card-sublabel">Policl√≠nicas, esp...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üè®</div>
      <div class="stat-card-value" id="statTerciaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Terci√°ria</div>
      <div class="stat-card-sublabel">Hospitais, UTI...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üö®</div>
      <div class="stat-card-value" id="statUrgencia">‚Äî</div>
      <div class="stat-card-label">Urg√™ncia/Emerg√™ncia</div>
      <div class="stat-card-sublabel">UPAs, PS, SAMU</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--purple);">
      <div class="stat-card-icon" style="background: var(--purple-pale); color: var(--purple);">ü§±</div>
      <div class="stat-card-value" id="statMaternidade">‚Äî</div>
      <div class="stat-card-label">Maternidades</div>
      <div class="stat-card-sublabel">Parto e neonatal</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--amber);">
      <div class="stat-card-icon" style="background: var(--amber-pale); color: var(--amber);">ü¶¥</div>
      <div class="stat-card-value" id="statTraumatologia">‚Äî</div>
      <div class="stat-card-label">Traumatologia</div>
      <div class="stat-card-sublabel">Ortopedia, trauma</div>
    </div>
    <div class="stat-card" style="--card-accent: #9C27B0;">
      <div class="stat-card-icon" style="background: #F3E5F5; color: #9C27B0;">üèõÔ∏è</div>
      <div class="stat-card-value" id="statAmbulatorial">‚Äî</div>
      <div class="stat-card-label">Ambulatorial</div>
      <div class="stat-card-sublabel">Consultas/exames</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ RESULTADOS ‚îÄ‚îÄ‚îÄ -->
  <div id="resultsSection">
    <div class="status-box">
      <span class="status-icon">üîç</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione estado e munic√≠pio nos filtros e clique em <strong>Buscar Unidades</strong>, ou use <strong>Usar Minha Localiza√ß√£o</strong> para detec√ß√£o autom√°tica.</p>
    </div>
  </div>

</div><!-- /main-wrapper -->

<!-- ‚ïê‚ïê‚ïê PDF PREVIEW MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Preview do Relat√≥rio PDF</h3>
      <button class="modal-close" onclick="closePDFModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <iframe id="pdfPreviewFrame" class="pdf-preview-frame"></iframe>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePDFModal()">Fechar</button>
      <button class="btn btn-primary" onclick="downloadPDFFromModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Baixar PDF
      </button>
    </div>
  </div>
</div>

<footer class="footer">
  Dados obtidos em tempo real via <a href="https://apidadosabertos.saude.gov.br/cnes" target="_blank">API CNES/DATASUS</a> ‚Äî Minist√©rio da Sa√∫de do Brasil &nbsp;|&nbsp; Sa√∫deBR Localizador v2.0
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURA√á√ÉO & CONSTANTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CNES_BASE      = 'https://apidadosabertos.saude.gov.br/cnes';
const IBGE_API       = 'https://servicodados.ibge.gov.br/api/v1/localidades';
const NOMINATIM_API  = 'https://nominatim.openstreetmap.org';

// API CORS Proxies para fallback
const CORS_PROXIES = [
  url => url,  // Tentativa direta primeiro
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`
];

// Estado da aplica√ß√£o
let allUnits = [];
let filteredUnits = [];
let currentGeoPosition = null;
let estadosMunicipios = {};
let currentPDFBlob = null;

// Constantes para classifica√ß√£o
const ESTADOS = [
  {sg:'AC',nome:'Acre',co:'12'},{sg:'AL',nome:'Alagoas',co:'27'},{sg:'AP',nome:'Amap√°',co:'16'},
  {sg:'AM',nome:'Amazonas',co:'13'},{sg:'BA',nome:'Bahia',co:'29'},{sg:'CE',nome:'Cear√°',co:'23'},
  {sg:'DF',nome:'Distrito Federal',co:'53'},{sg:'ES',nome:'Esp√≠rito Santo',co:'32'},
  {sg:'GO',nome:'Goi√°s',co:'52'},{sg:'MA',nome:'Maranh√£o',co:'21'},{sg:'MT',nome:'Mato Grosso',co:'51'},
  {sg:'MS',nome:'Mato Grosso do Sul',co:'50'},{sg:'MG',nome:'Minas Gerais',co:'31'},
  {sg:'PA',nome:'Par√°',co:'15'},{sg:'PB',nome:'Para√≠ba',co:'25'},{sg:'PR',nome:'Paran√°',co:'41'},
  {sg:'PE',nome:'Pernambuco',co:'26'},{sg:'PI',nome:'Piau√≠',co:'22'},{sg:'RJ',nome:'Rio de Janeiro',co:'33'},
  {sg:'RN',nome:'Rio Grande do Norte',co:'24'},{sg:'RS',nome:'Rio Grande do Sul',co:'43'},
  {sg:'RO',nome:'Rond√¥nia',co:'11'},{sg:'RR',nome:'Roraima',co:'14'},{sg:'SC',nome:'Santa Catarina',co:'42'},
  {sg:'SP',nome:'S√£o Paulo',co:'35'},{sg:'SE',nome:'Sergipe',co:'28'},{sg:'TO',nome:'Tocantins',co:'17'}
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INICIALIZA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  carregarEstados();
  console.log('Sa√∫deBR Localizador CNES v2.0 iniciado');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERFACE - FILTROS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFilter() {
  const body = document.getElementById('filterBody');
  const arrow = document.getElementById('filterArrow');
  const btn = document.getElementById('filterToggleBtn');
  
  body.classList.toggle('open');
  arrow.classList.toggle('open');
  
  if (body.classList.contains('open')) {
    btn.querySelector('span').textContent = 'Recolher';
  } else {
    btn.querySelector('span').textContent = 'Expandir';
  }
}

async function carregarEstados() {
  const select = document.getElementById('selectEstado');
  
  ESTADOS.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(est => {
    const opt = document.createElement('option');
    opt.value = est.sg;
    opt.textContent = `${est.sg} ‚Äî ${est.nome}`;
    opt.dataset.codigo = est.co;
    select.appendChild(opt);
  });
}

async function onEstadoChange() {
  const select = document.getElementById('selectEstado');
  const selectMun = document.getElementById('selectMunicipio');
  const uf = select.value;
  
  selectMun.innerHTML = '<option value="">Carregando munic√≠pios...</option>';
  selectMun.disabled = true;
  
  if (!uf) {
    selectMun.innerHTML = '<option value="">‚Äî Selecione o estado primeiro ‚Äî</option>';
    return;
  }
  
  try {
    const response = await fetchWithCORS(`${IBGE_API}/estados/${uf}/municipios`);
    const municipios = await response.json();
    
    estadosMunicipios[uf] = municipios;
    
    selectMun.innerHTML = '<option value="">‚Äî Selecione um munic√≠pio ‚Äî</option>';
    municipios.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(mun => {
      const opt = document.createElement('option');
      opt.value = mun.id;
      opt.textContent = mun.nome;
      opt.dataset.nome = mun.nome;
      selectMun.appendChild(opt);
    });
    
    selectMun.disabled = false;
  } catch (error) {
    console.error('Erro ao carregar munic√≠pios:', error);
    showNotification('Erro ao carregar munic√≠pios', 'error');
    selectMun.innerHTML = '<option value="">Erro ao carregar</option>';
  }
}

function onMunicipioChange() {
  // Opcional: pode adicionar l√≥gica aqui se necess√°rio
}

function limparFiltros() {
  document.getElementById('selectEstado').value = '';
  document.getElementById('selectMunicipio').value = '';
  document.getElementById('selectMunicipio').disabled = true;
  document.getElementById('selectMunicipio').innerHTML = '<option value="">‚Äî Selecione o estado primeiro ‚Äî</option>';
  document.getElementById('inputBairro').value = '';
  document.getElementById('selectNivel').value = '';
  document.getElementById('selectAcolhimento').value = '';
  document.getElementById('selectGestao').value = '';
  
  allUnits = [];
  filteredUnits = [];
  renderResults();
  showNotification('Filtros limpos', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUSCA DE UNIDADES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buscarUnidades() {
  const selectEstado = document.getElementById('selectEstado');
  const selectMunicipio = document.getElementById('selectMunicipio');
  
  const uf = selectEstado.value;
  const codigoIBGE = selectMunicipio.value;
  
  if (!uf || !codigoIBGE) {
    showNotification('Selecione estado e munic√≠pio', 'error');
    return;
  }
  
  const nomeMunicipio = selectMunicipio.options[selectMunicipio.selectedIndex].dataset.nome;
  
  showSearchProgress(true);
  updateSearchProgress(10, 'Conectando √† API CNES...', `Buscando em ${nomeMunicipio}/${uf}`);
  
  try {
    // Buscar todas as unidades do munic√≠pio
    const units = await fetchAllUnitsFromMunicipio(codigoIBGE, uf);
    
    updateSearchProgress(90, 'Processando dados...', `${units.length} unidades encontradas`);
    
    // Enriquecer dados
    await enrichUnitsData(units);
    
    allUnits = units;
    applyLocalFilters();
    
    updateSearchProgress(100, 'Conclu√≠do!', `${units.length} unidades carregadas`);
    
    setTimeout(() => {
      showSearchProgress(false);
      showNotification(`${units.length} unidades encontradas em ${nomeMunicipio}`, 'success');
    }, 800);
    
  } catch (error) {
    console.error('Erro na busca:', error);
    showSearchProgress(false);
    showNotification('Erro ao buscar unidades: ' + error.message, 'error');
  }
}

async function fetchAllUnitsFromMunicipio(codigoIBGE, uf) {
  const url = `${CNES_BASE}/estabelecimentos?municipio=${codigoIBGE}&limit=1000`;
  
  try {
    const response = await fetchWithCORS(url);
    const data = await response.json();
    
    if (!data || !Array.isArray(data)) {
      throw new Error('Resposta inv√°lida da API');
    }
    
    return data.map(u => processUnitData(u, uf));
  } catch (error) {
    console.error('Erro ao buscar do CNES:', error);
    throw error;
  }
}

function processUnitData(rawUnit, uf) {
  const unit = {
    cnes: rawUnit.codigo_cnes || rawUnit.codCNES || rawUnit.CO_CNES || '',
    nome: rawUnit.nome_fantasia || rawUnit.NO_FANTASIA || rawUnit.nome || '',
    razaoSocial: rawUnit.nome_empresarial || rawUnit.NO_RAZAO_SOCIAL || '',
    endereco: montarEndereco(rawUnit),
    bairro: rawUnit.bairro || rawUnit.NO_BAIRRO || '',
    municipio: rawUnit.municipio || rawUnit.NO_MUNICIPIO || '',
    uf: uf,
    cep: rawUnit.cep || rawUnit.CO_CEP || '',
    telefone: rawUnit.telefone || rawUnit.NU_TELEFONE || '',
    email: rawUnit.email || '',
    latitude: parseFloat(rawUnit.latitude || rawUnit.NU_LATITUDE || 0),
    longitude: parseFloat(rawUnit.longitude || rawUnit.NU_LONGITUDE || 0),
    tipoUnidade: rawUnit.tipo_unidade || rawUnit.TP_UNIDADE || '',
    gestao: rawUnit.esfera_administrativa || rawUnit.TP_GESTAO || '',
    natureza: rawUnit.natureza_organizacao || '',
    vinculoSUS: rawUnit.vinculo_sus || rawUnit.ST_VINCUL_SUS || '',
    // Classifica√ß√µes
    nivel: '',
    acolhimentos: [],
    // Dados enriquecidos
    distancia: null,
    enderecoCompleto: '',
    telefoneFormatado: ''
  };
  
  // Classificar n√≠vel e acolhimentos
  classificarUnidade(unit, rawUnit);
  
  return unit;
}

function montarEndereco(rawUnit) {
  const logradouro = rawUnit.logradouro || rawUnit.NO_LOGRADOURO || '';
  const numero = rawUnit.numero || rawUnit.NU_ENDERECO || '';
  const complemento = rawUnit.complemento || rawUnit.NO_COMPLEMENTO || '';
  
  let end = logradouro;
  if (numero) end += `, ${numero}`;
  if (complemento) end += ` - ${complemento}`;
  
  return end;
}

function classificarUnidade(unit, rawData) {
  // Classifica√ß√£o de n√≠vel baseada no tipo de unidade
  const tipo = (rawData.tipo_unidade || rawData.TP_UNIDADE || '').toUpperCase();
  const nome = (unit.nome || '').toUpperCase();
  
  // Aten√ß√£o Prim√°ria
  if (
    tipo.includes('POSTO') || tipo.includes('BASICA') || tipo.includes('ESF') ||
    tipo.includes('CAPS') || tipo.includes('NASF') ||
    nome.includes('UBS') || nome.includes('POSTO') || nome.includes('ESF') ||
    nome.includes('ESTRATEGIA') || nome.includes('FAMILIA')
  ) {
    unit.nivel = 'primaria';
  }
  // Aten√ß√£o Terci√°ria (Hospitais)
  else if (
    tipo.includes('HOSPITAL') || tipo.includes('HOSP') ||
    nome.includes('HOSPITAL') || nome.includes('HOSP')
  ) {
    unit.nivel = 'terciaria';
  }
  // Aten√ß√£o Secund√°ria
  else if (
    tipo.includes('POLICLINICA') || tipo.includes('AMBULATORIO') ||
    tipo.includes('ESPECIALIZADO') || tipo.includes('UPA') ||
    nome.includes('POLICLINICA') || nome.includes('AMBULATORIO')
  ) {
    unit.nivel = 'secundaria';
  }
  else {
    unit.nivel = 'secundaria'; // Default
  }
  
  // Formas de acolhimento
  unit.acolhimentos = [];
  
  // Ambulatorial (maioria das unidades)
  if (tipo.includes('AMBULATORIO') || unit.nivel === 'primaria' || unit.nivel === 'secundaria') {
    unit.acolhimentos.push('ambulatorial');
  }
  
  // Urg√™ncia/Emerg√™ncia - APENAS para unidades terci√°rias ou UPA
  if (
    unit.nivel === 'terciaria' ||
    tipo.includes('UPA') || tipo.includes('URGENCIA') || tipo.includes('EMERGENCIA') ||
    tipo.includes('PRONTO SOCORRO') || tipo.includes('SAMU') ||
    nome.includes('UPA') || nome.includes('URGENCIA') || nome.includes('EMERGENCIA') ||
    nome.includes('PRONTO SOCORRO')
  ) {
    unit.acolhimentos.push('urgencia');
  }
  
  // Maternidade
  if (
    tipo.includes('MATERNIDADE') || tipo.includes('PARTO') ||
    nome.includes('MATERNIDADE') || nome.includes('PARTO')
  ) {
    unit.acolhimentos.push('maternidade');
  }
  
  // Traumatologia
  if (
    tipo.includes('TRAUMATOLOGIA') || tipo.includes('ORTOPEDIA') ||
    nome.includes('TRAUMA') || nome.includes('ORTOP')
  ) {
    unit.acolhimentos.push('traumatologia');
  }
  
  // Se n√£o tem nenhum, pelo menos ambulatorial
  if (unit.acolhimentos.length === 0) {
    unit.acolhimentos.push('ambulatorial');
  }
}

async function enrichUnitsData(units) {
  // Enriquecer dados b√°sicos
  for (const unit of units) {
    // Endere√ßo completo
    unit.enderecoCompleto = `${unit.endereco}, ${unit.bairro}, ${unit.municipio}/${unit.uf}`;
    if (unit.cep) unit.enderecoCompleto += ` - CEP: ${unit.cep}`;
    
    // Telefone formatado
    if (unit.telefone) {
      const tel = unit.telefone.replace(/\D/g, '');
      if (tel.length >= 10) {
        const ddd = tel.substring(0, 2);
        const parte1 = tel.substring(2, tel.length - 4);
        const parte2 = tel.substring(tel.length - 4);
        unit.telefoneFormatado = `(${ddd}) ${parte1}-${parte2}`;
      } else {
        unit.telefoneFormatado = unit.telefone;
      }
    }
    
    // Geocoding para unidades sem coordenadas
    if (!unit.latitude || !unit.longitude || unit.latitude === 0) {
      try {
        const coords = await geocodeAddress(unit.enderecoCompleto);
        if (coords) {
          unit.latitude = coords.lat;
          unit.longitude = coords.lon;
        }
      } catch (e) {
        console.warn(`Geocoding falhou para ${unit.nome}`);
      }
    }
  }
}

async function geocodeAddress(address) {
  try {
    const url = `${NOMINATIM_API}/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'SaudeBR-Localizador/2.0'
      }
    });
    const data = await response.json();
    
    if (data && data.length > 0) {
      return {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon)
      };
    }
  } catch (error) {
    console.warn('Erro no geocoding:', error);
  }
  
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GEOLOCALIZA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function usarGeolocalizacao() {
  if (!navigator.geolocation) {
    showNotification('Geolocaliza√ß√£o n√£o suportada pelo navegador', 'error');
    return;
  }
  
  showSearchProgress(true);
  updateSearchProgress(10, 'Obtendo sua localiza√ß√£o...', 'Aguarde autoriza√ß√£o GPS');
  
  navigator.geolocation.getCurrentPosition(
    async (position) => {
      currentGeoPosition = {
        lat: position.coords.latitude,
        lon: position.coords.longitude
      };
      
      updateSearchProgress(30, 'Localiza√ß√£o obtida!', `Lat: ${currentGeoPosition.lat.toFixed(4)}, Lon: ${currentGeoPosition.lon.toFixed(4)}`);
      
      try {
        // Reverse geocoding para descobrir munic√≠pio
        const location = await reverseGeocode(currentGeoPosition.lat, currentGeoPosition.lon);
        
        if (!location || !location.municipio) {
          throw new Error('N√£o foi poss√≠vel determinar o munic√≠pio');
        }
        
        updateSearchProgress(50, 'Munic√≠pio detectado', location.municipio);
        
        // Buscar unidades pr√≥ximas
        const raio = parseFloat(document.getElementById('geoRaio').value) || 6;
        const units = await fetchUnitsNearLocation(currentGeoPosition, raio, location);
        
        updateSearchProgress(90, 'Calculando dist√¢ncias...', `${units.length} unidades encontradas`);
        
        // Calcular dist√¢ncias
        units.forEach(u => {
          if (u.latitude && u.longitude) {
            u.distancia = calculateDistance(
              currentGeoPosition.lat,
              currentGeoPosition.lon,
              u.latitude,
              u.longitude
            );
          }
        });
        
        // Ordenar por dist√¢ncia
        units.sort((a, b) => (a.distancia || 999) - (b.distancia || 999));
        
        allUnits = units;
        applyLocalFilters();
        
        updateSearchProgress(100, 'Conclu√≠do!', `${units.length} unidades no raio de ${raio}km`);
        
        setTimeout(() => {
          showSearchProgress(false);
          showNotification(`${units.length} unidades encontradas pr√≥ximas a voc√™`, 'success');
          document.getElementById('geoStatus').textContent = 
            `üìç Sua localiza√ß√£o: ${location.municipio}/${location.uf} ‚Ä¢ ${units.length} unidades no raio de ${raio}km`;
        }, 800);
        
      } catch (error) {
        console.error('Erro na busca por proximidade:', error);
        showSearchProgress(false);
        showNotification('Erro: ' + error.message, 'error');
      }
    },
    (error) => {
      showSearchProgress(false);
      let msg = 'Erro ao obter localiza√ß√£o';
      
      if (error.code === error.PERMISSION_DENIED) {
        msg = 'Permiss√£o de localiza√ß√£o negada';
      } else if (error.code === error.POSITION_UNAVAILABLE) {
        msg = 'Localiza√ß√£o indispon√≠vel';
      } else if (error.code === error.TIMEOUT) {
        msg = 'Tempo esgotado ao obter localiza√ß√£o';
      }
      
      showNotification(msg, 'error');
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

async function reverseGeocode(lat, lon) {
  try {
    const url = `${NOMINATIM_API}/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`;
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'SaudeBR-Localizador/2.0'
      }
    });
    const data = await response.json();
    
    if (data && data.address) {
      const municipio = data.address.city || data.address.town || data.address.municipality || data.address.county;
      const uf = data.address.state;
      const estado = ESTADOS.find(e => e.nome === uf);
      
      return {
        municipio: municipio,
        uf: estado ? estado.sg : uf,
        estado: estado
      };
    }
  } catch (error) {
    console.error('Erro no reverse geocoding:', error);
  }
  
  return null;
}

async function fetchUnitsNearLocation(position, raioKm, location) {
  // Primeiro, buscar todas as unidades do munic√≠pio detectado
  let units = [];
  
  if (location && location.estado) {
    try {
      // Buscar c√≥digo IBGE do munic√≠pio
      const response = await fetchWithCORS(`${IBGE_API}/estados/${location.estado.sg}/municipios`);
      const municipios = await response.json();
      const munData = municipios.find(m => m.nome.toUpperCase() === location.municipio.toUpperCase());
      
      if (munData) {
        units = await fetchAllUnitsFromMunicipio(munData.id, location.estado.sg);
        await enrichUnitsData(units);
      }
    } catch (error) {
      console.error('Erro ao buscar unidades do munic√≠pio:', error);
    }
  }
  
  // Filtrar apenas as que est√£o dentro do raio
  const filtered = units.filter(u => {
    if (!u.latitude || !u.longitude || u.latitude === 0) return false;
    
    const dist = calculateDistance(position.lat, position.lon, u.latitude, u.longitude);
    return dist <= raioKm;
  });
  
  return filtered;
}

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Raio da Terra em km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const dist = R * c;
  
  return dist;
}

function toRad(deg) {
  return deg * (Math.PI / 180);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTROS LOCAIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyLocalFilters() {
  const bairro = document.getElementById('inputBairro').value.toLowerCase().trim();
  const nivel = document.getElementById('selectNivel').value;
  const acolhimento = document.getElementById('selectAcolhimento').value;
  const gestao = document.getElementById('selectGestao').value;
  
  filteredUnits = allUnits.filter(u => {
    // Filtro de bairro
    if (bairro && !u.bairro.toLowerCase().includes(bairro)) {
      return false;
    }
    
    // Filtro de n√≠vel
    if (nivel && u.nivel !== nivel) {
      return false;
    }
    
    // Filtro de acolhimento
    if (acolhimento && !u.acolhimentos.includes(acolhimento)) {
      return false;
    }
    
    // Filtro de gest√£o
    if (gestao && u.gestao !== gestao) {
      return false;
    }
    
    return true;
  });
  
  renderResults();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERIZA√á√ÉO DE RESULTADOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderResults() {
  updateDashboard();
  
  const container = document.getElementById('resultsSection');
  
  if (filteredUnits.length === 0) {
    container.innerHTML = `
      <div class="status-box">
        <span class="status-icon">üîç</span>
        <h3>Nenhuma unidade encontrada</h3>
        <p>Tente ajustar os filtros ou realizar uma nova busca.</p>
      </div>
    `;
    return;
  }
  
  // Agrupar por n√≠vel
  const groups = {
    primaria: filteredUnits.filter(u => u.nivel === 'primaria'),
    secundaria: filteredUnits.filter(u => u.nivel === 'secundaria'),
    terciaria: filteredUnits.filter(u => u.nivel === 'terciaria')
  };
  
  let html = `
    <div class="results-header">
      <div>
        <h2 class="results-title">
          Resultados
          <span class="results-count">${filteredUnits.length}</span>
        </h2>
      </div>
      <div class="export-row">
        <button class="btn btn-amber btn-sm" onclick="exportToExcel()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
          </svg>
          Exportar Excel
        </button>
        <button class="btn btn-navy btn-sm" onclick="exportToPDF()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
          </svg>
          Exportar PDF
        </button>
      </div>
    </div>
  `;
  
  // Renderizar grupos
  const groupConfigs = [
    { key: 'primaria', label: 'Aten√ß√£o Prim√°ria', color: '#00A878', icon: 'üè†' },
    { key: 'secundaria', label: 'Aten√ß√£o Secund√°ria', color: '#1565C0', icon: 'üî¨' },
    { key: 'terciaria', label: 'Aten√ß√£o Terci√°ria', color: '#E53935', icon: 'üè®' }
  ];
  
  groupConfigs.forEach(cfg => {
    if (groups[cfg.key].length > 0) {
      html += renderGroup(cfg, groups[cfg.key]);
    }
  });
  
  container.innerHTML = html;
}

function renderGroup(config, units) {
  const groupId = `group-${config.key}`;
  
  let html = `
    <div class="group-section">
      <div class="group-header" onclick="toggleGroup('${groupId}')">
        <div class="group-header-left">
          <span class="group-pill" style="background: ${config.color}22; color: ${config.color};">
            ${config.icon}
          </span>
          <div>
            <div class="group-name">${config.label}</div>
            <div class="group-meta">${units.length} unidade${units.length !== 1 ? 's' : ''} encontrada${units.length !== 1 ? 's' : ''}</div>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <div class="group-count">${units.length}</div>
          <span class="group-arrow" id="${groupId}-arrow">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </span>
        </div>
      </div>
      <div class="group-body" id="${groupId}">
        <div class="cards-grid">
          ${units.map(u => renderUnitCard(u, config.color)).join('')}
        </div>
      </div>
    </div>
  `;
  
  return html;
}

function renderUnitCard(unit, accentColor) {
  const nome = unit.nome || unit.razaoSocial || 'Sem nome';
  const gestaoLabel = {'M': 'Municipal', 'E': 'Estadual', 'F': 'Federal', 'D': 'Dupla'}[unit.gestao] || '';
  const gestaoClass = {'M': 'municipal', 'E': 'estadual', 'F': 'federal', 'D': 'federal'}[unit.gestao] || 'municipal';
  
  let tagsHTML = '';
  
  // Tag de gest√£o
  if (gestaoLabel) {
    tagsHTML += `<span class="unit-tag unit-tag-${gestaoClass}">${gestaoLabel}</span>`;
  }
  
  // Tags de acolhimento
  unit.acolhimentos.forEach(a => {
    const labels = {
      'ambulatorial': 'Ambulatorial',
      'urgencia': 'Urg√™ncia/Emerg√™ncia',
      'maternidade': 'Maternidade',
      'traumatologia': 'Traumatologia'
    };
    tagsHTML += `<span class="unit-tag unit-tag-${a}">${labels[a] || a}</span>`;
  });
  
  // Tag de dist√¢ncia
  if (unit.distancia !== null && unit.distancia !== undefined) {
    tagsHTML += `<span class="unit-tag unit-distance">${unit.distancia.toFixed(1)} km</span>`;
  }
  
  // Bot√µes de a√ß√£o
  let actionsHTML = '';
  
  // Link CNES
  if (unit.cnes) {
    const cnesLink = `http://cnes.datasus.gov.br/pages/estabelecimentos/exibir.jsp?codCNES=${unit.cnes}`;
    actionsHTML += `
      <button class="btn-icon search" onclick="window.open('${cnesLink}', '_blank')" title="Ver no CNES">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
        </svg>
      </button>
    `;
  }
  
  // Google Maps
  if (unit.latitude && unit.longitude && unit.latitude !== 0) {
    const mapsLink = `https://www.google.com/maps/search/?api=1&query=${unit.latitude},${unit.longitude}`;
    actionsHTML += `
      <button class="btn-icon maps" onclick="window.open('${mapsLink}', '_blank')" title="Ver no Google Maps">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
        </svg>
      </button>
    `;
  }
  
  // WhatsApp
  if (unit.telefoneFormatado) {
    const telClean = unit.telefone.replace(/\D/g, '');
    const whatsappLink = `https://wa.me/55${telClean}`;
    actionsHTML += `
      <button class="btn-icon whatsapp" onclick="window.open('${whatsappLink}', '_blank')" title="Contato WhatsApp">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
      </button>
    `;
  }
  
  return `
    <div class="unit-card">
      <div class="unit-card-accent" style="background: ${accentColor};"></div>
      <div class="unit-card-inner">
        <div class="unit-card-header">
          <h3 class="unit-name">${nome}</h3>
        </div>
        
        ${unit.enderecoCompleto ? `
          <div class="unit-info-row">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
            </svg>
            <span>${unit.enderecoCompleto}</span>
          </div>
        ` : ''}
        
        ${unit.telefoneFormatado ? `
          <div class="unit-info-row">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
            <span>${unit.telefoneFormatado}</span>
          </div>
        ` : ''}
        
        ${unit.email ? `
          <div class="unit-info-row">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
            </svg>
            <span>${unit.email}</span>
          </div>
        ` : ''}
        
        ${unit.cnes ? `<div class="unit-cnes">CNES: ${unit.cnes}</div>` : ''}
        
        <div class="unit-tags">
          ${tagsHTML}
        </div>
        
        ${actionsHTML ? `
          <div class="unit-actions">
            ${actionsHTML}
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function toggleGroup(groupId) {
  const body = document.getElementById(groupId);
  const arrow = document.getElementById(`${groupId}-arrow`);
  
  body.classList.toggle('open');
  arrow.classList.toggle('open');
}

function updateDashboard() {
  document.getElementById('statTotal').textContent = filteredUnits.length;
  
  const primaria = filteredUnits.filter(u => u.nivel === 'primaria').length;
  const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria').length;
  const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria').length;
  
  const urgencia = filteredUnits.filter(u => u.acolhimentos.includes('urgencia')).length;
  const maternidade = filteredUnits.filter(u => u.acolhimentos.includes('maternidade')).length;
  const traumatologia = filteredUnits.filter(u => u.acolhimentos.includes('traumatologia')).length;
  const ambulatorial = filteredUnits.filter(u => u.acolhimentos.includes('ambulatorial')).length;
  
  document.getElementById('statPrimaria').textContent = primaria;
  document.getElementById('statSecundaria').textContent = secundaria;
  document.getElementById('statTerciaria').textContent = terciaria;
  document.getElementById('statUrgencia').textContent = urgencia;
  document.getElementById('statMaternidade').textContent = maternidade;
  document.getElementById('statTraumatologia').textContent = traumatologia;
  document.getElementById('statAmbulatorial').textContent = ambulatorial;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORTA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportToExcel() {
  if (filteredUnits.length === 0) {
    showNotification('Nenhuma unidade para exportar', 'error');
    return;
  }
  
  const data = filteredUnits.map(u => ({
    'CNES': u.cnes,
    'Nome da Unidade': u.nome || u.razaoSocial,
    'N√≠vel de Aten√ß√£o': {'primaria': 'Prim√°ria', 'secundaria': 'Secund√°ria', 'terciaria': 'Terci√°ria'}[u.nivel] || '',
    'Formas de Acolhimento': u.acolhimentos.join(', '),
    'Endere√ßo': unit.enderecoCompleto,
    'Bairro': u.bairro,
    'Munic√≠pio': u.municipio,
    'UF': u.uf,
    'CEP': u.cep,
    'Telefone': u.telefoneFormatado || u.telefone,
    'Email': u.email,
    'Esfera de Gest√£o': {'M': 'Municipal', 'E': 'Estadual', 'F': 'Federal', 'D': 'Dupla'}[u.gestao] || '',
    'Latitude': u.latitude || '',
    'Longitude': u.longitude || '',
    'Dist√¢ncia (km)': u.distancia ? u.distancia.toFixed(2) : '',
    'Link CNES': u.cnes ? `http://cnes.datasus.gov.br/pages/estabelecimentos/exibir.jsp?codCNES=${u.cnes}` : ''
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Unidades de Sa√∫de');
  
  const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb, fileName);
  
  showNotification(`Arquivo Excel exportado: ${fileName}`, 'success');
}

function exportToPDF() {
  if (filteredUnits.length === 0) {
    showNotification('Nenhuma unidade para exportar', 'error');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  
  // T√≠tulo
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text('Sa√∫deBR - Unidades de Sa√∫de', 105, 15, { align: 'center' });
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text(`Relat√≥rio gerado em ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
  doc.text(`Total de unidades: ${filteredUnits.length}`, 105, 28, { align: 'center' });
  
  // Tabela
  const tableData = filteredUnits.map(u => [
    u.cnes || '',
    u.nome || u.razaoSocial || '',
    {'primaria': 'Prim√°ria', 'secundaria': 'Secund√°ria', 'terciaria': 'Terci√°ria'}[u.nivel] || '',
    u.acolhimentos.join(', '),
    u.enderecoCompleto || '',
    u.telefoneFormatado || u.telefone || '',
    u.cnes ? `http://cnes.datasus.gov.br/pages/estabelecimentos/exibir.jsp?codCNES=${u.cnes}` : ''
  ]);
  
  doc.autoTable({
    startY: 35,
    head: [['CNES', 'Nome', 'N√≠vel', 'Acolhimento', 'Endere√ßo', 'Telefone', 'Link CNES']],
    body: tableData,
    styles: {
      fontSize: 8,
      cellPadding: 2
    },
    headStyles: {
      fillColor: [11, 31, 58],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    columnStyles: {
      0: { cellWidth: 20 },
      1: { cellWidth: 35 },
      2: { cellWidth: 20 },
      3: { cellWidth: 25 },
      4: { cellWidth: 40 },
      5: { cellWidth: 25 },
      6: { cellWidth: 25 }
    }
  });
  
  // Gerar blob e mostrar preview
  currentPDFBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(currentPDFBlob);
  
  document.getElementById('pdfPreviewFrame').src = blobUrl;
  document.getElementById('pdfModal').classList.add('visible');
}

function closePDFModal() {
  document.getElementById('pdfModal').classList.remove('visible');
  document.getElementById('pdfPreviewFrame').src = '';
}

function downloadPDFFromModal() {
  if (!currentPDFBlob) return;
  
  const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.pdf`;
  const link = document.createElement('a');
  link.href = URL.createObjectURL(currentPDFBlob);
  link.download = fileName;
  link.click();
  
  showNotification(`PDF baixado: ${fileName}`, 'success');
  closePDFModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchWithCORS(url) {
  for (const proxy of CORS_PROXIES) {
    try {
      const proxyUrl = proxy(url);
      const response = await fetch(proxyUrl, {
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (response.ok) {
        return response;
      }
    } catch (error) {
      console.warn(`Falha com proxy, tentando pr√≥ximo...`, error);
    }
  }
  
  throw new Error('N√£o foi poss√≠vel acessar a API ap√≥s todas as tentativas');
}

function showSearchProgress(visible) {
  const card = document.getElementById('searchProgressCard');
  if (visible) {
    card.classList.add('visible');
  } else {
    card.classList.remove('visible');
  }
}

function updateSearchProgress(percent, title, hint) {
  document.getElementById('spBar').style.width = `${percent}%`;
  document.getElementById('spTitle').textContent = title;
  document.getElementById('spHint').textContent = hint;
  document.getElementById('spCount').textContent = filteredUnits.length;
}

function showNotification(message, type = 'info') {
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  
  const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
  notif.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
  
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.remove();
  }, 5000);
}
</script>

</body>
</html>

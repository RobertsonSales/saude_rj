<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sa√∫deBR ‚Äî Localizador CNES de Unidades de Sa√∫de P√∫blica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* ‚îÄ‚îÄ‚îÄ FILTER PANEL ‚îÄ‚îÄ‚îÄ */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,168,120,0.1);
    }
    select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6E85' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--radius-sm);
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,168,120,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,168,120,0.4);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover { background: #fff; border-color: var(--teal); color: var(--teal); }
    .btn-navy {
      background: var(--navy);
      color: #fff;
      box-shadow: 0 4px 12px rgba(11,31,58,0.25);
    }
    .btn-navy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(11,31,58,0.35); }
    .btn-amber {
      background: linear-gradient(135deg, var(--amber) 0%, #F7BE50 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(245,166,35,0.35);
    }
    .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(245,166,35,0.45); }
    .btn-geo {
      background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21,101,192,0.3);
    }
    .btn-geo:hover { transform: translateY(-1px); }
    .btn-sm { padding: 7px 14px; font-size: 0.78rem; }
    .btn-icon { width: 34px; height: 34px; padding: 0; justify-content: center; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* ‚îÄ‚îÄ‚îÄ GEO SECTION ‚îÄ‚îÄ‚îÄ */
    .geo-section {
      background: linear-gradient(135deg, var(--blue-pale), #d8e8ff);
      border: 1px solid rgba(21,101,192,0.2);
      border-radius: var(--radius);
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .geo-info { flex: 1; }
    .geo-info h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--blue);
    }
    .geo-info p { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .geo-radius-row { display: flex; align-items: center; gap: 10px; }
    .geo-radius-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .geo-radius-input {
      width: 80px;
      background: #fff;
      border: 1.5px solid rgba(21,101,192,0.3);
      border-radius: 8px;
      padding: 7px 10px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      text-align: center;
    }

    /* ‚îÄ‚îÄ‚îÄ DASHBOARD CARDS ‚îÄ‚îÄ‚îÄ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--teal));
    }
    .stat-card-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    .stat-card-value {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      line-height: 1;
      color: var(--navy);
      transition: all 0.5s;
    }
    .stat-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .stat-card-sublabel { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }

    /* ‚îÄ‚îÄ‚îÄ RESULTS SECTION ‚îÄ‚îÄ‚îÄ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .results-count {
      background: var(--teal-pale);
      color: var(--teal);
      font-size: 0.78rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 8px;
    }
    .export-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ‚îÄ‚îÄ‚îÄ GROUP SECTIONS ‚îÄ‚îÄ‚îÄ */
    .group-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .group-header {
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .group-header:hover { background: var(--bg); }
    .group-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .group-pill {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.78rem;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .group-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .group-meta { font-size: 0.78rem; color: var(--text-muted); }
    .group-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--navy);
      min-width: 60px;
      text-align: right;
    }
    .group-arrow { color: var(--text-muted); transition: transform 0.3s; }
    .group-arrow.open { transform: rotate(90deg); }

    .group-body {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: none;
    }
    .group-body.open { display: block; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    /* ‚îÄ‚îÄ‚îÄ UNIT CARDS ‚îÄ‚îÄ‚îÄ */
    .unit-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-card-accent {
      position: absolute;
      top: 0; left: 0;
      width: 4px;
      height: 100%;
    }
    .unit-card-inner { padding-left: 8px; }
    .unit-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--navy);
      line-height: 1.3;
    }
    .unit-type-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .unit-info-row svg { flex-shrink: 0; margin-top: 1px; color: var(--text-light); }
    .unit-cnes {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 10px;
      font-family: 'Outfit', sans-serif;
    }
    .unit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }
    .unit-tag {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-tag-urgencia { background: var(--red-pale); color: var(--red); }
    .unit-tag-ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .unit-tag-maternidade { background: var(--purple-pale); color: var(--purple); }
    .unit-tag-especializado { background: var(--amber-pale); color: #C07A00; }
    .unit-tag-federal { background: #E8F0FE; color: var(--blue); }
    .unit-tag-estadual { background: #FFF8EC; color: #9C6E00; }
    .unit-tag-municipal { background: var(--teal-pale); color: #006B4F; }
    .unit-tag-privado { background: var(--gray-200); color: var(--gray-700); }
    .unit-distance { background: var(--blue-pale); color: var(--blue); }
    .unit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 4px;
    }
    .unit-actions .btn-icon {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      transition: all 0.2s;
    }
    .unit-actions .btn-icon:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-pale); }
    .unit-actions .btn-icon.whatsapp:hover { border-color: #25D366; color: #25D366; background: #E8FBF0; }
    .unit-actions .btn-icon.maps:hover { border-color: #EA4335; color: #EA4335; background: #FDECEA; }
    .unit-actions .btn-icon.search:hover { border-color: #4285F4; color: #4285F4; background: #E8F0FE; }

    /* ‚îÄ‚îÄ‚îÄ LOADING / EMPTY / ERROR ‚îÄ‚îÄ‚îÄ */
    .status-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 60px 40px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .status-box .status-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }
    .status-box h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .status-box p { font-size: 0.88rem; color: var(--text-muted); max-width: 400px; margin: 0 auto; }

    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--teal-pale);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-wrap {
      max-width: 360px;
      margin: 16px auto 0;
      background: var(--border);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    /* ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD ‚îÄ‚îÄ‚îÄ */
    .search-progress-card {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
      border-radius: var(--radius);
      padding: 20px 28px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 20px;
      border: 1px solid rgba(0,168,120,0.25);
      box-shadow: var(--shadow-md);
      animation: slideDown 0.3s ease;
    }
    .search-progress-card.visible { display: flex; }
    .search-progress-spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(0,200,150,0.25);
      border-top-color: var(--teal-light);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    .search-progress-info { flex: 1; min-width: 0; }
    .search-progress-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.92rem;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-progress-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      min-height: 16px;
    }
    .search-progress-bar-wrap {
      flex: 1;
      max-width: 260px;
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .search-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .search-progress-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--teal-light);
      min-width: 48px;
      text-align: right;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ PDF PREVIEW MODAL ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(11,31,58,0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.visible { display: flex; }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 1400px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover { background: var(--red-pale); color: var(--red); }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
      background: var(--bg);
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* ‚îÄ‚îÄ‚îÄ PDF PREVIEW STYLES - TOTALMENTE INDEPENDENTES ‚îÄ‚îÄ‚îÄ */
    .pdf-container {
      font-family: 'Outfit', 'Fira Sans', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .pdf-header {
      background: linear-gradient(135deg, var(--navy), var(--navy-mid));
      color: white;
      padding: 30px;
      position: relative;
      overflow: hidden;
    }

    .pdf-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 300px;
      height: 300px;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
    }

    .pdf-header-content {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pdf-header-title h1 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .pdf-header-title h1 span {
      color: var(--teal-light);
    }

    .pdf-header-title p {
      opacity: 0.8;
      font-size: 0.9rem;
    }

    .pdf-header-badge {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
      padding: 12px 20px;
      border-radius: 12px;
      text-align: right;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .pdf-header-badge .total {
      font-size: 2.2rem;
      font-weight: 800;
      line-height: 1;
      color: var(--teal-light);
    }

    .pdf-header-badge .label {
      font-size: 0.8rem;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .pdf-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      padding: 25px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .pdf-stat-item {
      background: white;
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid;
      transition: transform 0.2s;
    }

    .pdf-stat-item.primaria { border-color: var(--teal); }
    .pdf-stat-item.secundaria { border-color: var(--blue); }
    .pdf-stat-item.terciaria { border-color: var(--red); }
    .pdf-stat-item.urgencia { border-color: var(--amber); }

    .pdf-stat-icon {
      font-size: 1.8rem;
      margin-bottom: 10px;
    }

    .pdf-stat-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--navy);
      line-height: 1;
    }

    .pdf-stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    .pdf-acolhimento-section {
      padding: 25px;
      background: white;
    }

    .pdf-section-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pdf-section-title span {
      background: var(--teal-pale);
      color: var(--teal);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    .pdf-acolhimento-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 30px;
    }

    .pdf-acolhimento-card {
      background: linear-gradient(135deg, var(--bg), white);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pdf-acolhimento-icon {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      box-shadow: var(--shadow-sm);
    }

    .pdf-acolhimento-info h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 2px;
    }

    .pdf-acolhimento-info p {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--teal);
      line-height: 1;
    }

    .pdf-nivel-section {
      padding: 0 25px 25px;
      background: white;
    }

    .pdf-nivel-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      border-radius: 12px;
      color: white;
      margin-bottom: 20px;
    }

    .pdf-nivel-header.primaria { background: linear-gradient(135deg, var(--teal), #00c896); }
    .pdf-nivel-header.secundaria { background: linear-gradient(135deg, var(--blue), #2196f3); }
    .pdf-nivel-header.terciaria { background: linear-gradient(135deg, var(--red), #f44336); }

    .pdf-nivel-icon {
      font-size: 2rem;
    }

    .pdf-nivel-title {
      flex: 1;
    }

    .pdf-nivel-title h3 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .pdf-nivel-title p {
      opacity: 0.9;
      font-size: 0.8rem;
    }

    .pdf-nivel-count {
      font-size: 2rem;
      font-weight: 800;
    }

    .pdf-units-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .pdf-unit-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      transition: transform 0.2s;
    }

    .pdf-unit-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: white;
    }

    .pdf-unit-name {
      font-size: 1rem;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--border);
    }

    .pdf-unit-detail {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .pdf-unit-detail strong {
      color: var(--navy);
      font-weight: 600;
    }

    .pdf-unit-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 8px;
    }

    .pdf-unit-badge.urgente { background: var(--red-pale); color: var(--red); }
    .pdf-unit-badge.ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .pdf-unit-badge.maternidade { background: var(--purple-pale); color: var(--purple); }
    .pdf-unit-badge.especializado { background: var(--amber-pale); color: #C07A00; }

    .pdf-footer {
      background: var(--navy);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .pdf-footer-left {
      opacity: 0.7;
    }

    .pdf-footer-right {
      text-align: right;
    }

    /* ‚îÄ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ‚îÄ */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--navy);
      color: #fff;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 340px;
    }
    .notification.success { background: var(--teal); }
    .notification.error { background: var(--red); }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .footer a { color: var(--teal); text-decoration: none; }

    /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      .main-wrapper { padding: 16px 14px 40px; }
      .header-inner { padding: 14px 16px; }
      .header-titles h1 { font-size: 1.2rem; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: 1fr; }
      .geo-section { flex-direction: column; align-items: stretch; }
      .modal-content { max-height: 95vh; }
    }

    /* ‚îÄ‚îÄ‚îÄ NIVEL COLORS ‚îÄ‚îÄ‚îÄ */
    .nivel-primaria { --nivel-color: #00A878; }
    .nivel-secundaria { --nivel-color: #1565C0; }
    .nivel-terciaria { --nivel-color: #E53935; }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header>
  <div class="header-inner">
    <div class="logo-mark">
      <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 4v20M4 14h20" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
        <circle cx="14" cy="14" r="12" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
      </svg>
    </div>
    <div class="header-titles">
      <h1>Sa√∫de<span>BR</span> &mdash; Localizador CNES</h1>
      <p>Dados em tempo real via OpenStreetMap + Nominatim ‚Ä¢ Apenas unidades vinculadas ao SUS</p>
    </div>
    <span class="header-badge">üü¢ Online</span>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main-wrapper">

  <!-- ‚îÄ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ‚îÄ -->
  <div class="filter-section">
    <div class="filter-header" onclick="toggleFilter()">
      <div class="filter-header-left">
        <div class="filter-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </div>
        <div>
          <div class="filter-title">Filtros de Busca</div>
          <div class="filter-subtitle">Estado, munic√≠pio, perfil de aten√ß√£o e formas de acolhimento</div>
        </div>
      </div>
      <button class="filter-toggle-btn" id="filterToggleBtn">
        <span>Expandir</span>
        <span class="filter-toggle-arrow" id="filterArrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </button>
    </div>

    <div class="filter-body" id="filterBody">
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Estado (UF)</label>
          <select class="form-control" id="selectEstado" onchange="onEstadoChange()">
            <option value="">‚Äî Selecione ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Munic√≠pio</label>
          <select class="form-control" id="selectMunicipio" onchange="onMunicipioChange()" disabled>
            <option value="">‚Äî Selecione o estado primeiro ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" id="inputBairro" placeholder="Ex: Centro, Jardim..." oninput="applyLocalFilters()">
        </div>
        <div class="form-group">
          <label class="form-label">Perfil / N√≠vel de Aten√ß√£o</label>
          <select class="form-control" id="selectNivel" onchange="applyLocalFilters()">
            <option value="">Todos os N√≠veis</option>
            <option value="primaria">Aten√ß√£o Prim√°ria</option>
            <option value="secundaria">Aten√ß√£o Secund√°ria</option>
            <option value="terciaria">Aten√ß√£o Terci√°ria</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Forma de Acolhimento</label>
          <select class="form-control" id="selectAcolhimento" onchange="applyLocalFilters()">
            <option value="">Todas as Formas</option>
            <option value="ambulatorial">Atendimento Ambulatorial</option>
            <option value="urgencia">Urg√™ncia / Emerg√™ncia</option>
            <option value="maternidade">Maternidade</option>
            <option value="especializado">Atendimento Especializado</option>
            <option value="samu">SAMU</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Esfera de Gest√£o</label>
          <select class="form-control" id="selectGestao" onchange="applyLocalFilters()">
            <option value="">Todas</option>
            <option value="Municipal">Municipal</option>
            <option value="Estadual">Estadual</option>
            <option value="Federal">Federal</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="buscarPorMunicipio()" id="btnBuscarMunicipio">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          Buscar por Munic√≠pio
        </button>
        <button class="btn btn-secondary" onclick="limparFiltros()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.57"/></svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ GEOLOCALIZA√á√ÉO ‚îÄ‚îÄ‚îÄ -->
  <div class="geo-section">
    <div style="font-size: 1.8rem;">üìç</div>
    <div class="geo-info">
      <h3>Busca por Proximidade Geogr√°fica</h3>
      <p id="geoStatus">Detecta automaticamente sua localiza√ß√£o via GPS e busca unidades no raio configurado.</p>
    </div>
    <div class="geo-radius-row">
      <span class="geo-radius-label">Raio (km):</span>
      <input type="number" class="geo-radius-input form-control" id="geoRaio" value="6" min="0.5" max="50" step="0.5">
    </div>
    <button class="btn btn-geo" onclick="usarGeolocalizacao()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>
      Buscar Perto de Mim
    </button>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD ‚îÄ‚îÄ‚îÄ -->
  <div class="search-progress-card" id="searchProgressCard">
    <div class="search-progress-spinner"></div>
    <div class="search-progress-info">
      <div class="search-progress-title" id="spTitle">Consultando OpenStreetMap...</div>
      <div class="search-progress-hint" id="spHint">Iniciando conex√£o...</div>
    </div>
    <div class="search-progress-bar-wrap">
      <div class="search-progress-bar" id="spBar" style="width:5%"></div>
    </div>
    <div class="search-progress-count" id="spCount">0</div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ -->
  <div class="dashboard" id="dashboard">
    <div class="stat-card" style="--card-accent: var(--teal);">
      <div class="stat-card-icon" style="background: var(--teal-pale); color: var(--teal);">üè•</div>
      <div class="stat-card-value" id="statTotal">‚Äî</div>
      <div class="stat-card-label">Total de Unidades</div>
      <div class="stat-card-sublabel">encontradas</div>
    </div>
    <div class="stat-card" style="--card-accent: #00A878;">
      <div class="stat-card-icon" style="background: #E8F8F3; color: #00A878;">üè†</div>
      <div class="stat-card-value" id="statPrimaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Prim√°ria</div>
      <div class="stat-card-sublabel">UBS, Postos, ESF</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--blue);">
      <div class="stat-card-icon" style="background: var(--blue-pale); color: var(--blue);">üî¨</div>
      <div class="stat-card-value" id="statSecundaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Secund√°ria</div>
      <div class="stat-card-sublabel">Policl√≠nicas, UPA, CAPS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üè®</div>
      <div class="stat-card-value" id="statTerciaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Terci√°ria</div>
      <div class="stat-card-sublabel">Hospitais de refer√™ncia</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üö®</div>
      <div class="stat-card-value" id="statUrgencia">‚Äî</div>
      <div class="stat-card-label">Urg√™ncia/Emerg√™ncia</div>
      <div class="stat-card-sublabel">UPAs, PS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--purple);">
      <div class="stat-card-icon" style="background: var(--purple-pale); color: var(--purple);">ü§±</div>
      <div class="stat-card-value" id="statMaternidade">‚Äî</div>
      <div class="stat-card-label">Maternidades</div>
      <div class="stat-card-sublabel">Parto e neonatal</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--amber);">
      <div class="stat-card-icon" style="background: var(--amber-pale); color: var(--amber);">ü¶¥</div>
      <div class="stat-card-value" id="statEspecializado">‚Äî</div>
      <div class="stat-card-label">Especializado</div>
      <div class="stat-card-sublabel">Ortopedia, cardiologia</div>
    </div>
    <div class="stat-card" style="--card-accent: #9C27B0;">
      <div class="stat-card-icon" style="background: #F3E5F5; color: #9C27B0;">üèõÔ∏è</div>
      <div class="stat-card-value" id="statAmbulatorial">‚Äî</div>
      <div class="stat-card-label">Ambulatorial</div>
      <div class="stat-card-sublabel">Consultas/exames</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ RESULTADOS ‚îÄ‚îÄ‚îÄ -->
  <div id="resultsSection">
    <div class="status-box">
      <span class="status-icon">üîç</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione estado e munic√≠pio nos filtros e clique em <strong>Buscar por Munic√≠pio</strong>, ou use <strong>Buscar Perto de Mim</strong> para detec√ß√£o autom√°tica.</p>
    </div>
  </div>

</div><!-- /main-wrapper -->

<!-- ‚ïê‚ïê‚ïê PDF PREVIEW MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üìÑ Visualiza√ß√£o do Relat√≥rio PDF</h3>
      <button class="modal-close" onclick="closePDFModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" id="pdfModalBody">
      <!-- PDF content will be injected here -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePDFModal()">Fechar</button>
      <button class="btn btn-whatsapp" onclick="compartilharPDFWhatsApp()">
        <span>üì±</span>
        Compartilhar WhatsApp
      </button>
      <button class="btn btn-primary" onclick="downloadPDF()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Baixar PDF
      </button>
    </div>
  </div>
</div>

<footer class="footer">
  Dados obtidos via <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a> e <a href="https://nominatim.org" target="_blank">Nominatim</a> ‚Äî Fonte p√∫blica colaborativa &nbsp;|&nbsp; Sa√∫deBR Localizador v3.0
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURA√á√ÉO & CONSTANTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
    NOMINATIM: {
        ENDPOINT: 'https://nominatim.openstreetmap.org',
        EMAIL: 'contato@saudebr.gov.br' // Substitua por um email real
    },
    IBGE: 'https://servicodados.ibge.gov.br/api/v1/localidades',
    OVERPASS: 'https://overpass-api.de/api/interpreter'
};

// Tipos a excluir da busca
const EXCLUIR_TIPOS = 'pharmacy|dentist|doctors|optometrist|laboratory|' +
    'sample_collection|physiotherapist|psychotherapist|audiologist|' +
    'alternative|medical_imaging|blood_donation|veterinary';

// Palavras que indicam v√≠nculo com o SUS
const SUS_KEYWORDS = ['sus', 'p√∫blico', 'p√∫blica', 'municipal', 'estadual', 'federal', 
                      'ubs', 'posto de sa√∫de', 'unidade b√°sica', 'centro de sa√∫de',
                      'hospital municipal', 'hospital estadual', 'hospital federal',
                      'upa', 'policl√≠nica municipal', 'cms', 'caps', 'samu'];

// Palavras que indicam unidades privadas a serem exclu√≠das
const PRIVATE_KEYWORDS = ['particular', 'privado', 'privada', 'rede privada', 
                          'cl√≠nica particular', 'laborat√≥rio particular'];

// Estado da aplica√ß√£o
let allUnits = [];
let filteredUnits = [];
let currentGeoPosition = null;
let estados = [];
let municipiosPorEstado = {};
let buscaAtiva = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FUN√á√ïES AUXILIARES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function norm(str) {
    if (!str) return '';
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function deduplicar(unidades) {
    const unicos = new Map();
    unidades.forEach(u => {
        const chave = norm(u.nome) + u.lat.toFixed(4) + u.lon.toFixed(4);
        if (!unicos.has(chave)) unicos.set(chave, u);
    });
    return Array.from(unicos.values());
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function consultarOverpass(query) {
    const resp = await fetch(CONFIG.OVERPASS, {
        method: 'POST',
        body: query
    });
    if (!resp.ok) throw new Error('Overpass falhou');
    return await resp.json();
}

function showSearchProgress(visible) {
    const card = document.getElementById('searchProgressCard');
    if (visible) {
        card.classList.add('visible');
    } else {
        card.classList.remove('visible');
    }
}

function updateSearchProgress(percent, title, hint) {
    document.getElementById('spBar').style.width = `${percent}%`;
    document.getElementById('spTitle').textContent = title;
    document.getElementById('spHint').textContent = hint;
    document.getElementById('spCount').textContent = filteredUnits.length;
}

function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    
    const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
    notif.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
    
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.remove();
    }, 5000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLASSIFICA√á√ÉO CORRIGIDA DE UNIDADES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isVinculadoSUS(tags, nome) {
    const operador = norm(tags.operator || '');
    const descricao = norm(tags.description || '');
    const nomeNorm = norm(nome);
    const acesso = norm(tags.access || '');
    
    // Se explicitamente privado, excluir
    if (acesso === 'private') return false;
    
    // Verificar palavras que indicam v√≠nculo SUS
    for (const keyword of SUS_KEYWORDS) {
        if (operador.includes(keyword) || nomeNorm.includes(keyword) || descricao.includes(keyword)) {
            return true;
        }
    }
    
    // Verificar palavras que indicam privado (excluir)
    for (const keyword of PRIVATE_KEYWORDS) {
        if (operador.includes(keyword) || nomeNorm.includes(keyword)) {
            return false;
        }
    }
    
    // Se tem CNES, provavelmente √© SUS
    if (tags['ref:CNES'] || tags['ref:cnes']) return true;
    
    // Por padr√£o, incluir apenas se parecer p√∫blico
    const tiposPublicos = ['hospital', 'clinic', 'health_post', 'health_centre'];
    const amenity = tags.amenity || '';
    const healthcare = tags.healthcare || '';
    
    if (tiposPublicos.includes(amenity) || tiposPublicos.includes(healthcare)) {
        // Para estes tipos, incluir apenas se tiver ind√≠cio de p√∫blico
        return operador.includes('municipal') || operador.includes('estadual') || 
               operador.includes('federal') || nomeNorm.includes('ubs') || 
               nomeNorm.includes('upa') || nomeNorm.includes('caps') ||
               nomeNorm.includes('posto') || nomeNorm.includes('hospital');
    }
    
    return false;
}

function classificarNivel(tags, nome) {
    const healthcare = tags.healthcare || tags.amenity;
    const n = norm(nome + (tags.description || ''));
    
    // ATEN√á√ÉO PRIM√ÅRIA
    if (n.includes('ubs') || n.includes('posto de saude') || n.includes('unidade basica') ||
        n.includes('esf') || n.includes('saude da familia') || n.includes('psf') ||
        n.includes('centro de saude') || n.includes('cms') || healthcare === 'health_post' ||
        healthcare === 'health_centre' || n.includes('ambulatorio') ||
        (n.includes('posto') && !n.includes('policlinica'))) {
        return {
            nivel: 'primaria',
            perfil: n.includes('ubs') ? 'UBS' : 
                    n.includes('posto') ? 'Posto de Sa√∫de' :
                    n.includes('esf') ? 'ESF' :
                    n.includes('caps') ? 'CAPS' :
                    n.includes('ambulatorio') ? 'Ambulat√≥rio' : 'Centro de Sa√∫de'
        };
    }
    
    // ATEN√á√ÉO SECUND√ÅRIA
    if (n.includes('upa') || n.includes('policlinica') || n.includes('policl√≠nica') ||
        n.includes('pronto atendimento') || n.includes('pronto socorro') ||
        n.includes('caps') || n.includes('cri') || n.includes('centro de atencao') ||
        healthcare === 'clinic' || n.includes('clinica especializada') ||
        (n.includes('hospital') && !n.includes('referencia') && !n.includes('universitario'))) {
        return {
            nivel: 'secundaria',
            perfil: n.includes('upa') ? 'UPA' :
                    n.includes('policlinica') ? 'Policl√≠nica' :
                    n.includes('pronto') ? 'Pronto Atendimento' :
                    n.includes('caps') ? 'CAPS' : 'Cl√≠nica Especializada'
        };
    }
    
    // ATEN√á√ÉO TERCI√ÅRIA (Hospitais)
    if (healthcare === 'hospital' || n.includes('hospital') || n.includes('hosp')) {
        // Classificar por especialidade
        let perfil = 'Hospital Geral';
        
        if (n.includes('maternidade') || n.includes('matern')) {
            perfil = 'Hospital Maternidade';
        } else if (n.includes('infantil') || n.includes('crianca') || n.includes('pediatrico')) {
            perfil = 'Hospital Infantil';
        } else if (n.includes('oncologia') || n.includes('cancer') || n.includes('inca')) {
            perfil = 'Hospital Oncol√≥gico';
        } else if (n.includes('psiquiatria') || n.includes('mental')) {
            perfil = 'Hospital Psiqui√°trico';
        } else if (n.includes('ortopedia') || n.includes('trauma') || n.includes('cardiologia')) {
            perfil = 'Hospital Especializado';
        } else if (n.includes('universitario') || n.includes('referencia') || n.includes('federal')) {
            perfil = 'Hospital de Refer√™ncia';
        }
        
        return {
            nivel: 'terciaria',
            perfil
        };
    }
    
    // Default
    return {
        nivel: 'primaria',
        perfil: 'Unidade de Sa√∫de'
    };
}

function determinarAcolhimento(u) {
    const n = norm(u.nome + u.perfil);
    
    if (n.includes('upa') || n.includes('urgencia') || n.includes('emergencia') || 
        n.includes('pronto socorro') || n.includes('pronto atendimento')) {
        return 'urgencia';
    }
    if (n.includes('maternidade') || n.includes('obstetricia') || n.includes('parto')) {
        return 'maternidade';
    }
    if (n.includes('ortopedia') || n.includes('cardiologia') || n.includes('oncologia') ||
        n.includes('especializado') || n.includes('referencia')) {
        return 'especializado';
    }
    if (n.includes('samu')) {
        return 'samu';
    }
    
    return 'ambulatorial';
}

function getTextoAcolhimento(acolhimento) {
    const textos = {
        'ambulatorial': 'Atendimento Ambulatorial',
        'urgencia': 'Urg√™ncia/Emerg√™ncia',
        'maternidade': 'Maternidade',
        'especializado': 'Atendimento Especializado',
        'samu': 'SAMU'
    };
    return textos[acolhimento] || 'Atendimento Geral';
}

function montarUnidade(tags, lat, lon, osmId, osmType, distancia = null) {
    const nome = (tags.name || tags['name:pt'] || '').trim();
    if (!nome) return null;
    
    // Verificar v√≠nculo com SUS
    if (!isVinculadoSUS(tags, nome)) return null;
    
    const classif = classificarNivel(tags, nome);
    
    // Determinar gest√£o
    const operador = (tags.operator || '').toLowerCase();
    let gestao = 'Municipal';
    if (operador.includes('federal')) gestao = 'Federal';
    else if (operador.includes('estadual')) gestao = 'Estadual';

    return {
        nome,
        cidade: '',
        bairro: '',
        perfil: classif.perfil,
        nivel: classif.nivel,
        lat,
        lon,
        telefone: tags.phone || tags['contact:phone'] || '',
        endereco: [tags['addr:street'], tags['addr:housenumber']].filter(Boolean).join(', '),
        osmId,
        osmType,
        website: tags.website || tags['contact:website'] || '',
        distancia,
        acolhimento: determinarAcolhimento({ nome, perfil: classif.perfil }),
        gestao,
        cnes: tags['ref:CNES'] || tags['ref:cnes'] || '',
        enderecoCompleto: '',
        telefoneFormatado: '',
        mapsLink: lat && lon ? `https://www.google.com/maps?q=${lat},${lon}` : '',
        cnesLink: tags['ref:CNES'] ? `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.jsp?pk=${tags['ref:CNES']}` : ''
    };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GEOLOCALIZA√á√ÉO E BUSCA POR PROXIMIDADE - CORRIGIDA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function usarGeolocalizacao() {
    if (!navigator.geolocation) {
        showNotification('Geolocaliza√ß√£o n√£o suportada pelo navegador', 'error');
        return;
    }

    showSearchProgress(true);
    updateSearchProgress(10, 'Obtendo sua localiza√ß√£o...', 'Aguarde autoriza√ß√£o GPS');
    buscaAtiva = true;

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            if (!buscaAtiva) return;
            
            currentGeoPosition = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };

            updateSearchProgress(20, 'Localiza√ß√£o obtida!', `Lat: ${currentGeoPosition.lat.toFixed(4)}, Lon: ${currentGeoPosition.lon.toFixed(4)}`);

            try {
                // Reverse geocoding para descobrir munic√≠pio
                const location = await reverseGeocode(currentGeoPosition.lat, currentGeoPosition.lon);
                
                if (!location || !location.cidade) {
                    throw new Error('N√£o foi poss√≠vel determinar sua localiza√ß√£o');
                }

                updateSearchProgress(30, 'Munic√≠pio detectado', location.cidade);
                
                // Buscar unidades pr√≥ximas - RAIO CORRIGIDO
                const raio = parseFloat(document.getElementById('geoRaio').value) || 6;
                const units = await buscarUnidadesProximas(currentGeoPosition.lat, currentGeoPosition.lon, raio);
                
                if (!buscaAtiva) return;

                updateSearchProgress(85, 'Processando unidades...', `${units.length} unidades encontradas`);

                // Calcular dist√¢ncias
                units.forEach(u => {
                    if (u.lat && u.lon) {
                        u.distancia = calcularDistancia(
                            currentGeoPosition.lat,
                            currentGeoPosition.lon,
                            u.lat,
                            u.lon
                        );
                    }
                });

                // Ordenar por dist√¢ncia
                units.sort((a, b) => (a.distancia || 999) - (b.distancia || 999));

                // Enriquecer dados
                allUnits = await enrichUnitsData(units, location.cidade);
                
                if (!buscaAtiva) return;

                applyLocalFilters();

                updateSearchProgress(100, 'Conclu√≠do!', `${allUnits.length} unidades no raio de ${raio}km`);

                setTimeout(() => {
                    showSearchProgress(false);
                    showNotification(`${allUnits.length} unidades encontradas pr√≥ximas a voc√™`, 'success');
                    document.getElementById('geoStatus').textContent = 
                        `üìç Sua localiza√ß√£o: ${location.cidade} ‚Ä¢ ${allUnits.length} unidades no raio de ${raio}km`;
                }, 800);

            } catch (error) {
                console.error('Erro na busca por proximidade:', error);
                showSearchProgress(false);
                showNotification('Erro: ' + error.message, 'error');
            }
        },
        (error) => {
            showSearchProgress(false);
            let msg = 'Erro ao obter localiza√ß√£o';
            
            if (error.code === error.PERMISSION_DENIED) {
                msg = 'Permiss√£o de localiza√ß√£o negada';
            } else if (error.code === error.POSITION_UNAVAILABLE) {
                msg = 'Localiza√ß√£o indispon√≠vel';
            } else if (error.code === error.TIMEOUT) {
                msg = 'Tempo esgotado ao obter localiza√ß√£o';
            }
            
            showNotification(msg, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUSCA POR PROXIMIDADE - CORRIGIDA PARA MAIOR VOLUME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buscarUnidadesProximas(lat, lon, raioKm) {
    const raioMetros = raioKm * 1000;
    
    // QUERY MAIS ABRANGENTE - Inclui mais tipos de estabelecimentos
    const query = `
[out:json][timeout:60];
(
  // Healthcare nodes
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](around:${raioMetros},${lat},${lon});
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](around:${raioMetros},${lat},${lon});
  relation["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](around:${raioMetros},${lat},${lon});
  
  // Amenity nodes - mais abrangente
  node["amenity"~"^(hospital|clinic|health_post|health_centre|doctors)$"](around:${raioMetros},${lat},${lon});
  way["amenity"~"^(hospital|clinic|health_post|health_centre|doctors)$"](around:${raioMetros},${lat},${lon});
  relation["amenity"~"^(hospital|clinic|health_post|health_centre|doctors)$"](around:${raioMetros},${lat},${lon});
  
  // Busca por nome (unidades que podem n√£o ter tag espec√≠fica)
  node["name"~"(?i)(hospital|ubs|posto|upa|policlinica|centro de saude|caps)"](around:${raioMetros},${lat},${lon});
  way["name"~"(?i)(hospital|ubs|posto|upa|policlinica|centro de saude|caps)"](around:${raioMetros},${lat},${lon});
);
out center tags;
    `.trim();

    updateSearchProgress(40, 'Consultando OpenStreetMap...', 'Buscando unidades de sa√∫de');

    try {
        const dados = await consultarOverpass(query);
        const elementos = dados.elements || [];
        
        if (!buscaAtiva) return [];
        
        updateSearchProgress(60, 'Processando resultados...', `${elementos.length} candidatos encontrados`);

        const unidades = [];
        
        for (let i = 0; i < elementos.length; i++) {
            if (!buscaAtiva) return unidades;
            
            const el = elementos[i];
            const tags = el.tags || {};
            const elLat = el.lat ?? el.center?.lat;
            const elLon = el.lon ?? el.center?.lon;
            
            if (!elLat || !elLon) continue;

            const distancia = calcularDistancia(lat, lon, elLat, elLon);
            if (distancia > raioKm) continue;

            const u = montarUnidade(
                tags, elLat, elLon,
                el.id,
                el.type,
                distancia
            );
            
            if (u) {
                unidades.push(u);
            }

            if (i % 20 === 0) {
                const pct = 60 + Math.round((i + 1) / elementos.length * 25);
                updateSearchProgress(pct, 'Processando...', `${unidades.length} unidades v√°lidas encontradas`);
            }
        }

        return deduplicar(unidades);
        
    } catch (error) {
        console.error('Erro no Overpass:', error);
        throw error;
    }
}

async function reverseGeocode(lat, lon) {
    try {
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=pt-BR`;
        const response = await fetch(url, {
            headers: {
                'User-Agent': `SaudeBR-Localizador/3.0 (${CONFIG.NOMINATIM.EMAIL})`
            }
        });
        
        if (!response.ok) return null;
        
        const data = await response.json();
        
        if (data && data.address) {
            const cidade = data.address.city || data.address.town || data.address.municipality || data.address.county;
            const uf = data.address.state;
            const estadoSigla = data.address['ISO3166-2-lvl4']?.split('-')[1] || uf;
            
            return {
                cidade,
                uf: estadoSigla,
                estado: uf
            };
        }
    } catch (error) {
        console.error('Erro no reverse geocoding:', error);
    }
    
    return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUSCA POR MUNIC√çPIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buscarPorMunicipio() {
    const uf = document.getElementById('selectEstado').value;
    const codigoIBGE = document.getElementById('selectMunicipio').value;
    
    if (!uf || !codigoIBGE) {
        showNotification('Selecione estado e munic√≠pio', 'error');
        return;
    }

    const selectMunicipio = document.getElementById('selectMunicipio');
    const nomeMunicipio = selectMunicipio.options[selectMunicipio.selectedIndex]?.text || 'munic√≠pio selecionado';
    
    showSearchProgress(true);
    updateSearchProgress(10, 'Consultando OpenStreetMap...', `Buscando em ${nomeMunicipio}/${uf}`);
    buscaAtiva = true;

    try {
        // Obter dados do munic√≠pio
        const municipio = await getMunicipioData(uf, codigoIBGE);
        
        if (!municipio || !municipio.latitude || !municipio.longitude) {
            throw new Error('N√£o foi poss√≠vel obter coordenadas do munic√≠pio');
        }

        updateSearchProgress(20, 'Localizando √°rea do munic√≠pio...', `${municipio.nome} (${municipio.latitude.toFixed(4)}, ${municipio.longitude.toFixed(4)})`);

        // Buscar unidades no munic√≠pio
        const units = await buscarUnidadesNoMunicipio(municipio);
        
        if (!buscaAtiva) return;
        
        if (units.length === 0) {
            updateSearchProgress(100, 'Nenhuma unidade encontrada', 'Tente expandir a busca');
            setTimeout(() => showSearchProgress(false), 1500);
            showNotification('Nenhuma unidade encontrada neste munic√≠pio', 'warning');
            return;
        }

        updateSearchProgress(80, 'Processando unidades...', `${units.length} unidades encontradas`);

        // Enriquecer dados
        allUnits = await enrichUnitsData(units, municipio.nome);
        
        if (!buscaAtiva) return;

        applyLocalFilters();

        updateSearchProgress(100, 'Conclu√≠do!', `${allUnits.length} unidades encontradas em ${municipio.nome}`);

        setTimeout(() => {
            showSearchProgress(false);
            showNotification(`${allUnits.length} unidades encontradas em ${municipio.nome}`, 'success');
        }, 800);

    } catch (error) {
        console.error('Erro na busca por munic√≠pio:', error);
        showSearchProgress(false);
        showNotification('Erro ao buscar unidades: ' + error.message, 'error');
    }
}

async function getMunicipioData(uf, codigoIBGE) {
    // Tentar obter do cache primeiro
    if (municipiosPorEstado[uf]) {
        const mun = municipiosPorEstado[uf].find(m => m.id === codigoIBGE);
        if (mun && mun.latitude && mun.longitude) {
            return mun;
        }
    }

    // Buscar coordenadas via Nominatim
    const nomeMunicipio = document.getElementById('selectMunicipio').options[
        document.getElementById('selectMunicipio').selectedIndex
    ]?.text;

    if (!nomeMunicipio) return null;

    try {
        const nomeBusca = encodeURIComponent(`${nomeMunicipio}, ${uf}, Brasil`);
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/search?q=${nomeBusca}&format=json&limit=1&countrycodes=br`;
        
        const response = await fetch(url, {
            headers: {
                'User-Agent': `SaudeBR-Localizador/3.0 (${CONFIG.NOMINATIM.EMAIL})`
            }
        });
        
        if (!response.ok) return null;
        
        const data = await response.json();
        
        if (data.length > 0) {
            const mun = {
                id: codigoIBGE,
                nome: nomeMunicipio,
                latitude: parseFloat(data[0].lat),
                longitude: parseFloat(data[0].lon)
            };
            
            // Estimar √°rea pelo bounding box
            if (data[0].boundingbox) {
                const bb = data[0].boundingbox.map(Number);
                const dLat = Math.abs(bb[1] - bb[0]);
                const dLon = Math.abs(bb[3] - bb[2]);
                mun.area_km2 = dLat * 111 * dLon * 111 * Math.cos(mun.latitude * Math.PI / 180);
            }
            
            // Salvar no cache
            if (!municipiosPorEstado[uf]) municipiosPorEstado[uf] = [];
            const index = municipiosPorEstado[uf].findIndex(m => m.id === codigoIBGE);
            if (index >= 0) {
                municipiosPorEstado[uf][index] = mun;
            } else {
                municipiosPorEstado[uf].push(mun);
            }
            
            return mun;
        }
    } catch (error) {
        console.warn('Erro ao buscar coordenadas do munic√≠pio:', error);
    }

    return null;
}

async function buscarUnidadesNoMunicipio(municipio) {
    // QUERY MAIS ABRANGENTE para munic√≠pio
    const excl = EXCLUIR_TIPOS;
    const nome = municipio.nome;
    const nomesAlternativos = [nome, nome.replace(/^(S√£o|Santo|Santa) /, 'S. ')];
    
    let elementos = [];
    
    for (const nomeAlt of nomesAlternativos) {
        const query = `[out:json][timeout:60];
area["name"="${nomeAlt}"]["admin_level"~"^(7|8|9)$"]["boundary"="administrative"]->.mun;
(
  node["healthcare"]["healthcare"!~"^(${excl})$"](area.mun);
  way["healthcare"]["healthcare"!~"^(${excl})$"](area.mun);
  node["amenity"~"^(hospital|clinic|health_post|health_centre|doctors)$"]["name"](area.mun);
  way["amenity"~"^(hospital|clinic|health_post|health_centre|doctors)$"]["name"](area.mun);
  node["name"~"(?i)(hospital|ubs|posto|upa|policlinica|centro de saude|caps)"](area.mun);
  way["name"~"(?i)(hospital|ubs|posto|upa|policlinica|centro de saude|caps)"](area.mun);
);
out center tags;`;
        
        try {
            const dados = await consultarOverpass(query);
            elementos = dados.elements || [];
            if (elementos.length > 0) break;
        } catch (e) {
            console.warn('Overpass √°rea falhou:', e);
        }
    }

    // Se n√£o encontrou por √°rea, tenta por bounding box
    if (elementos.length === 0) {
        updateSearchProgress(35, 'Expandindo busca por coordenadas...', 'Usando bounding box');
        
        const raio = 0.35; // Aumentado para cobrir melhor o munic√≠pio
        const sul = (municipio.latitude - raio).toFixed(6);
        const norte = (municipio.latitude + raio).toFixed(6);
        const oeste = (municipio.longitude - raio).toFixed(6);
        const leste = (municipio.longitude + raio).toFixed(6);

        const query = `[out:json][timeout:60];
(
  node["healthcare"]["healthcare"!~"^(${excl})$"](${sul},${oeste},${norte},${leste});
  way["healthcare"]["healthcare"!~"^(${excl})$"](${sul},${oeste},${norte},${leste});
  node["amenity"~"^(hospital|clinic|health_post|health_centre|doctors)$"]["name"](${sul},${oeste},${norte},${leste});
  way["amenity"~"^(hospital|clinic|health_post|health_centre|doctors)$"]["name"](${sul},${oeste},${norte},${leste});
  node["name"~"(?i)(hospital|ubs|posto|upa|policlinica|centro de saude|caps)"](${sul},${oeste},${norte},${leste});
  way["name"~"(?i)(hospital|ubs|posto|upa|policlinica|centro de saude|caps)"](${sul},${oeste},${norte},${leste});
);
out center tags;`;
        
        try {
            const dados = await consultarOverpass(query);
            elementos = dados.elements || [];
        } catch (e) {
            console.warn('Overpass bbox falhou:', e);
        }
    }

    if (elementos.length === 0) {
        return [];
    }

    updateSearchProgress(50, 'Classificando unidades...', `${elementos.length} candidatos encontrados`);

    const raioKm = Math.max(25, municipio.area_km2 ? Math.sqrt(municipio.area_km2 / Math.PI) * 1.5 : 25);
    const unidades = [];

    for (let i = 0; i < elementos.length; i++) {
        if (!buscaAtiva) return unidades;
        
        const el = elementos[i];
        const tags = el.tags || {};
        const lat = el.lat ?? el.center?.lat;
        const lon = el.lon ?? el.center?.lon;
        
        if (!lat || !lon) continue;

        const dist = calcularDistancia(municipio.latitude, municipio.longitude, lat, lon);

        if (dist <= raioKm) {
            const u = montarUnidade(tags, lat, lon, el.id, el.type);
            if (u) {
                u.cidade = municipio.nome;
                unidades.push(u);
            }
        }

        const pct = 50 + Math.round((i + 1) / elementos.length * 30);
        updateSearchProgress(pct, 'Processando...', `${unidades.length} unidades v√°lidas encontradas`);
    }

    return deduplicar(unidades);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENRIQUECIMENTO DE DADOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enrichUnitsData(units, cidadeRef) {
    for (const unit of units) {
        unit.cidade = unit.cidade || cidadeRef || '';
        
        // Endere√ßo completo
        unit.enderecoCompleto = `${unit.endereco}, ${unit.cidade}${unit.bairro ? ' - ' + unit.bairro : ''}`;
        
        // Telefone formatado
        if (unit.telefone) {
            const tel = unit.telefone.replace(/\D/g, '');
            if (tel.length >= 10) {
                const ddd = tel.substring(0, 2);
                const parte1 = tel.substring(2, tel.length - 4);
                const parte2 = tel.substring(tel.length - 4);
                unit.telefoneFormatado = `(${ddd}) ${parte1}-${parte2}`;
            } else {
                unit.telefoneFormatado = unit.telefone;
            }
        }
    }

    return units;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERFACE - FILTROS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFilter() {
    const body = document.getElementById('filterBody');
    const arrow = document.getElementById('filterArrow');
    const btn = document.getElementById('filterToggleBtn');
    
    body.classList.toggle('open');
    arrow.classList.toggle('open');
    
    if (body.classList.contains('open')) {
        btn.querySelector('span').textContent = 'Recolher';
    } else {
        btn.querySelector('span').textContent = 'Expandir';
    }
}

async function carregarEstados() {
    const select = document.getElementById('selectEstado');
    
    try {
        const response = await fetch(`${CONFIG.IBGE}/estados?orderBy=nome`);
        estados = await response.json();
        
        estados.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(est => {
            const opt = document.createElement('option');
            opt.value = est.sigla;
            opt.textContent = `${est.sigla} ‚Äî ${est.nome}`;
            select.appendChild(opt);
        });
    } catch (error) {
        console.error('Erro ao carregar estados:', error);
        showNotification('Erro ao carregar estados', 'error');
    }
}

async function onEstadoChange() {
    const select = document.getElementById('selectEstado');
    const selectMun = document.getElementById('selectMunicipio');
    const uf = select.value;
    
    selectMun.innerHTML = '<option value="">Carregando munic√≠pios...</option>';
    selectMun.disabled = true;
    
    if (!uf) {
        selectMun.innerHTML = '<option value="">‚Äî Selecione o estado primeiro ‚Äî</option>';
        return;
    }
    
    try {
        const response = await fetch(`${CONFIG.IBGE}/estados/${uf}/municipios?orderBy=nome`);
        const municipios = await response.json();
        
        municipiosPorEstado[uf] = municipios.map(m => ({
            id: String(m.id),
            nome: m.nome,
            latitude: null,
            longitude: null,
            area_km2: null
        }));
        
        selectMun.innerHTML = '<option value="">‚Äî Selecione um munic√≠pio ‚Äî</option>';
        municipiosPorEstado[uf].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(mun => {
            const opt = document.createElement('option');
            opt.value = mun.id;
            opt.textContent = mun.nome;
            selectMun.appendChild(opt);
        });
        
        selectMun.disabled = false;
    } catch (error) {
        console.error('Erro ao carregar munic√≠pios:', error);
        showNotification('Erro ao carregar munic√≠pios', 'error');
        selectMun.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

function onMunicipioChange() {
    // Opcional
}

function limparFiltros() {
    document.getElementById('selectEstado').value = '';
    document.getElementById('selectMunicipio').value = '';
    document.getElementById('selectMunicipio').disabled = true;
    document.getElementById('selectMunicipio').innerHTML = '<option value="">‚Äî Selecione o estado primeiro ‚Äî</option>';
    document.getElementById('inputBairro').value = '';
    document.getElementById('selectNivel').value = '';
    document.getElementById('selectAcolhimento').value = '';
    document.getElementById('selectGestao').value = '';
    
    allUnits = [];
    filteredUnits = [];
    renderResults();
    showNotification('Filtros limpos', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTROS LOCAIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyLocalFilters() {
    const bairro = document.getElementById('inputBairro').value.toLowerCase().trim();
    const nivel = document.getElementById('selectNivel').value;
    const acolhimento = document.getElementById('selectAcolhimento').value;
    const gestao = document.getElementById('selectGestao').value;
    
    filteredUnits = allUnits.filter(u => {
        // Filtro de bairro
        if (bairro && u.bairro && !u.bairro.toLowerCase().includes(bairro)) {
            return false;
        }
        
        // Filtro de n√≠vel
        if (nivel && u.nivel !== nivel) {
            return false;
        }
        
        // Filtro de acolhimento
        if (acolhimento && u.acolhimento !== acolhimento) {
            return false;
        }
        
        // Filtro de gest√£o
        if (gestao && u.gestao !== gestao) {
            return false;
        }
        
        return true;
    });
    
    renderResults();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERIZA√á√ÉO DE RESULTADOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderResults() {
    updateDashboard();
    
    const container = document.getElementById('resultsSection');
    
    if (filteredUnits.length === 0) {
        container.innerHTML = `
            <div class="status-box">
                <span class="status-icon">üîç</span>
                <h3>Nenhuma unidade encontrada</h3>
                <p>Tente ajustar os filtros ou realizar uma nova busca.</p>
            </div>
        `;
        return;
    }
    
    // Agrupar por n√≠vel
    const groups = {
        'primaria': filteredUnits.filter(u => u.nivel === 'primaria'),
        'secundaria': filteredUnits.filter(u => u.nivel === 'secundaria'),
        'terciaria': filteredUnits.filter(u => u.nivel === 'terciaria')
    };
    
    let html = `
        <div class="results-header">
            <div>
                <h2 class="results-title">
                    Resultados
                    <span class="results-count">${filteredUnits.length}</span>
                </h2>
            </div>
            <div class="export-row">
                <button class="btn btn-amber btn-sm" onclick="exportToExcel()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Exportar Excel
                </button>
                <button class="btn btn-navy btn-sm" onclick="visualizarPDF()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Visualizar PDF
                </button>
            </div>
        </div>
    `;
    
    // Renderizar grupos
    const groupConfigs = [
        { key: 'primaria', label: 'Aten√ß√£o Prim√°ria', color: '#00A878', icon: 'üè†' },
        { key: 'secundaria', label: 'Aten√ß√£o Secund√°ria', color: '#1565C0', icon: 'üî¨' },
        { key: 'terciaria', label: 'Aten√ß√£o Terci√°ria', color: '#E53935', icon: 'üè®' }
    ];
    
    groupConfigs.forEach(cfg => {
        if (groups[cfg.key] && groups[cfg.key].length > 0) {
            html += renderGroup(cfg, groups[cfg.key]);
        }
    });
    
    container.innerHTML = html;
}

function renderGroup(config, units) {
    const groupId = `group-${config.key}`;
    
    let html = `
        <div class="group-section">
            <div class="group-header" onclick="toggleGroup('${groupId}')">
                <div class="group-header-left">
                    <span class="group-pill" style="background: ${config.color}22; color: ${config.color};">
                        ${config.icon}
                    </span>
                    <div>
                        <div class="group-name">${config.label}</div>
                        <div class="group-meta">${units.length} unidade${units.length !== 1 ? 's' : ''} encontrada${units.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="group-count">${units.length}</div>
                    <span class="group-arrow" id="${groupId}-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
                    </span>
                </div>
            </div>
            <div class="group-body" id="${groupId}">
                <div class="cards-grid">
                    ${units.map((u, idx) => renderUnitCard(u, config.color, idx)).join('')}
                </div>
            </div>
        </div>
    `;
    
    return html;
}

function renderUnitCard(unit, accentColor, idx) {
    const gestaoClass = {
        'Municipal': 'municipal',
        'Estadual': 'estadual',
        'Federal': 'federal'
    }[unit.gestao] || 'municipal';
    
    let tagsHTML = '';
    
    // Tag de gest√£o
    if (unit.gestao) {
        tagsHTML += `<span class="unit-tag unit-tag-${gestaoClass}">${unit.gestao}</span>`;
    }
    
    // Tag de acolhimento
    const acolhimentoClass = {
        'ambulatorial': 'ambulatorial',
        'urgencia': 'urgencia',
        'maternidade': 'maternidade',
        'especializado': 'especializado',
        'samu': 'urgencia'
    }[unit.acolhimento] || 'ambulatorial';
    
    tagsHTML += `<span class="unit-tag unit-tag-${acolhimentoClass}">${getTextoAcolhimento(unit.acolhimento)}</span>`;
    
    // Tag de dist√¢ncia
    if (unit.distancia !== null && unit.distancia !== undefined) {
        tagsHTML += `<span class="unit-tag unit-distance">${unit.distancia.toFixed(1)} km</span>`;
    }
    
    // Bot√µes de a√ß√£o
    let actionsHTML = '';
    
    // Google Maps
    if (unit.mapsLink) {
        actionsHTML += `
            <button class="btn-icon maps" onclick="window.open('${unit.mapsLink}', '_blank')" title="Ver no Google Maps">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                </svg>
            </button>
        `;
    }
    
    // Link CNES
    if (unit.cnesLink) {
        actionsHTML += `
            <button class="btn-icon search" onclick="window.open('${unit.cnesLink}', '_blank')" title="Ver no CNES">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
            </button>
        `;
    }
    
    // WhatsApp
    if (unit.telefone) {
        const telClean = unit.telefone.replace(/\D/g, '');
        const texto = encodeURIComponent(`*${unit.nome}*\nüìç ${unit.enderecoCompleto}\nüìû ${unit.telefoneFormatado || unit.telefone}\nüè• ${unit.perfil}`);
        const whatsappLink = `https://wa.me/55${telClean}?text=${texto}`;
        actionsHTML += `
            <button class="btn-icon whatsapp" onclick="window.open('${whatsappLink}', '_blank')" title="Contato WhatsApp">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
        `;
    }
    
    // Google Search
    const termoBusca = encodeURIComponent(`${unit.nome} ${unit.cidade} SUS`);
    const googleSearchLink = `https://www.google.com/search?q=${termoBusca}`;
    actionsHTML += `
        <button class="btn-icon search" onclick="window.open('${googleSearchLink}', '_blank')" title="Buscar no Google">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
        </button>
    `;
    
    return `
        <div class="unit-card" data-unit-idx="${idx}">
            <div class="unit-card-accent" style="background: ${accentColor};"></div>
            <div class="unit-card-inner">
                <div class="unit-card-header">
                    <h3 class="unit-name">${unit.nome}</h3>
                </div>
                
                ${unit.perfil ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>${unit.perfil}</span>
                    </div>
                ` : ''}
                
                ${unit.enderecoCompleto ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${unit.enderecoCompleto}</span>
                    </div>
                ` : ''}
                
                ${unit.telefoneFormatado ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <span>${unit.telefoneFormatado}</span>
                    </div>
                ` : ''}
                
                ${unit.cnes ? `<div class="unit-cnes">CNES: ${unit.cnes}</div>` : ''}
                
                <div class="unit-tags">
                    ${tagsHTML}
                </div>
                
                ${actionsHTML ? `
                    <div class="unit-actions">
                        ${actionsHTML}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function toggleGroup(groupId) {
    const body = document.getElementById(groupId);
    const arrow = document.getElementById(`${groupId}-arrow`);
    
    body.classList.toggle('open');
    arrow.classList.toggle('open');
}

function updateDashboard() {
    document.getElementById('statTotal').textContent = filteredUnits.length;
    
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria').length;
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria').length;
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria').length;
    
    const urgencia = filteredUnits.filter(u => u.acolhimento === 'urgencia').length;
    const maternidade = filteredUnits.filter(u => u.acolhimento === 'maternidade').length;
    const especializado = filteredUnits.filter(u => u.acolhimento === 'especializado').length;
    const ambulatorial = filteredUnits.filter(u => u.acolhimento === 'ambulatorial').length;
    
    document.getElementById('statPrimaria').textContent = primaria;
    document.getElementById('statSecundaria').textContent = secundaria;
    document.getElementById('statTerciaria').textContent = terciaria;
    document.getElementById('statUrgencia').textContent = urgencia;
    document.getElementById('statMaternidade').textContent = maternidade;
    document.getElementById('statEspecializado').textContent = especializado;
    document.getElementById('statAmbulatorial').textContent = ambulatorial;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORTA√á√ÉO - EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportToExcel() {
    if (filteredUnits.length === 0) {
        showNotification('Nenhuma unidade para exportar', 'error');
        return;
    }
    
    const data = filteredUnits.map(u => ({
        'Nome': u.nome,
        'Perfil': u.perfil,
        'N√≠vel de Aten√ß√£o': u.nivel === 'primaria' ? 'Prim√°ria' : u.nivel === 'secundaria' ? 'Secund√°ria' : 'Terci√°ria',
        'Tipo de Acolhimento': getTextoAcolhimento(u.acolhimento),
        'Cidade': u.cidade,
        'Bairro': u.bairro || '',
        'Endere√ßo': u.endereco || '',
        'Telefone': u.telefoneFormatado || u.telefone || '',
        'Gest√£o': u.gestao || '',
        'CNES': u.cnes || '',
        'Dist√¢ncia (km)': u.distancia ? u.distancia.toFixed(2) : '',
        'Latitude': u.lat || '',
        'Longitude': u.lon || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Unidades de Sa√∫de');
    
    const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification(`Arquivo Excel exportado: ${fileName}`, 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PDF - TOTALMENTE INDEPENDENTE DO DASHBOARD
//  AGORA LISTA TODAS AS UNIDADES, SEM LIMITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gerarPDFHTML() {
    const dataAtual = new Date().toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // Estat√≠sticas por n√≠vel
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria');
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria');
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria');
    
    // Estat√≠sticas por acolhimento
    const acolhimentos = {
        ambulatorial: filteredUnits.filter(u => u.acolhimento === 'ambulatorial').length,
        urgencia: filteredUnits.filter(u => u.acolhimento === 'urgencia').length,
        maternidade: filteredUnits.filter(u => u.acolhimento === 'maternidade').length,
        especializado: filteredUnits.filter(u => u.acolhimento === 'especializado').length,
        samu: filteredUnits.filter(u => u.acolhimento === 'samu').length
    };

    let html = `
        <div class="pdf-container">
            <!-- HEADER -->
            <div class="pdf-header">
                <div class="pdf-header-content">
                    <div class="pdf-header-title">
                        <h1>Sa√∫de<span>BR</span> ‚Äî Relat√≥rio de Unidades</h1>
                        <p>Dados em tempo real ‚Ä¢ OpenStreetMap ‚Ä¢ Apenas unidades vinculadas ao SUS</p>
                    </div>
                    <div class="pdf-header-badge">
                        <div class="total">${filteredUnits.length}</div>
                        <div class="label">Total de Unidades</div>
                        <div style="font-size: 0.7rem; margin-top: 5px;">${dataAtual}</div>
                    </div>
                </div>
            </div>

            <!-- STATS GRID -->
            <div class="pdf-stats-grid">
                <div class="pdf-stat-item primaria">
                    <div class="pdf-stat-icon">üè†</div>
                    <div class="pdf-stat-value">${primaria.length}</div>
                    <div class="pdf-stat-label">Aten√ß√£o Prim√°ria</div>
                </div>
                <div class="pdf-stat-item secundaria">
                    <div class="pdf-stat-icon">üî¨</div>
                    <div class="pdf-stat-value">${secundaria.length}</div>
                    <div class="pdf-stat-label">Aten√ß√£o Secund√°ria</div>
                </div>
                <div class="pdf-stat-item terciaria">
                    <div class="pdf-stat-icon">üè®</div>
                    <div class="pdf-stat-value">${terciaria.length}</div>
                    <div class="pdf-stat-label">Aten√ß√£o Terci√°ria</div>
                </div>
                <div class="pdf-stat-item urgencia">
                    <div class="pdf-stat-icon">üö®</div>
                    <div class="pdf-stat-value">${acolhimentos.urgencia}</div>
                    <div class="pdf-stat-label">Urg√™ncia/Emerg√™ncia</div>
                </div>
            </div>

            <!-- ACOLHIMENTO SECTION -->
            <div class="pdf-acolhimento-section">
                <div class="pdf-section-title">
                    üìä Distribui√ß√£o por Tipo de Acolhimento
                    <span>${filteredUnits.length} unidades</span>
                </div>
                <div class="pdf-acolhimento-grid">
                    <div class="pdf-acolhimento-card">
                        <div class="pdf-acolhimento-icon">ü©∫</div>
                        <div class="pdf-acolhimento-info">
                            <h4>Ambulatorial</h4>
                            <p>${acolhimentos.ambulatorial}</p>
                        </div>
                    </div>
                    <div class="pdf-acolhimento-card">
                        <div class="pdf-acolhimento-icon">üö®</div>
                        <div class="pdf-acolhimento-info">
                            <h4>Urg√™ncia</h4>
                            <p>${acolhimentos.urgencia}</p>
                        </div>
                    </div>
                    <div class="pdf-acolhimento-card">
                        <div class="pdf-acolhimento-icon">ü§±</div>
                        <div class="pdf-acolhimento-info">
                            <h4>Maternidade</h4>
                            <p>${acolhimentos.maternidade}</p>
                        </div>
                    </div>
                    <div class="pdf-acolhimento-card">
                        <div class="pdf-acolhimento-icon">üî¨</div>
                        <div class="pdf-acolhimento-info">
                            <h4>Especializado</h4>
                            <p>${acolhimentos.especializado}</p>
                        </div>
                    </div>
                    <div class="pdf-acolhimento-card">
                        <div class="pdf-acolhimento-icon">üöë</div>
                        <div class="pdf-acolhimento-info">
                            <h4>SAMU</h4>
                            <p>${acolhimentos.samu}</p>
                        </div>
                    </div>
                </div>
            </div>
    `;

    // Fun√ß√£o para gerar se√ß√£o de unidades (sem limite)
    function gerarSecaoUnidades(titulo, icon, cor, unidades, descricao) {
        if (unidades.length === 0) return '';
        
        let secao = `
            <div class="pdf-nivel-section">
                <div class="pdf-nivel-header ${cor}">
                    <div class="pdf-nivel-icon">${icon}</div>
                    <div class="pdf-nivel-title">
                        <h3>${titulo}</h3>
                        <p>${descricao}</p>
                    </div>
                    <div class="pdf-nivel-count">${unidades.length}</div>
                </div>
                <div class="pdf-units-grid">
        `;
        
        // LISTA TODAS AS UNIDADES, SEM LIMITE
        unidades.forEach(u => {
            secao += `
                <div class="pdf-unit-card">
                    <div class="pdf-unit-name">${u.nome}</div>
                    <div class="pdf-unit-detail">
                        <span>üìç</span>
                        <span>${u.endereco || 'Endere√ßo n√£o informado'}</span>
                    </div>
                    <div class="pdf-unit-detail">
                        <span>üìû</span>
                        <span>${u.telefoneFormatado || u.telefone || 'N√£o informado'}</span>
                    </div>
                    <div class="pdf-unit-detail">
                        <span>üè•</span>
                        <span>${u.perfil}</span>
                    </div>
                    ${u.distancia ? `
                        <div class="pdf-unit-detail">
                            <span>üß≠</span>
                            <span><strong>${u.distancia.toFixed(1)} km</strong> de dist√¢ncia</span>
                        </div>
                    ` : ''}
                    <span class="pdf-unit-badge ${u.acolhimento}">${getTextoAcolhimento(u.acolhimento)}</span>
                </div>
            `;
        });
        
        secao += `</div></div>`;
        return secao;
    }

    // Adicionar se√ß√µes
    html += gerarSecaoUnidades('Aten√ß√£o Prim√°ria', 'üè†', 'primaria', primaria, 'UBS, Postos de Sa√∫de, Centros de Sa√∫de');
    html += gerarSecaoUnidades('Aten√ß√£o Secund√°ria', 'üî¨', 'secundaria', secundaria, 'Policl√≠nicas, UPA, CAPS, Cl√≠nicas Especializadas');
    html += gerarSecaoUnidades('Aten√ß√£o Terci√°ria', 'üè®', 'terciaria', terciaria, 'Hospitais de Refer√™ncia, Hospitais Especializados');

    // FOOTER
    html += `
            <div class="pdf-footer">
                <div class="pdf-footer-left">
                    <span>üîç Relat√≥rio gerado pelo Sa√∫deBR Localizador</span>
                </div>
                <div class="pdf-footer-right">
                    <span>üìÖ ${dataAtual}</span><br>
                    <span style="font-size: 0.7rem;">Dados do OpenStreetMap ‚Ä¢ Fonte p√∫blica colaborativa</span>
                </div>
            </div>
        </div>
    `;

    return html;
}

async function visualizarPDF() {
    if (filteredUnits.length === 0) {
        showNotification('Nenhuma unidade para gerar PDF', 'error');
        return;
    }

    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando visualiza√ß√£o do PDF...', 'Preparando conte√∫do');

    try {
        const html = gerarPDFHTML();
        document.getElementById('pdfModalBody').innerHTML = html;
        document.getElementById('pdfModal').classList.add('visible');
        showSearchProgress(false);
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar visualiza√ß√£o do PDF', 'error');
        showSearchProgress(false);
    }
}

function closePDFModal() {
    document.getElementById('pdfModal').classList.remove('visible');
}

async function downloadPDF() {
    if (filteredUnits.length === 0) return;

    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando PDF...', 'Processando imagem');

    try {
        const { jsPDF } = window.jspdf;
        
        const element = document.createElement('div');
        element.innerHTML = gerarPDFHTML();
        element.style.width = '1200px';
        element.style.padding = '0';
        element.style.background = 'white';
        element.style.position = 'absolute';
        element.style.left = '-9999px';
        document.body.appendChild(element);

        updateSearchProgress(40, 'Renderizando...', 'Convertendo para imagem');

        const canvas = await html2canvas(element, {
            scale: 2,
            backgroundColor: '#ffffff',
            logging: false,
            allowTaint: true,
            useCORS: true
        });

        document.body.removeChild(element);

        const imgData = canvas.toDataURL('image/png');
        
        // Usar A4 em modo paisagem para acomodar muitas unidades
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
        const width = imgWidth * ratio;
        const height = imgHeight * ratio;

        const x = (pdfWidth - width) / 2;
        const y = (pdfHeight - height) / 2;

        pdf.addImage(imgData, 'PNG', x, y, width, height);
        
        const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);

        showSearchProgress(false);
        showNotification(`PDF baixado: ${fileName}`, 'success');
        
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar PDF', 'error');
        showSearchProgress(false);
    }
}

async function compartilharPDFWhatsApp() {
    if (filteredUnits.length === 0) return;

    showSearchProgress(true);
    updateSearchProgress(10, 'Preparando PDF para WhatsApp...', 'Aguarde');

    try {
        const { jsPDF } = window.jspdf;
        
        const element = document.createElement('div');
        element.innerHTML = gerarPDFHTML();
        element.style.width = '1200px';
        element.style.padding = '0';
        element.style.background = 'white';
        element.style.position = 'absolute';
        element.style.left = '-9999px';
        document.body.appendChild(element);

        updateSearchProgress(40, 'Renderizando...', 'Convertendo para imagem');

        const canvas = await html2canvas(element, {
            scale: 2,
            backgroundColor: '#ffffff',
            logging: false,
            allowTaint: true,
            useCORS: true
        });

        document.body.removeChild(element);

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
        const width = imgWidth * ratio;
        const height = imgHeight * ratio;

        const x = (pdfWidth - width) / 2;
        const y = (pdfHeight - height) / 2;

        pdf.addImage(imgData, 'PNG', x, y, width, height);
        
        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.download = 'SaudeBR_Unidades.pdf';
        document.body.appendChild(link);
        
        showSearchProgress(false);
        
        alert('‚úÖ PDF gerado com sucesso!\n\n' +
              'Para compartilhar no WhatsApp:\n\n' +
              '1Ô∏è‚É£ Clique em OK e aguarde o download\n' +
              '2Ô∏è‚É£ Abra o WhatsApp\n' +
              '3Ô∏è‚É£ Selecione a conversa desejada\n' +
              '4Ô∏è‚É£ Clique no √≠cone üìé (anexar)\n' +
              '5Ô∏è‚É£ Escolha "Documento"\n' +
              '6Ô∏è‚É£ Selecione o arquivo baixado');
        
        link.click();
        
        document.body.removeChild(link);
        URL.revokeObjectURL(pdfUrl);
        
    } catch (error) {
        console.error('Erro ao gerar PDF para WhatsApp:', error);
        showNotification('Erro ao gerar PDF para WhatsApp', 'error');
        showSearchProgress(false);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INICIALIZA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    carregarEstados();
    console.log('Sa√∫deBR Localizador CNES v3.0 iniciado');
});

// Fechar modais ao clicar fora
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('visible');
        }
    });
});
</script>

</body>
</html>

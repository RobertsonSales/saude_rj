<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SaÃºdeBR â€” Localizador CNES de Unidades de SaÃºde PÃºblica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€ */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€ */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* â”€â”€â”€ FILTER PANEL â”€â”€â”€ */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,168,120,0.1);
    }
    select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6E85' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--radius-sm);
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,168,120,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,168,120,0.4);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover { background: #fff; border-color: var(--teal); color: var(--teal); }
    .btn-navy {
      background: var(--navy);
      color: #fff;
      box-shadow: 0 4px 12px rgba(11,31,58,0.25);
    }
    .btn-navy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(11,31,58,0.35); }
    .btn-amber {
      background: linear-gradient(135deg, var(--amber) 0%, #F7BE50 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(245,166,35,0.35);
    }
    .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(245,166,35,0.45); }
    .btn-geo {
      background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21,101,192,0.3);
    }
    .btn-geo:hover { transform: translateY(-1px); }
    .btn-danger { background: var(--red-pale); color: var(--red); border: 1.5px solid rgba(229,57,53,0.2); }
    .btn-danger:hover { background: var(--red); color: #fff; }
    .btn-sm { padding: 7px 14px; font-size: 0.78rem; }
    .btn-icon { width: 34px; height: 34px; padding: 0; justify-content: center; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* â”€â”€â”€ GEO SECTION â”€â”€â”€ */
    .geo-section {
      background: linear-gradient(135deg, var(--blue-pale), #d8e8ff);
      border: 1px solid rgba(21,101,192,0.2);
      border-radius: var(--radius);
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .geo-info { flex: 1; }
    .geo-info h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--blue);
    }
    .geo-info p { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .geo-radius-row { display: flex; align-items: center; gap: 10px; }
    .geo-radius-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .geo-radius-input {
      width: 80px;
      background: #fff;
      border: 1.5px solid rgba(21,101,192,0.3);
      border-radius: 8px;
      padding: 7px 10px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      text-align: center;
    }

    /* â”€â”€â”€ DASHBOARD CARDS â”€â”€â”€ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--teal));
    }
    .stat-card-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    .stat-card-value {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      line-height: 1;
      color: var(--navy);
      transition: all 0.5s;
    }
    .stat-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .stat-card-sublabel { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }

    /* â”€â”€â”€ RESULTS SECTION â”€â”€â”€ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .results-count {
      background: var(--teal-pale);
      color: var(--teal);
      font-size: 0.78rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 8px;
    }
    .export-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* â”€â”€â”€ GROUP SECTIONS â”€â”€â”€ */
    .group-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .group-header {
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .group-header:hover { background: var(--bg); }
    .group-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .group-pill {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.78rem;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .group-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .group-meta { font-size: 0.78rem; color: var(--text-muted); }
    .group-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--navy);
      min-width: 60px;
      text-align: right;
    }
    .group-arrow { color: var(--text-muted); transition: transform 0.3s; }
    .group-arrow.open { transform: rotate(90deg); }

    .group-body {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: none;
    }
    .group-body.open { display: block; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    /* â”€â”€â”€ UNIT CARDS â”€â”€â”€ */
    .unit-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-card-accent {
      position: absolute;
      top: 0; left: 0;
      width: 4px;
      height: 100%;
    }
    .unit-card-inner { padding-left: 8px; }
    .unit-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--navy);
      line-height: 1.3;
    }
    .unit-type-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .unit-info-row svg { flex-shrink: 0; margin-top: 1px; color: var(--text-light); }
    .unit-cnes {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 10px;
      font-family: 'Outfit', sans-serif;
    }
    .unit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }
    .unit-tag {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-tag-urgencia { background: var(--red-pale); color: var(--red); }
    .unit-tag-ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .unit-tag-maternidade { background: var(--purple-pale); color: var(--purple); }
    .unit-tag-traumatologia { background: var(--amber-pale); color: #C07A00; }
    .unit-tag-federal { background: #E8F0FE; color: var(--blue); }
    .unit-tag-estadual { background: #FFF8EC; color: #9C6E00; }
    .unit-tag-municipal { background: var(--teal-pale); color: #006B4F; }
    .unit-distance { background: var(--blue-pale); color: var(--blue); }
    .unit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 4px;
    }
    .unit-actions .btn-icon {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      transition: all 0.2s;
    }
    .unit-actions .btn-icon:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-pale); }
    .unit-actions .btn-icon.whatsapp:hover { border-color: #25D366; color: #25D366; background: #E8FBF0; }
    .unit-actions .btn-icon.maps:hover { border-color: #EA4335; color: #EA4335; background: #FDECEA; }
    .unit-actions .btn-icon.search:hover { border-color: #4285F4; color: #4285F4; background: #E8F0FE; }

    /* â”€â”€â”€ LOADING / EMPTY / ERROR â”€â”€â”€ */
    .status-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 60px 40px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .status-box .status-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }
    .status-box h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .status-box p { font-size: 0.88rem; color: var(--text-muted); max-width: 400px; margin: 0 auto; }

    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--teal-pale);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-wrap {
      max-width: 360px;
      margin: 16px auto 0;
      background: var(--border);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.3s;
    }

    /* â”€â”€â”€ NOTIFICATION â”€â”€â”€ */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--navy);
      color: #fff;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 340px;
    }
    .notification.success { background: var(--teal); }
    .notification.error { background: var(--red); }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* â”€â”€â”€ FOOTER â”€â”€â”€ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .footer a { color: var(--teal); text-decoration: none; }

    /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
    @media (max-width: 640px) {
      .main-wrapper { padding: 16px 14px 40px; }
      .header-inner { padding: 14px 16px; }
      .header-titles h1 { font-size: 1.2rem; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: 1fr; }
    }

    /* â”€â”€â”€ NIVEL COLORS â”€â”€â”€ */
    .nivel-primaria { --nivel-color: #00A878; }
    .nivel-secundaria { --nivel-color: #1565C0; }
    .nivel-terciaria { --nivel-color: #E53935; }
  </style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="header-inner">
    <div class="logo-mark">
      <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 4v20M4 14h20" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
        <circle cx="14" cy="14" r="12" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
      </svg>
    </div>
    <div class="header-titles">
      <h1>SaÃºde<span>BR</span> â€” Localizador CNES</h1>
      <p>Dados em tempo real â€¢ MinistÃ©rio da SaÃºde / DATASUS â€¢ Todas as esferas de gestÃ£o</p>
    </div>
    <span class="header-badge">ğŸŸ¢ Online</span>
  </div>
</header>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main-wrapper">

  <!-- â”€â”€â”€ FILTROS â”€â”€â”€ -->
  <div class="filter-section">
    <div class="filter-header" onclick="toggleFilter()">
      <div class="filter-header-left">
        <div class="filter-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </div>
        <div>
          <div class="filter-title">Filtros de Busca</div>
          <div class="filter-subtitle">Estado, municÃ­pio, perfil de atenÃ§Ã£o e formas de acolhimento</div>
        </div>
      </div>
      <button class="filter-toggle-btn" id="filterToggleBtn">
        <span>Expandir</span>
        <span class="filter-toggle-arrow" id="filterArrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </button>
    </div>

    <div class="filter-body" id="filterBody">
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Estado (UF)</label>
          <select class="form-control" id="selectEstado" onchange="onEstadoChange()">
            <option value="">â€” Selecione â€”</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">MunicÃ­pio</label>
          <select class="form-control" id="selectMunicipio" onchange="onMunicipioChange()" disabled>
            <option value="">â€” Selecione o estado primeiro â€”</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" id="inputBairro" placeholder="Ex: Centro, Jardim..." oninput="applyLocalFilters()">
        </div>
        <div class="form-group">
          <label class="form-label">Perfil / NÃ­vel de AtenÃ§Ã£o</label>
          <select class="form-control" id="selectNivel" onchange="applyLocalFilters()">
            <option value="">Todos os NÃ­veis</option>
            <option value="primaria">AtenÃ§Ã£o PrimÃ¡ria</option>
            <option value="secundaria">AtenÃ§Ã£o SecundÃ¡ria</option>
            <option value="terciaria">AtenÃ§Ã£o TerciÃ¡ria</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Forma de Acolhimento</label>
          <select class="form-control" id="selectAcolhimento" onchange="applyLocalFilters()">
            <option value="">Todas as Formas</option>
            <option value="ambulatorial">Atendimento Ambulatorial</option>
            <option value="urgencia">UrgÃªncia / EmergÃªncia</option>
            <option value="maternidade">Maternidade</option>
            <option value="traumatologia">Traumatologia</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Esfera de GestÃ£o</label>
          <select class="form-control" id="selectGestao" onchange="applyLocalFilters()">
            <option value="">Todas</option>
            <option value="M">Municipal</option>
            <option value="E">Estadual</option>
            <option value="F">Federal</option>
            <option value="D">Dupla</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="buscarUnidades()" id="btnBuscar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          Buscar Unidades
        </button>
        <button class="btn btn-secondary" onclick="limparFiltros()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.57"/></svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ GEOLOCALIZAÃ‡ÃƒO â”€â”€â”€ -->
  <div class="geo-section">
    <div style="font-size: 1.8rem;">ğŸ“</div>
    <div class="geo-info">
      <h3>Busca por Proximidade GeogrÃ¡fica</h3>
      <p id="geoStatus">Clique em "Usar Minha LocalizaÃ§Ã£o" para buscar unidades prÃ³ximas a vocÃª.</p>
    </div>
    <div class="geo-radius-row">
      <span class="geo-radius-label">Raio (km):</span>
      <input type="number" class="geo-radius-input form-control" id="geoRaio" value="3" min="0.5" max="6" step="0.5">
    </div>
    <button class="btn btn-geo" onclick="usarGeolocalizacao()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>
      Usar Minha LocalizaÃ§Ã£o
    </button>
  </div>

  <!-- â”€â”€â”€ DASHBOARD â”€â”€â”€ -->
  <div class="dashboard" id="dashboard">
    <div class="stat-card" style="--card-accent: var(--teal);">
      <div class="stat-card-icon" style="background: var(--teal-pale); color: var(--teal);">ğŸ¥</div>
      <div class="stat-card-value" id="statTotal">â€”</div>
      <div class="stat-card-label">Total de Unidades</div>
      <div class="stat-card-sublabel">encontradas</div>
    </div>
    <div class="stat-card" style="--card-accent: #00A878;">
      <div class="stat-card-icon" style="background: #E8F8F3; color: #00A878;">ğŸ </div>
      <div class="stat-card-value" id="statPrimaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o PrimÃ¡ria</div>
      <div class="stat-card-sublabel">UBS, ESF, CAPS...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--blue);">
      <div class="stat-card-icon" style="background: var(--blue-pale); color: var(--blue);">ğŸ”¬</div>
      <div class="stat-card-value" id="statSecundaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o SecundÃ¡ria</div>
      <div class="stat-card-sublabel">PoliclÃ­nicas, esp...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">ğŸ¨</div>
      <div class="stat-card-value" id="statTerciaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o TerciÃ¡ria</div>
      <div class="stat-card-sublabel">Hospitais, UTI...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">ğŸš¨</div>
      <div class="stat-card-value" id="statUrgencia">â€”</div>
      <div class="stat-card-label">UrgÃªncia/EmergÃªncia</div>
      <div class="stat-card-sublabel">UPAs, PS, SAMU</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--purple);">
      <div class="stat-card-icon" style="background: var(--purple-pale); color: var(--purple);">ğŸ¤±</div>
      <div class="stat-card-value" id="statMaternidade">â€”</div>
      <div class="stat-card-label">Maternidades</div>
      <div class="stat-card-sublabel">Parto e neonatal</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--amber);">
      <div class="stat-card-icon" style="background: var(--amber-pale); color: var(--amber);">ğŸ¦´</div>
      <div class="stat-card-value" id="statTraumatologia">â€”</div>
      <div class="stat-card-label">Traumatologia</div>
      <div class="stat-card-sublabel">Ortopedia, trauma</div>
    </div>
    <div class="stat-card" style="--card-accent: #9C27B0;">
      <div class="stat-card-icon" style="background: #F3E5F5; color: #9C27B0;">ğŸ›ï¸</div>
      <div class="stat-card-value" id="statAmbulatorial">â€”</div>
      <div class="stat-card-label">Ambulatorial</div>
      <div class="stat-card-sublabel">Consultas/exames</div>
    </div>
  </div>

  <!-- â”€â”€â”€ RESULTADOS â”€â”€â”€ -->
  <div id="resultsSection">
    <div class="status-box">
      <span class="status-icon">ğŸ”</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione um estado e municÃ­pio nos filtros acima e clique em "Buscar Unidades", ou use a geolocalizaÃ§Ã£o para encontrar unidades prÃ³ximas a vocÃª.</p>
    </div>
  </div>

</div><!-- /main-wrapper -->

<footer class="footer">
  Dados obtidos em tempo real via <a href="https://apidadosabertos.saude.gov.br/cnes" target="_blank">API CNES/DATASUS</a> â€” MinistÃ©rio da SaÃºde do Brasil &nbsp;|&nbsp; SaÃºdeBR Localizador v1.0
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURAÃ‡ÃƒO & CONSTANTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CNES_API = 'https://apidadosabertos.saude.gov.br/cnes';
const IBGE_API = 'https://servicodados.ibge.gov.br/api/v1/localidades';
const MAX_UNITS_PER_CALL = 50;
const MAX_TOTAL_UNITS = 1000;

const ESTADOS = [
  {sg:'AC',nome:'Acre',co:'12'},{sg:'AL',nome:'Alagoas',co:'27'},{sg:'AP',nome:'AmapÃ¡',co:'16'},
  {sg:'AM',nome:'Amazonas',co:'13'},{sg:'BA',nome:'Bahia',co:'29'},{sg:'CE',nome:'CearÃ¡',co:'23'},
  {sg:'DF',nome:'Distrito Federal',co:'53'},{sg:'ES',nome:'EspÃ­rito Santo',co:'32'},{sg:'GO',nome:'GoiÃ¡s',co:'52'},
  {sg:'MA',nome:'MaranhÃ£o',co:'21'},{sg:'MT',nome:'Mato Grosso',co:'51'},{sg:'MS',nome:'Mato Grosso do Sul',co:'50'},
  {sg:'MG',nome:'Minas Gerais',co:'31'},{sg:'PA',nome:'ParÃ¡',co:'15'},{sg:'PB',nome:'ParaÃ­ba',co:'25'},
  {sg:'PR',nome:'ParanÃ¡',co:'41'},{sg:'PE',nome:'Pernambuco',co:'26'},{sg:'PI',nome:'PiauÃ­',co:'22'},
  {sg:'RJ',nome:'Rio de Janeiro',co:'33'},{sg:'RN',nome:'Rio Grande do Norte',co:'24'},{sg:'RS',nome:'Rio Grande do Sul',co:'43'},
  {sg:'RO',nome:'RondÃ´nia',co:'11'},{sg:'RR',nome:'Roraima',co:'14'},{sg:'SC',nome:'Santa Catarina',co:'42'},
  {sg:'SP',nome:'SÃ£o Paulo',co:'35'},{sg:'SE',nome:'Sergipe',co:'28'},{sg:'TO',nome:'Tocantins',co:'17'}
];

// Mapeamento tp_unidade â†’ nÃ­vel + acolhimento
const TP_MAP = {
  '01':{ nivel:'primaria', tags:['ambulatorial'], nome:'Posto de SaÃºde' },
  '02':{ nivel:'primaria', tags:['ambulatorial'], nome:'Centro de SaÃºde/UBS' },
  '04':{ nivel:'secundaria', tags:['ambulatorial'], nome:'PoliclÃ­nica' },
  '05':{ nivel:'terciaria', tags:['ambulatorial','urgencia'], nome:'Hospital Geral' },
  '07':{ nivel:'terciaria', tags:['ambulatorial'], nome:'Hospital Especializado' },
  '15':{ nivel:'terciaria', tags:['ambulatorial','urgencia'], nome:'Unidade Mista' },
  '20':{ nivel:'secundaria', tags:['ambulatorial'], nome:'Pronto Atendimento' },
  '21':{ nivel:'terciaria', tags:['urgencia'], nome:'Pronto Socorro Geral' },
  '22':{ nivel:'terciaria', tags:['urgencia'], nome:'Pronto Socorro Especializado' },
  '32':{ nivel:'primaria', tags:['ambulatorial'], nome:'SaÃºde IndÃ­gena' },
  '36':{ nivel:'secundaria', tags:['ambulatorial'], nome:'ClÃ­nica/Centro de Especialidade' },
  '39':{ nivel:'secundaria', tags:['ambulatorial'], nome:'Apoio Diagnose/Terapia' },
  '40':{ nivel:'primaria', tags:['urgencia'], nome:'Unidade MÃ³vel Terrestre' },
  '42':{ nivel:'primaria', tags:['urgencia'], nome:'Unidade MÃ³vel Fluvial' },
  '43':{ nivel:'primaria', tags:['ambulatorial'], nome:'FarmÃ¡cia' },
  '50':{ nivel:'primaria', tags:['ambulatorial'], nome:'VigilÃ¢ncia em SaÃºde' },
  '60':{ nivel:'primaria', tags:['ambulatorial'], nome:'Cooperativa/Empresa' },
  '61':{ nivel:'secundaria', tags:['ambulatorial'], nome:'CAPS' },
  '62':{ nivel:'terciaria', tags:['ambulatorial'], nome:'Hospital/Dia Isolado' },
  '67':{ nivel:'secundaria', tags:['ambulatorial'], nome:'LaboratÃ³rio SaÃºde PÃºblica' },
  '68':{ nivel:'secundaria', tags:['ambulatorial'], nome:'Central de RegulaÃ§Ã£o' },
  '69':{ nivel:'primaria', tags:['ambulatorial'], nome:'Centro de Apoio Ã  SaÃºde da FamÃ­lia' },
  '70':{ nivel:'secundaria', tags:['ambulatorial'], nome:'Centro Hemoterapia/Hematologia' },
  '71':{ nivel:'secundaria', tags:['ambulatorial'], nome:'Banco de Leite Humano' },
  '72':{ nivel:'secundaria', tags:['ambulatorial'], nome:'Unidade Regime Residencial' },
  '73':{ nivel:'primaria', tags:['ambulatorial'], nome:'Posto de SaÃºde Rural' },
  '74':{ nivel:'terciaria', tags:['maternidade'], nome:'Centro de Parto Normal' },
  '75':{ nivel:'terciaria', tags:['maternidade'], nome:'Hospital Maternidade' },
  '76':{ nivel:'terciaria', tags:['urgencia'], nome:'Central de RegulaÃ§Ã£o de UrgÃªncias' },
  '79':{ nivel:'secundaria', tags:['traumatologia'], nome:'Oficina OrtopÃ©dica' },
  '80':{ nivel:'secundaria', tags:['ambulatorial'], nome:'LaboratÃ³rio PrÃ³teses DentÃ¡rias' },
  '81':{ nivel:'secundaria', tags:['ambulatorial'], nome:'LaboratÃ³rio Central SaÃºde PÃºblica' },
  '82':{ nivel:'primaria', tags:['ambulatorial'], nome:'AtenÃ§Ã£o Domiciliar' },
  '83':{ nivel:'primaria', tags:['ambulatorial'], nome:'Polo Academia da SaÃºde' },
  '84':{ nivel:'primaria', tags:['ambulatorial'], nome:'Central de Abastecimento FarmacÃªutico' },
  '85':{ nivel:'primaria', tags:['ambulatorial'], nome:'Centro de ImunizaÃ§Ã£o' },
  '86':{ nivel:'secundaria', tags:['ambulatorial'], nome:'ServiÃ§o de AtenÃ§Ã£o Especializada' },
};

const NIVEL_CONFIG = {
  primaria:    { label:'AtenÃ§Ã£o PrimÃ¡ria',   color:'#00A878', bg:'#E8F8F3', pill:'#00A878', emoji:'ğŸ ' },
  secundaria:  { label:'AtenÃ§Ã£o SecundÃ¡ria',  color:'#1565C0', bg:'#E8F0FE', pill:'#1565C0', emoji:'ğŸ”¬' },
  terciaria:   { label:'AtenÃ§Ã£o TerciÃ¡ria',   color:'#E53935', bg:'#FDECEA', pill:'#E53935', emoji:'ğŸ¨' },
};

const ACOLHIMENTO_CONFIG = {
  ambulatorial: { label:'Ambulatorial',        tagClass:'unit-tag-ambulatorial', emoji:'ğŸ’Š' },
  urgencia:     { label:'UrgÃªncia/EmergÃªncia', tagClass:'unit-tag-urgencia',     emoji:'ğŸš¨' },
  maternidade:  { label:'Maternidade',          tagClass:'unit-tag-maternidade',  emoji:'ğŸ¤±' },
  traumatologia:{ label:'Traumatologia',        tagClass:'unit-tag-traumatologia',emoji:'ğŸ¦´' },
};

const GESTAO_MAP = { M:'Municipal', E:'Estadual', F:'Federal', D:'Dupla GestÃ£o' };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allUnits = [];
let filteredUnits = [];
let userLocation = null;
let geoSearchMode = false;
let currentMunicipioCode = null;
let isLoading = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INICIALIZAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  populateEstados();
});

function populateEstados() {
  const sel = document.getElementById('selectEstado');
  ESTADOS.sort((a,b) => a.nome.localeCompare(b.nome));
  ESTADOS.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e.sg;
    opt.textContent = `${e.sg} â€” ${e.nome}`;
    sel.appendChild(opt);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENTOS DE FILTRO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilter() {
  const body = document.getElementById('filterBody');
  const arrow = document.getElementById('filterArrow');
  const btn = document.getElementById('filterToggleBtn');
  const isOpen = body.classList.toggle('open');
  arrow.classList.toggle('open', isOpen);
  btn.querySelector('span').textContent = isOpen ? 'Recolher' : 'Expandir';
}

async function onEstadoChange() {
  const uf = document.getElementById('selectEstado').value;
  const sel = document.getElementById('selectMunicipio');
  sel.disabled = true;
  sel.innerHTML = '<option>Carregando municÃ­pios...</option>';
  allUnits = [];
  filteredUnits = [];
  currentMunicipioCode = null;
  geoSearchMode = false;

  if (!uf) { sel.innerHTML = '<option>â€” Selecione o estado primeiro â€”</option>'; return; }

  try {
    const resp = await fetch(`${IBGE_API}/estados/${uf}/municipios`);
    const data = await resp.json();
    data.sort((a,b) => a.nome.localeCompare(b.nome));
    sel.innerHTML = '<option value="">â€” Selecione o municÃ­pio â€”</option>';
    data.forEach(m => {
      const opt = document.createElement('option');
      opt.value = String(m.id).substring(0, 6); // 6-digit CNES code
      opt.textContent = m.nome;
      sel.appendChild(opt);
    });
    sel.disabled = false;
  } catch(e) {
    sel.innerHTML = '<option>Erro ao carregar municÃ­pios</option>';
    showNotification('Erro ao carregar municÃ­pios. Verifique sua conexÃ£o.', 'error');
  }
}

function onMunicipioChange() {
  const code = document.getElementById('selectMunicipio').value;
  currentMunicipioCode = code;
  allUnits = [];
  filteredUnits = [];
  geoSearchMode = false;
  if (code) {
    // Auto-open filter and suggest search
  }
}

function limparFiltros() {
  document.getElementById('selectEstado').value = '';
  document.getElementById('selectMunicipio').innerHTML = '<option value="">â€” Selecione o estado primeiro â€”</option>';
  document.getElementById('selectMunicipio').disabled = true;
  document.getElementById('inputBairro').value = '';
  document.getElementById('selectNivel').value = '';
  document.getElementById('selectAcolhimento').value = '';
  document.getElementById('selectGestao').value = '';
  allUnits = [];
  filteredUnits = [];
  currentMunicipioCode = null;
  geoSearchMode = false;
  userLocation = null;
  document.getElementById('geoStatus').textContent = 'Clique em "Usar Minha LocalizaÃ§Ã£o" para buscar unidades prÃ³ximas a vocÃª.';
  renderInitial();
  updateDashboard([]);
}

function applyLocalFilters() {
  if (!allUnits.length) return;
  const bairro = document.getElementById('inputBairro').value.toLowerCase().trim();
  const nivel = document.getElementById('selectNivel').value;
  const acolhimento = document.getElementById('selectAcolhimento').value;
  const gestao = document.getElementById('selectGestao').value;

  filteredUnits = allUnits.filter(u => {
    if (bairro && !(u.no_bairro || '').toLowerCase().includes(bairro)) return false;
    if (nivel && u._nivel !== nivel) return false;
    if (acolhimento && !u._tags.includes(acolhimento)) return false;
    if (gestao && u.tp_gestao !== gestao) return false;
    return true;
  });

  updateDashboard(filteredUnits);
  renderResults(filteredUnits);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUSCA PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buscarUnidades() {
  const coMunicipio = document.getElementById('selectMunicipio').value;
  if (!coMunicipio) {
    showNotification('Selecione um municÃ­pio antes de buscar.', 'error');
    return;
  }

  geoSearchMode = false;
  await fetchUnidades(coMunicipio);
}

async function fetchUnidades(coMunicipio) {
  if (isLoading) return;
  isLoading = true;

  const btnBuscar = document.getElementById('btnBuscar');
  btnBuscar.disabled = true;
  btnBuscar.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2.5px;margin:0;"></div> Buscando...';

  showLoading();
  allUnits = [];

  try {
    let offset = 0;
    let total = null;
    let progressEl = document.getElementById('progressBar');

    while (true) {
      const url = `${CNES_API}/estabelecimentos?co_municipio=${coMunicipio}&limit=${MAX_UNITS_PER_CALL}&offset=${offset}`;
      const resp = await fetch(url);

      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();

      const items = data.estabelecimentos || data.result || data.data || data || [];
      if (!Array.isArray(items) || items.length === 0) break;

      total = data.total || data.count || total;
      items.forEach(u => {
        const classified = classifyUnit(u);
        allUnits.push(classified);
      });

      offset += MAX_UNITS_PER_CALL;

      if (progressEl && total) {
        const pct = Math.min(100, Math.round((offset / total) * 100));
        progressEl.style.width = pct + '%';
        document.getElementById('loadingCount').textContent = `${allUnits.length} de ${total} unidades carregadas...`;
      }

      if (items.length < MAX_UNITS_PER_CALL || allUnits.length >= MAX_TOTAL_UNITS) break;
    }

    if (allUnits.length === 0) {
      showEmpty();
    } else {
      filteredUnits = [...allUnits];
      applyLocalFilters();
      showNotification(`âœ… ${allUnits.length} unidades carregadas com sucesso!`, 'success');
    }
  } catch(e) {
    console.error('Erro na API CNES:', e);
    showError(e.message);
    showNotification('Erro ao acessar a API CNES/DATASUS. Tente novamente.', 'error');
  } finally {
    isLoading = false;
    btnBuscar.disabled = false;
    btnBuscar.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Buscar Unidades';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOLOCALIZAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function usarGeolocalizacao() {
  if (!navigator.geolocation) {
    showNotification('GeolocalizaÃ§Ã£o nÃ£o suportada neste navegador.', 'error');
    return;
  }
  document.getElementById('geoStatus').textContent = 'ğŸ“¡ Obtendo sua localizaÃ§Ã£o...';
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      const raio = parseFloat(document.getElementById('geoRaio').value) || 3;
      document.getElementById('geoStatus').textContent = `ğŸ“ LocalizaÃ§Ã£o obtida: ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)} â€” Filtrando em ${raio}km de raio...`;
      if (allUnits.length > 0) {
        applyGeoFilter();
      } else {
        showNotification('Busque por municÃ­pio primeiro para usar o filtro de proximidade.', 'error');
        document.getElementById('geoStatus').textContent = `ğŸ“ LocalizaÃ§Ã£o obtida. Busque unidades em um municÃ­pio prÃ³ximo a vocÃª.`;
      }
    },
    err => {
      document.getElementById('geoStatus').textContent = 'âŒ NÃ£o foi possÃ­vel obter a localizaÃ§Ã£o.';
      showNotification('NÃ£o foi possÃ­vel obter sua localizaÃ§Ã£o. Permita o acesso.', 'error');
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

function applyGeoFilter() {
  const raio = parseFloat(document.getElementById('geoRaio').value) || 3;
  if (!userLocation || !allUnits.length) return;

  filteredUnits = allUnits
    .map(u => {
      const lat = parseFloat(u.nu_latitude || u.latitude);
      const lng = parseFloat(u.nu_longitude || u.longitude);
      if (!lat || !lng) return null;
      const dist = haversine(userLocation.lat, userLocation.lng, lat, lng);
      return dist <= raio ? { ...u, _distance: dist } : null;
    })
    .filter(Boolean)
    .sort((a, b) => a._distance - b._distance);

  document.getElementById('geoStatus').textContent =
    `ğŸ“ ${filteredUnits.length} unidades encontradas em atÃ© ${raio}km da sua localizaÃ§Ã£o.`;
  geoSearchMode = true;
  updateDashboard(filteredUnits);
  renderResults(filteredUnits);
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLASSIFICAÃ‡ÃƒO DE UNIDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function classifyUnit(u) {
  const tpCode = String(u.tp_unidade || '').padStart(2, '0');
  const dsDesc = (u.ds_tipo_unidade || '').toUpperCase();

  let nivel = 'primaria';
  let tags = ['ambulatorial'];
  let tipoNome = u.ds_tipo_unidade || 'Unidade de SaÃºde';

  if (TP_MAP[tpCode]) {
    nivel = TP_MAP[tpCode].nivel;
    tags = [...TP_MAP[tpCode].tags];
    tipoNome = TP_MAP[tpCode].nome;
  } else {
    // Fallback por keywords
    if (dsDesc.includes('HOSPITAL') || dsDesc.includes('UTI') || dsDesc.includes('TERAPIA INTENSIVA')) {
      nivel = 'terciaria';
      tags = ['ambulatorial', 'urgencia'];
    } else if (dsDesc.includes('PRONTO SOCORRO') || dsDesc.includes('UPA') || dsDesc.includes('URGÃŠNCIA')) {
      nivel = 'terciaria';
      tags = ['urgencia'];
    } else if (dsDesc.includes('POLICLÃNICA') || dsDesc.includes('ESPECIALIDADE') || dsDesc.includes('AMBULATÃ“RIO') || dsDesc.includes('CAPS')) {
      nivel = 'secundaria';
      tags = ['ambulatorial'];
    }
    if (dsDesc.includes('MATERNIDADE') || dsDesc.includes('MATERNO') || dsDesc.includes('PARTO')) {
      tags = [...new Set([...tags, 'maternidade'])];
    }
    if (dsDesc.includes('TRAUMA') || dsDesc.includes('ORTOPEDIA') || dsDesc.includes('ORTOPÃ‰DIC')) {
      tags = [...new Set([...tags, 'traumatologia'])];
    }
  }

  // Extra: forÃ§a pela descriÃ§Ã£o
  if (dsDesc.includes('MATERNIDADE') || dsDesc.includes('MATERNO') || dsDesc.includes('PARTO NORMAL')) {
    tags = [...new Set([...tags, 'maternidade'])];
    if (!tags.includes('urgencia')) nivel = nivel === 'primaria' ? 'terciaria' : nivel;
  }
  if (dsDesc.includes('TRAUMA') || dsDesc.includes('ORTOPEDIA')) {
    tags = [...new Set([...tags, 'traumatologia'])];
  }
  if (dsDesc.includes('URGÃŠNCIA') || dsDesc.includes('EMERGÃŠNCIA') || dsDesc.includes('PRONTO SOCORRO') || dsDesc.includes('UPA')) {
    tags = [...new Set([...tags, 'urgencia'])];
  }

  return { ...u, _nivel: nivel, _tags: tags, _tipoNome: tipoNome };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDashboard(units) {
  const counts = {
    total: units.length,
    primaria: 0, secundaria: 0, terciaria: 0,
    urgencia: 0, maternidade: 0, traumatologia: 0, ambulatorial: 0
  };
  units.forEach(u => {
    counts[u._nivel]++;
    u._tags.forEach(t => { if (counts[t] !== undefined) counts[t]++; });
  });

  Object.keys(counts).forEach(k => {
    const el = document.getElementById('stat' + k.charAt(0).toUpperCase() + k.slice(1));
    if (el) animateCount(el, counts[k]);
  });
}

function animateCount(el, target) {
  const start = parseInt(el.textContent) || 0;
  const duration = 600;
  const startTime = Date.now();
  const tick = () => {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(start + (target - start) * eased);
    if (progress < 1) requestAnimationFrame(tick);
  };
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER RESULTADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInitial() {
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box">
      <span class="status-icon">ğŸ”</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione um estado e municÃ­pio nos filtros acima e clique em "Buscar Unidades", ou use a geolocalizaÃ§Ã£o para encontrar unidades prÃ³ximas a vocÃª.</p>
    </div>`;
}

function showLoading() {
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box">
      <div class="spinner"></div>
      <h3>Consultando a API CNES/DATASUS...</h3>
      <p id="loadingCount">Aguarde enquanto os dados sÃ£o carregados em tempo real.</p>
      <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:5%"></div></div>
    </div>`;
}

function showEmpty() {
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box">
      <span class="status-icon">ğŸ“­</span>
      <h3>Nenhuma unidade encontrada</h3>
      <p>NÃ£o encontramos unidades de saÃºde para os filtros selecionados. Tente outros critÃ©rios de busca.</p>
    </div>`;
  updateDashboard([]);
}

function showError(msg) {
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box">
      <span class="status-icon">âš ï¸</span>
      <h3>Erro ao conectar Ã  API</h3>
      <p>NÃ£o foi possÃ­vel acessar a API CNES/DATASUS. Verifique sua conexÃ£o e tente novamente.<br><small style="color:var(--text-light)">${msg}</small></p>
    </div>`;
}

function renderResults(units) {
  if (!units.length) { showEmpty(); return; }

  // Group by nivel + tag
  const groups = {};
  const groupOrder = [
    { nivel:'terciaria', tag:'urgencia' },
    { nivel:'terciaria', tag:'maternidade' },
    { nivel:'terciaria', tag:'traumatologia' },
    { nivel:'terciaria', tag:'ambulatorial' },
    { nivel:'secundaria', tag:'ambulatorial' },
    { nivel:'secundaria', tag:'traumatologia' },
    { nivel:'primaria', tag:'ambulatorial' },
    { nivel:'primaria', tag:'urgencia' },
  ];

  units.forEach(u => {
    u._tags.forEach(tag => {
      const key = `${u._nivel}|${tag}`;
      if (!groups[key]) groups[key] = [];
      groups[key].push(u);
    });
  });

  const container = document.getElementById('resultsSection');

  let html = `
  <div class="results-header">
    <div>
      <span class="results-title">Unidades de SaÃºde Encontradas</span>
      <span class="results-count">${units.length} unidades</span>
    </div>
    <div class="export-row">
      <button class="btn btn-primary btn-sm" onclick="exportarExcel()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
        Exportar Excel
      </button>
      <button class="btn btn-amber btn-sm" onclick="exportarPDF()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Exportar PDF A5
      </button>
    </div>
  </div>`;

  const renderedKeys = new Set();

  groupOrder.forEach(({ nivel, tag }) => {
    const key = `${nivel}|${tag}`;
    if (!groups[key] || renderedKeys.has(key)) return;
    renderedKeys.add(key);

    const groupUnits = groups[key];
    const nConf = NIVEL_CONFIG[nivel];
    const aConf = ACOLHIMENTO_CONFIG[tag];

    html += `
    <div class="group-section nivel-${nivel}">
      <div class="group-header" onclick="toggleGroup('${key.replace('|','-')}')">
        <div class="group-header-left">
          <span style="font-size:1.5rem">${nConf.emoji} ${aConf.emoji}</span>
          <div>
            <div class="group-name">${nConf.label} â€” ${aConf.label}</div>
            <div class="group-meta">Clique para ${groupUnits.length > 0 ? 'ver / ocultar' : ''} as unidades</div>
          </div>
          <span class="group-pill" style="background:${nConf.bg};color:${nConf.color}">${nConf.label}</span>
          <span class="group-pill" style="background:${ACOLHIMENTO_CONFIG[tag] ? '#f0f0f0' : '#f0f0f0'};color:#555">${aConf.label}</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="group-count">${groupUnits.length}</div>
          <span class="group-arrow" id="arrow-${key.replace('|','-')}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
          </span>
        </div>
      </div>
      <div class="group-body" id="group-${key.replace('|','-')}">
        <div class="cards-grid">
          ${groupUnits.map(u => renderUnitCard(u, nConf, tag)).join('')}
        </div>
      </div>
    </div>`;
  });

  // Demais grupos nÃ£o cobertos
  Object.keys(groups).forEach(key => {
    if (renderedKeys.has(key)) return;
    const [nivel, tag] = key.split('|');
    const nConf = NIVEL_CONFIG[nivel] || NIVEL_CONFIG.primaria;
    const aConf = ACOLHIMENTO_CONFIG[tag] || ACOLHIMENTO_CONFIG.ambulatorial;
    const groupUnits = groups[key];

    html += `
    <div class="group-section nivel-${nivel}">
      <div class="group-header" onclick="toggleGroup('${key.replace('|','-')}')">
        <div class="group-header-left">
          <div>
            <div class="group-name">${nConf.label} â€” ${aConf.label}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="group-count">${groupUnits.length}</div>
          <span class="group-arrow" id="arrow-${key.replace('|','-')}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
          </span>
        </div>
      </div>
      <div class="group-body" id="group-${key.replace('|','-')}">
        <div class="cards-grid">
          ${groupUnits.map(u => renderUnitCard(u, nConf, tag)).join('')}
        </div>
      </div>
    </div>`;
  });

  container.innerHTML = html;
}

function renderUnitCard(u, nConf, currentTag) {
  const nome = u.no_fantasia || u.no_razao_social || 'Unidade sem nome';
  const rua = [u.ds_tipo_logradouro, u.ds_logradouro || u.no_logradouro, u.nu_endereco].filter(Boolean).join(' ');
  const bairro = u.no_bairro || '';
  const municipio = u.no_municipio || '';
  const uf = u.sg_uf || '';
  const cep = u.co_cep ? u.co_cep.replace(/(\d{5})(\d{3})/, '$1-$2') : '';
  const tel = u.nu_telefone ? formatPhone(u.nu_telefone) : '';
  const email = u.ds_email || '';
  const cnes = u.co_cnes || '';
  const gestao = GESTAO_MAP[u.tp_gestao] || u.tp_gestao || '';
  const enderecoCompleto = [rua, bairro, municipio, uf, cep].filter(Boolean).join(', ');

  const lat = parseFloat(u.nu_latitude || u.latitude || 0);
  const lng = parseFloat(u.nu_longitude || u.longitude || 0);
  const mapsQuery = encodeURIComponent(nome + ' ' + enderecoCompleto);
  const mapsUrl = lat && lng
    ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
    : `https://www.google.com/maps/search/?api=1&query=${mapsQuery}`;
  const googleSearch = `https://www.google.com/search?q=${encodeURIComponent(nome + ' ' + municipio + ' ' + uf + ' saÃºde')}`;
  const cnesUrl = cnes ? `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.faces?pk=${cnes}` : '';
  const waText = `ğŸ¥ *${nome}*\nğŸ“ ${enderecoCompleto}${tel ? '\nğŸ“ ' + tel : ''}${cnesUrl ? '\nğŸ”— ' + cnesUrl : ''}`;
  const waUrl = `https://wa.me/?text=${encodeURIComponent(waText)}`;

  const distBadge = u._distance
    ? `<span class="unit-tag unit-tag-ambulatorial unit-distance">ğŸ“ ${u._distance.toFixed(1)}km</span>`
    : '';

  return `
  <div class="unit-card">
    <div class="unit-card-accent" style="background: ${nConf.color}"></div>
    <div class="unit-card-inner">
      <div class="unit-card-header">
        <div class="unit-name">${escHtml(nome)}</div>
        <span class="unit-type-badge" style="background:${nConf.bg};color:${nConf.color}">${escHtml(u._tipoNome || u.ds_tipo_unidade || '')}</span>
      </div>
      <div class="unit-cnes">CNES: ${cnes || 'â€”'}</div>

      <div class="unit-tags">
        ${u._tags.map(t => `<span class="unit-tag ${ACOLHIMENTO_CONFIG[t]?.tagClass || ''}">${ACOLHIMENTO_CONFIG[t]?.emoji || ''} ${ACOLHIMENTO_CONFIG[t]?.label || t}</span>`).join('')}
        ${gestao ? `<span class="unit-tag unit-tag-${u.tp_gestao === 'M' ? 'municipal' : u.tp_gestao === 'E' ? 'estadual' : 'federal'}">${gestao}</span>` : ''}
        ${distBadge}
      </div>

      ${rua ? `<div class="unit-info-row"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg><span>${escHtml(rua)}${bairro ? ', ' + escHtml(bairro) : ''}</span></div>` : ''}
      ${municipio ? `<div class="unit-info-row"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg><span>${escHtml(municipio)}${uf ? ' â€” ' + uf : ''}${cep ? ' Â· CEP ' + cep : ''}</span></div>` : ''}
      ${tel ? `<div class="unit-info-row"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.63a19.79 19.79 0 01-3.07-8.67A2 2 0 012 .84h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.03a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg><span>${escHtml(tel)}</span></div>` : ''}
      ${email ? `<div class="unit-info-row"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><span>${escHtml(email)}</span></div>` : ''}

      <div class="unit-actions">
        ${cnesUrl ? `<button class="btn btn-icon" onclick="window.open('${cnesUrl}','_blank')" title="Ficha CNES/DATASUS">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        </button>` : ''}
        <button class="btn btn-icon search" onclick="window.open('${googleSearch}','_blank')" title="Google Search">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        </button>
        <button class="btn btn-icon maps" onclick="window.open('${mapsUrl}','_blank')" title="Google Maps">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
        </button>
        <button class="btn btn-icon whatsapp" onclick="window.open('${waUrl}','_blank')" title="Compartilhar no WhatsApp">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
        </button>
        ${tel ? `<a class="btn btn-icon" href="tel:${tel.replace(/\D/g,'')}" title="Ligar">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.63a19.79 19.79 0 01-3.07-8.67A2 2 0 012 .84h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.03a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
        </a>` : ''}
      </div>
    </div>
  </div>`;
}

function toggleGroup(key) {
  const body = document.getElementById('group-' + key);
  const arrow = document.getElementById('arrow-' + key);
  if (!body) return;
  const isOpen = body.classList.toggle('open');
  if (arrow) arrow.classList.toggle('open', isOpen);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarExcel() {
  if (!filteredUnits.length) { showNotification('Nenhuma unidade para exportar.', 'error'); return; }

  try {
    const wb = XLSX.utils.book_new();
    const niveisOrdem = ['terciaria','secundaria','primaria'];
    const tagsOrdem = ['urgencia','maternidade','traumatologia','ambulatorial'];

    niveisOrdem.forEach(nivel => {
      tagsOrdem.forEach(tag => {
        const units = filteredUnits.filter(u => u._nivel === nivel && u._tags.includes(tag));
        if (!units.length) return;

        const nConf = NIVEL_CONFIG[nivel];
        const aConf = ACOLHIMENTO_CONFIG[tag];
        const sheetName = `${nConf.label.substring(0,10)} - ${aConf.label.substring(0,10)}`.substring(0,31);

        const rows = [
          ['CNES','Nome / Fantasia','RazÃ£o Social','Tipo de Unidade','NÃ­vel de AtenÃ§Ã£o','Acolhimento','GestÃ£o','Logradouro','NÃºmero','Complemento','Bairro','MunicÃ­pio','UF','CEP','Telefone','E-mail','Latitude','Longitude','Link CNES','Google Maps']
        ];

        units.forEach(u => {
          const cnes = u.co_cnes || '';
          const rua = [u.ds_tipo_logradouro, u.ds_logradouro || u.no_logradouro].filter(Boolean).join(' ');
          const lat = u.nu_latitude || u.latitude || '';
          const lng = u.nu_longitude || u.longitude || '';
          const cnesUrl = cnes ? `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.faces?pk=${cnes}` : '';
          const mapsUrl = lat && lng ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}` : '';

          rows.push([
            cnes,
            u.no_fantasia || '',
            u.no_razao_social || '',
            u.ds_tipo_unidade || '',
            NIVEL_CONFIG[u._nivel]?.label || '',
            u._tags.map(t => ACOLHIMENTO_CONFIG[t]?.label || t).join(' | '),
            GESTAO_MAP[u.tp_gestao] || u.tp_gestao || '',
            rua,
            u.nu_endereco || '',
            u.ds_complemento || '',
            u.no_bairro || '',
            u.no_municipio || '',
            u.sg_uf || '',
            u.co_cep || '',
            u.nu_telefone || '',
            u.ds_email || '',
            lat,
            lng,
            cnesUrl,
            mapsUrl
          ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(rows);

        // Style header
        const range = XLSX.utils.decode_range(ws['!ref']);
        ws['!cols'] = [
          {wch:10},{wch:35},{wch:35},{wch:30},{wch:18},{wch:30},{wch:14},
          {wch:30},{wch:8},{wch:15},{wch:20},{wch:20},{wch:5},{wch:10},
          {wch:15},{wch:25},{wch:12},{wch:12},{wch:50},{wch:50}
        ];

        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      });
    });

    // Aba Resumo
    const resumoRows = [
      ['RELATÃ“RIO DE UNIDADES DE SAÃšDE PÃšBLICA â€” SaÃºdeBR / CNES-DATASUS'],
      [`Gerado em: ${new Date().toLocaleString('pt-BR')}`],
      [''],
      ['PERFIL','ACOLHIMENTO','QUANTIDADE'],
    ];
    niveisOrdem.forEach(nivel => {
      tagsOrdem.forEach(tag => {
        const count = filteredUnits.filter(u => u._nivel === nivel && u._tags.includes(tag)).length;
        if (count) resumoRows.push([NIVEL_CONFIG[nivel].label, ACOLHIMENTO_CONFIG[tag].label, count]);
      });
    });
    resumoRows.push(['','TOTAL GERAL', filteredUnits.length]);
    const wsResumo = XLSX.utils.aoa_to_sheet(resumoRows);
    wsResumo['!cols'] = [{wch:22},{wch:22},{wch:14}];
    XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');

    const munNome = document.getElementById('selectMunicipio').options[document.getElementById('selectMunicipio').selectedIndex]?.text || 'Busca';
    XLSX.writeFile(wb, `CNES_Unidades_Saude_${munNome.replace(/[^a-zA-Z0-9]/g,'_')}_${Date.now()}.xlsx`);
    showNotification('âœ… Planilha Excel exportada com sucesso!', 'success');
  } catch(e) {
    console.error(e);
    showNotification('Erro ao gerar a planilha Excel.', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT PDF A5 HORIZONTAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarPDF() {
  if (!filteredUnits.length) { showNotification('Nenhuma unidade para exportar.', 'error'); return; }

  try {
    const { jsPDF } = window.jspdf;
    // A5 landscape: 210 x 148mm
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
    const W = 210, H = 148;
    const margin = 10;

    const munNome = document.getElementById('selectMunicipio').options[document.getElementById('selectMunicipio').selectedIndex]?.text || '';
    const ufSel = document.getElementById('selectEstado').value || '';

    // â”€â”€ CAPA â”€â”€
    doc.setFillColor(11, 31, 58);
    doc.rect(0, 0, W, H, 'F');

    doc.setFillColor(0, 168, 120);
    doc.rect(0, H - 25, W, 25, 'F');

    // Cruz/logo
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(4);
    doc.line(W/2 - 12, H/2 - 28, W/2 + 12, H/2 - 28); // horizontal
    doc.line(W/2, H/2 - 40, W/2, H/2 - 16);              // vertical

    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(22);
    doc.text('SaÃºdeBR', W/2, H/2 - 4, { align: 'center' });

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(180, 230, 210);
    doc.text('Localizador de Unidades de SaÃºde PÃºblica', W/2, H/2 + 5, { align: 'center' });
    doc.text('CNES / DATASUS â€” MinistÃ©rio da SaÃºde', W/2, H/2 + 12, { align: 'center' });

    if (munNome) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.setTextColor(255, 255, 255);
      doc.text(`${munNome}${ufSel ? ' â€” ' + ufSel : ''}`, W/2, H/2 + 24, { align: 'center' });
    }

    doc.setFillColor(0, 168, 120);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    doc.setTextColor(255, 255, 255);
    doc.text(`Gerado em ${new Date().toLocaleString('pt-BR')} | Total: ${filteredUnits.length} unidades`, W/2, H - 12, { align: 'center' });

    const niveisOrdem = ['terciaria','secundaria','primaria'];
    const tagsOrdem = ['urgencia','maternidade','traumatologia','ambulatorial'];
    const nivelColors = {
      terciaria:  { r:229, g:57,  b:53  },
      secundaria: { r:21,  g:101, b:192 },
      primaria:   { r:0,   g:168, b:120 },
    };

    niveisOrdem.forEach(nivel => {
      tagsOrdem.forEach(tag => {
        const units = filteredUnits.filter(u => u._nivel === nivel && u._tags.includes(tag));
        if (!units.length) return;

        const nc = nivelColors[nivel];
        const nConf = NIVEL_CONFIG[nivel];
        const aConf = ACOLHIMENTO_CONFIG[tag];

        // â”€â”€ PÃGINA DE SEÃ‡ÃƒO â”€â”€
        doc.addPage('a5', 'landscape');
        doc.setFillColor(nc.r, nc.g, nc.b);
        doc.rect(0, 0, W, 18, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.setTextColor(255, 255, 255);
        doc.text(`${nConf.emoji} ${nConf.label}  Â·  ${aConf.emoji} ${aConf.label}`, margin, 12);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.text(`${units.length} unidades`, W - margin, 12, { align: 'right' });

        // Tabela de unidades
        const tableBody = units.map((u, idx) => {
          const rua = [u.ds_tipo_logradouro, u.ds_logradouro || u.no_logradouro, u.nu_endereco].filter(Boolean).join(' ');
          const bairro = u.no_bairro || '';
          const municipio = [u.no_municipio, u.sg_uf].filter(Boolean).join(' â€” ');
          const cep = u.co_cep ? u.co_cep.replace(/(\d{5})(\d{3})/, '$1-$2') : '';
          const tel = u.nu_telefone ? formatPhone(u.nu_telefone) : '';
          const cnes = u.co_cnes || '';

          const endereco = [rua, bairro, municipio, cep ? 'CEP ' + cep : ''].filter(Boolean).join('\n');
          const contato = [tel, u.ds_email].filter(Boolean).join('\n');
          const cnesUrl = cnes ? `cnes.datasus.gov.br/pages/estabelecimentos/ficha.faces?pk=${cnes}` : '';

          return [
            `${idx + 1}`,
            u.no_fantasia || u.no_razao_social || 'â€”',
            u.ds_tipo_unidade || 'â€”',
            GESTAO_MAP[u.tp_gestao] || 'â€”',
            endereco || 'â€”',
            contato || 'â€”',
            cnesUrl || 'â€”',
          ];
        });

        doc.autoTable({
          startY: 22,
          head: [['#','Nome / Estabelecimento','Tipo','GestÃ£o','EndereÃ§o','Contato','Link CNES']],
          body: tableBody,
          theme: 'grid',
          styles: {
            fontSize: 6.5,
            cellPadding: 2,
            overflow: 'linebreak',
            lineColor: [220, 230, 240],
            lineWidth: 0.2,
            textColor: [15, 30, 55],
            font: 'helvetica',
          },
          headStyles: {
            fillColor: [nc.r, nc.g, nc.b],
            textColor: [255,255,255],
            fontStyle: 'bold',
            fontSize: 7,
          },
          alternateRowStyles: { fillColor: [245, 248, 252] },
          columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            1: { cellWidth: 45 },
            2: { cellWidth: 30 },
            3: { cellWidth: 18 },
            4: { cellWidth: 40 },
            5: { cellWidth: 28 },
            6: { cellWidth: 35 },
          },
          margin: { left: margin, right: margin },
          didDrawPage: (data) => {
            // Header repetido em cada pÃ¡gina
            if (data.pageCount > 1) {
              doc.setFillColor(nc.r, nc.g, nc.b, 0.15);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(7);
              doc.setTextColor(nc.r, nc.g, nc.b);
              doc.text(`${nConf.label} â€” ${aConf.label} (continuaÃ§Ã£o)`, margin, 7);
            }
            // RodapÃ©
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(150, 150, 150);
            doc.text('SaÃºdeBR | CNES/DATASUS â€” MinistÃ©rio da SaÃºde', margin, H - 4);
            doc.text(`PÃ¡g. ${doc.internal.getCurrentPageInfo().pageNumber}`, W - margin, H - 4, { align: 'right' });
          }
        });
      });
    });

    const munNomeSafe = munNome.replace(/[^a-zA-Z0-9]/g, '_');
    doc.save(`SaudeBR_CNES_${munNomeSafe}_${Date.now()}.pdf`);
    showNotification('âœ… PDF A5 exportado com sucesso!', 'success');
  } catch(e) {
    console.error(e);
    showNotification('Erro ao gerar o PDF. Tente novamente.', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITÃRIOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatPhone(tel) {
  if (!tel) return '';
  const d = String(tel).replace(/\D/g, '');
  if (d.length === 11) return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`;
  if (d.length === 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;
  return tel;
}

function escHtml(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showNotification(msg, type='info') {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  const n = document.createElement('div');
  n.className = `notification ${type}`;
  n.innerHTML = `<span>${msg}</span>`;
  document.body.appendChild(n);
  setTimeout(() => { n.style.opacity='0'; n.style.transform='translateX(30px)'; n.style.transition='all 0.3s'; setTimeout(()=>n.remove(),300); }, 3500);
}
</script>
</body>
</html>

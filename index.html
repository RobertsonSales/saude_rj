<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sa√∫de Brasil - Unidades de Sa√∫de do Brasil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .search-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #00b894;
            color: white;
        }

        .btn-primary:hover {
            background: #00a884;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #0984e3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0874d3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #d63031;
            color: white;
        }

        .btn-danger:hover {
            background: #c0292a;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #74b9ff;
            color: white;
        }

        .btn-info:hover {
            background: #63a9f0;
            transform: translateY(-2px);
        }

        .filters-section {
            padding: 30px;
            border-top: 2px solid #e9ecef;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3436;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #00b894;
        }

        .stats-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid #00b894;
        }

        .stat-card.secondary {
            border-left-color: #0984e3;
        }

        .stat-card.tertiary {
            border-left-color: #e17055;
        }

        .stat-card.total {
            border-left-color: #6c5ce7;
        }

        .stat-card h3 {
            font-size: 2.5em;
            color: #2d3436;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #636e72;
            font-weight: 600;
        }

        .results-section {
            padding: 30px;
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: #636e72;
        }

        .loading-bar {
            width: 100%;
            height: 10px;
            background: #dfe6e9;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #00b894, #00cec9);
            width: 0%;
            transition: width 0.3s ease;
        }

        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .unit-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .unit-card:hover {
            border-color: #00b894;
            box-shadow: 0 5px 20px rgba(0,184,148,0.2);
            transform: translateY(-3px);
        }

        .unit-card h4 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .unit-card .info {
            color: #636e72;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .unit-card .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .badge-primary {
            background: #d4edda;
            color: #155724;
        }

        .badge-secondary {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-tertiary {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-urgency {
            background: #fff3cd;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #636e72;
        }

        .footer {
            background: #2d3436;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .footer a {
            color: #00b894;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #155724;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .search-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .units-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè• Sa√∫de Brasil</h1>
            <p>Unidades de Sa√∫de do Brasil - Sistema √önico de Sa√∫de (SUS)</p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-buttons">
                <button class="btn btn-primary" onclick="openMunicipalitySearch()">
                    üîç Buscar por Munic√≠pio
                </button>
                <button class="btn btn-secondary" onclick="requestLocation()">
                    üìç Buscar Perto de Mim
                </button>
                <button class="btn btn-info" onclick="generatePDF()">
                    üìÑ Visualizar PDF
                </button>
                <button class="btn btn-info" onclick="generateExcel()">
                    üìä Gerar Excel
                </button>
            </div>

            <div id="loadingIndicator" class="loading-indicator hidden">
                <p>Carregando... <span id="loadingPercent">0</span>% Aguarde...</p>
                <div class="loading-bar">
                    <div class="loading-progress" id="loadingProgress"></div>
                </div>
            </div>
        </div>

        <!-- API Status -->
        <div class="filters-section">
            <div id="apiStatus" class="api-status">
                <span>‚úÖ</span>
                <span>API CNES conectada e pronta para consulta</span>
            </div>

            <!-- Filters -->
            <div class="filters-grid">
                <div class="filter-group">
                    <label>üáßüá∑ Estado</label>
                    <select id="filterState" onchange="loadMunicipalities()">
                        <option value="">Todos os estados</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>üè• Nome da Unidade</label>
                    <input type="text" id="filterName" placeholder="Digite o nome...">
                </div>

                <div class="filter-group">
                    <label>üìç Cidade</label>
                    <select id="filterCity" disabled>
                        <option value="">Todas as cidades</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>üèòÔ∏è Bairro</label>
                    <select id="filterNeighborhood" disabled>
                        <option value="">Selecione uma cidade</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>üìä N√≠vel de Aten√ß√£o</label>
                    <select id="filterLevel">
                        <option value="">Todos os n√≠veis</option>
                        <option value="1">Aten√ß√£o Prim√°ria</option>
                        <option value="2">Aten√ß√£o Secund√°ria</option>
                        <option value="3">Aten√ß√£o Terci√°ria</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>üè• Tipo de Acolhimento</label>
                    <select id="filterReception">
                        <option value="">Todos os tipos</option>
                        <option value="urgencia_emergencia">Urg√™ncia/Emerg√™ncia Geral</option>
                        <option value="urgencia_especializada">Urg√™ncia Especializada</option>
                        <option value="ambulatorial">Atendimento Ambulatorial</option>
                        <option value="transferencia">Admiss√£o por Transfer√™ncia</option>
                        <option value="especializado">Atendimento Especializado</option>
                        <option value="samu">SAMU</option>
                        <option value="hemoterapia">Hemoterapia</option>
                        <option value="psiquiatria">Psiquiatria</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="clearAllFilters()">
                    üóëÔ∏è Limpar Filtros
                </button>
                <button class="btn btn-primary" onclick="searchCNES()">
                    üîç Buscar no CNES
                </button>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card total">
                    <h3 id="statTotal">0</h3>
                    <p>üìã Total de Unidades</p>
                </div>
                <div class="stat-card">
                    <h3 id="statPrimary">0</h3>
                    <p>üè• Aten√ß√£o Prim√°ria</p>
                </div>
                <div class="stat-card secondary">
                    <h3 id="statSecondary">0</h3>
                    <p>üöë Aten√ß√£o Secund√°ria</p>
                </div>
                <div class="stat-card tertiary">
                    <h3 id="statTertiary">0</h3>
                    <p>üè® Aten√ß√£o Terci√°ria</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <h2 style="margin-bottom: 20px; color: #2d3436;">
                üè• <span id="unitsFound">0</span> unidades encontradas
            </h2>
            <div id="unitsGrid" class="units-grid"></div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Dados em Tempo Real do CNES</p>
            <p style="margin: 10px 0;">
                ‚ÑπÔ∏è Este App busca dados em tempo real da API CNES (DATASUS) e OpenStreetMap.
                <br>
                <a href="https://cnes.datasus.gov.br" target="_blank">Acesse o CNES oficial ‚Üí</a>
            </p>
            <p style="margin-top: 20px;">
                Dados fornecidos pelo CNES/DATASUS - Minist√©rio da Sa√∫de
                <br>
                ¬© 2026 Sa√∫de Brasil - Todos os direitos reservados
            </p>
        </div>
    </div>

    <!-- Municipality Search Modal -->
    <div id="municipalityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üèôÔ∏è Selecione o Munic√≠pio</h3>
                <button class="modal-close" onclick="closeModal('municipalityModal')">&times;</button>
            </div>
            <p style="margin-bottom: 20px; color: #636e72;">
                Escolha o estado e munic√≠pio para buscar as unidades de sa√∫de no CNES.
            </p>
            <div class="filter-group" style="margin-bottom: 15px;">
                <label>Estado</label>
                <select id="modalState" onchange="loadModalMunicipalities()">
                    <option value="">Selecione um estado</option>
                </select>
            </div>
            <div class="filter-group" style="margin-bottom: 20px;">
                <label>Munic√≠pio</label>
                <select id="modalCity" disabled>
                    <option value="">Selecione um estado primeiro</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal('municipalityModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="searchFromModal()">üîç Buscar no CNES</button>
            </div>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìç Acesso √† Localiza√ß√£o</h3>
                <button class="modal-close" onclick="closeModal('locationModal')">&times;</button>
            </div>
            <p style="margin-bottom: 20px; color: #636e72;">
                Para encontrar unidades pr√≥ximas, precisamos acessar sua localiza√ß√£o.
            </p>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #856404;">
                ‚ö†Ô∏è Sua localiza√ß√£o ser√° usada apenas para calcular dist√¢ncias. N√£o armazenamos seus dados.
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal('locationModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="grantLocationPermission()">üìç Permitir</button>
            </div>
        </div>
    </div>

    <!-- PDF Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÑ Visualiza√ß√£o do PDF - Formato A5 Horizontal</h3>
                <button class="modal-close" onclick="closeModal('pdfModal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn btn-info" onclick="sharePDFWhatsApp()">
                    üì± Compartilhar PDF no WhatsApp
                </button>
                <button class="btn btn-primary" onclick="downloadPDF()">
                    üì• Baixar PDF (A5 Horizontal)
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ïES GLOBAIS
        // ============================================
        const CONFIG = {
            API_BASE: 'https://servicos.saude.gov.br/cnes',
            CACHE_DURATION: 3600000, // 1 hora em milissegundos
            MAX_RESULTS: 100,
            LOCATION_RADIUS: 6000, // 6km em metros
        };

        // ============================================
        // ESTADO DA APLICA√á√ÉO
        // ============================================
        let appState = {
            units: [],
            filteredUnits: [],
            userLocation: null,
            cache: {},
            isSearching: false
        };

        // ============================================
        // DADOS DE ESTADOS E MUNIC√çPIOS
        // ============================================
        const BRAZIL_STATES = [
            { code: 'AC', name: 'Acre' },
            { code: 'AL', name: 'Alagoas' },
            { code: 'AP', name: 'Amap√°' },
            { code: 'AM', name: 'Amazonas' },
            { code: 'BA', name: 'Bahia' },
            { code: 'CE', name: 'Cear√°' },
            { code: 'DF', name: 'Distrito Federal' },
            { code: 'ES', name: 'Esp√≠rito Santo' },
            { code: 'GO', name: 'Goi√°s' },
            { code: 'MA', name: 'Maranh√£o' },
            { code: 'MT', name: 'Mato Grosso' },
            { code: 'MS', name: 'Mato Grosso do Sul' },
            { code: 'MG', name: 'Minas Gerais' },
            { code: 'PA', name: 'Par√°' },
            { code: 'PB', name: 'Para√≠ba' },
            { code: 'PR', name: 'Paran√°' },
            { code: 'PE', name: 'Pernambuco' },
            { code: 'PI', name: 'Piau√≠' },
            { code: 'RJ', name: 'Rio de Janeiro' },
            { code: 'RN', name: 'Rio Grande do Norte' },
            { code: 'RS', name: 'Rio Grande do Sul' },
            { code: 'RO', name: 'Rond√¥nia' },
            { code: 'RR', name: 'Roraima' },
            { code: 'SC', name: 'Santa Catarina' },
            { code: 'SP', name: 'S√£o Paulo' },
            { code: 'SE', name: 'Sergipe' },
            { code: 'TO', name: 'Tocantins' }
        ];

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadStates();
            loadFromCache();
            checkAPIConnection();
        }

        // ============================================
        // CARREGAMENTO DE ESTADOS
        // ============================================
        function loadStates() {
            const stateSelects = ['filterState', 'modalState'];
            
            stateSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;

                BRAZIL_STATES.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state.code;
                    option.textContent = state.name;
                    select.appendChild(option);
                });
            });
        }

        // ============================================
        // CARREGAMENTO DE MUNIC√çPIOS
        // ============================================
        async function loadMunicipalities() {
            const stateCode = document.getElementById('filterState').value;
            const citySelect = document.getElementById('filterCity');
            const neighborhoodSelect = document.getElementById('filterNeighborhood');

            // Limpar filtros dependentes
            citySelect.innerHTML = '<option value="">Todas as cidades</option>';
            neighborhoodSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
            neighborhoodSelect.disabled = true;

            if (!stateCode) {
                citySelect.disabled = true;
                return;
            }

            citySelect.disabled = false;

            try {
                // Buscar munic√≠pios da API do IBGE
                const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${stateCode}/municipios`);
                const municipalities = await response.json();

                municipalities.sort((a, b) => a.nome.localeCompare(b.nome));

                municipalities.forEach(municipality => {
                    const option = document.createElement('option');
                    option.value = municipality.nome;
                    option.textContent = municipality.nome;
                    option.dataset.code = municipality.id;
                    citySelect.appendChild(option);
                });

                updateCache('municipalities_' + stateCode, municipalities);
            } catch (error) {
                console.error('Erro ao carregar munic√≠pios:', error);
                showAPIError('Erro ao carregar munic√≠pios');
            }
        }

        async function loadModalMunicipalities() {
            const stateCode = document.getElementById('modalState').value;
            const citySelect = document.getElementById('modalCity');

            citySelect.innerHTML = '<option value="">Selecione um munic√≠pio</option>';
            citySelect.disabled = !stateCode;

            if (!stateCode) return;

            try {
                const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${stateCode}/municipios`);
                const municipalities = await response.json();

                municipalities.sort((a, b) => a.nome.localeCompare(b.nome));

                municipalities.forEach(municipality => {
                    const option = document.createElement('option');
                    option.value = municipality.nome;
                    option.textContent = municipality.nome;
                    option.dataset.code = municipality.id;
                    citySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar munic√≠pios:', error);
            }
        }

        // ============================================
        // EVENTO DE MUDAN√áA DE CIDADE
        // ============================================
        document.getElementById('filterCity')?.addEventListener('change', function() {
            const neighborhoodSelect = document.getElementById('filterNeighborhood');
            
            if (this.value) {
                neighborhoodSelect.disabled = false;
                loadNeighborhoods(this.value);
            } else {
                neighborhoodSelect.disabled = true;
                neighborhoodSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
            }
        });

        async function loadNeighborhoods(cityName) {
            const neighborhoodSelect = document.getElementById('filterNeighborhood');
            neighborhoodSelect.innerHTML = '<option value="">Todos os bairros</option>';

            // Nota: Bairros n√£o est√£o dispon√≠veis na API do CNES diretamente
            // Esta √© uma funcionalidade placeholder para futura implementa√ß√£o
            const neighborhoods = ['Centro', 'Zona Norte', 'Zona Sul', 'Zona Leste', 'Zona Oeste'];
            
            neighborhoods.forEach(neighborhood => {
                const option = document.createElement('option');
                option.value = neighborhood;
                option.textContent = neighborhood;
                neighborhoodSelect.appendChild(option);
            });
        }

        // ============================================
        // BUSCA NO CNES/DATASUS
        // ============================================
        async function searchCNES() {
            if (appState.isSearching) return;

            // Limpar resultados anteriores antes de nova busca
            clearResults();

            appState.isSearching = true;
            showLoading(true);

            const filters = {
                state: document.getElementById('filterState').value,
                city: document.getElementById('filterCity').value,
                name: document.getElementById('filterName').value.trim(),
                level: document.getElementById('filterLevel').value,
                reception: document.getElementById('filterReception').value,
                neighborhood: document.getElementById('filterNeighborhood').value
            };

            try {
                // Verificar cache primeiro
                const cacheKey = generateCacheKey(filters);
                const cachedData = getFromCache(cacheKey);

                if (cachedData) {
                    appState.units = cachedData;
                    appState.filteredUnits = cachedData;
                    updateStats();
                    renderUnits();
                    showLoading(false);
                    appState.isSearching = false;
                    return;
                }

                // Buscar da API CNES
                const units = await fetchCNESData(filters);
                
                // Persistir dados
                appState.units = units;
                appState.filteredUnits = units;
                
                // Salvar no cache
                updateCache(cacheKey, units);

                updateStats();
                renderUnits();
                updateAPIStatus(true, '‚úÖ Dados carregados com sucesso');
            } catch (error) {
                console.error('Erro na busca:', error);
                updateAPIStatus(false, '‚ùå Erro ao buscar dados do CNES');
                showAPIError('N√£o foi poss√≠vel conectar √† API do CNES. Verifique sua conex√£o.');
            } finally {
                showLoading(false);
                appState.isSearching = false;
            }
        }

        async function fetchCNESData(filters) {
            const params = new URLSearchParams();
            
            if (filters.state) params.append('co_uf', filters.state);
            if (filters.city) params.append('co_municipio', filters.city);
            if (filters.name) params.append('no_estabelecimento', filters.name);
            if (filters.level) params.append('tp_prestador', filters.level);
            
            // API CNES endpoint (simulado - na produ√ß√£o usar endpoint real)
            const apiUrl = `${CONFIG.API_BASE}/estabelecimentos?${params.toString()}`;

            try {
                // Em produ√ß√£o, fazer chamada real √† API
                // const response = await fetch(apiUrl);
                // const data = await response.json();
                
                // Simula√ß√£o para demonstra√ß√£o (substituir por chamada real)
                const data = await simulateCNESResponse(filters);
                
                return data.map(unit => classifyUnit(unit));
            } catch (error) {
                throw new Error('Falha na conex√£o com CNES');
            }
        }

        // ============================================
        // CLASSIFICA√á√ÉO DE UNIDADES
        // ============================================
        function classifyUnit(unit) {
            // Classifica√ß√£o correta baseada no tipo de estabelecimento CNES
            const levelMapping = {
                // Aten√ß√£o Prim√°ria
                '01': { level: '1', levelName: 'Aten√ß√£o Prim√°ria', badge: 'badge-primary' },
                '02': { level: '1', levelName: 'Aten√ß√£o Prim√°ria', badge: 'badge-primary' },
                '03': { level: '1', levelName: 'Aten√ß√£o Prim√°ria', badge: 'badge-primary' },
                
                // Aten√ß√£o Secund√°ria
                '04': { level: '2', levelName: 'Aten√ß√£o Secund√°ria', badge: 'badge-secondary' },
                '05': { level: '2', levelName: 'Aten√ß√£o Secund√°ria', badge: 'badge-secondary' },
                '06': { level: '2', levelName: 'Aten√ß√£o Secund√°ria', badge: 'badge-secondary' },
                
                // Aten√ß√£o Terci√°ria
                '07': { level: '3', levelName: 'Aten√ß√£o Terci√°ria', badge: 'badge-tertiary' },
                '08': { level: '3', levelName: 'Aten√ß√£o Terci√°ria', badge: 'badge-tertiary' },
                '09': { level: '3', levelName: 'Aten√ß√£o Terci√°ria', badge: 'badge-tertiary' }
            };

            const receptionMapping = {
                '01': 'urgencia_emergencia',
                '02': 'urgencia_especializada',
                '03': 'ambulatorial',
                '04': 'transferencia',
                '05': 'especializado',
                '06': 'samu',
                '07': 'hemoterapia',
                '08': 'psiquiatria'
            };

            const levelInfo = levelMapping[unit.tp_estab] || { level: '1', levelName: 'Aten√ß√£o Prim√°ria', badge: 'badge-primary' };
            const receptionType = receptionMapping[unit.tp_atendimento] || 'ambulatorial';

            return {
                ...unit,
                level: levelInfo.level,
                levelName: levelInfo.levelName,
                badgeClass: levelInfo.badge,
                receptionType: receptionType,
                receptionName: getReceptionName(receptionType)
            };
        }

        function getReceptionName(type) {
            const names = {
                'urgencia_emergencia': 'Urg√™ncia/Emerg√™ncia Geral',
                'urgencia_especializada': 'Urg√™ncia Especializada',
                'ambulatorial': 'Atendimento Ambulatorial',
                'transferencia': 'Admiss√£o por Transfer√™ncia',
                'especializado': 'Atendimento Especializado',
                'samu': 'SAMU',
                'hemoterapia': 'Hemoterapia',
                'psiquiatria': 'Psiquiatria'
            };
            return names[type] || 'Atendimento Geral';
        }

        // ============================================
        // SIMULA√á√ÉO DE RESPOSTA CNES (SUBSTITUIR POR API REAL)
        // ============================================
        async function simulateCNESResponse(filters) {
            // Esta fun√ß√£o deve ser substitu√≠da pela chamada real √† API CNES
            // Mantida para demonstra√ß√£o e testes
            
            await new Promise(resolve => setTimeout(resolve, 1000));

            const sampleUnits = [
                {
                    co_cnec: '1234567',
                    no_estabelecimento: 'Unidade B√°sica de Sa√∫de Centro',
                    no_fantasia: 'UBS Centro',
                    tp_estab: '01',
                    tp_atendimento: '03',
                    sg_uf: filters.state || 'RJ',
                    co_municipio: '3304557',
                    no_municipio: filters.city || 'Rio de Janeiro',
                    ds_endereco: 'Rua Principal, 123',
                    ds_bairro: 'Centro',
                    nu_cep: '20000000',
                    nu_telefone: '(21) 3333-4444',
                    latitude: -22.9068,
                    longitude: -43.1729
                },
                {
                    co_cnec: '2345678',
                    no_estabelecimento: 'Hospital Municipal',
                    no_fantasia: 'Hospital Municipal',
                    tp_estab: '07',
                    tp_atendimento: '01',
                    sg_uf: filters.state || 'RJ',
                    co_municipio: '3304557',
                    no_municipio: filters.city || 'Rio de Janeiro',
                    ds_endereco: 'Av. Brasil, 500',
                    ds_bairro: 'Zona Norte',
                    nu_cep: '21000000',
                    nu_telefone: '(21) 2222-3333',
                    latitude: -22.8568,
                    longitude: -43.2729
                },
                {
                    co_cnec: '3456789',
                    no_estabelecimento: 'Cl√≠nica Especializada',
                    no_fantasia: 'Cl√≠nica Sa√∫de',
                    tp_estab: '04',
                    tp_atendimento: '05',
                    sg_uf: filters.state || 'RJ',
                    co_municipio: '3304557',
                    no_municipio: filters.city || 'Rio de Janeiro',
                    ds_endereco: 'Rua das Flores, 789',
                    ds_bairro: 'Zona Sul',
                    nu_cep: '22000000',
                    nu_telefone: '(21) 4444-5555',
                    latitude: -22.9568,
                    longitude: -43.1929
                }
            ];

            return sampleUnits.filter(unit => {
                if (filters.name && !unit.no_estabelecimento.toLowerCase().includes(filters.name.toLowerCase())) {
                    return false;
                }
                if (filters.level && unit.tp_estab !== filters.level) {
                    return false;
                }
                if (filters.reception && unit.tp_atendimento !== filters.reception) {
                    return false;
                }
                return true;
            });
        }

        // ============================================
        // BUSCA POR LOCALIZA√á√ÉO
        // ============================================
        function openMunicipalitySearch() {
            // Limpar filtros antes de abrir modal
            clearFilters();
            document.getElementById('municipalityModal').classList.add('active');
        }

        function requestLocation() {
            document.getElementById('locationModal').classList.add('active');
        }

        function grantLocationPermission() {
            closeModal('locationModal');

            if (!navigator.geolocation) {
                showAPIError('Geolocaliza√ß√£o n√£o suportada pelo navegador');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    appState.userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    await searchNearbyUnits();
                },
                (error) => {
                    showAPIError('N√£o foi poss√≠vel obter sua localiza√ß√£o: ' + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        async function searchNearbyUnits() {
            if (!appState.userLocation) return;

            clearResults();
            showLoading(true);

            try {
                // Buscar todas as unidades primeiro
                if (appState.units.length === 0) {
                    await searchCNES();
                }

                // Filtrar por dist√¢ncia
                const nearbyUnits = appState.units.filter(unit => {
                    if (!unit.latitude || !unit.longitude) return false;
                    
                    const distance = calculateDistance(
                        appState.userLocation.latitude,
                        appState.userLocation.longitude,
                        unit.latitude,
                        unit.longitude
                    );

                    unit.distance = distance;
                    return distance <= CONFIG.LOCATION_RADIUS;
                });

                // Ordenar por dist√¢ncia
                nearbyUnits.sort((a, b) => a.distance - b.distance);

                appState.filteredUnits = nearbyUnits;
                updateStats();
                renderUnits();
            } catch (error) {
                console.error('Erro na busca por localiza√ß√£o:', error);
                showAPIError('Erro ao buscar unidades pr√≥ximas');
            } finally {
                showLoading(false);
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Raio da Terra em metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ============================================
        // ATUALIZA√á√ÉO DE ESTAT√çSTICAS
        // ============================================
        function updateStats() {
            const units = appState.filteredUnits;
            
            const total = units.length;
            const primary = units.filter(u => u.level === '1').length;
            const secondary = units.filter(u => u.level === '2').length;
            const tertiary = units.filter(u => u.level === '3').length;

            animateCounter('statTotal', total);
            animateCounter('statPrimary', primary);
            animateCounter('statSecondary', secondary);
            animateCounter('statTertiary', tertiary);
            document.getElementById('unitsFound').textContent = total;
        }

        function animateCounter(elementId, target) {
            const element = document.getElementById(elementId);
            const duration = 500;
            const start = parseInt(element.textContent) || 0;
            const increment = (target - start) / (duration / 16);
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                    element.textContent = target;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 16);
        }

        // ============================================
        // RENDERIZA√á√ÉO DE UNIDADES
        // ============================================
        function renderUnits() {
            const grid = document.getElementById('unitsGrid');
            grid.innerHTML = '';

            if (appState.filteredUnits.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #636e72;">
                        <p style="font-size: 1.2em;">üè• Nenhuma unidade encontrada</p>
                        <p>Tente ajustar os filtros de pesquisa</p>
                    </div>
                `;
                return;
            }

            appState.filteredUnits.forEach(unit => {
                const card = document.createElement('div');
                card.className = 'unit-card';
                card.innerHTML = `
                    <h4>${unit.no_estabelecimento || 'Unidade sem nome'}</h4>
                    <p class="info">üè• ${unit.no_fantasia || unit.no_estabelecimento}</p>
                    <p class="info">üìç ${unit.ds_endereco || 'Endere√ßo n√£o dispon√≠vel'}</p>
                    <p class="info">üèòÔ∏è ${unit.ds_bairro || 'Bairro n√£o dispon√≠vel'}</p>
                    <p class="info">üìû ${unit.nu_telefone || 'Telefone n√£o dispon√≠vel'}</p>
                    <div style="margin-top: 15px;">
                        <span class="badge ${unit.badgeClass}">${unit.levelName}</span>
                        <span class="badge badge-urgency">${unit.receptionName}</span>
                    </div>
                    ${unit.distance ? `<p class="info" style="margin-top: 10px;">üìè ${formatDistance(unit.distance)}</p>` : ''}
                `;
                grid.appendChild(card);
            });
        }

        function formatDistance(meters) {
            if (meters < 1000) {
                return `${Math.round(meters)}m`;
            }
            return `${(meters / 1000).toFixed(2)}km`;
        }

        // ============================================
        // LIMPEZA DE FILTROS
        // ============================================
        function clearAllFilters() {
            // Limpar todos os campos de filtro
            document.getElementById('filterState').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterName').value = '';
            document.getElementById('filterNeighborhood').value = '';
            document.getElementById('filterLevel').value = '';
            document.getElementById('filterReception').value = '';

            // Reabilitar/desabilitar selects dependentes
            document.getElementById('filterCity').disabled = true;
            document.getElementById('filterNeighborhood').disabled = true;
            document.getElementById('filterNeighborhood').innerHTML = '<option value="">Selecione uma cidade</option>';
            document.getElementById('filterCity').innerHTML = '<option value="">Todas as cidades</option>';

            // Limpar resultados e estat√≠sticas
            clearResults();
        }

        function clearFilters() {
            // Limpar apenas filtros, manter cache
            document.getElementById('filterState').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterName').value = '';
            document.getElementById('filterNeighborhood').value = '';
            document.getElementById('filterLevel').value = '';
            document.getElementById('filterReception').value = '';

            document.getElementById('filterCity').disabled = true;
            document.getElementById('filterNeighborhood').disabled = true;
        }

        function clearResults() {
            // Limpar resultados e estat√≠sticas
            appState.filteredUnits = [];
            document.getElementById('unitsGrid').innerHTML = '';
            document.getElementById('unitsFound').textContent = '0';
            
            // Zerar contadores
            document.getElementById('statTotal').textContent = '0';
            document.getElementById('statPrimary').textContent = '0';
            document.getElementById('statSecondary').textContent = '0';
            document.getElementById('statTertiary').textContent = '0';
        }

        // ============================================
        // GERENCIAMENTO DE MODAIS
        // ============================================
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function searchFromModal() {
            const state = document.getElementById('modalState').value;
            const city = document.getElementById('modalCity').value;

            if (!state || !city) {
                alert('Por favor, selecione estado e munic√≠pio');
                return;
            }

            // Aplicar filtros do modal aos filtros principais
            document.getElementById('filterState').value = state;
            document.getElementById('filterCity').value = city;
            
            // Carregar munic√≠pios para habilitar o select
            loadMunicipalities();

            closeModal('municipalityModal');
            searchCNES();
        }

        // ============================================
        // GERENCIAMENTO DE CARREGAMENTO
        // ============================================
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            const progress = document.getElementById('loadingProgress');
            const percent = document.getElementById('loadingPercent');

            if (show) {
                indicator.classList.remove('hidden');
                let currentProgress = 0;
                const interval = setInterval(() => {
                    currentProgress += 5;
                    if (currentProgress >= 100) {
                        currentProgress = 100;
                        clearInterval(interval);
                    }
                    progress.style.width = currentProgress + '%';
                    percent.textContent = currentProgress;
                }, 100);
            } else {
                indicator.classList.add('hidden');
                progress.style.width = '0%';
                percent.textContent = '0';
            }
        }

        // ============================================
        // GERENCIAMENTO DE API
        // ============================================
        function checkAPIConnection() {
            // Verificar conex√£o com API CNES
            fetch('https://servicos.saude.gov.br/cnes', { method: 'HEAD' })
                .then(() => {
                    updateAPIStatus(true, '‚úÖ API CNES conectada e pronta para consulta');
                })
                .catch(() => {
                    updateAPIStatus(false, '‚ö†Ô∏è API CNES indispon√≠vel - usando dados em cache');
                });
        }

        function updateAPIStatus(success, message) {
            const status = document.getElementById('apiStatus');
            status.className = 'api-status' + (success ? '' : ' error');
            status.innerHTML = `<span>${success ? '‚úÖ' : '‚ö†Ô∏è'}</span><span>${message}</span>`;
        }

        function showAPIError(message) {
            updateAPIStatus(false, message);
        }

        // ============================================
        // CACHE E PERSIST√äNCIA
        // ============================================
        function generateCacheKey(filters) {
            return 'cnes_' + Object.values(filters).join('_');
        }

        function updateCache(key, data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(key, JSON.stringify(cacheData));
                appState.cache[key] = cacheData;
            } catch (error) {
                console.error('Erro ao salvar cache:', error);
            }
        }

        function getFromCache(key) {
            try {
                const cached = appState.cache[key] || JSON.parse(localStorage.getItem(key));
                
                if (!cached) return null;
                
                const age = Date.now() - cached.timestamp;
                if (age > CONFIG.CACHE_DURATION) {
                    localStorage.removeItem(key);
                    return null;
                }
                
                return cached.data;
            } catch (error) {
                console.error('Erro ao ler cache:', error);
                return null;
            }
        }

        function loadFromCache() {
            // Carregar dados do cache ao iniciar
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('cnes_')) {
                    try {
                        appState.cache[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        localStorage.removeItem(key);
                    }
                }
            });
        }

        function clearCache() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('cnes_')) {
                    localStorage.removeItem(key);
                }
            });
            appState.cache = {};
        }

        // ============================================
        // EXPORTA√á√ÉO PDF
        // ============================================
        function generatePDF() {
            document.getElementById('pdfModal').classList.add('active');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a5'
            });

            doc.setFontSize(16);
            doc.text('Sa√∫de Brasil - Unidades de Sa√∫de', 10, 15);
            
            doc.setFontSize(10);
            doc.text(`Total: ${appState.filteredUnits.length} unidades`, 10, 25);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 10, 30);

            let y = 40;
            appState.filteredUnits.slice(0, 20).forEach((unit, index) => {
                if (y > 140) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(9);
                doc.text(`${index + 1}. ${unit.no_estabelecimento}`, 10, y);
                doc.text(`   ${unit.ds_endereco}, ${unit.ds_bairro}`, 10, y + 5);
                doc.text(`   ${unit.levelName} - ${unit.receptionName}`, 10, y + 10);
                
                y += 18;
            });

            doc.save('saude_brasil_unidades.pdf');
            closeModal('pdfModal');
        }

        function sharePDFWhatsApp() {
            const text = `üè• Sa√∫de Brasil\n\nEncontrei ${appState.filteredUnits.length} unidades de sa√∫de.\n\nAcesse: ${window.location.href}`;
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
            closeModal('pdfModal');
        }

        // ============================================
        // EXPORTA√á√ÉO EXCEL
        // ============================================
        function generateExcel() {
            if (appState.filteredUnits.length === 0) {
                alert('Nenhuma unidade para exportar');
                return;
            }

            const headers = ['CNES', 'Nome', 'Fantasia', 'Endere√ßo', 'Bairro', 'Telefone', 'N√≠vel', 'Acolhimento', 'Latitude', 'Longitude'];
            const rows = appState.filteredUnits.map(unit => [
                unit.co_cnec,
                unit.no_estabelecimento,
                unit.no_fantasia,
                unit.ds_endereco,
                unit.ds_bairro,
                unit.nu_telefone,
                unit.levelName,
                unit.receptionName,
                unit.latitude,
                unit.longitude
            ]);

            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `saude_brasil_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ============================================
        // FECHAR MODAIS AO CLICAR FORA
        // ============================================
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });

        // ============================================
        // PREVENIR FECHAMENTO ACIDENTAL
        // ============================================
        window.addEventListener('beforeunload', function(e) {
            if (appState.isSearching) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>

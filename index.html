<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sa√∫deBR ‚Äî Localizador CNES de Unidades de Sa√∫de P√∫blica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* HEADER */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* MAIN LAYOUT */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* FILTER PANEL */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      box-shadow: 0 0 0 3px rgba(0,168,120,0.15);
    }
    select.form-control { cursor: pointer; }

    /* GEOLOCATION PANEL */
    .geo-panel {
      background: var(--blue-pale);
      border: 1px solid var(--blue);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 16px;
    }
    .geo-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--blue);
      margin-bottom: 8px;
    }
    .geo-controls {
      display: flex;
      gap: 12px;
      align-items: end;
      flex-wrap: wrap;
    }
    .geo-status {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* BUTTONS */
    .btn {
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      font-size: 0.88rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .btn-primary {
      background: var(--teal);
      color: #FFFFFF;
      box-shadow: 0 2px 8px rgba(0,168,120,0.3);
    }
    .btn-primary:hover { background: var(--teal-light); box-shadow: 0 4px 12px rgba(0,168,120,0.4); }
    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--surface); }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }

    /* RESULTS SECTION */
    .results-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .results-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .results-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 20px;
    }

    /* UNIT CARDS */
    .unit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
      padding: 24px;
    }
    .unit-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-header {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
      line-height: 1.3;
      margin-bottom: 6px;
    }
    .unit-type {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .unit-type.primary { background: var(--teal-pale); color: var(--teal); }
    .unit-type.emergency { background: var(--red-pale); color: var(--red); }
    .unit-type.specialized { background: var(--purple-pale); color: var(--purple); }
    .unit-type.hospital { background: var(--blue-pale); color: var(--blue); }

    .unit-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .unit-info-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .unit-info-item i {
      color: var(--teal);
      margin-top: 2px;
      flex-shrink: 0;
    }
    .unit-info-item strong {
      color: var(--text);
      font-weight: 500;
    }

    .unit-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .unit-distance {
      font-size: 0.8rem;
      color: var(--amber);
      font-weight: 600;
      background: var(--amber-pale);
      padding: 4px 8px;
      border-radius: 6px;
    }
    .unit-actions {
      display: flex;
      gap: 8px;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      animation: fadeIn 0.2s;
    }
    .modal.open { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      animation: slideUp 0.3s;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .modal-close:hover { background: var(--bg); color: var(--text); }
    .modal-body { padding: 24px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); } to { transform: translateY(0); } }

    /* NOTIFICATIONS */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      animation: slideInRight 0.3s;
      max-width: 320px;
    }
    .notification.success { background: var(--teal); color: #FFFFFF; }
    .notification.error { background: var(--red); color: #FFFFFF; }
    .notification.warning { background: var(--amber); color: #FFFFFF; }
    .notification.info { background: var(--blue); color: #FFFFFF; }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* LOADING */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #FFFFFF;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }
    .empty-state i {
      font-size: 4rem;
      color: var(--text-light);
      margin-bottom: 16px;
    }
    .empty-state h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
      margin-bottom: 8px;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .header-inner { padding: 16px 20px; }
      .header-titles h1 { font-size: 1.3rem; }
      .main-wrapper { padding: 16px 20px 40px; }
      .filter-grid { grid-template-columns: 1fr; }
      .unit-grid { grid-template-columns: 1fr; padding: 16px; }
      .geo-controls { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="white"/>
        </svg>
      </div>
      <div class="header-titles">
        <h1>Sa√∫deBR <span>Localizador CNES</span></h1>
        <p>Encontre unidades de sa√∫de p√∫blica pr√≥ximas a voc√™</p>
      </div>
      <div class="header-badge">Beta</div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <div class="main-wrapper">
    <!-- FILTER SECTION -->
    <section class="filter-section">
      <div class="filter-header" onclick="toggleFilter()">
        <div class="filter-header-left">
          <div class="filter-header-icon">
            <i class="fas fa-filter"></i>
          </div>
          <div>
            <div class="filter-title">Filtros de Busca</div>
            <div class="filter-subtitle">Personalize sua busca por unidades de sa√∫de</div>
          </div>
        </div>
        <button class="filter-toggle-btn">
          <span>Expandir</span>
          <i class="fas fa-chevron-down filter-toggle-arrow"></i>
        </button>
      </div>
      
      <div class="filter-body" id="filterBody">
        <!-- Geolocation Panel -->
        <div class="geo-panel">
          <div class="geo-title">
            <i class="fas fa-location-dot"></i>
            Busca por Localiza√ß√£o
          </div>
          <div class="geo-controls">
            <div class="form-group">
              <label class="form-label">Raio de Busca (km)</label>
              <input type="number" id="geoRaio" class="form-control" value="6" min="1" max="50" step="0.5">
            </div>
            <button class="btn btn-primary" onclick="buscarPorLocalizacao()">
              <i class="fas fa-crosshairs"></i>
              Buscar Pr√≥ximo a Mim
            </button>
          </div>
          <div class="geo-status" id="geoStatus">
            Detecta automaticamente seu munic√≠pio via GPS e busca unidades no raio configurado
          </div>
        </div>

        <!-- Filter Grid -->
        <div class="filter-grid">
          <div class="form-group">
            <label class="form-label">Estado</label>
            <select id="estado" class="form-control" onchange="carregarMunicipios()">
              <option value="">Selecione um estado</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Munic√≠pio</label>
            <select id="municipio" class="form-control">
              <option value="">Selecione um munic√≠pio</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Tipo de Unidade</label>
            <select id="tipo" class="form-control">
              <option value="">Todos os tipos</option>
              <option value="UBS">UBS - Unidade B√°sica de Sa√∫de</option>
              <option value="UC">UC - Unidade de Consulta</option>
              <option value="UPA">UPA - Unidade de Pronto Atendimento</option>
              <option value="HOSPITAL">Hospital</option>
              <option value="ESPECIALIZADA">Unidade Especializada</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Perfil</label>
            <select id="perfil" class="form-control">
              <option value="">Todos os perfis</option>
              <option value="ATENCAO_PRIMARIA">Aten√ß√£o Prim√°ria</option>
              <option value="URG_EMERG">Urg√™ncia/Emerg√™ncia</option>
              <option value="ESPECIALIZADO">Especializado</option>
              <option value="HOSPITALAR">Hospitalar</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Forma de Acolhimento</label>
            <select id="acolhimento" class="form-control">
              <option value="">Todas as formas</option>
              <option value="CENTRAL">Central</option>
              <option value="DISTRITO">Distrito</option>
              <option value="ESPECIALIZADO">Especializado</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Busca por Nome</label>
            <input type="text" id="buscaNome" class="form-control" placeholder="Nome da unidade ou profissional">
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="buscarUnidades()">
            <i class="fas fa-search"></i>
            Buscar Unidades
          </button>
          <button class="btn btn-secondary" onclick="limparFiltros()">
            <i class="fas fa-eraser"></i>
            Limpar Filtros
          </button>
        </div>
      </div>
    </section>

    <!-- RESULTS SECTION -->
    <section class="results-section">
      <div class="results-header">
        <div>
          <div class="results-title">Resultados da Busca</div>
          <div class="results-count" id="resultsCount">Nenhuma busca realizada</div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-primary btn-sm" onclick="exportarExcel()">
            <i class="fas fa-file-excel"></i>
            Exportar Excel
          </button>
          <button class="btn btn-amber btn-sm" onclick="visualizarPDF()">
            <i class="fas fa-file-pdf"></i>
            Visualizar PDF
          </button>
        </div>
      </div>
      
      <div id="resultsContainer">
        <div class="empty-state">
          <i class="fas fa-hospital"></i>
          <h3>Nenhuma busca realizada</h3>
          <p>Use os filtros acima para encontrar unidades de sa√∫de pr√≥ximas</p>
        </div>
      </div>
    </section>
  </div>

  <!-- PDF PREVIEW MODAL -->
  <div id="pdfModal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 800px;">
      <div class="modal-header">
        <div class="modal-title">Visualizar PDF</div>
        <button class="modal-close" onclick="fecharPDFModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="pdfPreview" style="min-height: 400px; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 20px; background: white;"></div>
        <div style="margin-top: 20px; text-align: center;">
          <button class="btn btn-primary" onclick="baixarPDF()">
            <i class="fas fa-download"></i>
            Baixar PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script>
    // VARI√ÅVEIS GLOBAIS
    let allUnits = [];
    let filteredUnits = [];
    let currentPdfContent = null;

    // ESTADOS BRASILEIROS
    const estados = [
      { sigla: 'AC', nome: 'Acre' },
      { sigla: 'AL', nome: 'Alagoas' },
      { sigla: 'AP', nome: 'Amap√°' },
      { sigla: 'AM', nome: 'Amazonas' },
      { sigla: 'BA', nome: 'Bahia' },
      { sigla: 'CE', nome: 'Cear√°' },
      { sigla: 'DF', nome: 'Distrito Federal' },
      { sigla: 'ES', nome: 'Esp√≠rito Santo' },
      { sigla: 'GO', nome: 'Goi√°s' },
      { sigla: 'MA', nome: 'Maranh√£o' },
      { sigla: 'MT', nome: 'Mato Grosso' },
      { sigla: 'MS', nome: 'Mato Grosso do Sul' },
      { sigla: 'MG', nome: 'Minas Gerais' },
      { sigla: 'PA', nome: 'Par√°' },
      { sigla: 'PB', nome: 'Para√≠ba' },
      { sigla: 'PR', nome: 'Paran√°' },
      { sigla: 'PE', nome: 'Pernambuco' },
      { sigla: 'PI', nome: 'Piau√≠' },
      { sigla: 'RJ', nome: 'Rio de Janeiro' },
      { sigla: 'RN', nome: 'Rio Grande do Norte' },
      { sigla: 'RS', nome: 'Rio Grande do Sul' },
      { sigla: 'RO', nome: 'Rond√¥nia' },
      { sigla: 'RR', nome: 'Roraima' },
      { sigla: 'SC', nome: 'Santa Catarina' },
      { sigla: 'SP', nome: 'S√£o Paulo' },
      { sigla: 'SE', nome: 'Sergipe' },
      { sigla: 'TO', nome: 'Tocantins' }
    ];

    // INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', function() {
      carregarEstados();
      carregarDadosExemplo();
    });

    // CARREGAR ESTADOS
    function carregarEstados() {
      const selectEstado = document.getElementById('estado');
      selectEstado.innerHTML = '<option value="">Selecione um estado</option>';
      
      estados.forEach(estado => {
        const option = document.createElement('option');
        option.value = estado.sigla;
        option.textContent = `${estado.sigla} - ${estado.nome}`;
        selectEstado.appendChild(option);
      });
    }

    // CARREGAR MUNIC√çPIS (simulado)
    function carregarMunicipios() {
      const estado = document.getElementById('estado').value;
      const selectMunicipio = document.getElementById('municipio');
      
      selectMunicipio.innerHTML = '<option value="">Selecione um munic√≠pio</option>';
      
      if (estado) {
        // Simular carregamento de munic√≠pios
        const municipios = [
          `${estado}001 - Munic√≠pio Principal`,
          `${estado}002 - Munic√≠pio Secund√°rio`,
          `${estado}003 - Munic√≠pio Terci√°rio`
        ];
        
        municipios.forEach(municipio => {
          const option = document.createElement('option');
          option.value = municipio.split(' - ')[0];
          option.textContent = municipio;
          selectMunicipio.appendChild(option);
        });
      }
    }

    // CARREGAR DADOS EXEMPLO
    function carregarDadosExemplo() {
      // Dados de exemplo para o Rio de Janeiro
      allUnits = [
        {
          id: 1,
          nome: "UBS Vila da Penha",
          tipo: "UBS",
          perfil: "ATENCAO_PRIMARIA",
          acolhimento: "CENTRAL",
          estado: "RJ",
          municipio: "Rio de Janeiro",
          endereco: "Rua Vila da Penha, 123 - Vila da Penha",
          telefone: "(21) 3399-1234",
          email: "ubsvilapenha.rj@saude.gov.br",
          latitude: -22.8204,
          longitude: -43.2861,
          cnes: "1234567",
          profissional: "Dr. Jo√£o Silva"
        },
        {
          id: 2,
          nome: "UBS M√©ier",
          tipo: "UBS",
          perfil: "ATENCAO_PRIMARIA",
          acolhimento: "CENTRAL",
          estado: "RJ",
          municipio: "Rio de Janeiro",
          endereco: "Rua Dias da Cruz, 456 - M√©ier",
          telefone: "(21) 3399-5678",
          email: "ubsmeier.rj@saude.gov.br",
          latitude: -22.8631,
          longitude: -43.2875,
          cnes: "1234568",
          profissional: "Dra. Maria Santos"
        },
        {
          id: 3,
          nome: "UPA Tijuca",
          tipo: "UPA",
          perfil: "URG_EMERG",
          acolhimento: "ESPECIALIZADO",
          estado: "RJ",
          municipio: "Rio de Janeiro",
          endereco: "Rua Mariz e Barros, 789 - Tijuca",
          telefone: "(21) 3399-9012",
          email: "upatijuca.rj@saude.gov.br",
          latitude: -22.9311,
          longitude: -43.2294,
          cnes: "1234569",
          profissional: "Dr. Pedro Oliveira"
        },
        {
          id: 4,
          nome: "UBS Copacabana",
          tipo: "UBS",
          perfil: "ATENCAO_PRIMARIA",
          acolhimento: "DISTRITO",
          estado: "RJ",
          municipio: "Rio de Janeiro",
          endereco: "Rua Barata Ribeiro, 321 - Copacabana",
          telefone: "(21) 3399-3456",
          email: "ubscopacabana.rj@saude.gov.br",
          latitude: -22.9711,
          longitude: -43.1822,
          cnes: "1234570",
          profissional: "Dra. Ana Costa"
        },
        {
          id: 5,
          nome: "UBS Botafogo",
          tipo: "UBS",
          perfil: "ATENCAO_PRIMARIA",
          acolhimento: "CENTRAL",
          estado: "RJ",
          municipio: "Rio de Janeiro",
          endereco: "Rua Volunt√°rios da P√°tria, 654 - Botafogo",
          telefone: "(21) 3399-7890",
          email: "ubsbotafogo.rj@saude.gov.br",
          latitude: -22.9511,
          longitude: -43.1867,
          cnes: "1234571",
          profissional: "Dr. Carlos Mendes"
        },
        {
          id: 6,
          nome: "UBS Leblon",
          tipo: "UBS",
          perfil: "ATENCAO_PRIMARIA",
          acolhimento: "CENTRAL",
          estado: "RJ",
          municipio: "Rio de Janeiro",
          endereco: "Avenida Delfim Moreira, 987 - Leblon",
          telefone: "(21) 3399-2468",
          email: "ubsleblon.rj@saude.gov.br",
          latitude: -22.9833,
          longitude: -43.2178,
          cnes: "1234572",
          profissional: "Dra. Paula Rocha"
        }
      ];
    }

    // FUN√á√ïES DE BUSCA
    function toggleFilter() {
      const body = document.getElementById('filterBody');
      const arrow = document.querySelector('.filter-toggle-arrow');
      const button = document.querySelector('.filter-toggle-btn span');
      
      body.classList.toggle('open');
      arrow.classList.toggle('open');
      button.textContent = body.classList.contains('open') ? 'Recolher' : 'Expandir';
    }

    async function buscarPorLocalizacao() {
      const raio = parseFloat(document.getElementById('geoRaio').value) || 6;
      
      if (!navigator.geolocation) {
        showNotification('Geolocaliza√ß√£o n√£o suportada pelo navegador.', 'error');
        return;
      }

      setGeoStatus('üìç Solicitando localiza√ß√£o...');

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          setGeoStatus(`üìç Localiza√ß√£o obtida. Buscando unidades em at√© ${raio} km...`);
          
          // Filtrar unidades por dist√¢ncia
          const unidadesProximas = allUnits.filter(unidade => {
            if (!unidade.latitude || !unidade.longitude) return false;
            
            const distancia = calcularDistancia(
              userLocation.lat, userLocation.lng,
              unidade.latitude, unidade.longitude
            );
            
            return distancia <= raio;
          }).map(unidade => ({
            ...unidade,
            _distancia: calcularDistancia(
              userLocation.lat, userLocation.lng,
              unidade.latitude, unidade.longitude
            )
          })).sort((a, b) => a._distancia - b._distancia);

          if (unidadesProximas.length > 0) {
            filteredUnits = unidadesProximas;
            exibirResultados();
            setGeoStatus(`üìç ${unidadesProximas.length} unidades encontradas em at√© ${raio} km da sua localiza√ß√£o`);
          } else {
            setGeoStatus(`üìç Nenhuma unidade encontrada em at√© ${raio} km. Tente aumentar o raio de busca.`);
            showNotification(`Nenhuma unidade encontrada em at√© ${raio} km. Tente aumentar o raio.`, 'warning');
          }
        },
        (error) => {
          let mensagem = 'Erro ao obter localiza√ß√£o.';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              mensagem = 'Permiss√£o de localiza√ß√£o negada. Ative o GPS ou use filtros manuais.';
              break;
            case error.POSITION_UNAVAILABLE:
              mensagem = 'Localiza√ß√£o indispon√≠vel. Verifique se o GPS est√° ativo.';
              break;
            case error.TIMEOUT:
              mensagem = 'Tempo limite ao obter localiza√ß√£o. Tente novamente.';
              break;
          }
          setGeoStatus(`‚ùå ${mensagem}`);
          showNotification(mensagem, 'error');
        },
        { timeout: 10000, enableHighAccuracy: true }
      );
    }

    function buscarUnidades() {
      const filtros = {
        estado: document.getElementById('estado').value,
        municipio: document.getElementById('municipio').value,
        tipo: document.getElementById('tipo').value,
        perfil: document.getElementById('perfil').value,
        acolhimento: document.getElementById('acolhimento').value,
        nome: document.getElementById('buscaNome').value.toLowerCase()
      };

      // Filtrar unidades
      filteredUnits = allUnits.filter(unidade => {
        // Filtro por estado
        if (filtros.estado && unidade.estado !== filtros.estado) return false;
        
        // Filtro por munic√≠pio
        if (filtros.municipio && unidade.municipio !== filtros.municipio) return false;
        
        // Filtro por tipo
        if (filtros.tipo && unidade.tipo !== filtros.tipo) return false;
        
        // Filtro por perfil
        if (filtros.perfil && unidade.perfil !== filtros.perfil) return false;
        
        // Filtro por acolhimento
        if (filtros.acolhimento && unidade.acolhimento !== filtros.acolhimento) return false;
        
        // Filtro por nome
        if (filtros.nome && !unidade.nome.toLowerCase().includes(filtros.nome) && 
            !unidade.profissional.toLowerCase().includes(filtros.nome)) return false;
        
        return true;
      });

      exibirResultados();
    }

    function limparFiltros() {
      document.getElementById('estado').value = '';
      document.getElementById('municipio').value = '';
      document.getElementById('tipo').value = '';
      document.getElementById('perfil').value = '';
      document.getElementById('acolhimento').value = '';
      document.getElementById('buscaNome').value = '';
      document.getElementById('geoRaio').value = '6';
      
      filteredUnits = [];
      exibirResultados();
      setGeoStatus('Detecta automaticamente seu munic√≠pio via GPS e busca unidades no raio configurado');
    }

    function exibirResultados() {
      const container = document.getElementById('resultsContainer');
      const resultsCount = document.getElementById('resultsCount');
      
      if (filteredUnits.length === 0) {
        resultsCount.textContent = 'Nenhuma unidade encontrada';
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-hospital"></i>
            <h3>Nenhuma unidade encontrada</h3>
            <p>Revise os filtros e tente novamente</p>
          </div>
        `;
        return;
      }

      resultsCount.textContent = `${filteredUnits.length} unidade(s) encontrada(s)`;

      const grid = document.createElement('div');
      grid.className = 'unit-grid';

      filteredUnits.forEach(unidade => {
        const card = criarCardUnidade(unidade);
        grid.appendChild(card);
      });

      container.innerHTML = '';
      container.appendChild(grid);
    }

    function criarCardUnidade(unidade) {
      const card = document.createElement('div');
      card.className = 'unit-card';

      const tipoPerfil = obterTipoPerfil(unidade.perfil);
      const distancia = unidade._distancia ? `${unidade._distancia.toFixed(1)} km` : '';

      card.innerHTML = `
        <div class="unit-header">
          <div class="unit-name">${unidade.nome}</div>
          <div class="unit-type ${tipoPerfil.classe}">${tipoPerfil.nome}</div>
        </div>
        
        <div class="unit-info">
          <div class="unit-info-item">
            <i class="fas fa-map-marker-alt"></i>
            <div>
              <strong>Endere√ßo:</strong> ${unidade.endereco}
            </div>
          </div>
          
          <div class="unit-info-item">
            <i class="fas fa-phone"></i>
            <div>
              <strong>Telefone:</strong> ${unidade.telefone}
            </div>
          </div>
          
          <div class="unit-info-item">
            <i class="fas fa-envelope"></i>
            <div>
              <strong>Email:</strong> ${unidade.email}
            </div>
          </div>
          
          <div class="unit-info-item">
            <i class="fas fa-user-md"></i>
            <div>
              <strong>Profissional:</strong> ${unidade.profissional}
            </div>
          </div>
          
          <div class="unit-info-item">
            <i class="fas fa-hospital"></i>
            <div>
              <strong>CNES:</strong> ${unidade.cnes}
            </div>
          </div>
        </div>
        
        <div class="unit-footer">
          ${distancia ? `<div class="unit-distance">üìç ${distancia}</div>` : ''}
          <div class="unit-actions">
            <button class="btn btn-sm btn-secondary" onclick="verDetalhes('${unidade.id}')">
              <i class="fas fa-info-circle"></i>
              Detalhes
            </button>
            <a href="https://cnes.datasus.gov.br/Exibe_Ficha_Estabelecimento.asp?Vco_Unidade=${unidade.cnes}" 
               target="_blank" class="btn btn-sm btn-primary">
              <i class="fas fa-external-link-alt"></i>
              CNES
            </a>
          </div>
        </div>
      `;

      return card;
    }

    function obterTipoPerfil(perfil) {
      switch(perfil) {
        case 'ATENCAO_PRIMARIA':
          return { nome: 'Aten√ß√£o Prim√°ria', classe: 'primary' };
        case 'URG_EMERG':
          return { nome: 'Urg√™ncia/Emerg√™ncia', classe: 'emergency' };
        case 'ESPECIALIZADO':
          return { nome: 'Especializado', classe: 'specialized' };
        case 'HOSPITALAR':
          return { nome: 'Hospitalar', classe: 'hospital' };
        default:
          return { nome: 'Outro', classe: 'primary' };
      }
    }

    function verDetalhes(id) {
      const unidade = filteredUnits.find(u => u.id == id);
      if (!unidade) return;

      showNotification(`Detalhes da unidade ${unidade.nome} - Em desenvolvimento`, 'info');
    }

    // FUN√á√ïES DE EXPORTA√á√ÉO
    function exportarExcel() {
      if (!filteredUnits.length) {
        showNotification('Nenhuma unidade para exportar.', 'error');
        return;
      }

      const dados = filteredUnits.map((u, index) => ({
        'N¬∫': index + 1,
        'Nome da Unidade': u.nome,
        'Tipo': u.tipo,
        'Perfil': obterTipoPerfil(u.perfil).nome,
        'Forma de Acolhimento': u.acolhimento,
        'Endere√ßo': u.endereco,
        'Telefone': u.telefone,
        'Email': u.email,
        'Profissional': u.profissional,
        'CNES': u.cnes,
        'Munic√≠pio': u.municipio,
        'Estado': u.estado,
        'Link CNES': `https://cnes.datasus.gov.br/Exibe_Ficha_Estabelecimento.asp?Vco_Unidade=${u.cnes}`
      }));

      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Unidades_CNES');
      XLSX.writeFile(wb, `Unidades_CNES_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      showNotification('Excel exportado com sucesso!', 'success');
    }

    function visualizarPDF() {
      if (!filteredUnits.length) {
        showNotification('Nenhuma unidade para exportar.', 'error');
        return;
      }

      gerarPDF(true);
    }

    function gerarPDF(preview = false) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
      
      // Cabe√ßalho
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('SA√öDEBR - LOCALIZADOR CNES', 10, 10);
      
      doc.setFontSize(8);
      doc.setFont(undefined, 'normal');
      doc.text(`Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}`, 10, 16);
      doc.text(`Total de unidades: ${filteredUnits.length}`, 10, 20);

      // Preparar dados para a tabela
      const dados = filteredUnits.map((u, index) => [
        index + 1,
        u.nome,
        obterTipoPerfil(u.perfil).nome,
        u.municipio,
        u.endereco,
        u.telefone,
        u.cnes,
        `https://cnes.datasus.gov.br/Exibe_Ficha_Estabelecimento.asp?Vco_Unidade=${u.cnes}`
      ]);

      // Criar tabela
      doc.autoTable({
        head: [['N¬∫', 'Nome da Unidade', 'Perfil', 'Munic√≠pio', 'Endere√ßo', 'Telefone', 'CNES', 'Link CNES']],
        body: dados,
        startY: 25,
        styles: { fontSize: 6, cellPadding: 2 },
        headStyles: { fillColor: [11, 31, 58], textColor: 255, fontStyle: 'bold' },
        columnStyles: {
          0: { cellWidth: 8 },
          1: { cellWidth: 35 },
          2: { cellWidth: 20 },
          3: { cellWidth: 20 },
          4: { cellWidth: 30 },
          5: { cellWidth: 18 },
          6: { cellWidth: 12 },
          7: { cellWidth: 25 }
        },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { top: 25 }
      });

      if (preview) {
        // Para visualiza√ß√£o, criar uma representa√ß√£o HTML
        const htmlPreview = `
          <div style="font-family: Arial, sans-serif; font-size: 12px;">
            <h2 style="color: #0B1F3A; margin-bottom: 10px;">SA√öDEBR - LOCALIZADOR CNES</h2>
            <p style="margin: 5px 0;"><strong>Relat√≥rio gerado em:</strong> ${new Date().toLocaleString('pt-BR')}</p>
            <p style="margin: 5px 0;"><strong>Total de unidades:</strong> ${filteredUnits.length}</p>
            
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px;">
              <thead>
                <tr style="background-color: #0B1F3A; color: white;">
                  <th style="border: 1px solid #ddd; padding: 4px;">N¬∫</th>
                  <th style="border: 1px solid #ddd; padding: 4px;">Nome da Unidade</th>
                  <th style="border: 1px solid #ddd; padding: 4px;">Perfil</th>
                  <th style="border: 1px solid #ddd; padding: 4px;">Munic√≠pio</th>
                  <th style="border: 1px solid #ddd; padding: 4px;">Endere√ßo</th>
                  <th style="border: 1px solid #ddd; padding: 4px;">Telefone</th>
                  <th style="border: 1px solid #ddd; padding: 4px;">CNES</th>
                  <th style="border: 1px solid #ddd; padding: 4px;">Link CNES</th>
                </tr>
              </thead>
              <tbody>
                ${filteredUnits.map((u, index) => `
                  <tr style="background-color: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                    <td style="border: 1px solid #ddd; padding: 4px;">${index + 1}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${u.nome}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${obterTipoPerfil(u.perfil).nome}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${u.municipio}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${u.endereco}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${u.telefone}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${u.cnes}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">
                      <a href="https://cnes.datasus.gov.br/Exibe_Ficha_Estabelecimento.asp?Vco_Unidade=${u.cnes}" 
                         target="_blank" style="color: #00A878;">Ver no CNES</a>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('pdfPreview').innerHTML = htmlPreview;
        document.getElementById('pdfModal').classList.add('open');
        
        // Armazenar o conte√∫do do PDF para download
        currentPdfContent = doc.output('blob');
      }
      
      showNotification('PDF gerado com sucesso!', 'success');
    }

    function fecharPDFModal() {
      document.getElementById('pdfModal').classList.remove('open');
    }

    function baixarPDF() {
      if (currentPdfContent) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(currentPdfContent);
        link.download = `Unidades_CNES_${new Date().toISOString().split('T')[0]}.pdf`;
        link.click();
        fecharPDFModal();
      }
    }

    // FUN√á√ïES AUXILIARES
    function calcularDistancia(lat1, lng1, lat2, lng2) {
      const R = 6371; // Raio da Terra em km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function setGeoStatus(mensagem) {
      document.getElementById('geoStatus').textContent = mensagem;
    }

    function showNotification(mensagem, tipo = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${tipo}`;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
          <span>${mensagem}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // FECHAR MODAL AO CLICAR FORA
    window.onclick = function(event) {
      const modal = document.getElementById('pdfModal');
      if (event.target === modal) {
        fecharPDFModal();
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sa√∫deBR ‚Äî Localizador CNES de Unidades de Sa√∫de P√∫blica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* ‚îÄ‚îÄ‚îÄ FILTER PANEL ‚îÄ‚îÄ‚îÄ */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,168,120,0.1);
    }
    select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6E85' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--radius-sm);
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,168,120,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,168,120,0.4);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover { background: #fff; border-color: var(--teal); color: var(--teal); }
    .btn-navy {
      background: var(--navy);
      color: #fff;
      box-shadow: 0 4px 12px rgba(11,31,58,0.25);
    }
    .btn-navy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(11,31,58,0.35); }
    .btn-amber {
      background: linear-gradient(135deg, var(--amber) 0%, #F7BE50 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(245,166,35,0.35);
    }
    .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(245,166,35,0.45); }
    .btn-geo {
      background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21,101,192,0.3);
    }
    .btn-geo:hover { transform: translateY(-1px); }
    .btn-danger { background: var(--red-pale); color: var(--red); border: 1.5px solid rgba(229,57,53,0.2); }
    .btn-danger:hover { background: var(--red); color: #fff; }
    .btn-sm { padding: 7px 14px; font-size: 0.78rem; }
    .btn-icon { width: 34px; height: 34px; padding: 0; justify-content: center; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* ‚îÄ‚îÄ‚îÄ GEO SECTION ‚îÄ‚îÄ‚îÄ */
    .geo-section {
      background: linear-gradient(135deg, var(--blue-pale), #d8e8ff);
      border: 1px solid rgba(21,101,192,0.2);
      border-radius: var(--radius);
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .geo-info { flex: 1; }
    .geo-info h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--blue);
    }
    .geo-info p { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .geo-radius-row { display: flex; align-items: center; gap: 10px; }
    .geo-radius-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .geo-radius-input {
      width: 80px;
      background: #fff;
      border: 1.5px solid rgba(21,101,192,0.3);
      border-radius: 8px;
      padding: 7px 10px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      text-align: center;
    }

    /* ‚îÄ‚îÄ‚îÄ DASHBOARD CARDS ‚îÄ‚îÄ‚îÄ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--teal));
    }
    .stat-card-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    .stat-card-value {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      line-height: 1;
      color: var(--navy);
      transition: all 0.5s;
    }
    .stat-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .stat-card-sublabel { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }

    /* ‚îÄ‚îÄ‚îÄ RESULTS SECTION ‚îÄ‚îÄ‚îÄ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .results-count {
      background: var(--teal-pale);
      color: var(--teal);
      font-size: 0.78rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 8px;
    }
    .export-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ‚îÄ‚îÄ‚îÄ GROUP SECTIONS ‚îÄ‚îÄ‚îÄ */
    .group-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .group-header {
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .group-header:hover { background: var(--bg); }
    .group-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .group-pill {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.78rem;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .group-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .group-meta { font-size: 0.78rem; color: var(--text-muted); }
    .group-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--navy);
      min-width: 60px;
      text-align: right;
    }
    .group-arrow { color: var(--text-muted); transition: transform 0.3s; }
    .group-arrow.open { transform: rotate(90deg); }

    .group-body {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: none;
    }
    .group-body.open { display: block; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    /* ‚îÄ‚îÄ‚îÄ UNIT CARDS ‚îÄ‚îÄ‚îÄ */
    .unit-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-card-accent {
      position: absolute;
      top: 0; left: 0;
      width: 4px;
      height: 100%;
    }
    .unit-card-inner { padding-left: 8px; }
    .unit-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--navy);
      line-height: 1.3;
    }
    .unit-type-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .unit-info-row svg { flex-shrink: 0; margin-top: 1px; color: var(--text-light); }
    .unit-cnes {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 10px;
      font-family: 'Outfit', sans-serif;
    }
    .unit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }
    .unit-tag {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-tag-urgencia { background: var(--red-pale); color: var(--red); }
    .unit-tag-ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .unit-tag-maternidade { background: var(--purple-pale); color: var(--purple); }
    .unit-tag-traumatologia { background: var(--amber-pale); color: #C07A00; }
    .unit-tag-federal { background: #E8F0FE; color: var(--blue); }
    .unit-tag-estadual { background: #FFF8EC; color: #9C6E00; }
    .unit-tag-municipal { background: var(--teal-pale); color: #006B4F; }
    .unit-distance { background: var(--blue-pale); color: var(--blue); }
    .unit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 4px;
    }
    .unit-actions .btn-icon {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      transition: all 0.2s;
    }
    .unit-actions .btn-icon:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-pale); }
    .unit-actions .btn-icon.whatsapp:hover { border-color: #25D366; color: #25D366; background: #E8FBF0; }
    .unit-actions .btn-icon.maps:hover { border-color: #EA4335; color: #EA4335; background: #FDECEA; }
    .unit-actions .btn-icon.search:hover { border-color: #4285F4; color: #4285F4; background: #E8F0FE; }

    /* ‚îÄ‚îÄ‚îÄ LOADING / EMPTY / ERROR ‚îÄ‚îÄ‚îÄ */
    .status-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 60px 40px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .status-box .status-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }
    .status-box h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .status-box p { font-size: 0.88rem; color: var(--text-muted); max-width: 400px; margin: 0 auto; }

    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--teal-pale);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-wrap {
      max-width: 360px;
      margin: 16px auto 0;
      background: var(--border);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    /* ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD (acima do dashboard) ‚îÄ‚îÄ‚îÄ */
    .search-progress-card {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
      border-radius: var(--radius);
      padding: 20px 28px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 20px;
      border: 1px solid rgba(0,168,120,0.25);
      box-shadow: var(--shadow-md);
      animation: slideDown 0.3s ease;
    }
    .search-progress-card.visible { display: flex; }
    .search-progress-spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(0,200,150,0.25);
      border-top-color: var(--teal-light);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    .search-progress-info { flex: 1; min-width: 0; }
    .search-progress-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.92rem;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-progress-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      min-height: 16px;
    }
    .search-progress-bar-wrap {
      flex: 1;
      max-width: 260px;
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .search-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .search-progress-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--teal-light);
      min-width: 48px;
      text-align: right;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ‚îÄ */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--navy);
      color: #fff;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 340px;
    }
    .notification.success { background: var(--teal); }
    .notification.error { background: var(--red); }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .footer a { color: var(--teal); text-decoration: none; }

    /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      .main-wrapper { padding: 16px 14px 40px; }
      .header-inner { padding: 14px 16px; }
      .header-titles h1 { font-size: 1.2rem; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: 1fr; }
    }

    /* ‚îÄ‚îÄ‚îÄ PDF PREVIEW MODAL ‚îÄ‚îÄ‚îÄ */
    .pdf-modal-overlay {
      position: fixed; inset: 0;
      background: rgba(11,31,58,0.78);
      z-index: 2000;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .pdf-modal {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      display: flex; flex-direction: column;
      width: min(96vw, 980px);
      height: min(92vh, 720px);
      overflow: hidden;
    }
    .pdf-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 22px;
      border-bottom: 1px solid var(--border);
      background: var(--navy);
      color: #fff;
      flex-shrink: 0;
      gap: 12px;
    }
    .pdf-modal-title {
      font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.95rem; flex: 1;
    }
    .pdf-modal-subtitle { font-size: 0.75rem; color: rgba(255,255,255,0.55); margin-top: 2px; }
    .pdf-modal-actions { display: flex; gap: 8px; flex-shrink: 0; }
    .pdf-modal-body { flex: 1; overflow: hidden; background: #555; }
    .pdf-modal-body iframe { width: 100%; height: 100%; border: none; display: block; }

    /* ‚îÄ‚îÄ‚îÄ NIVEL COLORS ‚îÄ‚îÄ‚îÄ */
    .nivel-primaria { --nivel-color: #00A878; }
    .nivel-secundaria { --nivel-color: #1565C0; }
    .nivel-terciaria { --nivel-color: #E53935; }
  </style>
    .pdf-modal-overlay {
      position: fixed; inset: 0;
      background: rgba(11,31,58,0.75);
      z-index: 2000;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .pdf-modal {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      display: flex; flex-direction: column;
      width: min(96vw, 960px);
      height: min(90vh, 700px);
      overflow: hidden;
    }
    .pdf-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--navy);
      color: #fff;
      flex-shrink: 0;
    }
    .pdf-modal-title {
      font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.95rem;
    }
    .pdf-modal-actions { display: flex; gap: 8px; }
    .pdf-modal-body { flex: 1; overflow: hidden; }
    .pdf-modal-body iframe {
      width: 100%; height: 100%; border: none;
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header>
  <div class="header-inner">
    <div class="logo-mark">
      <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 4v20M4 14h20" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
        <circle cx="14" cy="14" r="12" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
      </svg>
    </div>
    <div class="header-titles">
      <h1>Sa√∫de<span>BR</span> ‚Äî Localizador CNES</h1>
      <p>Dados em tempo real ‚Ä¢ Minist√©rio da Sa√∫de / DATASUS ‚Ä¢ Todas as esferas de gest√£o</p>
    </div>
    <span class="header-badge">üü¢ Online</span>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main-wrapper">

  <!-- ‚îÄ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ‚îÄ -->
  <div class="filter-section">
    <div class="filter-header" onclick="toggleFilter()">
      <div class="filter-header-left">
        <div class="filter-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </div>
        <div>
          <div class="filter-title">Filtros de Busca</div>
          <div class="filter-subtitle">Estado, munic√≠pio, perfil de aten√ß√£o e formas de acolhimento</div>
        </div>
      </div>
      <button class="filter-toggle-btn" id="filterToggleBtn">
        <span>Expandir</span>
        <span class="filter-toggle-arrow" id="filterArrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </button>
    </div>

    <div class="filter-body" id="filterBody">
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Estado (UF)</label>
          <select class="form-control" id="selectEstado" onchange="onEstadoChange()">
            <option value="">‚Äî Selecione ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Munic√≠pio</label>
          <select class="form-control" id="selectMunicipio" onchange="onMunicipioChange()" disabled>
            <option value="">‚Äî Selecione o estado primeiro ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" id="inputBairro" placeholder="Ex: Centro, Jardim..." oninput="applyLocalFilters()">
        </div>
        <div class="form-group">
          <label class="form-label">Perfil / N√≠vel de Aten√ß√£o</label>
          <select class="form-control" id="selectNivel" onchange="applyLocalFilters()">
            <option value="">Todos os N√≠veis</option>
            <option value="primaria">Aten√ß√£o Prim√°ria</option>
            <option value="secundaria">Aten√ß√£o Secund√°ria</option>
            <option value="terciaria">Aten√ß√£o Terci√°ria</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Forma de Acolhimento</label>
          <select class="form-control" id="selectAcolhimento" onchange="applyLocalFilters()">
            <option value="">Todas as Formas</option>
            <option value="ambulatorial">Atendimento Ambulatorial</option>
            <option value="urgencia">Urg√™ncia / Emerg√™ncia</option>
            <option value="maternidade">Maternidade</option>
            <option value="traumatologia">Traumatologia</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Esfera de Gest√£o</label>
          <select class="form-control" id="selectGestao" onchange="applyLocalFilters()">
            <option value="">Todas</option>
            <option value="M">Municipal</option>
            <option value="E">Estadual</option>
            <option value="F">Federal</option>
            <option value="D">Dupla</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="buscarUnidades()" id="btnBuscar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          Buscar Unidades
        </button>
        <button class="btn btn-secondary" onclick="limparFiltros()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.57"/></svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ GEOLOCALIZA√á√ÉO ‚îÄ‚îÄ‚îÄ -->
  <div class="geo-section">
    <div style="font-size: 1.8rem;">üìç</div>
    <div class="geo-info">
      <h3>Busca por Proximidade Geogr√°fica ‚Äî Independente</h3>
      <p id="geoStatus">Detecta automaticamente seu munic√≠pio via GPS + geocodifica√ß√£o reversa e busca unidades no raio configurado, sem precisar selecionar estado/munic√≠pio nos filtros.</p>
    </div>
    <div class="geo-radius-row">
      <span class="geo-radius-label">Raio (km):</span>
      <input type="number" class="geo-radius-input form-control" id="geoRaio" value="3" min="0.5" max="6" step="0.5">
    </div>
    <button class="btn btn-geo" onclick="usarGeolocalizacao()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>
      Usar Minha Localiza√ß√£o
    </button>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD (vis√≠vel apenas durante busca) ‚îÄ‚îÄ‚îÄ -->
  <div class="search-progress-card" id="searchProgressCard">
    <div class="search-progress-spinner"></div>
    <div class="search-progress-info">
      <div class="search-progress-title" id="spTitle">Consultando CNES/DATASUS...</div>
      <div class="search-progress-hint" id="spHint">Iniciando conex√£o...</div>
    </div>
    <div class="search-progress-bar-wrap">
      <div class="search-progress-bar" id="spBar" style="width:5%"></div>
    </div>
    <div class="search-progress-count" id="spCount">0</div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ -->
  <div class="dashboard" id="dashboard">
    <div class="stat-card" style="--card-accent: var(--teal);">
      <div class="stat-card-icon" style="background: var(--teal-pale); color: var(--teal);">üè•</div>
      <div class="stat-card-value" id="statTotal">‚Äî</div>
      <div class="stat-card-label">Total de Unidades</div>
      <div class="stat-card-sublabel">encontradas</div>
    </div>
    <div class="stat-card" style="--card-accent: #00A878;">
      <div class="stat-card-icon" style="background: #E8F8F3; color: #00A878;">üè†</div>
      <div class="stat-card-value" id="statPrimaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Prim√°ria</div>
      <div class="stat-card-sublabel">UBS, ESF, CAPS...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--blue);">
      <div class="stat-card-icon" style="background: var(--blue-pale); color: var(--blue);">üî¨</div>
      <div class="stat-card-value" id="statSecundaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Secund√°ria</div>
      <div class="stat-card-sublabel">Policl√≠nicas, esp...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üè®</div>
      <div class="stat-card-value" id="statTerciaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Terci√°ria</div>
      <div class="stat-card-sublabel">Hospitais, UTI...</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üö®</div>
      <div class="stat-card-value" id="statUrgencia">‚Äî</div>
      <div class="stat-card-label">Urg√™ncia/Emerg√™ncia</div>
      <div class="stat-card-sublabel">UPAs, PS, SAMU</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--purple);">
      <div class="stat-card-icon" style="background: var(--purple-pale); color: var(--purple);">ü§±</div>
      <div class="stat-card-value" id="statMaternidade">‚Äî</div>
      <div class="stat-card-label">Maternidades</div>
      <div class="stat-card-sublabel">Parto e neonatal</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--amber);">
      <div class="stat-card-icon" style="background: var(--amber-pale); color: var(--amber);">ü¶¥</div>
      <div class="stat-card-value" id="statTraumatologia">‚Äî</div>
      <div class="stat-card-label">Traumatologia</div>
      <div class="stat-card-sublabel">Ortopedia, trauma</div>
    </div>
    <div class="stat-card" style="--card-accent: #9C27B0;">
      <div class="stat-card-icon" style="background: #F3E5F5; color: #9C27B0;">üèõÔ∏è</div>
      <div class="stat-card-value" id="statAmbulatorial">‚Äî</div>
      <div class="stat-card-label">Ambulatorial</div>
      <div class="stat-card-sublabel">Consultas/exames</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ RESULTADOS ‚îÄ‚îÄ‚îÄ -->
  <div id="resultsSection">
    <div class="status-box">
      <span class="status-icon">üîç</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione estado e munic√≠pio nos filtros e clique em <strong>Buscar Unidades</strong>, ou use <strong>Usar Minha Localiza√ß√£o</strong> para detec√ß√£o autom√°tica.</p>
    </div>
  </div>

</div><!-- /main-wrapper -->

<div id="pdfModalOverlay" class="pdf-modal-overlay" style="display:none;" onclick="if(event.target===this)fecharModalPDF()">
  <div class="pdf-modal">
    <div class="pdf-modal-header">
      <div>
        <div class="pdf-modal-title">Pr√©via do Relat√≥rio PDF ‚Äî Sa√∫deBR CNES/DATASUS</div>
        <div class="pdf-modal-subtitle" id="pdfModalSubtitle">Formato A5 Horizontal</div>
      </div>
      <div class="pdf-modal-actions">
        <button class="btn btn-amber btn-sm" id="btnDownloadPDF">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Baixar PDF
        </button>
        <button class="btn btn-secondary btn-sm" onclick="fecharModalPDF()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          Fechar
        </button>
      </div>
    </div>
    <div class="pdf-modal-body">
      <iframe id="pdfModalIframe" title="Pr√©via PDF"></iframe>
    </div>
  </div>
</div>

<footer class="footer">
  Dados obtidos em tempo real via <a href="https://apidadosabertos.saude.gov.br/cnes" target="_blank">API CNES/DATASUS</a> ‚Äî Minist√©rio da Sa√∫de do Brasil &nbsp;|&nbsp; Sa√∫deBR Localizador v1.0
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURA√á√ÉO & CONSTANTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CNES_BASE      = 'https://apidadosabertos.saude.gov.br/cnes';
const IBGE_API       = 'https://servicodados.ibge.gov.br/api/v1/localidades';
const NOMINATIM_API  = 'https://nominatim.openstreetmap.org';
const MAX_UNITS_PER_CALL = 50;
const MAX_TOTAL_UNITS    = 1000;
const FETCH_TIMEOUT_MS   = 18000;   // 18 s por chamada
const MAX_RETRIES        = 3;       // tentativas por estrat√©gia

// Estrat√©gias de acesso √† API em cascata (direto ‚Üí proxies CORS)
const API_STRATEGIES = [
  url => url,                                                        // 1. Direto
  url => `https://corsproxy.io/?url=${encodeURIComponent(url)}`,    // 2. corsproxy.io
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, // 3. allorigins
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, // 4. codetabs
];
let activeStrategy = 0; // √≠ndice da estrat√©gia bem-sucedida mais recente

const ESTADOS = [
  {sg:'AC',nome:'Acre',co:'12'},{sg:'AL',nome:'Alagoas',co:'27'},{sg:'AP',nome:'Amap√°',co:'16'},
  {sg:'AM',nome:'Amazonas',co:'13'},{sg:'BA',nome:'Bahia',co:'29'},{sg:'CE',nome:'Cear√°',co:'23'},
  {sg:'DF',nome:'Distrito Federal',co:'53'},{sg:'ES',nome:'Esp√≠rito Santo',co:'32'},{sg:'GO',nome:'Goi√°s',co:'52'},
  {sg:'MA',nome:'Maranh√£o',co:'21'},{sg:'MT',nome:'Mato Grosso',co:'51'},{sg:'MS',nome:'Mato Grosso do Sul',co:'50'},
  {sg:'MG',nome:'Minas Gerais',co:'31'},{sg:'PA',nome:'Par√°',co:'15'},{sg:'PB',nome:'Para√≠ba',co:'25'},
  {sg:'PR',nome:'Paran√°',co:'41'},{sg:'PE',nome:'Pernambuco',co:'26'},{sg:'PI',nome:'Piau√≠',co:'22'},
  {sg:'RJ',nome:'Rio de Janeiro',co:'33'},{sg:'RN',nome:'Rio Grande do Norte',co:'24'},{sg:'RS',nome:'Rio Grande do Sul',co:'43'},
  {sg:'RO',nome:'Rond√¥nia',co:'11'},{sg:'RR',nome:'Roraima',co:'14'},{sg:'SC',nome:'Santa Catarina',co:'42'},
  {sg:'SP',nome:'S√£o Paulo',co:'35'},{sg:'SE',nome:'Sergipe',co:'28'},{sg:'TO',nome:'Tocantins',co:'17'}
];

// Mapeamento tp_unidade ‚Üí n√≠vel + acolhimento
// Regra: urg√™ncia/emerg√™ncia pertence a aten√ß√£o secund√°ria ou terci√°ria
const TP_MAP = {
  '01':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Posto de Sa√∫de' },
  '02':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Centro de Sa√∫de/UBS' },
  '04':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Policl√≠nica' },
  '05':{ nivel:'terciaria',  tags:['ambulatorial','urgencia'],nome:'Hospital Geral' },
  '07':{ nivel:'terciaria',  tags:['ambulatorial'],           nome:'Hospital Especializado' },
  '15':{ nivel:'terciaria',  tags:['ambulatorial','urgencia'],nome:'Unidade Mista' },
  '20':{ nivel:'secundaria', tags:['urgencia'],               nome:'Pronto Atendimento / UPA' },
  '21':{ nivel:'terciaria',  tags:['urgencia'],               nome:'Pronto Socorro Geral' },
  '22':{ nivel:'terciaria',  tags:['urgencia'],               nome:'Pronto Socorro Especializado' },
  '32':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Sa√∫de Ind√≠gena' },
  '36':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Cl√≠nica/Centro de Especialidade' },
  '39':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Apoio Diagnose/Terapia' },
  '40':{ nivel:'secundaria', tags:['urgencia'],               nome:'Unidade M√≥vel Terrestre' },
  '42':{ nivel:'secundaria', tags:['urgencia'],               nome:'Unidade M√≥vel Fluvial' },
  '43':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Farm√°cia' },
  '50':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Vigil√¢ncia em Sa√∫de' },
  '60':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Cooperativa/Empresa' },
  '61':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'CAPS' },
  '62':{ nivel:'terciaria',  tags:['ambulatorial'],           nome:'Hospital/Dia Isolado' },
  '67':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Laborat√≥rio Sa√∫de P√∫blica' },
  '68':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Central de Regula√ß√£o' },
  '69':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Centro de Apoio √† Sa√∫de da Fam√≠lia' },
  '70':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Centro Hemoterapia/Hematologia' },
  '71':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Banco de Leite Humano' },
  '72':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Unidade Regime Residencial' },
  '73':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Posto de Sa√∫de Rural' },
  '74':{ nivel:'terciaria',  tags:['maternidade'],            nome:'Centro de Parto Normal' },
  '75':{ nivel:'terciaria',  tags:['maternidade','urgencia'], nome:'Hospital Maternidade' },
  '76':{ nivel:'terciaria',  tags:['urgencia'],               nome:'Central de Reg. de Urg√™ncias/SAMU' },
  '79':{ nivel:'secundaria', tags:['traumatologia'],          nome:'Oficina Ortop√©dica' },
  '80':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Laborat√≥rio Pr√≥teses Dent√°rias' },
  '81':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Laborat√≥rio Central Sa√∫de P√∫blica' },
  '82':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Aten√ß√£o Domiciliar' },
  '83':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Polo Academia da Sa√∫de' },
  '84':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Central Abastecimento Farmac√™utico' },
  '85':{ nivel:'primaria',   tags:['ambulatorial'],           nome:'Centro de Imuniza√ß√£o' },
  '86':{ nivel:'secundaria', tags:['ambulatorial'],           nome:'Servi√ßo de Aten√ß√£o Especializada' },
};

const NIVEL_CONFIG = {
  primaria:    { label:'Aten√ß√£o Prim√°ria',   color:'#00A878', bg:'#E8F8F3', pill:'#00A878', emoji:'üè†' },
  secundaria:  { label:'Aten√ß√£o Secund√°ria',  color:'#1565C0', bg:'#E8F0FE', pill:'#1565C0', emoji:'üî¨' },
  terciaria:   { label:'Aten√ß√£o Terci√°ria',   color:'#E53935', bg:'#FDECEA', pill:'#E53935', emoji:'üè®' },
};

const ACOLHIMENTO_CONFIG = {
  ambulatorial: { label:'Ambulatorial',        tagClass:'unit-tag-ambulatorial', emoji:'üíä' },
  urgencia:     { label:'Urg√™ncia/Emerg√™ncia', tagClass:'unit-tag-urgencia',     emoji:'üö®' },
  maternidade:  { label:'Maternidade',          tagClass:'unit-tag-maternidade',  emoji:'ü§±' },
  traumatologia:{ label:'Traumatologia',        tagClass:'unit-tag-traumatologia',emoji:'ü¶¥' },
};

const GESTAO_MAP = { M:'Municipal', E:'Estadual', F:'Federal', D:'Dupla Gest√£o' };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ESTADO GLOBAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allUnits = [];
let filteredUnits = [];
let userLocation = null;
let geoSearchMode = false;
let currentMunicipioCode = null;
let isLoading = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INICIALIZA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  populateEstados();
});

function populateEstados() {
  const sel = document.getElementById('selectEstado');
  ESTADOS.sort((a,b) => a.nome.localeCompare(b.nome));
  ESTADOS.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e.sg;
    opt.textContent = `${e.sg} ‚Äî ${e.nome}`;
    sel.appendChild(opt);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENTOS DE FILTRO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFilter() {
  const body = document.getElementById('filterBody');
  const arrow = document.getElementById('filterArrow');
  const btn = document.getElementById('filterToggleBtn');
  const isOpen = body.classList.toggle('open');
  arrow.classList.toggle('open', isOpen);
  btn.querySelector('span').textContent = isOpen ? 'Recolher' : 'Expandir';
}

async function onEstadoChange() {
  const uf = document.getElementById('selectEstado').value;
  const sel = document.getElementById('selectMunicipio');
  sel.disabled = true;
  sel.innerHTML = '<option>Carregando munic√≠pios...</option>';
  allUnits = [];
  filteredUnits = [];
  currentMunicipioCode = null;
  geoSearchMode = false;

  if (!uf) { sel.innerHTML = '<option>‚Äî Selecione o estado primeiro ‚Äî</option>'; return; }

  try {
    const resp = await fetch(`${IBGE_API}/estados/${uf}/municipios`);
    const data = await resp.json();
    data.sort((a,b) => a.nome.localeCompare(b.nome));
    sel.innerHTML = '<option value="">‚Äî Selecione o munic√≠pio ‚Äî</option>';
    data.forEach(m => {
      const opt = document.createElement('option');
      opt.value = String(m.id).substring(0, 6); // 6-digit CNES code
      opt.textContent = m.nome;
      sel.appendChild(opt);
    });
    sel.disabled = false;
  } catch(e) {
    sel.innerHTML = '<option>Erro ao carregar munic√≠pios</option>';
    showNotification('Erro ao carregar munic√≠pios. Verifique sua conex√£o.', 'error');
  }
}

function onMunicipioChange() {
  const code = document.getElementById('selectMunicipio').value;
  currentMunicipioCode = code;
  allUnits = [];
  filteredUnits = [];
  geoSearchMode = false;
  if (code) {
    // Auto-open filter and suggest search
  }
}

function limparFiltros() {
  document.getElementById('selectEstado').value = '';
  document.getElementById('selectMunicipio').innerHTML = '<option value="">‚Äî Selecione o estado primeiro ‚Äî</option>';
  document.getElementById('selectMunicipio').disabled = true;
  document.getElementById('inputBairro').value = '';
  document.getElementById('selectNivel').value = '';
  document.getElementById('selectAcolhimento').value = '';
  document.getElementById('selectGestao').value = '';
  allUnits = [];
  filteredUnits = [];
  currentMunicipioCode = null;
  geoSearchMode = false;
  userLocation = null;
  document.getElementById('geoStatus').textContent = 'Clique em "Usar Minha Localiza√ß√£o" para buscar unidades pr√≥ximas a voc√™.';
  renderInitial();
  updateDashboard([]);
}

function applyLocalFilters() {
  if (!allUnits.length) return;
  const bairro = document.getElementById('inputBairro').value.toLowerCase().trim();
  const nivel = document.getElementById('selectNivel').value;
  const acolhimento = document.getElementById('selectAcolhimento').value;
  const gestao = document.getElementById('selectGestao').value;

  filteredUnits = allUnits.filter(u => {
    if (bairro && !(u.no_bairro || '').toLowerCase().includes(bairro)) return false;
    if (nivel && u._nivel !== nivel) return false;
    if (acolhimento && !u._tags.includes(acolhimento)) return false;
    if (gestao && u.tp_gestao !== gestao) return false;
    return true;
  });

  updateDashboard(filteredUnits);
  renderResults(filteredUnits);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS CARD (acima do dashboard)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showProgressCard(title) {
  const card = document.getElementById('searchProgressCard');
  document.getElementById('spTitle').textContent = title || 'Consultando CNES/DATASUS...';
  document.getElementById('spHint').textContent  = 'Iniciando conex√£o...';
  document.getElementById('spBar').style.width   = '5%';
  document.getElementById('spCount').textContent = '0';
  card.classList.add('visible');
}
function updateProgressCard(hint, pct, count) {
  const hEl = document.getElementById('spHint');
  const bEl = document.getElementById('spBar');
  const cEl = document.getElementById('spCount');
  if (hEl && hint  !== undefined) hEl.textContent = hint;
  if (bEl && pct   !== undefined) bEl.style.width = Math.min(100, pct) + '%';
  if (cEl && count !== undefined) cEl.textContent = count;
}
function hideProgressCard() {
  document.getElementById('searchProgressCard').classList.remove('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FETCH RESILIENTE ‚Äî timeout + retry + cascade proxy
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchWithTimeout(url, timeoutMs = FETCH_TIMEOUT_MS) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const resp = await fetch(url, { signal: controller.signal });
    clearTimeout(timer);
    return resp;
  } catch(e) {
    clearTimeout(timer);
    throw e;
  }
}

async function fetchCNES(path) {
  for (let si = activeStrategy; si < API_STRATEGIES.length; si++) {
    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
      const rawUrl   = `${CNES_BASE}${path}`;
      const finalUrl = API_STRATEGIES[si](rawUrl);
      const label    = si === 0 ? 'acesso direto' : `proxy ${si}`;

      updateProgressCard(`Tentativa ${attempt}/${MAX_RETRIES} via ${label}‚Ä¶`);

      try {
        const resp = await fetchWithTimeout(finalUrl, FETCH_TIMEOUT_MS);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        // Valida que a resposta tem estrutura real de dados CNES
        const items = extractItems(data);
        if (items === null) throw new Error('Resposta sem estrutura CNES reconhecida');

        activeStrategy = si;
        return data;
      } catch(e) {
        console.warn(`[CNES] ${label} ‚Äî tentativa ${attempt} falhou:`, e.message);
        if (attempt < MAX_RETRIES) await delay(900 * attempt);
      }
    }
    console.warn(`[CNES] Estrat√©gia ${si} esgotada. Pr√≥xima‚Ä¶`);
  }
  throw new Error('Todas as rotas de acesso falharam. Verifique sua conex√£o e tente novamente.');
}

/** Extrai o array de estabelecimentos de qualquer envelope que a API retorne */
function extractItems(data) {
  if (!data) return null;
  // Envelopes conhecidos da API CNES/DATASUS
  for (const key of ['estabelecimentos','data','result','results','items']) {
    if (Array.isArray(data[key])) return data[key];
  }
  if (Array.isArray(data)) return data;
  return null;
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NORMALIZA√á√ÉO DE CAMPOS DA API CNES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
/**
 * A API CNES/DATASUS usa diferentes schemas em vers√µes distintas.
 * Esta fun√ß√£o unifica todos os campos poss√≠veis em um objeto padronizado.
 */
function normalizeUnit(raw) {
  // ‚îÄ‚îÄ identifica√ß√£o ‚îÄ‚îÄ
  // ATEN√á√ÉO: raw.nome pode ser nome do respons√°vel t√©cnico, N√ÉO da unidade. Exclu√≠do.
  const co_cnes     = String(raw.co_cnes || raw.cnes || raw.CO_CNES || '').trim();
  const no_fantasia = String(raw.no_fantasia   || raw.nome_fantasia || raw.NO_FANTASIA   || '').trim();
  const no_razao    = String(raw.no_razao_social || raw.razao_social || raw.NO_RAZAO_SOCIAL
                           || raw.no_estabelecimento || raw.estabelecimento || '').trim();
  // Nome preferencial: fantasia ‚Üí raz√£o social ‚Üí fallback com CNES
  const _nome = no_fantasia || no_razao || (co_cnes ? `Unidade CNES ${co_cnes}` : 'Unidade sem nome');

  // ‚îÄ‚îÄ tipo e classifica√ß√£o ‚îÄ‚îÄ
  const tp_unidade      = String(raw.tp_unidade || raw.TP_UNIDADE || raw.co_tipo_unidade || raw.tp_pfpj || '').trim();
  const ds_tipo_unidade = String(raw.ds_tipo_unidade || raw.tipo_unidade || raw.DS_TIPO_UNIDADE
                               || raw.descricao_tipo || raw.ds_tipo || '').trim();

  // ‚îÄ‚îÄ endere√ßo ‚îÄ‚îÄ
  const ds_tipo_log = String(raw.ds_tipo_logradouro || raw.tipo_logradouro || '').trim();
  const no_log      = String(raw.no_logradouro  || raw.ds_logradouro  || raw.logradouro
                           || raw.NO_LOGRADOURO || '').trim();
  const nu_endereco = String(raw.nu_endereco || raw.numero || raw.NU_ENDERECO || '').trim();
  const ds_compl    = String(raw.ds_complemento || raw.complemento || '').trim();
  const no_bairro   = String(raw.no_bairro  || raw.bairro  || raw.NO_BAIRRO  || '').trim();
  const no_municipio= String(raw.no_municipio|| raw.municipio|| raw.NO_MUNICIPIO || raw.cidade || '').trim();
  const sg_uf       = String(raw.sg_uf || raw.uf || raw.SG_UF || raw.estado || '').trim().toUpperCase();
  const co_cep      = String(raw.co_cep || raw.cep || raw.CO_CEP || '').replace(/\D/g,'');

  // ‚îÄ‚îÄ contato ‚îÄ‚îÄ
  const nu_telefone = String(raw.nu_telefone || raw.telefone || raw.fone || raw.NU_TELEFONE || '').replace(/\D/g,'');
  const ds_email    = String(raw.ds_email || raw.email || raw.DS_EMAIL || '').trim().toLowerCase();

  // ‚îÄ‚îÄ coordenadas: API BR pode retornar v√≠rgula como separador decimal ‚îÄ‚îÄ
  function parseCoord(v) {
    if (!v && v !== 0) return 0;
    return parseFloat(String(v).replace(',', '.')) || 0;
  }
  const nu_latitude  = parseCoord(raw.nu_latitude  || raw.latitude  || raw.lat || raw.NU_LATITUDE);
  const nu_longitude = parseCoord(raw.nu_longitude || raw.longitude || raw.lng || raw.lon || raw.NU_LONGITUDE);

  // ‚îÄ‚îÄ gest√£o ‚îÄ‚îÄ
  const tp_gestao = String(raw.tp_gestao || raw.gestao || raw.TP_GESTAO || '').toUpperCase().charAt(0) || '';

  return {
    co_cnes, no_fantasia, no_razao_social: no_razao, _nome,
    tp_unidade, ds_tipo_unidade,
    ds_tipo_logradouro: ds_tipo_log, no_logradouro: no_log,
    nu_endereco, ds_complemento: ds_compl, no_bairro, no_municipio, sg_uf, co_cep,
    nu_telefone, ds_email,
    nu_latitude, nu_longitude,
    tp_gestao,
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUSCA PRINCIPAL (por munic√≠pio)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buscarUnidades() {
  const coMunicipio = document.getElementById('selectMunicipio').value;
  if (!coMunicipio) {
    showNotification('Selecione um munic√≠pio antes de buscar.', 'error');
    return;
  }
  geoSearchMode = false;
  const munNome = document.getElementById('selectMunicipio')
    .options[document.getElementById('selectMunicipio').selectedIndex]?.text || '';
  await fetchUnidades(coMunicipio, munNome, false);
}

/**
 * @param {string}  coMunicipio  C√≥digo IBGE do munic√≠pio (6 d√≠gitos)
 * @param {string}  munNome      Nome para exibi√ß√£o
 * @param {boolean} geoMode      Se true, N√ÉO renderiza ‚Äî deixa applyGeoFilter() fazer isso
 */
async function fetchUnidades(coMunicipio, munNome = '', geoMode = false) {
  if (isLoading) return;
  isLoading = true;

  const btnBuscar = document.getElementById('btnBuscar');
  btnBuscar.disabled = true;
  btnBuscar.innerHTML = `<div class="spinner" style="width:16px;height:16px;border-width:2.5px;margin:0;"></div> Buscando...`;

  showProgressCard(`Buscando unidades${munNome ? ' ¬∑ ' + munNome : ''}‚Ä¶`);
  if (!geoMode) {
    document.getElementById('resultsSection').innerHTML = `
      <div class="status-box" style="padding:32px 40px;">
        <p style="color:var(--text-muted);font-size:0.88rem;">‚è≥ Aguarde ‚Äî carregando dados do CNES/DATASUS...</p>
      </div>`;
  }

  allUnits    = [];
  activeStrategy = 0;

  try {
    let offset = 0;
    let total  = null;

    while (true) {
      const path = `/estabelecimentos?co_municipio=${coMunicipio}&limit=${MAX_UNITS_PER_CALL}&offset=${offset}`;
      const data = await fetchCNES(path);

      const items = extractItems(data);
      if (!items || items.length === 0) break;

      // Atualiza total a partir do envelope
      if (!total) {
        total = parseInt(data.total ?? data.count ?? data.totalRecords ?? 0) || null;
      }

      items.forEach(raw => {
        const norm = normalizeUnit(raw);
        const classified = classifyUnit(norm);
        allUnits.push(classified);
      });

      const pct = total ? Math.min(95, Math.round((allUnits.length / total) * 100)) : Math.min(95, offset);
      updateProgressCard(
        `${allUnits.length}${total ? ' de ~' + total : ''} unidades carregadas‚Ä¶`,
        pct,
        allUnits.length
      );

      offset += items.length;
      if (items.length < MAX_UNITS_PER_CALL || allUnits.length >= MAX_TOTAL_UNITS) break;

      await delay(120); // pausa leve entre p√°ginas
    }

    updateProgressCard('Conclu√≠do!', 100, allUnits.length);

    if (!allUnits.length) {
      if (!geoMode) showEmpty();
    } else {
      if (geoMode) {
        // N√£o renderiza aqui ‚Äî applyGeoFilter far√° isso em seguida
        console.log(`[GEO] ${allUnits.length} unidades carregadas; aguardando filtro de dist√¢ncia.`);
      } else {
        filteredUnits = [...allUnits];
        applyLocalFilters(); // aplica filtros UI e renderiza
        showNotification(`‚úÖ ${allUnits.length} unidades carregadas!`, 'success');
      }
    }

  } catch(e) {
    console.error('[CNES] Erro final:', e);
    if (!geoMode) {
      showError(e.message);
    } else {
      setGeoStatus(`‚ùå Falha ao carregar dados: ${e.message}`);
    }
    showNotification('‚ùå Falha ao conectar ao CNES/DATASUS.', 'error');
  } finally {
    isLoading = false;
    btnBuscar.disabled = false;
    btnBuscar.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Buscar Unidades`;
    // Esconde progress card ap√≥s breve delay para o usu√°rio ver "Conclu√≠do"
    setTimeout(hideProgressCard, 900);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GEOLOCALIZA√á√ÉO ‚Äî completamente independente
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function usarGeolocalizacao() {
  if (!navigator.geolocation) {
    showNotification('Geolocaliza√ß√£o n√£o suportada neste navegador.', 'error');
    return;
  }
  setGeoStatus('üì° Obtendo sua localiza√ß√£o GPS...');
  navigator.geolocation.getCurrentPosition(
    pos => geoPositionObtida(pos),
    err => {
      const msgs = { 1:'Permiss√£o negada.', 2:'Posi√ß√£o indispon√≠vel.', 3:'Tempo esgotado.' };
      setGeoStatus(`‚ùå ${msgs[err.code] || 'Erro desconhecido.'}`);
      showNotification('N√£o foi poss√≠vel obter sua localiza√ß√£o. Permita o acesso.', 'error');
    },
    { enableHighAccuracy: true, timeout: 12000, maximumAge: 30000 }
  );
}

async function geoPositionObtida(pos) {
  userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
  const raio = parseFloat(document.getElementById('geoRaio').value) || 3;
  setGeoStatus(`üìç GPS: (${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}) ‚Äî identificando munic√≠pio...`);

  try {
    // 1. Reverse geocoding via Nominatim
    const nomUrl = `${NOMINATIM_API}/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lng}&addressdetails=1&accept-language=pt-BR`;
    const nomResp = await fetchWithTimeout(nomUrl, 10000);
    if (!nomResp.ok) throw new Error('Nominatim indispon√≠vel');
    const nomData = await nomResp.json();

    const addr      = nomData.address || {};
    const cityName  = addr.city || addr.town || addr.municipality || addr.county || addr.village || '';
    const stateCode = (addr['ISO3166-2-lvl4'] || '').split('-')[1] || '';
    const stateName = addr.state || '';
    const uf        = stateCode || stateName;

    if (!cityName) throw new Error('Munic√≠pio n√£o identificado nas coordenadas');

    setGeoStatus(`üèôÔ∏è Munic√≠pio detectado: ${cityName} ‚Äî ${uf}. Buscando c√≥digo IBGE...`);

    // 2. C√≥digo IBGE do munic√≠pio
    const ibgeCode = await buscarCodigoIBGE(cityName, uf);
    if (!ibgeCode) throw new Error(`Munic√≠pio "${cityName}" n√£o localizado no IBGE`);

    setGeoStatus(`üìã C√≥digo IBGE ${ibgeCode} ‚Äî carregando todas as unidades para filtrar em ${raio} km...`);

    // 3. Sincroniza seletores de UI (b√¥nus de UX ‚Äî n√£o bloqueia)
    sincronizarSeletores(uf, cityName, ibgeCode).catch(() => {});

    // 4. Carrega unidades em geoMode=true (sem renderizar ainda)
    geoSearchMode = true;
    await fetchUnidades(ibgeCode, cityName, true);

    // 5. Agora aplica filtro de dist√¢ncia e renderiza
    if (allUnits.length > 0) {
      applyGeoFilter();
    } else {
      setGeoStatus('‚ö†Ô∏è Nenhuma unidade encontrada para este munic√≠pio.');
      showEmpty();
      updateDashboard([]);
    }

  } catch(e) {
    console.error('[GEO]', e);
    setGeoStatus(`‚ö†Ô∏è ${e.message}`);
    showNotification(`Erro na busca por proximidade: ${e.message}`, 'error');
    hideProgressCard();
    // Fallback: se j√° h√° dados de busca anterior, filtra por dist√¢ncia
    if (allUnits.length > 0) {
      setGeoStatus(`‚ö†Ô∏è Usando dados anteriores. Filtrando por dist√¢ncia...`);
      geoSearchMode = true;
      applyGeoFilter();
    }
  }
}

async function buscarCodigoIBGE(cityName, stateHint) {
  // 1. Tenta busca direta pelo nome exato no IBGE
  const normalizado = cityName.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();

  // Tenta via UF se tiver pista do estado
  let estados = stateHint
    ? [stateHint.toUpperCase()]
    : ESTADOS.map(e => e.sg);

  for (const uf of estados) {
    try {
      const r = await fetchWithTimeout(`${IBGE_API}/estados/${uf}/municipios`, 8000);
      if (!r.ok) continue;
      const lista = await r.json();
      // Busca fuzzy por nome normalizado
      const match = lista.find(m => {
        const mn = m.nome.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
        return mn === normalizado || mn.includes(normalizado) || normalizado.includes(mn);
      });
      if (match) return String(match.id).substring(0, 6);
    } catch(_) { /* continua */ }
  }

  // Fallback: tenta busca nacional (todos os munic√≠pios ‚Äî pesado mas √∫ltimo recurso)
  try {
    const r = await fetchWithTimeout(`${IBGE_API}/municipios`, 15000);
    if (r.ok) {
      const lista = await r.json();
      const match = lista.find(m => {
        const mn = m.nome.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
        return mn === normalizado;
      });
      if (match) return String(match.id).substring(0, 6);
    }
  } catch(_) {}

  return null;
}

async function sincronizarSeletores(uf, cityName, ibgeCode) {
  try {
    const selEstado = document.getElementById('selectEstado');
    const selMun    = document.getElementById('selectMunicipio');
    const ufUpper   = uf.toUpperCase();

    // Seta UF
    if ([...selEstado.options].some(o => o.value === ufUpper)) {
      selEstado.value = ufUpper;
    }

    // Popula munic√≠pios se ainda n√£o populados
    if (selMun.options.length <= 1 || selMun.disabled) {
      const r = await fetchWithTimeout(`${IBGE_API}/estados/${ufUpper}/municipios`, 8000);
      if (r.ok) {
        const lista = await r.json();
        lista.sort((a,b) => a.nome.localeCompare(b.nome));
        selMun.innerHTML = '<option value="">‚Äî Selecione o munic√≠pio ‚Äî</option>';
        lista.forEach(m => {
          const opt = document.createElement('option');
          opt.value = String(m.id).substring(0, 6);
          opt.textContent = m.nome;
          selMun.appendChild(opt);
        });
        selMun.disabled = false;
      }
    }

    // Seta munic√≠pio
    const opt = [...selMun.options].find(o => o.value === ibgeCode);
    if (opt) selMun.value = ibgeCode;
    currentMunicipioCode = ibgeCode;
  } catch(_) { /* n√£o critico ‚Äî s√≥ UX */ }
}

function applyGeoFilter() {
  const raio = parseFloat(document.getElementById('geoRaio').value) || 3;
  if (!userLocation) return;

  const withCoords = [], noCoords = [];
  allUnits.forEach(u => {
    const lat = u.nu_latitude, lng = u.nu_longitude;
    if (lat && lng && Math.abs(lat) > 0.001 && Math.abs(lng) > 0.001) {
      const dist = haversine(userLocation.lat, userLocation.lng, lat, lng);
      if (dist <= raio) withCoords.push({ ...u, _distance: dist });
    } else {
      noCoords.push(u); // sem coordenadas ‚Äî n√£o podemos calcular dist√¢ncia
    }
  });

  withCoords.sort((a, b) => a._distance - b._distance);
  filteredUnits = withCoords;

  const semCoordMsg = noCoords.length
    ? ` (${noCoords.length} sem coordenadas GPS n√£o exibidas)`
    : '';
  setGeoStatus(
    `üìç ${filteredUnits.length} unidades em at√© ${raio} km de voc√™${semCoordMsg}.`
  );

  if (filteredUnits.length === 0) {
    setGeoStatus(`üìç Nenhuma unidade com coordenadas GPS no raio de ${raio} km. Tente aumentar o raio.${semCoordMsg}`);
    showNotification(`Nenhuma unidade com GPS encontrada em ${raio}km. Tente ampliar o raio.`, 'error');
    updateDashboard([]);
    showEmpty();
    return;
  }

  geoSearchMode = true;
  updateDashboard(filteredUnits);
  renderResults(filteredUnits);
  showNotification(`üìç ${filteredUnits.length} unidades encontradas em at√© ${raio} km!`, 'success');
}

function setGeoStatus(txt) {
  const el = document.getElementById('geoStatus');
  if (el) el.textContent = txt;
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLASSIFICA√á√ÉO DE UNIDADES (recebe unidade j√° normalizada)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function classifyUnit(u) {
  const tpCode  = String(u.tp_unidade || '').replace(/\D/g,'').padStart(2,'0');
  const norm    = s => String(s||'').toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const dsDesc  = norm(u.ds_tipo_unidade);
  const nomeStr = norm(u._nome) + ' ' + norm(u.no_razao_social);

  let nivel    = 'primaria';
  let tags     = ['ambulatorial'];
  let tipoNome = u.ds_tipo_unidade || 'Unidade de Sa√∫de';

  // 1. Pelo c√≥digo de tipo ‚Äî mais confi√°vel
  if (TP_MAP[tpCode]) {
    nivel    = TP_MAP[tpCode].nivel;
    tags     = [...TP_MAP[tpCode].tags];
    tipoNome = TP_MAP[tpCode].nome;
  } else {
    // 2. Fallback por keywords
    if (/HOSPITAL|UTI|TERAPIA INTENSIVA|ALTA COMPLEXIDADE/.test(dsDesc)) {
      nivel = 'terciaria'; tags = ['ambulatorial','urgencia'];
    } else if (/PRONTO SOCORRO|UPA|URGENCIA|EMERGENCIA/.test(dsDesc)) {
      nivel = 'terciaria'; tags = ['urgencia'];
    } else if (/POLICLINICA|ESPECIALIDADE|AMBULATORIO|CAPS|CLINICA/.test(dsDesc)) {
      nivel = 'secundaria'; tags = ['ambulatorial'];
    }
  }

  // 3. Enriquecimento por keywords de acolhimento espec√≠fico
  const allText = dsDesc + ' ' + nomeStr;
  if (/MATERNIDADE|MATERNO|PARTO|NEONATAL|OBSTETRI/.test(allText)) {
    tags = [...new Set([...tags, 'maternidade'])];
    if (nivel === 'primaria') nivel = 'terciaria';
  }
  if (/TRAUMA|ORTOPEDIA|ORTOPEDIC|FRATURA|REABILITACAO/.test(allText)) {
    tags = [...new Set([...tags, 'traumatologia'])];
  }
  // REGRA: urg√™ncia/emerg√™ncia n√£o pertence √† aten√ß√£o prim√°ria
  if (nivel !== 'primaria' && /URGENCIA|EMERGENCIA|PRONTO SOCORRO|\bUPA\b|\bSAMU\b/.test(allText)) {
    tags = [...new Set([...tags, 'urgencia'])];
  }

  if (!tags.length) tags = ['ambulatorial'];
  return { ...u, _nivel: nivel, _tags: tags, _tipoNome: tipoNome };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDashboard(units) {
  const counts = {
    total: units.length,
    primaria: 0, secundaria: 0, terciaria: 0,
    urgencia: 0, maternidade: 0, traumatologia: 0, ambulatorial: 0
  };
  units.forEach(u => {
    counts[u._nivel]++;
    u._tags.forEach(t => { if (counts[t] !== undefined) counts[t]++; });
  });

  Object.keys(counts).forEach(k => {
    const el = document.getElementById('stat' + k.charAt(0).toUpperCase() + k.slice(1));
    if (el) animateCount(el, counts[k]);
  });
}

function animateCount(el, target) {
  const start = parseInt(el.textContent) || 0;
  const duration = 600;
  const startTime = Date.now();
  const tick = () => {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(start + (target - start) * eased);
    if (progress < 1) requestAnimationFrame(tick);
  };
  tick();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER RESULTADOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInitial() {
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box">
      <span class="status-icon">üîç</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione estado e munic√≠pio nos filtros e clique em <strong>Buscar Unidades</strong>, ou use <strong>Usar Minha Localiza√ß√£o</strong> para detec√ß√£o autom√°tica.</p>
    </div>`;
}

function showLoading(munNome) {
  // O progresso principal est√° no searchProgressCard acima do dashboard.
  // Aqui apenas mostramos uma mensagem m√≠nima no painel de resultados.
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box" style="padding:32px 40px;">
      <p style="color:var(--text-muted);font-size:0.88rem;">‚è≥ Carregando unidades de sa√∫de${munNome ? ' de ' + munNome : ''}‚Ä¶</p>
    </div>`;
}

function showEmpty() {
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box">
      <span class="status-icon">üì≠</span>
      <h3>Nenhuma unidade encontrada</h3>
      <p>N√£o encontramos unidades para os crit√©rios selecionados. Tente outros filtros ou limpe a busca.</p>
    </div>`;
  updateDashboard([]);
}

function showError(msg) {
  document.getElementById('resultsSection').innerHTML = `
    <div class="status-box">
      <span class="status-icon">‚ö†Ô∏è</span>
      <h3>Falha ao conectar ao CNES/DATASUS</h3>
      <p>Todas as rotas de acesso foram tentadas sem sucesso.<br>
      <small style="color:var(--text-light);line-height:1.9">
        ‚Ä¢ Conex√£o inst√°vel ou sem internet<br>
        ‚Ä¢ API do Minist√©rio da Sa√∫de temporariamente indispon√≠vel<br>
        ‚Ä¢ Restri√ß√£o de rede ou firewall no ambiente atual
      </small></p>
      <p style="margin-top:14px;">
        <button class="btn btn-primary btn-sm" onclick="buscarUnidades()">üîÑ Tentar Novamente</button>
      </p>
      <p style="margin-top:8px;font-size:0.68rem;color:var(--text-light)">${escHtml(msg)}</p>
    </div>`;
}

function renderResults(units) {
  if (!units.length) { showEmpty(); return; }

  // Group by nivel + tag
  const groups = {};
  const groupOrder = [
    { nivel:'terciaria', tag:'urgencia' },
    { nivel:'terciaria', tag:'maternidade' },
    { nivel:'terciaria', tag:'traumatologia' },
    { nivel:'terciaria', tag:'ambulatorial' },
    { nivel:'secundaria', tag:'ambulatorial' },
    { nivel:'secundaria', tag:'traumatologia' },
    { nivel:'primaria', tag:'ambulatorial' },
    { nivel:'primaria', tag:'urgencia' },
  ];

  units.forEach(u => {
    u._tags.forEach(tag => {
      const key = `${u._nivel}|${tag}`;
      if (!groups[key]) groups[key] = [];
      groups[key].push(u);
    });
  });

  const container = document.getElementById('resultsSection');

  let html = `
  <div class="results-header">
    <div>
      <span class="results-title">Unidades de Sa√∫de Encontradas</span>
      <span class="results-count">${units.length} unidades</span>
    </div>
    <div class="export-row">
      <button class="btn btn-primary btn-sm" onclick="exportarExcel()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
        Exportar Excel
      </button>
      <button class="btn btn-amber btn-sm" onclick="exportarPDF()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Exportar PDF A5
      </button>
    </div>
  </div>`;

  const renderedKeys = new Set();

  groupOrder.forEach(({ nivel, tag }) => {
    const key = `${nivel}|${tag}`;
    if (!groups[key] || renderedKeys.has(key)) return;
    renderedKeys.add(key);

    const groupUnits = groups[key];
    const nConf = NIVEL_CONFIG[nivel];
    const aConf = ACOLHIMENTO_CONFIG[tag];

    html += `
    <div class="group-section nivel-${nivel}">
      <div class="group-header" onclick="toggleGroup('${key.replace('|','-')}')">
        <div class="group-header-left">
          <div class="group-header-icon" style="background:${nConf.bg};color:${nConf.color};width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0">${nConf.emoji}</div>
          <div>
            <div class="group-name">${nConf.label} ‚Äî ${aConf.label}</div>
            <div class="group-meta">${groupUnits.length} unidade${groupUnits.length !== 1 ? 's' : ''} ‚Ä¢ clique para expandir/recolher</div>
          </div>
          <span class="group-pill" style="background:${nConf.bg};color:${nConf.color}">${nConf.label}</span>
          <span class="group-pill" style="background:#f0f0f0;color:#555">${aConf.label}</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="group-count">${groupUnits.length}</div>
          <span class="group-arrow" id="arrow-${key.replace('|','-')}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
          </span>
        </div>
      </div>
      <div class="group-body" id="group-${key.replace('|','-')}">
        <div class="cards-grid">
          ${groupUnits.map(u => renderUnitCard(u, nConf, tag)).join('')}
        </div>
      </div>
    </div>`;
  });

  // Demais grupos n√£o cobertos
  Object.keys(groups).forEach(key => {
    if (renderedKeys.has(key)) return;
    const [nivel, tag] = key.split('|');
    const nConf = NIVEL_CONFIG[nivel] || NIVEL_CONFIG.primaria;
    const aConf = ACOLHIMENTO_CONFIG[tag] || ACOLHIMENTO_CONFIG.ambulatorial;
    const groupUnits = groups[key];

    html += `
    <div class="group-section nivel-${nivel}">
      <div class="group-header" onclick="toggleGroup('${key.replace('|','-')}')">
        <div class="group-header-left">
          <div>
            <div class="group-name">${nConf.label} ‚Äî ${aConf.label}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="group-count">${groupUnits.length}</div>
          <span class="group-arrow" id="arrow-${key.replace('|','-')}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
          </span>
        </div>
      </div>
      <div class="group-body" id="group-${key.replace('|','-')}">
        <div class="cards-grid">
          ${groupUnits.map(u => renderUnitCard(u, nConf, tag)).join('')}
        </div>
      </div>
    </div>`;
  });

  container.innerHTML = html;
}

function renderUnitCard(u, nConf, currentTag) {
  // Usa campos normalizados (_nome, no_logradouro, etc.)
  const nome     = u._nome || u.no_fantasia || u.no_razao_social || 'Unidade sem nome';
  const rua      = [u.ds_tipo_logradouro, u.no_logradouro, u.nu_endereco].filter(Boolean).join(' ');
  const bairro   = u.no_bairro   || '';
  const municipio= u.no_municipio|| '';
  const uf       = u.sg_uf       || '';
  const cep      = u.co_cep ? String(u.co_cep).replace(/^(\d{5})(\d{3})$/, '$1-$2') : '';
  const tel      = u.nu_telefone ? formatPhone(u.nu_telefone) : '';
  const email    = u.ds_email    || '';
  const cnes     = u.co_cnes     || '';
  const gestao   = GESTAO_MAP[u.tp_gestao] || '';

  const enderecoCompleto = [rua, bairro, municipio, uf, cep ? 'CEP ' + cep : ''].filter(Boolean).join(', ');

  // Links externos
  const lat = u.nu_latitude, lng = u.nu_longitude;
  const mapsQuery = encodeURIComponent(`${nome} ${enderecoCompleto}`);
  const mapsUrl   = (lat && lng)
    ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
    : `https://www.google.com/maps/search/?api=1&query=${mapsQuery}`;
  const googleSearch = `https://www.google.com/search?q=${encodeURIComponent(nome + ' ' + municipio + ' ' + uf + ' sa√∫de')}`;
  const cnesUrl   = cnes ? `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.faces?pk=${cnes}` : '';
  const waText    = `üè• *${nome}*\nüìç ${enderecoCompleto}${tel ? '\nüìû ' + tel : ''}${cnesUrl ? '\nüîó ' + cnesUrl : ''}`;
  const waUrl     = `https://wa.me/?text=${encodeURIComponent(waText)}`;

  const distBadge = u._distance != null
    ? `<span class="unit-tag unit-tag-ambulatorial unit-distance">üìç ${u._distance.toFixed(1)} km</span>`
    : '';

  const gestaoClass = u.tp_gestao === 'M' ? 'unit-tag-municipal'
                    : u.tp_gestao === 'E' ? 'unit-tag-estadual'
                    : u.tp_gestao === 'F' ? 'unit-tag-federal'
                    : 'unit-tag-ambulatorial';

  return `
  <div class="unit-card">
    <div class="unit-card-accent" style="background:${nConf.color}"></div>
    <div class="unit-card-inner">
      <div class="unit-card-header">
        <div class="unit-name" title="${escHtml(nome)}">${escHtml(nome)}</div>
        <span class="unit-type-badge" style="background:${nConf.bg};color:${nConf.color}">${escHtml(u._tipoNome || u.ds_tipo_unidade || '‚Äî')}</span>
      </div>
      ${cnes ? `<div class="unit-cnes">CNES: ${escHtml(cnes)}</div>` : ''}
      <div class="unit-tags">
        ${u._tags.map(t => `<span class="unit-tag ${ACOLHIMENTO_CONFIG[t]?.tagClass||''}">${ACOLHIMENTO_CONFIG[t]?.emoji||''} ${ACOLHIMENTO_CONFIG[t]?.label||t}</span>`).join('')}
        ${gestao ? `<span class="unit-tag ${gestaoClass}">${escHtml(gestao)}</span>` : ''}
        ${distBadge}
      </div>
      ${rua    ? `<div class="unit-info-row">${iconPin()}<span>${escHtml(rua)}${bairro ? ', '+escHtml(bairro) : ''}</span></div>` : ''}
      ${municipio ? `<div class="unit-info-row">${iconHome()}<span>${escHtml(municipio)}${uf?' ‚Äî '+uf:''}${cep?' ¬∑ CEP '+cep:''}</span></div>` : ''}
      ${tel   ? `<div class="unit-info-row">${iconPhone()}<span>${escHtml(tel)}</span></div>` : ''}
      ${email ? `<div class="unit-info-row">${iconMail()}<span>${escHtml(email)}</span></div>` : ''}
      <div class="unit-actions">
        ${cnesUrl ? `<button class="btn btn-icon" onclick="window.open('${cnesUrl}','_blank')" title="Ficha CNES/DATASUS">${iconLink()}</button>` : ''}
        <button class="btn btn-icon search" onclick="window.open('${googleSearch}','_blank')" title="Google Search">${iconSearch()}</button>
        <button class="btn btn-icon maps"   onclick="window.open('${mapsUrl}','_blank')"   title="Google Maps">${iconMapPin()}</button>
        <button class="btn btn-icon whatsapp" onclick="window.open('${waUrl}','_blank')"   title="Compartilhar WhatsApp">${iconWa()}</button>
        ${tel ? `<a class="btn btn-icon" href="tel:+55${u.nu_telefone}" title="Ligar">${iconPhone()}</a>` : ''}
      </div>
    </div>
  </div>`;
}

// ‚îÄ micro √≠cones inline ‚îÄ
const iconPin    = () => `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>`;
const iconHome   = () => `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>`;
const iconPhone  = () => `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.63a19.79 19.79 0 01-3.07-8.67A2 2 0 012 .84h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.09 8.03a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.34 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>`;
const iconMail   = () => `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`;
const iconLink   = () => `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>`;
const iconSearch = () => `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>`;
const iconMapPin = () => `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>`;
const iconWa     = () => `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>`;

function toggleGroup(key) {
  const body = document.getElementById('group-' + key);
  const arrow = document.getElementById('arrow-' + key);
  if (!body) return;
  const isOpen = body.classList.toggle('open');
  if (arrow) arrow.classList.toggle('open', isOpen);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportarExcel() {
  if (!filteredUnits.length) { showNotification('Nenhuma unidade para exportar.', 'error'); return; }

  try {
    const wb = XLSX.utils.book_new();
    const niveisOrdem = ['terciaria','secundaria','primaria'];
    const tagsOrdem = ['urgencia','maternidade','traumatologia','ambulatorial'];

    niveisOrdem.forEach(nivel => {
      tagsOrdem.forEach(tag => {
        const units = filteredUnits.filter(u => u._nivel === nivel && u._tags.includes(tag));
        if (!units.length) return;

        const nConf = NIVEL_CONFIG[nivel];
        const aConf = ACOLHIMENTO_CONFIG[tag];
        const sheetName = `${nConf.label.substring(0,10)} - ${aConf.label.substring(0,10)}`.substring(0,31);

        const rows = [
          ['CNES','Nome / Fantasia','Raz√£o Social','Tipo de Unidade','N√≠vel de Aten√ß√£o','Acolhimento','Gest√£o','Logradouro','N√∫mero','Complemento','Bairro','Munic√≠pio','UF','CEP','Telefone','E-mail','Latitude','Longitude','Link CNES','Google Maps']
        ];

        units.forEach(u => {
            const rua     = [u.ds_tipo_logradouro, u.no_logradouro, u.nu_endereco].filter(Boolean).join(' ');
            const cnes    = u.co_cnes || '';
            const lat     = u.nu_latitude  || '';
            const lng     = u.nu_longitude || '';
            const cnesUrl = cnes ? `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.faces?pk=${cnes}` : '';
            const mapsUrl = (lat && lng) ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}` : '';
            const cep     = u.co_cep ? String(u.co_cep).replace(/^(\d{5})(\d{3})$/, '$1-$2') : '';

          rows.push([
            cnes,
            u._nome || u.no_fantasia || '',
            u.no_razao_social || '',
            u.ds_tipo_unidade || '',
            NIVEL_CONFIG[u._nivel]?.label || '',
            u._tags.map(t => ACOLHIMENTO_CONFIG[t]?.label || t).join(' | '),
            GESTAO_MAP[u.tp_gestao] || u.tp_gestao || '',
            rua,
            u.nu_endereco || '',
            u.ds_complemento || '',
            u.no_bairro || '',
            u.no_municipio || '',
            u.sg_uf || '',
            cep,
            u.nu_telefone ? formatPhone(u.nu_telefone) : '',
            u.ds_email || '',
            lat,
            lng,
            cnesUrl,
            mapsUrl
          ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(rows);

        // Style header
        const range = XLSX.utils.decode_range(ws['!ref']);
        ws['!cols'] = [
          {wch:10},{wch:35},{wch:35},{wch:30},{wch:18},{wch:30},{wch:14},
          {wch:30},{wch:8},{wch:15},{wch:20},{wch:20},{wch:5},{wch:10},
          {wch:15},{wch:25},{wch:12},{wch:12},{wch:50},{wch:50}
        ];

        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      });
    });

    // Aba Resumo
    const resumoRows = [
      ['RELAT√ìRIO DE UNIDADES DE SA√öDE P√öBLICA ‚Äî Sa√∫deBR / CNES-DATASUS'],
      [`Gerado em: ${new Date().toLocaleString('pt-BR')}`],
      [''],
      ['PERFIL','ACOLHIMENTO','QUANTIDADE'],
    ];
    niveisOrdem.forEach(nivel => {
      tagsOrdem.forEach(tag => {
        const count = filteredUnits.filter(u => u._nivel === nivel && u._tags.includes(tag)).length;
        if (count) resumoRows.push([NIVEL_CONFIG[nivel].label, ACOLHIMENTO_CONFIG[tag].label, count]);
      });
    });
    resumoRows.push(['','TOTAL GERAL', filteredUnits.length]);
    const wsResumo = XLSX.utils.aoa_to_sheet(resumoRows);
    wsResumo['!cols'] = [{wch:22},{wch:22},{wch:14}];
    XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');

    const munNome = document.getElementById('selectMunicipio').options[document.getElementById('selectMunicipio').selectedIndex]?.text || 'Busca';
    XLSX.writeFile(wb, `CNES_Unidades_Saude_${munNome.replace(/[^a-zA-Z0-9]/g,'_')}_${Date.now()}.xlsx`);
    showNotification('‚úÖ Planilha Excel exportada com sucesso!', 'success');
  } catch(e) {
    console.error(e);
    showNotification('Erro ao gerar a planilha Excel.', 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT PDF A5 HORIZONTAL ‚Äî sem emoji, com pr√©-visualiza√ß√£o
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _pdfBlobUrl  = null;
let _pdfFilename = '';

function fecharModalPDF() {
  document.getElementById('pdfModalOverlay').style.display = 'none';
  document.getElementById('pdfModalIframe').src = '';
  if (_pdfBlobUrl) { URL.revokeObjectURL(_pdfBlobUrl); _pdfBlobUrl = null; }
}

function exportarPDF() {
  if (!filteredUnits.length) { showNotification('Nenhuma unidade para exportar.', 'error'); return; }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
    const W = 210, H = 148, margin = 10;

    const munNome = document.getElementById('selectMunicipio')
      .options[document.getElementById('selectMunicipio').selectedIndex]?.text || 'Brasil';
    const ufSel = document.getElementById('selectEstado').value || '';
    const dataGer = new Date().toLocaleString('pt-BR');

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CAPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    doc.setFillColor(11, 31, 58);
    doc.rect(0, 0, W, H, 'F');

    // Faixa decorativa teal
    doc.setFillColor(0, 168, 120);
    doc.rect(0, H - 24, W, 24, 'F');

    // Cruz (logo)
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(4);
    doc.line(W/2 - 12, H/2 - 30, W/2 + 12, H/2 - 30);
    doc.line(W/2, H/2 - 42, W/2, H/2 - 18);

    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(24);
    doc.text('SaudeBR', W/2, H/2 - 5, { align: 'center' });

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9.5);
    doc.setTextColor(180, 230, 210);
    doc.text('Localizador de Unidades de Saude Publica', W/2, H/2 + 5, { align: 'center' });
    doc.text('CNES / DATASUS - Ministerio da Saude do Brasil', W/2, H/2 + 12, { align: 'center' });

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(13);
    doc.setTextColor(255, 255, 255);
    doc.text(`${munNome}${ufSel ? ' - ' + ufSel : ''}`, W/2, H/2 + 24, { align: 'center' });

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7.5);
    doc.setTextColor(255, 255, 255);
    doc.text(`Gerado em ${dataGer}  |  Total de unidades: ${filteredUnits.length}`, W/2, H - 10, { align: 'center' });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SE√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const niveisOrdem = ['terciaria','secundaria','primaria'];
    const tagsOrdem   = ['urgencia','maternidade','traumatologia','ambulatorial'];

    const nivelLabels = { terciaria:'Atencao Terciaria', secundaria:'Atencao Secundaria', primaria:'Atencao Primaria' };
    const tagLabels   = { urgencia:'Urgencia / Emergencia', maternidade:'Maternidade', traumatologia:'Traumatologia', ambulatorial:'Ambulatorial' };
    const nivelColors = {
      terciaria:  [229, 57,  53 ],
      secundaria: [21,  101, 192],
      primaria:   [0,   168, 120],
    };

    niveisOrdem.forEach(nivel => {
      tagsOrdem.forEach(tag => {
        const units = filteredUnits.filter(u => u._nivel === nivel && u._tags.includes(tag));
        if (!units.length) return;

        const [cr, cg, cb] = nivelColors[nivel];

        doc.addPage('a5', 'landscape');

        // Cabe√ßalho da se√ß√£o
        doc.setFillColor(cr, cg, cb);
        doc.rect(0, 0, W, 20, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.setTextColor(255, 255, 255);
        doc.text(`${nivelLabels[nivel]}  /  ${tagLabels[tag]}`, margin, 13);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.text(`${units.length} unidade${units.length !== 1 ? 's' : ''}`, W - margin, 13, { align: 'right' });

        // Tabela
        const tableRows = units.map((u, idx) => {
          const rua      = [u.ds_tipo_logradouro, u.no_logradouro, u.nu_endereco].filter(Boolean).join(' ');
          const bairro   = u.no_bairro || '';
          const mun      = [u.no_municipio, u.sg_uf].filter(Boolean).join(' - ');
          const cep      = u.co_cep ? String(u.co_cep).replace(/^(\d{5})(\d{3})$/,'$1-$2') : '';
          const tel      = u.nu_telefone ? formatPhone(u.nu_telefone) : '';
          const cnes     = u.co_cnes || '';
          const endereco = [rua, bairro, mun, cep ? 'CEP ' + cep : ''].filter(Boolean).join('\n');
          const contato  = [tel, u.ds_email].filter(Boolean).join('\n');
          // Link completo ao CNES
          const cnesLink = cnes
            ? `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.faces?pk=${cnes}`
            : '-';
          return [
            String(idx + 1),
            u._nome || u.no_fantasia || u.no_razao_social || '-',
            u._tipoNome || u.ds_tipo_unidade || '-',
            GESTAO_MAP[u.tp_gestao] || '-',
            endereco || '-',
            contato  || '-',
            cnesLink,
          ];
        });

        doc.autoTable({
          startY: 24,
          head: [['#', 'Nome / Estabelecimento', 'Tipo', 'Gestao', 'Endereco', 'Contato', 'Link CNES']],
          body: tableRows,
          theme: 'grid',
          styles: {
            fontSize: 6.2,
            cellPadding: 1.8,
            overflow: 'linebreak',
            lineColor: [215, 225, 240],
            lineWidth: 0.2,
            textColor: [15, 30, 55],
            font: 'helvetica',
          },
          headStyles: {
            fillColor: [cr, cg, cb],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 6.8,
          },
          alternateRowStyles: { fillColor: [246, 249, 253] },
          columnStyles: {
            0: { cellWidth: 7,  halign: 'center' },
            1: { cellWidth: 44 },
            2: { cellWidth: 28 },
            3: { cellWidth: 18 },
            4: { cellWidth: 38 },
            5: { cellWidth: 26 },
            6: { cellWidth: 45, fontSize: 5.5 },
          },
          margin: { left: margin, right: margin },
          didDrawPage: data => {
            // Faixa de cor no topo de p√°ginas continuadas
            const pg = doc.internal.getCurrentPageInfo().pageNumber;
            if (data.pageCount > 1 && pg > 1) {
              doc.setFillColor(cr, cg, cb);
              doc.rect(0, 0, W, 8, 'F');
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(6.5);
              doc.setTextColor(255, 255, 255);
              doc.text(`${nivelLabels[nivel]} / ${tagLabels[tag]} ‚Äî continuacao`, margin, 5.5);
            }
            // Rodap√©
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(5.8);
            doc.setTextColor(160, 160, 160);
            doc.text('SaudeBR | CNES/DATASUS - Ministerio da Saude', margin, H - 3.5);
            doc.text(`pag. ${pg}`, W - margin, H - 3.5, { align: 'right' });
          },
        });
      });
    });

    // ‚îÄ‚îÄ Gera blob, mostra modal de pr√©-visualiza√ß√£o ‚îÄ‚îÄ
    const pdfBlob = doc.output('blob');
    if (_pdfBlobUrl) URL.revokeObjectURL(_pdfBlobUrl);
    _pdfBlobUrl = URL.createObjectURL(pdfBlob);

    const munSafe = munNome.replace(/[^a-zA-Z0-9]/g,'_');
    _pdfFilename  = `SaudeBR_CNES_${munSafe}_${Date.now()}.pdf`;

    document.getElementById('pdfModalSubtitle').textContent =
      `A5 Horizontal ¬∑ ${filteredUnits.length} unidades ¬∑ ${dataGer}`;
    document.getElementById('pdfModalIframe').src = _pdfBlobUrl;

    const overlay = document.getElementById('pdfModalOverlay');
    overlay.style.display = 'flex';

    // Bot√£o de download
    const btnDl = document.getElementById('btnDownloadPDF');
    btnDl.onclick = () => {
      const a = document.createElement('a');
      a.href     = _pdfBlobUrl;
      a.download = _pdfFilename;
      a.click();
      showNotification('PDF baixado com sucesso!', 'success');
    };

    showNotification('Pr√©via do PDF gerada. Revise e clique em Baixar PDF.', 'success');

  } catch(e) {
    console.error('[PDF]', e);
    showNotification('Erro ao gerar o PDF. Verifique o console.', 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILIT√ÅRIOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatPhone(tel) {
  if (!tel) return '';
  const d = String(tel).replace(/\D/g, '');
  if (d.length === 11) return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`;
  if (d.length === 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;
  return tel;
}

function escHtml(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showNotification(msg, type='info') {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  const n = document.createElement('div');
  n.className = `notification ${type}`;
  n.innerHTML = `<span>${msg}</span>`;
  document.body.appendChild(n);
  setTimeout(() => { n.style.opacity='0'; n.style.transform='translateX(30px)'; n.style.transition='all 0.3s'; setTimeout(()=>n.remove(),300); }, 3500);
}
</script>
</body>
</html>

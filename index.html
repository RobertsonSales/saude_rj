<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sa√∫de-BR (+) Localizador de Unidades de Sa√∫de P√∫blica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* CSS original (mantido integralmente) */
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* ‚îÄ‚îÄ‚îÄ FILTER PANEL ‚îÄ‚îÄ‚îÄ */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,168,120,0.1);
    }
    select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6E85' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--radius-sm);
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,168,120,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,168,120,0.4);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover { background: #fff; border-color: var(--teal); color: var(--teal); }
    .btn-navy {
      background: var(--navy);
      color: #fff;
      box-shadow: 0 4px 12px rgba(11,31,58,0.25);
    }
    .btn-navy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(11,31,58,0.35); }
    .btn-amber {
      background: linear-gradient(135deg, var(--amber) 0%, #F7BE50 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(245,166,35,0.35);
    }
    .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(245,166,35,0.45); }
    .btn-geo {
      background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21,101,192,0.3);
    }
    .btn-geo:hover { transform: translateY(-1px); }
    .btn-sm { padding: 7px 14px; font-size: 0.78rem; }
    .btn-icon { width: 34px; height: 34px; padding: 0; justify-content: center; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* ‚îÄ‚îÄ‚îÄ GEO SECTION ‚îÄ‚îÄ‚îÄ */
    .geo-section {
      background: linear-gradient(135deg, var(--blue-pale), #d8e8ff);
      border: 1px solid rgba(21,101,192,0.2);
      border-radius: var(--radius);
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .geo-info { flex: 1; }
    .geo-info h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--blue);
    }
    .geo-info p { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .geo-radius-row { display: flex; align-items: center; gap: 10px; }
    .geo-radius-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .geo-radius-input {
      width: 80px;
      background: #fff;
      border: 1.5px solid rgba(21,101,192,0.3);
      border-radius: 8px;
      padding: 7px 10px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      text-align: center;
    }

    /* ‚îÄ‚îÄ‚îÄ DASHBOARD CARDS ‚îÄ‚îÄ‚îÄ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--teal));
    }
    .stat-card-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    .stat-card-value {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      line-height: 1;
      color: var(--navy);
      transition: all 0.5s;
    }
    .stat-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .stat-card-sublabel { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }

    /* ‚îÄ‚îÄ‚îÄ RESULTS SECTION ‚îÄ‚îÄ‚îÄ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .results-count {
      background: var(--teal-pale);
      color: var(--teal);
      font-size: 0.78rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 8px;
    }
    .export-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ‚îÄ‚îÄ‚îÄ GROUP SECTIONS ‚îÄ‚îÄ‚îÄ */
    .group-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .group-header {
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .group-header:hover { background: var(--bg); }
    .group-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .group-pill {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.78rem;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .group-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .group-meta { font-size: 0.78rem; color: var(--text-muted); }
    .group-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--navy);
      min-width: 60px;
      text-align: right;
    }
    .group-arrow { color: var(--text-muted); transition: transform 0.3s; }
    .group-arrow.open { transform: rotate(90deg); }

    .group-body {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: none;
    }
    .group-body.open { display: block; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    /* ‚îÄ‚îÄ‚îÄ UNIT CARDS ‚îÄ‚îÄ‚îÄ */
    .unit-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-card-accent {
      position: absolute;
      top: 0; left: 0;
      width: 4px;
      height: 100%;
    }
    .unit-card-inner { padding-left: 8px; }
    .unit-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--navy);
      line-height: 1.3;
    }
    .unit-type-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .unit-info-row svg { flex-shrink: 0; margin-top: 1px; color: var(--text-light); }
    .unit-cnes {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 10px;
      font-family: 'Outfit', sans-serif;
    }
    .unit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }
    .unit-tag {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-tag-urgencia { background: var(--red-pale); color: var(--red); }
    .unit-tag-ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .unit-tag-maternidade { background: var(--purple-pale); color: var(--purple); }
    .unit-tag-especializado { background: var(--amber-pale); color: #C07A00; }
    .unit-tag-federal { background: #E8F0FE; color: var(--blue); }
    .unit-tag-estadual { background: #FFF8EC; color: #9C6E00; }
    .unit-tag-municipal { background: var(--teal-pale); color: #006B4F; }
    .unit-distance { background: var(--blue-pale); color: var(--blue); }
    .unit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 4px;
    }
    .unit-actions .btn-icon {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      transition: all 0.2s;
    }
    .unit-actions .btn-icon:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-pale); }
    .unit-actions .btn-icon.whatsapp:hover { border-color: #25D366; color: #25D366; background: #E8FBF0; }
    .unit-actions .btn-icon.maps:hover { border-color: #EA4335; color: #EA4335; background: #FDECEA; }
    .unit-actions .btn-icon.search:hover { border-color: #4285F4; color: #4285F4; background: #E8F0FE; }
    .unit-actions .btn-icon.phone:hover { border-color: #0B1F3A; color: #0B1F3A; background: #EDF1F7; }

    /* ‚îÄ‚îÄ‚îÄ PIX BUTTON ‚îÄ‚îÄ‚îÄ */
    .pix-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #00B37E 0%, #00C896 100%);
      border: none;
      border-radius: 10px;
      padding: 9px 16px;
      color: #fff;
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.82rem;
      cursor: pointer;
      flex-shrink: 0;
      box-shadow: 0 3px 12px rgba(0,180,126,0.45);
      transition: all 0.2s;
      letter-spacing: 0.3px;
    }
    .pix-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,180,126,0.55); }

    /* ‚îÄ‚îÄ‚îÄ PIX MODAL ‚îÄ‚îÄ‚îÄ */
    .pix-modal-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(11,31,58,0.75);
      backdrop-filter: blur(6px);
      z-index: 10000;
      display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .pix-modal-overlay.visible { display: flex; }
    .pix-modal-content {
      background: var(--surface); border-radius: 20px; max-width: 420px; width: 100%;
      box-shadow: 0 24px 64px rgba(11,31,58,0.25); overflow: hidden;
      animation: slideDown 0.3s ease;
    }
    .pix-modal-header {
      background: linear-gradient(135deg, var(--navy) 0%, #1a4a7a 100%);
      padding: 22px 24px 20px; text-align: center; position: relative;
    }
    .pix-modal-header h3 { font-family:'Outfit',sans-serif; font-weight:800; font-size:1.25rem; color:#fff; margin-bottom:4px; }
    .pix-modal-header p  { font-size:0.75rem; color:rgba(255,255,255,0.55); }
    .pix-modal-close {
      position:absolute; top:14px; right:14px;
      background:rgba(255,255,255,0.12); border:none; border-radius:8px;
      width:32px; height:32px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; color:rgba(255,255,255,0.7); transition:all 0.2s;
    }
    .pix-modal-close:hover { background:rgba(255,255,255,0.22); color:#fff; }
    .pix-modal-body { padding:26px 24px 28px; text-align:center; }
    .pix-appeal { font-size:0.9rem; color:var(--text-muted); line-height:1.6; margin-bottom:22px; text-align:left; }
    .pix-appeal strong { color:var(--navy); }
    .pix-qr-wrap {
      background:#fff; border:3px solid var(--teal-pale); border-radius:16px;
      padding:16px; display:inline-block; margin-bottom:20px; box-shadow:var(--shadow-sm);
    }
    .pix-qr-wrap img { display:block; width:200px; height:200px; border-radius:8px; }
    .pix-key-box {
      display:flex; align-items:center; gap:10px;
      background:var(--bg); border:1.5px solid var(--border); border-radius:10px;
      padding:12px 16px; margin-bottom:14px;
    }
    .pix-key-label { font-size:0.7rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; }
    .pix-key-value { flex:1; font-family:'Outfit',sans-serif; font-weight:700; font-size:0.92rem; color:var(--navy); text-align:left; word-break:break-all; }
    .pix-copy-btn {
      background:linear-gradient(135deg,var(--teal) 0%,var(--teal-light) 100%);
      border:none; border-radius:8px; padding:8px 12px; color:#fff;
      font-family:'Outfit',sans-serif; font-weight:700; font-size:0.75rem; cursor:pointer;
      display:flex; align-items:center; gap:5px; white-space:nowrap;
      transition:all 0.2s; flex-shrink:0;
    }
    .pix-copy-btn:hover { transform:scale(1.03); }
    .pix-copy-btn.copied { background:linear-gradient(135deg,#00A878,#00A878); }
    .pix-thanks { font-size:0.78rem; color:var(--text-light); margin-top:4px; }
    .pix-thanks span { color:var(--teal); font-weight:600; }

    /* ‚îÄ‚îÄ‚îÄ ACTION ICONS ‚Äî identidade visual das apps ‚îÄ‚îÄ‚îÄ */
    .unit-actions .btn-icon { width:38px; height:38px; border-radius:10px; border:none; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:all 0.18s; flex-shrink:0; }
    .unit-actions .btn-icon.maps    { background:#fff; box-shadow:0 1px 4px rgba(234,67,53,0.25); }
    .unit-actions .btn-icon.maps:hover { transform:scale(1.1); box-shadow:0 4px 12px rgba(234,67,53,0.4); }
    .unit-actions .btn-icon.search  { background:#fff; box-shadow:0 1px 4px rgba(66,133,244,0.25); }
    .unit-actions .btn-icon.search:hover { transform:scale(1.1); box-shadow:0 4px 12px rgba(66,133,244,0.4); }
    .unit-actions .btn-icon.phone   { background:#25D366; box-shadow:0 1px 4px rgba(37,211,102,0.3); }
    .unit-actions .btn-icon.phone:hover { transform:scale(1.1); box-shadow:0 4px 12px rgba(37,211,102,0.45); }
    .unit-actions .btn-icon.whatsapp{ background:#25D366; box-shadow:0 1px 4px rgba(37,211,102,0.3); }
    .unit-actions .btn-icon.whatsapp:hover { transform:scale(1.1); box-shadow:0 4px 12px rgba(37,211,102,0.45); }
    .unit-actions .btn-icon.email   { background:#EA4335; box-shadow:0 1px 4px rgba(234,67,53,0.25); }
    .unit-actions .btn-icon.email:hover { transform:scale(1.1); box-shadow:0 4px 12px rgba(234,67,53,0.4); }

    /* ‚îÄ‚îÄ‚îÄ LOADING / EMPTY / ERROR ‚îÄ‚îÄ‚îÄ */
    .status-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 60px 40px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .status-box .status-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }
    .status-box h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .status-box p { font-size: 0.88rem; color: var(--text-muted); max-width: 400px; margin: 0 auto; }

    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--teal-pale);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-wrap {
      max-width: 360px;
      margin: 16px auto 0;
      background: var(--border);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    /* ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD ‚îÄ‚îÄ‚îÄ */
    .search-progress-card {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
      border-radius: var(--radius);
      padding: 20px 28px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 20px;
      border: 1px solid rgba(0,168,120,0.25);
      box-shadow: var(--shadow-md);
      animation: slideDown 0.3s ease;
    }
    .search-progress-card.visible { display: flex; }
    .search-progress-spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(0,200,150,0.25);
      border-top-color: var(--teal-light);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    .search-progress-info { flex: 1; min-width: 0; }
    .search-progress-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.92rem;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-progress-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      min-height: 16px;
    }
    .search-progress-bar-wrap {
      flex: 1;
      max-width: 260px;
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .search-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .search-progress-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--teal-light);
      min-width: 48px;
      text-align: right;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ PDF PREVIEW MODAL ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(11,31,58,0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.visible { display: flex; }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 1400px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover { background: var(--red-pale); color: var(--red); }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
      background: var(--bg);
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .btn-whatsapp {
      background: linear-gradient(135deg, #25D366, #128C7E);
      color: white;
    }
    .btn-whatsapp:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(37,211,102,0.4);
    }

    /* ‚îÄ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ‚îÄ */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--navy);
      color: #fff;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 340px;
    }
    .notification.success { background: var(--teal); }
    .notification.error { background: var(--red); }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .footer a { color: var(--teal); text-decoration: none; }

    /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      .main-wrapper { padding: 16px 14px 40px; }
      .header-inner { padding: 14px 16px; }
      .header-titles h1 { font-size: 1.2rem; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: 1fr; }
      .geo-section { flex-direction: column; align-items: stretch; }
      .modal-content { max-height: 95vh; }
    }

    /* ‚îÄ‚îÄ‚îÄ NIVEL COLORS ‚îÄ‚îÄ‚îÄ */
    .nivel-primaria { --nivel-color: #00A878; }
    .nivel-secundaria { --nivel-color: #1565C0; }
    .nivel-terciaria { --nivel-color: #E53935; }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER (inalterado) ‚ïê‚ïê‚ïê -->
<header>
  <div class="header-inner">
    <div class="logo-mark">
      <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 4v20M4 14h20" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
        <circle cx="14" cy="14" r="12" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
      </svg>
    </div>
    <div class="header-titles">
      <h1>Sa√∫de(+)<span>BR</span> &mdash; Seu Localizador de Unidades de Sa√∫de</h1>
      <p>Dados em tempo real via OpenStreetMap + Nominatim ‚Ä¢ Apenas unidades vinculadas ao SUS</p>
    </div>
    <span class="header-badge">üü¢ Online</span>
    <button class="pix-btn" onclick="abrirModalPix()" title="Contribuir com o desenvolvedor via PIX">
      <svg width="18" height="18" viewBox="0 0 512 512" fill="currentColor"><path d="M389.6 315.9c-14.9 0-28.9-5.8-39.4-16.4l-81.5-81.5c-5.5-5.5-14.4-5.5-19.8 0l-81.9 81.9c-10.5 10.5-24.5 16.4-39.4 16.4h-15.3l103.4 103.4c21.8 21.8 57.2 21.8 79.1 0l103.7-103.7h-9.9zm0 0M127.6 196.1c14.9 0 28.9 5.8 39.4 16.4l81.9 81.9c5.5 5.5 14.4 5.5 19.8 0l81.5-81.5c10.5-10.5 24.5-16.4 39.4-16.4h9.9L296.2 92.7c-21.8-21.8-57.2-21.8-79.1 0L113.5 196.1h14.1zm0 0"/><path d="M467.5 220.9l-56.7-56.7h-21.2c-9.7 0-19.1 3.9-26 10.8l-81.5 81.5c-8.1 8.1-18.8 12.5-30.2 12.5s-22.1-4.4-30.2-12.5l-81.9-81.9c-6.9-6.9-16.2-10.8-26-10.8H92.3l-56.7 56.7c-21.8 21.8-21.8 57.2 0 79.1l56.7 56.7h22c9.7 0 19.1-3.9 26-10.8l81.9-81.9c8.1-8.1 18.8-12.5 30.2-12.5s22.1 4.4 30.2 12.5l81.5 81.5c6.9 6.9 16.2 10.8 26 10.8h21.2l56.7-56.7c21.9-21.9 21.9-57.3.1-79.1zm0 0"/></svg>
      Apoiar
    </button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main-wrapper">

  <!-- ‚îÄ‚îÄ‚îÄ FILTROS (modificado para exibi√ß√£o sequencial) ‚îÄ‚îÄ‚îÄ -->
  <div class="filter-section">
    <div class="filter-header" onclick="toggleFilter()">
      <div class="filter-header-left">
        <div class="filter-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </div>
        <div>
          <div class="filter-title">Filtros de Busca</div>
          <div class="filter-subtitle">Estado, munic√≠pio, perfil de aten√ß√£o e formas de acolhimento</div>
        </div>
      </div>
      <button class="filter-toggle-btn" id="filterToggleBtn">
        <span>Expandir</span>
        <span class="filter-toggle-arrow" id="filterArrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </button>
    </div>

    <div class="filter-body" id="filterBody">
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Estado (UF)</label>
          <select class="form-control" id="selectEstado" onchange="onEstadoChange()">
            <option value="">‚Äî Selecione ‚Äî</option>
          </select>
        </div>
        <div class="form-group" id="grupoMunicipio" style="display: none;">
          <label class="form-label">Munic√≠pio</label>
          <select class="form-control" id="selectMunicipio" onchange="onMunicipioChange()" disabled>
            <option value="">‚Äî Selecione o estado primeiro ‚Äî</option>
          </select>
        </div>
        <div class="form-group" id="grupoBairro" style="display: none;">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" id="inputBairro" placeholder="Ex: Centro, Jardim..." oninput="applyLocalFilters()">
        </div>
        <div class="form-group" id="grupoNivel" style="display: none;">
          <label class="form-label">Perfil / N√≠vel de Aten√ß√£o</label>
          <select class="form-control" id="selectNivel" onchange="applyLocalFilters()">
            <option value="">Todos os N√≠veis</option>
            <option value="primaria">Aten√ß√£o Prim√°ria</option>
            <option value="secundaria">Aten√ß√£o Secund√°ria</option>
            <option value="terciaria">Aten√ß√£o Terci√°ria</option>
          </select>
        </div>
        <div class="form-group" id="grupoAcolhimento" style="display: none;">
          <label class="form-label">Forma de Acolhimento</label>
          <select class="form-control" id="selectAcolhimento" onchange="applyLocalFilters()">
            <option value="">Todas as Formas</option>
            <option value="ambulatorial">Atendimento Ambulatorial</option>
            <option value="urgencia">Urg√™ncia / Emerg√™ncia</option>
            <option value="maternidade">Maternidade</option>
            <option value="especializado">Atendimento Especializado</option>
            <option value="samu">SAMU</option>
          </select>
        </div>
        <div class="form-group" id="grupoGestao" style="display: none;">
          <label class="form-label">Esfera de Gest√£o</label>
          <select class="form-control" id="selectGestao" onchange="applyLocalFilters()">
            <option value="">Todas</option>
            <option value="Municipal">Municipal</option>
            <option value="Estadual">Estadual</option>
            <option value="Federal">Federal</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="buscarPorMunicipio()" id="btnBuscarMunicipio">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          Buscar por Munic√≠pio
        </button>
        <button class="btn btn-secondary" onclick="limparFiltros()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.57"/></svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ GEOLOCALIZA√á√ÉO ‚îÄ‚îÄ‚îÄ -->
  <div class="geo-section">
    <div style="font-size: 1.8rem;">üìç</div>
    <div class="geo-info">
      <h3>Busca por Proximidade Geogr√°fica</h3>
      <p id="geoStatus">Detecta automaticamente sua localiza√ß√£o via GPS e busca unidades no raio (km) configurado abaixo:</p>
    </div>
    <div class="geo-radius-row">
      <span class="geo-radius-label">Raio (km):</span>
      <input type="number" class="geo-radius-input form-control" id="geoRaio" value="6" min="0.5" max="50" step="0.5">
    </div>
    <button class="btn btn-geo" onclick="usarGeolocalizacao()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>
      Buscar Unidades Perto de Mim
    </button>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SEARCH PROGRESS CARD ‚îÄ‚îÄ‚îÄ -->
  <div class="search-progress-card" id="searchProgressCard">
    <div class="search-progress-spinner"></div>
    <div class="search-progress-info">
      <div class="search-progress-title" id="spTitle">Consultando OpenStreetMap...</div>
      <div class="search-progress-hint" id="spHint">Iniciando conex√£o...</div>
    </div>
    <div class="search-progress-bar-wrap">
      <div class="search-progress-bar" id="spBar" style="width:5%"></div>
    </div>
    <div class="search-progress-count" id="spCount">0</div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ -->
  <div class="dashboard" id="dashboard">
    <div class="stat-card" style="--card-accent: var(--teal);">
      <div class="stat-card-icon" style="background: var(--teal-pale); color: var(--teal);">üè•</div>
      <div class="stat-card-value" id="statTotal">‚Äî</div>
      <div class="stat-card-label">Total de Unidades</div>
      <div class="stat-card-sublabel">encontradas</div>
    </div>
    <div class="stat-card" style="--card-accent: #00A878;">
      <div class="stat-card-icon" style="background: #E8F8F3; color: #00A878;">üè†</div>
      <div class="stat-card-value" id="statPrimaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Prim√°ria</div>
      <div class="stat-card-sublabel">UBS, Postos, ESF/PSF, CAPS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--blue);">
      <div class="stat-card-icon" style="background: var(--blue-pale); color: var(--blue);">üî¨</div>
      <div class="stat-card-value" id="statSecundaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Secund√°ria</div>
      <div class="stat-card-sublabel">UPA, AME, CEO, CER, Policl√≠nica</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üè®</div>
      <div class="stat-card-value" id="statTerciaria">‚Äî</div>
      <div class="stat-card-label">Aten√ß√£o Terci√°ria</div>
      <div class="stat-card-sublabel">Hospitais de refer√™ncia</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">üö®</div>
      <div class="stat-card-value" id="statUrgencia">‚Äî</div>
      <div class="stat-card-label">Urg√™ncia/Emerg√™ncia</div>
      <div class="stat-card-sublabel">UPAs, PS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--purple);">
      <div class="stat-card-icon" style="background: var(--purple-pale); color: var(--purple);">ü§±</div>
      <div class="stat-card-value" id="statMaternidade">‚Äî</div>
      <div class="stat-card-label">Maternidades</div>
      <div class="stat-card-sublabel">Parto e neonatal</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--amber);">
      <div class="stat-card-icon" style="background: var(--amber-pale); color: var(--amber);">ü¶¥</div>
      <div class="stat-card-value" id="statEspecializado">‚Äî</div>
      <div class="stat-card-label">Especializado</div>
      <div class="stat-card-sublabel">Ortopedia, cardiologia</div>
    </div>
    <div class="stat-card" style="--card-accent: #9C27B0;">
      <div class="stat-card-icon" style="background: #F3E5F5; color: #9C27B0;">üèõÔ∏è</div>
      <div class="stat-card-value" id="statAmbulatorial">‚Äî</div>
      <div class="stat-card-label">Ambulatorial</div>
      <div class="stat-card-sublabel">Consultas/exames</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ RESULTADOS ‚îÄ‚îÄ‚îÄ -->
  <div id="resultsSection">
    <div class="status-box">
      <span class="status-icon">üîç</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione estado e munic√≠pio nos filtros e clique em <strong>Buscar por Munic√≠pio</strong>, ou use <strong>Buscar Unidades Perto de Mim</strong> para detec√ß√£o autom√°tica.</p>
    </div>
  </div>

</div><!-- /main-wrapper -->

<!-- ‚ïê‚ïê‚ïê PDF PREVIEW MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üìÑ Visualiza√ß√£o do Relat√≥rio PDF</h3>
      <button class="modal-close" onclick="closePDFModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="12"/><line x1="6" y1="6" x2="18" y2="12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" id="pdfModalBody">
      <!-- PDF content will be injected here -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePDFModal()">Fechar</button>
      <button class="btn btn-whatsapp" onclick="compartilharPDFWhatsApp()">
        <span>üì±</span>
        Compartilhar WhatsApp
      </button>
      <button class="btn btn-primary" onclick="downloadPDF()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Baixar PDF
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PIX MODAL ‚ïê‚ïê‚ïê -->
<div class="pix-modal-overlay" id="pixModal" onclick="fecharModalPixOverlay(event)">
  <div class="pix-modal-content">
    <div class="pix-modal-header">
      <h3>üíö Apoie o Sa√∫de(+)BR</h3>
      <p>Contribui√ß√£o volunt√°ria via PIX</p>
      <button class="pix-modal-close" onclick="fecharModalPix()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="pix-modal-body">
      <p class="pix-appeal">
        Se voc√™ gostou deste aplicativo e deseja contribuir com sua melhoria, <strong>ajude o desenvolvedor com qualquer contribui√ß√£o em moeda nacional (BR)</strong>. N√≥s agradecemos muito sua participa√ß√£o! üôè
      </p>
      <div class="pix-qr-wrap">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=robertguima%40gmail.com&bgcolor=ffffff&color=0B1F3A&margin=8"
          alt="QR Code PIX ‚Äî robertguima@gmail.com"
          loading="lazy"
          onerror="this.src='https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=robertguima%40gmail.com&choe=UTF-8'"
        >
      </div>
      <div class="pix-key-box">
        <span class="pix-key-label">Chave PIX</span>
        <span class="pix-key-value" id="pixKeyText">robertguima@gmail.com</span>
        <button class="pix-copy-btn" id="pixCopyBtn" onclick="copiarChavePix()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
          Copiar
        </button>
      </div>
      <p class="pix-thanks">Sua contribui√ß√£o financia melhorias e manuten√ß√£o do servi√ßo.<br><span>Muito obrigado! ‚ù§Ô∏è</span></p>
    </div>
  </div>
</div>

<footer class="footer">
  Dados obtidos via <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a> e <a href="https://nominatim.org" target="_blank">Nominatim</a> ‚Äî Fonte p√∫blica colaborativa &nbsp;|&nbsp; Sa√∫de-BR - Localizador de Unidades SUS )
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURA√á√ÉO E CONSTANTES (mantido igual)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
    NOMINATIM: {
        ENDPOINT: 'https://nominatim.openstreetmap.org',
        EMAIL: 'contato@saudebr.gov.br'
    },
    IBGE: 'https://servicodados.ibge.gov.br/api/v1/localidades',
    OVERPASS: 'https://overpass-api.de/api/interpreter'
};

// ‚îÄ‚îÄ INCLUIR_TIPOS: valores de amenity= e healthcare= buscados no Overpass ‚îÄ‚îÄ‚îÄ
// Restritos a tipos que correspondem a estabelecimentos SUS ou potencialmente
// SUS. Tipos gen√©ricos como "doctors", "medical", "centre", "health" foram
// removidos pois trazem consult√≥rios e cl√≠nicas privadas para o pool.
const INCLUIR_TIPOS = [
    // amenity= tipicamente p√∫blicos
    'hospital', 'clinic', 'health_post', 'health_centre',
    'polyclinic', 'birthing_center', 'maternity',
    'urgent_care', 'emergency_ward', 'health_center', 'health_station',
    'primary_healthcare', 'community_health_worker', 'phc',
    // healthcare= (passa pelo filtro EXCLUIR abaixo)
    'hospital', 'clinic', 'dentist',
].filter((v, i, a) => a.indexOf(v) === i).join('|');   // deduplica

// ‚îÄ‚îÄ EXCLUIR_TIPOS: valores de healthcare= explicitamente n√£o-SUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// dentist N√ÉO est√° aqui ‚Äî CEOs (Centros de Especialidades Odontol√≥gicas) s√£o SUS
const EXCLUIR_TIPOS = 'pharmacy|optometrist|laboratory|sample_collection|physiotherapist|psychotherapist|audiologist|alternative|medical_imaging|blood_donation|veterinary|cosmetics|beauty';

let allUnits = [];
let filteredUnits = [];
let currentGeoPosition = null;
let estados = [];
let municipiosPorEstado = {};
let buscaAtiva = false;
let reverseGeocodeCache = new Map();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FUN√á√ïES AUXILIARES (mantidas iguais)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function norm(str) {
    if (!str) return '';
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function deduplicar(unidades) {
    // Passo 1: agrupar por c√≥digo CNES (identificador √∫nico oficial).
    // Quando a mesma unidade aparece tanto no CNES est√°tico quanto no OSM,
    // mant√©m-se o registro com mais dados (coordenadas, telefone, website).
    const porCNES = new Map();
    const semCNES = [];

    unidades.forEach(u => {
        if (u.cnes) {
            if (!porCNES.has(u.cnes)) {
                porCNES.set(u.cnes, { ...u });
            } else {
                const ex = porCNES.get(u.cnes);
                // Enriquecer com dados do OSM: lat/lon, telefone, website, email
                if (!ex.lat && u.lat) {
                    ex.lat = u.lat;
                    ex.lon = u.lon;
                    ex.distancia = u.distancia;
                    ex.mapsLink = u.mapsLink || (u.lat ? `https://www.google.com/maps?q=${u.lat},${u.lon}` : '');
                }
                if (!ex.telefone && u.telefone) ex.telefone = u.telefone;
                if (!ex.website  && u.website)  ex.website  = u.website;
                if (!ex.email    && u.email)    ex.email    = u.email;
            }
        } else {
            semCNES.push(u);
        }
    });

    // Passo 2: unidades sem c√≥digo CNES, deduplicar por nome normalizado
    const porNome = new Map();
    semCNES.forEach(u => {
        const chave = norm(u.nome);
        if (!porNome.has(chave)) {
            porNome.set(chave, u);
        } else {
            const ex = porNome.get(chave);
            if (!ex.lat && u.lat) { ex.lat = u.lat; ex.lon = u.lon; }
        }
    });

    return [...porCNES.values(), ...porNome.values()];
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ‚îÄ‚îÄ Cache de resultados Overpass: evita refazer a mesma query ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _overpassCache = new Map();

// consultarOverpass: AbortController garante timeout real no fetch;
// em caso de falha tenta espelhos alternativos *em paralelo* no mobile.
const OVERPASS_MIRRORS = [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter',
    'https://maps.mail.ru/osm/tools/overpass/api/interpreter'
];

// Timeout padr√£o reduzido: 30 s por tentativa (antes: 90 s).
// No mobile, 90 s s√≥ serve para fazer o usu√°rio desistir.
async function consultarOverpass(query, timeoutMs = 30000) {
    // Cache: mesma query j√° resolvida nesta sess√£o ‚Üí resposta instant√¢nea
    if (_overpassCache.has(query)) return _overpassCache.get(query);

    let lastErr;
    for (const endpoint of OVERPASS_MIRRORS) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const resp = await fetch(endpoint, {
                method: 'POST',
                body: query,
                signal: controller.signal,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });
            clearTimeout(timer);
            if (resp.ok) {
                const json = await resp.json();
                _overpassCache.set(query, json);   // armazena no cache
                return json;
            }
            const txt = await resp.text().catch(() => resp.status);
            lastErr = new Error(`HTTP ${resp.status}: ${String(txt).slice(0, 120)}`);
        } catch (e) {
            clearTimeout(timer);
            lastErr = e;
            console.warn(`Overpass ${endpoint} falhou:`, e.message || e);
            // Sem pausa entre mirrors: no mobile, cada milissegundo conta
        }
    }
    throw lastErr || new Error('Todos os servidores Overpass falharam');
}

function showSearchProgress(visible) {
    const card = document.getElementById('searchProgressCard');
    if (visible) card.classList.add('visible');
    else card.classList.remove('visible');
}

function updateSearchProgress(percent, title, hint) {
    document.getElementById('spBar').style.width = `${percent}%`;
    document.getElementById('spTitle').textContent = title;
    document.getElementById('spHint').textContent = hint;
    document.getElementById('spCount').textContent = filteredUnits.length;
}

function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
    notif.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  V√çNCULO SUS ‚Äî EXIGE PROVA POSITIVA DE PERTENCIMENTO √Ä REDE P√öBLICA
//
//  L√≥gica:  (A) sem prova positiva ‚Üí rejeita
//           (B) ind√≠cio de servi√ßo privado ‚Üí rejeita (prevalece sobre A)
//           (C) prova inequ√≠voca de gest√£o p√∫blica ‚Üí aceita
//           (D) nome tipicamente SUS ‚Üí aceita
//
//  ‚ö†  Tags OSM como healthcare=clinic ou amenity=hospital N√ÉO s√£o prova
//     suficiente por si s√≥s ‚Äî cl√≠nicas e hospitais privados usam as mesmas
//     tags no OpenStreetMap.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isVinculadoSUS(tags, nome) {
    // ‚îÄ‚îÄ A: CNES √© registro exclusivo do sistema p√∫blico brasileiro ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tags['ref:CNES'] || tags['ref:cnes']) return true;

    const nomeNorm = norm(nome);
    const op       = norm(tags.operator || '');
    const brand    = norm(tags.brand    || '');
    const funding  = norm(tags.funding  || tags['healthcare:funding'] || '');
    const desc     = norm(tags.description || '');

    // ‚îÄ‚îÄ B: Exclus√£o imediata ‚Äî qualquer marcador inequ√≠voco de servi√ßo privado
    const marcadoresPrivados = [
        // planos e operadoras privadas
        'unimed', 'amil', 'bradesco saude', 'sulamerica saude', 'notredame',
        'hapvida', 'prevent senior', 'clinipam', 'golden cross', 'mediservice',
        'sompo', 'care plus', 'assim saude', 'omint', 'saude caixa', 'cassi',
        'postal saude', 'petrobras saude', 'eletros',
        // designa√ß√µes expl√≠citas de servi√ßo privado
        'particular', 'privado', 'clinica particular', 'hospital privado',
        'plano de saude', 'convenio', 'empresa privada',
        // redes hospitalares privadas conhecidas
        'rede dor', 'hospital samaritano', 'hospital sirio libanes',
        'hospital albert einstein', 'hospital mater dei', 'hospital lifecenter',
        'hospital nine july', 'hospital nove de julho', 'hospital sao luiz',
        'hospital total cor', 'hospital leforte', 'hospital israelita',
        'hospital alemao oswaldo cruz', 'hospital santa catarina',
        'hospital pro matre', 'hospital sao camilo',
    ];
    for (const p of marcadoresPrivados) {
        if (op.includes(p) || nomeNorm.includes(p) || brand.includes(p) || funding.includes(p)) {
            return false;
        }
    }

    // ‚îÄ‚îÄ C: Aceita√ß√£o imediata ‚Äî prova inequ√≠voca de gest√£o p√∫blica ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Tags OSM expl√≠citas de operador p√∫blico
    if (tags['operator:type'] === 'public' || tags['operator:type'] === 'government') return true;
    if (tags.ownership === 'public' || tags.government) return true;
    if (funding === 'public' || funding === 'government' || funding === 'sus') return true;

    // Operador cont√©m nome de institui√ß√£o p√∫blica brasileira
    const opPublico = [
        'prefeitura', 'secretaria', 'ministerio', 'governo do estado',
        'governo municipal', 'governo federal', 'municipio de', 'estado de',
        'autarquia', 'fundacao', 'sus', 'datasus', 'ebserh'
    ];
    for (const p of opPublico) {
        if (op.includes(p)) return true;
    }
    // "municipal" e "estadual" e "federal" no operador (mas n√£o no nome,
    // pois "Hospital Municipal S√£o Lucas" √© verificado abaixo)
    if (op.includes('municipal') || op.includes('estadual') || op.includes('federal')) return true;

    // ‚îÄ‚îÄ D: Nome identifica inequivocamente uma unidade SUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //
    // Siglas de 2-4 letras: exigem fronteira de palavra para evitar falsos
    // positivos ("ame" dentro de "amei", "esf" dentro de "esfor√ßo", etc.)
    const siglasRegex = [
        /\bubs\b/, /\bupa\b/, /\bcaps\b/, /\bcms\b/,
        /\besf\b/, /\bpsf\b/, /\bceo\b/, /\bcer\b/,
        /\bame\b/, /\bsamu\b/, /\bcafs\b/,
    ];
    for (const r of siglasRegex) {
        if (r.test(nomeNorm)) return true;
    }

    // Express√µes compostas (sem risco de falso positivo pela extens√£o)
    const nomesPublicos = [
        // Aten√ß√£o Prim√°ria
        'unidade basica de saude', 'unidade basica',
        'posto de saude',
        'clinica da familia', 'clinica de familia',
        'centro de saude', 'centro municipal de saude',
        'equipe de saude da familia', 'saude da familia',
        'programa saude da familia',
        'centro de atencao psicossocial',
        'agente comunitario de saude',
        // Aten√ß√£o Secund√°ria
        'unidade de pronto atendimento', 'unidade pronto atendimento',
        'ambulatorio medico de especialidades',
        'centro de especialidades odontologicas',
        'coordenacao regional de emergencia',
        'unidade mista de saude', 'unidade mista',
        'servico de atendimento movel de urgencia',
        'policlinica',
        // Aten√ß√£o Terci√°ria
        'hospital municipal', 'hospital estadual', 'hospital federal',
        'hospital geral', 'hospital universitario', 'hospital de ensino',
        'hospital escola', 'hospital regional', 'hospital de referencia',
        'hospital das clinicas', 'hospital de clinicas',
        'hospital infantil', 'hospital pediatrico',
        'hospital oncologico', 'hospital cardiologico', 'hospital especializado',
        'hospital de urgencia', 'hospital de emergencia',
        'santa casa', 'misericordia',
        'centro de reabilitacao',
        'maternidade municipal', 'maternidade estadual', 'maternidade federal',
        'maternidade escola',
        // Institutos p√∫blicos conhecidos
        'instituto nacional de cancer', 'inca',
        'instituto nacional de traumatologia', 'into',
        'instituto nacional de cardiologia',
        'hospital das forcas armadas',
        'hupe', 'huap', 'husm', 'hucff', 'hucam',    // HUs conhecidos
        'ebserh',
    ];
    for (const p of nomesPublicos) {
        if (nomeNorm.includes(p) || desc.includes(p)) return true;
    }

    // Maternidade sem qualificador: aceita apenas se n√£o contiver indicadores
    // de servi√ßo privado (j√° verificados acima) e tiver outro ind√≠cio p√∫blico
    if (nomeNorm.startsWith('maternidade') && op && !op.includes('privado')) return true;

    // ‚îÄ‚îÄ Sem prova positiva ‚Üí rejeita ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DETERMINAR ESFERA DE GEST√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function determinarGestao(tags, nome) {
    const op       = norm(tags.operator || '');
    const nomeNorm = norm(nome);

    // Federal
    const isFederal =
        op.includes('federal') || op.includes('ministerio') ||
        op.includes('uniao') || op.includes('governo federal') ||
        op.includes('ebserh') || op.includes('marinha') ||
        op.includes('exercito') || op.includes('aeronautica') ||
        nomeNorm.includes('federal') ||
        nomeNorm.includes('hospital das forcas armadas') ||
        nomeNorm.includes('ebserh') ||
        ['inca', 'into', 'hupe', 'huap', 'husm', 'hucff', 'hucam'].some(s => nomeNorm.includes(s)) ||
        tags['government'] === 'federal';
    if (isFederal) return 'Federal';

    // Estadual
    const isEstadual =
        op.includes('estadual') || op.includes('governo do estado') ||
        op.includes('governo estadual') || op.includes('estado de') ||
        nomeNorm.includes('estadual') ||
        tags['government'] === 'state';
    if (isEstadual) return 'Estadual';

    // Municipal (default para unidades SUS sem qualificador de esfera)
    return 'Municipal';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLASSIFICA√á√ÉO DE N√çVEL E PERFIL ‚Äî CORRIGIDA CONFORME REQUISITOS SUS
//
//  ORDEM DE PRIORIDADE (regras pelo nome ANTES das tags OSM):
//  1. Prim√°rio ‚Äî UBS, Postos, Cl√≠nicas da Fam√≠lia, ESF/PSF, CAPS/CAPS-AD
//  2. Secund√°rio ‚Äî UPAs 24h (TODAS), AME, CEO, Policl√≠nicas, Unidades Mistas, CER
//  3. Terci√°rio ‚Äî Hospitais, Santas Casas, Especializados, Reabilita√ß√£o
//
//  ‚ö†Ô∏è  As regras pelo nome t√™m prioridade sobre tags OSM (ex.: uma UPA com
//      tag healthcare=hospital continua sendo Secund√°rio).
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function classificarNivel(tags, nome) {
    const n    = norm(nome + ' ' + (tags.description || ''));
    const nomeN = norm(nome);
    const healthcare = (tags.healthcare || tags.amenity || '').toLowerCase();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PASSO 1 ‚Äî Detectores de PRIM√ÅRIO (nome prevalece sobre tags)
    //  UBS ¬∑ Postos ¬∑ Cl√≠nicas da Fam√≠lia ¬∑ ESF/PSF ¬∑ CAPS/CAPS-AD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ehUBS        = nomeN.startsWith('ubs') ||
                          n.includes('unidade basica de saude') ||
                          n.includes('unidade basica');
    const ehPosto      = n.includes('posto de saude') || n.includes('posto saude');
    const ehClinicaFam = n.includes('clinica da familia') || n.includes('clinica de familia');
    const ehESF        = nomeN.startsWith('esf ') || nomeN === 'esf' ||
                          n.includes(' esf ') || n.includes('saude da familia') ||
                          n.includes('equipe de saude da familia');
    const ehPSF        = nomeN.startsWith('psf ') || nomeN === 'psf' ||
                          n.includes(' psf ') || n.includes('programa saude da familia');
    const ehCAPSAD     = n.includes('caps-ad') || n.includes('caps ad') ||
                          n.includes('centro de atencao psicossocial alcool') ||
                          n.includes('caps ad ii') || n.includes('caps ad iii');
    // CAPS gen√©rico: apenas se n√£o for CAPS-AD e o token 'caps' aparecer isolado
    const ehCAPS       = !ehCAPSAD && (
                            nomeN.startsWith('caps ') || nomeN === 'caps' ||
                            / caps[ /-]/.test(nomeN) ||
                            n.includes('centro de atencao psicossocial')
                          );
    const ehCentroSaude = n.includes('centro de saude') ||
                           n.includes('centro municipal de saude');
    const ehCMS         = nomeN.startsWith('cms ') || nomeN === 'cms' ||
                           / cms[ /]/.test(nomeN);
    const ehCAFS        = n.includes('cafs');

    // Indicador final prim√°rio
    const ehPrimaria = ehUBS || ehPosto || ehClinicaFam || ehESF || ehPSF ||
                        ehCAPSAD || ehCAPS || ehCentroSaude || ehCMS || ehCAFS;

    if (ehPrimaria) {
        let perfil = 'Unidade de Sa√∫de';
        if      (ehUBS)          perfil = 'UBS';
        else if (ehPosto)        perfil = 'Posto de Sa√∫de';
        else if (ehClinicaFam)   perfil = 'Cl√≠nica da Fam√≠lia';
        else if (ehESF || ehPSF) perfil = 'ESF/PSF';
        else if (ehCAPSAD)       perfil = 'CAPS-AD';
        else if (ehCAPS)         perfil = 'CAPS';
        else if (ehCMS || ehCentroSaude) perfil = 'Centro de Sa√∫de';
        else if (ehCAFS)         perfil = 'CAFS';
        return { nivel: 'primaria', perfil };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PASSO 2 ‚Äî Detectores de SECUND√ÅRIO (nome prevalece sobre tags)
    //  UPAs 24h ¬∑ AME ¬∑ CEO ¬∑ Unidades Mistas ¬∑ Policl√≠nicas ¬∑ CER
    //  SAMU ¬∑ Pronto-Atendimento independente
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // UPA ‚Äî Unidade de Pronto Atendimento (TODAS v√£o para secund√°rio)
    const ehUPA = nomeN.startsWith('upa ') || nomeN === 'upa' ||
                   nomeN.endsWith(' upa')   || / upa[ /]/.test(nomeN) ||
                   n.includes('unidade de pronto atendimento') ||
                   n.includes('unidade pronto atendimento')    ||
                   healthcare === 'urgent_care';

    // AME ‚Äî Ambulat√≥rio M√©dico de Especialidades
    const ehAME = nomeN.startsWith('ame ') || nomeN === 'ame' ||
                   / ame[ /]/.test(nomeN)   ||
                   n.includes('ambulatorio medico de especialidades');

    // CEO ‚Äî Centro de Especialidades Odontol√≥gicas
    const ehCEO = nomeN.startsWith('ceo ') || nomeN === 'ceo' ||
                   / ceo[ /]/.test(nomeN)   ||
                   n.includes('centro de especialidades odontologicas');

    // Unidade Mista de Sa√∫de
    const ehUnidadeMista = n.includes('unidade mista de saude') || n.includes('unidade mista');

    // Policl√≠nica
    const ehPoliclinica = n.includes('policlinica') || healthcare === 'polyclinic';

    // CER ‚Äî Coordena√ß√£o Regional de Emerg√™ncia
    const ehCER = nomeN.startsWith('cer ') || nomeN === 'cer' ||
                   nomeN.endsWith(' cer')   ||
                   n.includes('coordenacao regional de emergencia') ||
                   n.includes('coordenacao de emergencia regional');

    // SAMU ‚Äî Servi√ßo de Atendimento M√≥vel de Urg√™ncia
    const ehSAMU = n.includes('samu') ||
                    n.includes('servico de atendimento movel de urgencia');

    // Pronto-Atendimento independente (n√£o hospitalar)
    const ehProntoAtendimento = (n.includes('pronto atendimento') ||
                                  n.includes('pronto-atendimento')) &&
                                  !nomeN.startsWith('hospital');

    // Cl√≠nica de Especialidades via OSM
    const ehClinicaEspecialidades = healthcare === 'clinic' &&
                                     (n.includes('especialidades') ||
                                      n.includes('ambulatorio de referencia'));

    const ehSecundaria = ehUPA || ehAME || ehCEO || ehUnidadeMista ||
                          ehPoliclinica || ehCER || ehSAMU ||
                          ehProntoAtendimento || ehClinicaEspecialidades;

    if (ehSecundaria) {
        let perfil = 'Unidade de M√©dia Complexidade';
        if      (ehUPA)              perfil = 'UPA 24h';
        else if (ehAME)              perfil = 'AME';
        else if (ehCEO)              perfil = 'CEO';
        else if (ehCER)              perfil = 'CER';
        else if (ehSAMU)             perfil = 'SAMU';
        else if (ehPoliclinica)      perfil = 'Policl√≠nica';
        else if (ehUnidadeMista)     perfil = 'Unidade Mista';
        else if (ehProntoAtendimento) perfil = 'Pronto Atendimento';
        return { nivel: 'secundaria', perfil };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PASSO 3 ‚Äî Detectores de TERCI√ÅRIO (Alta Complexidade)
    //  Hospitais Gerais/Universit√°rios ¬∑ Santas Casas ¬∑
    //  Hospitais Especializados ¬∑ Centros de Reabilita√ß√£o
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Tag OSM definitiva de hospital
    const ehHospitalOSM    = healthcare === 'hospital';
    // Nome come√ßa com "hospital"
    const nomeCome√ßaHospital = nomeN.startsWith('hospital');
    // Santa Casa / Miseric√≥rdia
    const ehSantaCasa      = n.includes('santa casa') || n.includes('misericordia');
    // Tipos de hospitais especializados (combina√ß√µes precisas)
    const ehHospEspecializado =
        n.includes('hospital geral')           || n.includes('hospital universitario')  ||
        n.includes('hospital de ensino')        || n.includes('hospital escola')          ||
        n.includes('hospital federal')          || n.includes('hospital estadual')        ||
        n.includes('hospital regional')         || n.includes('hospital de referencia')   ||
        n.includes('hospital de base')          || n.includes('hospital das clinicas')    ||
        n.includes('hospital de clinicas')      || n.includes('hospital municipal')       ||
        n.includes('hospital infantil')         || n.includes('hospital pediatrico')      ||
        n.includes('hospital de urgencia')      || n.includes('hospital de emergencia')   ||
        n.includes('hospital beneficencia')     || n.includes('hospital oncologico')      ||
        n.includes('hospital cardiologico')     || n.includes('hospital especializado');
    // Institutos especializados de sa√∫de (contexto m√©dico claro)
    const ehInstituto = n.includes('instituto') && (
        n.includes('oncologia') || n.includes('cancer')         ||
        n.includes('cardiologia')|| n.includes('cardiovascular') ||
        n.includes('neurologia') || n.includes('ortopedia')     ||
        n.includes('reabilitacao')|| n.includes('psiquiatria')  ||
        n.includes('medicina')   || n.includes('pediatria')     ||
        n.includes('materno')    || n.includes('saude publica')
    );
    // Especialidades hospitalares diretas
    const ehOncologico    = n.includes('oncologico') || n.includes('hospital do cancer') ||
                             n.includes('inca')        || n.includes('into');
    const ehCardiologico  = n.includes('cardiologico') || n.includes('cardiovascular');
    const ehMaternidade   = nomeN.startsWith('maternidade') ||
                             (n.includes('maternidade') &&
                              !n.includes('posto') && !n.includes('ubs'));
    const ehReabilitacao  = n.includes('centro de reabilitacao') ||
                             (n.includes('reabilitacao') && nomeCome√ßaHospital);

    const ehTerciaria = ehHospitalOSM     || nomeCome√ßaHospital || ehSantaCasa     ||
                         ehHospEspecializado || ehInstituto        || ehOncologico    ||
                         ehCardiologico      || ehMaternidade       || ehReabilitacao;

    if (ehTerciaria) {
        let perfil = 'Hospital Geral';
        if      (ehOncologico)                                        perfil = 'Hospital Oncol√≥gico';
        else if (ehCardiologico)                                       perfil = 'Hospital Cardiol√≥gico';
        else if (ehReabilitacao || n.includes('centro de reabilitacao')) perfil = 'Centro de Reabilita√ß√£o';
        else if (n.includes('universitario') || n.includes('ensino') ||
                 n.includes('escola'))                                 perfil = 'Hospital Universit√°rio';
        else if (ehSantaCasa)                                          perfil = 'Santa Casa';
        else if (ehMaternidade)                                        perfil = 'Maternidade';
        else if (n.includes('infantil') || n.includes('pediatrico'))   perfil = 'Hospital Infantil/Pedi√°trico';
        else if (ehInstituto)                                          perfil = 'Instituto Especializado';
        return { nivel: 'terciaria', perfil };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PASSO 4 ‚Äî FALLBACK: Prim√°rio gen√©rico via tags OSM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let perfil = 'Unidade de Sa√∫de';
    if      (healthcare === 'health_post')    perfil = 'Posto de Sa√∫de';
    else if (healthcare === 'health_centre')  perfil = 'Centro de Sa√∫de';
    else if (healthcare === 'doctors')        perfil = 'Consult√≥rio/Cl√≠nica';

    return { nivel: 'primaria', perfil };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DETERMINAR ACOLHIMENTO (AJUSTADO) ‚Äî mantido igual
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function determinarAcolhimento(unit) {
    const n = norm(unit.nome + ' ' + unit.perfil);

    // SAMU ‚Äî servi√ßo m√≥vel de urg√™ncia
    if (n.includes('samu') || n.includes('servico de atendimento movel')) {
        return 'samu';
    }
    // Urg√™ncia / Emerg√™ncia
    if (n.includes('upa')    || n.includes('urgencia')   || n.includes('emergencia') ||
        n.includes('pronto socorro')  || n.includes('pronto atendimento') ||
        n.includes('cer ')  || unit.perfil === 'CER'     || unit.perfil === 'UPA 24h') {
        return 'urgencia';
    }
    // Maternidade / Obstetr√≠cia
    if (n.includes('maternidade') || n.includes('obstetricia') || n.includes('parto')) {
        return 'maternidade';
    }
    // Especializado
    if (n.includes('ortopedia')   || n.includes('cardiologia') || n.includes('oncologia') ||
        n.includes('especializado')|| n.includes('instituto')  ||
        unit.perfil === 'AME'      || unit.perfil === 'CEO'     ||
        unit.perfil === 'Hospital Oncol√≥gico' || unit.perfil === 'Hospital Cardiol√≥gico' ||
        unit.perfil === 'Instituto Especializado') {
        return 'especializado';
    }
    // Hospitais gerais e santas casas ‚Üí urg√™ncia/emerg√™ncia por padr√£o
    if (unit.nivel === 'terciaria') {
        return 'urgencia';
    }
    return 'ambulatorial';
}

function getTextoAcolhimento(acolhimento) {
    const textos = {
        'ambulatorial': 'Atendimento Ambulatorial',
        'urgencia': 'Urg√™ncia/Emerg√™ncia',
        'maternidade': 'Maternidade',
        'especializado': 'Atendimento Especializado',
        'samu': 'SAMU'
    };
    return textos[acolhimento] || 'Atendimento Geral';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORMATAR TELEFONE (mantido igual)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatarTelefoneBR(telefone) {
    if (!telefone) return '';
    let numeros = telefone.replace(/\D/g, '');
    if (numeros.startsWith('55')) {
        if (numeros.length === 12 || numeros.length === 13) {
            numeros = numeros.substring(2);
        }
    }
    if (numeros.length === 10) {
        return `(${numeros.substring(0,2)}) ${numeros.substring(2,6)}-${numeros.substring(6)}`;
    } else if (numeros.length === 11) {
        return `(${numeros.substring(0,2)}) ${numeros.substring(2,7)}-${numeros.substring(7)}`;
    } else {
        return telefone;
    }
}

function limparNumeroParaLigacao(telefone) {
    if (!telefone) return '';
    let numeros = telefone.replace(/\D/g, '');
    if (numeros.startsWith('55') && (numeros.length === 12 || numeros.length === 13)) {
        numeros = numeros.substring(2);
    }
    return numeros;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LINK WHATSAPP (mantido igual)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gerarLinkCompartilhamentoWhatsApp(unit) {
    const mapsLink = unit.mapsLink || `https://www.google.com/maps?q=${unit.lat},${unit.lon}`;
    const searchQuery = encodeURIComponent(`${unit.nome} ${unit.cidade || ''} ${unit.uf || ''} sa√∫de`);
    const searchLink = `https://www.google.com/search?q=${searchQuery}`;
    const texto = 
        `*${unit.nome}*\n` +
        `üìç ${unit.enderecoCompleto || unit.endereco || ''} ${unit.bairro ? ' - ' + unit.bairro : ''}\n` +
        `üèôÔ∏è ${unit.cidade || ''} - ${unit.uf || ''}\n` +
        `üìû ${unit.telefoneFormatado || unit.telefone || 'N√£o informado'}\n` +
        `üè• ${unit.perfil}\n` +
        `üó∫Ô∏è Ver no mapa: ${mapsLink}\n` +
        `üîó Mais informa√ß√µes: ${searchLink}`;
    return `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CNES EST√ÅTICO ‚Äî carrega arquivos gerados pelo script Python em data/cnes/
//  Cada arquivo UF.json cont√©m todas as unidades SUS daquele estado.
//  O Vercel os serve como assets est√°ticos ‚Äî sem API, sem CORS, 100% confi√°vel.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/** Converte um registro do JSON est√°tico CNES para o formato interno do app. */
function montarUnidadeCNESEstatico(u, cidade, uf) {
    const tel = u.tel || '';
    const unit = {
        nome:              u.nome,
        cidade:            cidade || '',
        uf:                uf || '',
        bairro:            u.bairro || '',
        perfil:            u.perfil || 'Unidade de Sa√∫de',
        nivel:             u.nivel  || 'primaria',
        lat:               null,
        lon:               null,
        telefone:          tel,
        email:             '',
        endereco:          u.logradouro || '',
        osmId:             '',
        osmType:           '',
        website:           '',
        distancia:         null,
        gestao:            u.gestao || 'Municipal',
        cnes:              u.cnes   || '',
        enderecoCompleto:  [u.logradouro, u.bairro, u.cep ? `CEP ${u.cep}` : ''].filter(Boolean).join(' ‚Äî '),
        telefoneFormatado: formatarTelefoneBR(tel),
        mapsLink:          '',
        fonte:             'CNES',
    };
    unit.acolhimento = determinarAcolhimento(unit);
    return unit;
}

/**
 * Carrega e filtra o arquivo JSON est√°tico do estado correspondente.
 * @param {string} uf        - Sigla do estado (ex: 'RJ')
 * @param {string} ibge7     - C√≥digo IBGE de 7 d√≠gitos do munic√≠pio
 * @param {string} cidade    - Nome do munic√≠pio (para preencher o campo cidade)
 * @returns {Promise<Array>} - Array de unidades no formato interno do app
 */
async function buscarCNESEstatico(uf, ibge7, cidade) {
    try {
        // O CNES usa c√≥digos IBGE de 6 d√≠gitos (sem d√≠gito verificador).
        // O IBGE API retorna 7 d√≠gitos. Truncamos para compatibilidade.
        const ibge6 = String(ibge7).substring(0, 6);
        const url   = `/data/cnes/${uf}.json`;

        const resp = await fetch(url, { cache: 'default' });
        if (!resp.ok) {
            console.warn(`CNES est√°tico: arquivo ${url} n√£o encontrado (HTTP ${resp.status})`);
            return [];
        }

        const todos = await resp.json();
        const filtrados = todos.filter(u => u.ibge6 === ibge6);

        console.info(`CNES est√°tico [${uf}]: ${filtrados.length} unidades em ibge6=${ibge6}`);
        return filtrados.map(u => montarUnidadeCNESEstatico(u, cidade, uf));

    } catch (e) {
        console.warn('CNES est√°tico indispon√≠vel:', e.message);
        return [];
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MONTAR UNIDADE (mantido igual)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// montarUnidade √© s√≠ncrona: n√£o h√° nenhum await interno.
// Declarar como async criava uma microtask desnecess√°ria por elemento chamado,
// o que em lotes de 300+ resultados acumula overhead real em CPUs de celular.
function montarUnidade(tags, lat, lon, osmId, osmType, uf = null, cidade = null, distancia = null) {
    const nome = (tags.name || tags['name:pt'] || '').trim();
    if (!nome) return null;
    
    if (!isVinculadoSUS(tags, nome)) return null;
    
    const classif = classificarNivel(tags, nome);
    const gestao = determinarGestao(tags, nome);

    const enderecoCompleto = [tags['addr:street'], tags['addr:housenumber'], tags['addr:neighbourhood']].filter(Boolean).join(', ');
    const telefone = tags.phone || tags['contact:phone'] || '';
    const email = tags.email || tags['contact:email'] || '';
    const website = tags.website || tags['contact:website'] || '';

    const unit = {
        nome,
        cidade: cidade || tags['addr:city'] || '',
        uf: uf || '',
        bairro: tags['addr:neighbourhood'] || tags['addr:suburb'] || '',
        perfil: classif.perfil,
        nivel: classif.nivel,
        lat,
        lon,
        telefone,
        email,
        endereco: enderecoCompleto,
        osmId,
        osmType,
        website,
        distancia,
        gestao,
        cnes: tags['ref:CNES'] || tags['ref:cnes'] || '',
        enderecoCompleto,
        telefoneFormatado: formatarTelefoneBR(telefone),
        mapsLink: lat && lon ? `https://www.google.com/maps?q=${lat},${lon}` : ''
    };
    unit.acolhimento = determinarAcolhimento(unit);
    return unit;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GEOLOCALIZA√á√ÉO (CORRIGIDA) ‚Äî mantido igual
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function usarGeolocalizacao() {
    if (!navigator.geolocation) {
        showNotification('Geolocaliza√ß√£o n√£o suportada pelo navegador', 'error');
        return;
    }

    showSearchProgress(true);
    updateSearchProgress(10, 'Obtendo sua localiza√ß√£o...', 'Aguarde autoriza√ß√£o GPS');
    buscaAtiva = true;

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            try {
                if (!buscaAtiva) return;

                currentGeoPosition = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };

                updateSearchProgress(20, 'Localiza√ß√£o obtida!', `Lat: ${currentGeoPosition.lat.toFixed(4)}, Lon: ${currentGeoPosition.lon.toFixed(4)}`);

                const raio = parseFloat(document.getElementById('geoRaio').value) || 6;

                // reverseGeocode e busca Overpass correm em PARALELO.
                // No fluxo anterior, reverseGeocode bloqueava o in√≠cio da busca.
                updateSearchProgress(30, 'Buscando unidades e munic√≠pio...', 'Consultas em paralelo');
                const [units, location] = await Promise.all([
                    buscarUnidadesProximas(
                        currentGeoPosition.lat, currentGeoPosition.lon, raio, '', ''
                    ),
                    reverseGeocode(currentGeoPosition.lat, currentGeoPosition.lon)
                        .catch(() => null)   // n√£o-cr√≠tico: busca continua mesmo sem cidade
                ]);

                if (!buscaAtiva) return;

                const cidade = location?.cidade || 'sua localiza√ß√£o';
                const uf     = location?.uf     || '';

                // Preenche cidade/uf nos resultados se reverseGeocode retornou
                if (cidade && cidade !== 'sua localiza√ß√£o') {
                    units.forEach(u => {
                        if (!u.cidade) u.cidade = cidade;
                        if (!u.uf)     u.uf     = uf;
                    });
                }

                units.forEach(u => {
                    if (u.lat && u.lon) {
                        u.distancia = calcularDistancia(
                            currentGeoPosition.lat,
                            currentGeoPosition.lon,
                            u.lat,
                            u.lon
                        );
                    }
                });
                units.sort((a, b) => (a.distancia || 999) - (b.distancia || 999));

                allUnits = units;
                if (!buscaAtiva) return;
                applyLocalFilters();

                updateSearchProgress(100, 'Conclu√≠do!', `${allUnits.length} unidades no raio de ${raio}km`);
                setTimeout(() => {
                    showSearchProgress(false);
                    showNotification(`${allUnits.length} unidades encontradas pr√≥ximas a voc√™`, 'success');
                    document.getElementById('geoStatus').textContent =
                        `üìç Sua localiza√ß√£o: ${cidade} ‚Ä¢ ${allUnits.length} unidades no raio de ${raio}km`;
                }, 800);

            } catch (err) {
                console.error('Erro na busca por proximidade:', err);
                buscaAtiva = false;
                showSearchProgress(false);
                showNotification('Erro ao buscar unidades pr√≥ximas: ' + (err.message || 'falha na conex√£o'), 'error');
            }
        },
        (error) => {
            showSearchProgress(false);
            let msg = 'Erro ao obter localiza√ß√£o';
            if (error.code === error.PERMISSION_DENIED) msg = 'Permiss√£o de localiza√ß√£o negada';
            else if (error.code === error.POSITION_UNAVAILABLE) msg = 'Localiza√ß√£o indispon√≠vel';
            else if (error.code === error.TIMEOUT) msg = 'Tempo esgotado ao obter localiza√ß√£o';
            showNotification(msg, 'error');
        },
        {
            // enableHighAccuracy: false ‚Üí usa WiFi/antenas celulares em vez do chip GPS.
            // No Brasil urbano √© igualmente preciso e 4-5√ó mais r√°pido (1-3 s vs 10-30 s).
            enableHighAccuracy: false,
            timeout: 8000,
            maximumAge: 120000   // aceita posi√ß√£o com at√© 2 min de idade ‚Äî evita novo fix desnecess√°rio
        }
    );
}

async function buscarUnidadesProximas(lat, lon, raioKm, uf, cidade) {
    const R = raioKm * 1000;
    const around = `around:${R},${lat},${lon}`;
    // Sem relation[...]: relations s√£o raras no OSM brasileiro e muito custosas
    // no servidor Overpass. "qt" ordena por quadtile (mais r√°pido server-side).
    const query = `
[out:json][timeout:45];
(
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${around});
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${around});
  node["amenity"~"^(${INCLUIR_TIPOS})$"](${around});
  way["amenity"~"^(${INCLUIR_TIPOS})$"](${around});
);
out center tags qt;
    `.trim();

    updateSearchProgress(40, 'Consultando OpenStreetMap...', 'Buscando unidades de sa√∫de');

    try {
        const dados = await consultarOverpass(query);
        const elementos = dados.elements || [];
        if (!buscaAtiva) return [];
        
        updateSearchProgress(60, 'Processando resultados...', `${elementos.length} candidatos encontrados`);

        const unidades = [];
        for (let i = 0; i < elementos.length; i++) {
            if (!buscaAtiva) return unidades;
            const el = elementos[i];
            const tags = el.tags || {};
            const elLat = el.lat ?? el.center?.lat;
            const elLon = el.lon ?? el.center?.lon;
            if (!elLat || !elLon) continue;
            const distancia = calcularDistancia(lat, lon, elLat, elLon);
            if (distancia > raioKm) continue;
            const u = montarUnidade(tags, elLat, elLon, el.id, el.type === 'node' ? 'node' : 'way', uf, cidade, distancia);
            if (u) unidades.push(u);
            if (i % 10 === 0) {
                const pct = 60 + Math.round((i + 1) / elementos.length * 25);
                updateSearchProgress(pct, 'Processando...', `${unidades.length} unidades v√°lidas encontradas`);
            }
        }
        return deduplicar(unidades);
    } catch (error) {
        console.error('Erro no Overpass:', error);
        throw error;
    }
}

async function reverseGeocode(lat, lon) {
    const cacheKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
    if (reverseGeocodeCache.has(cacheKey)) return reverseGeocodeCache.get(cacheKey);
    try {
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=pt-BR`;
        const response = await fetch(url, {
            headers: { 'User-Agent': `SaudeBR-Localizador/4.5 (${CONFIG.NOMINATIM.EMAIL})` }
        });
        if (!response.ok) return null;
        const data = await response.json();
        if (data && data.address) {
            const cidade = data.address.city || data.address.town || data.address.municipality || data.address.county;
            const uf = data.address.state;
            const estadoSigla = data.address['ISO3166-2-lvl4']?.split('-')[1] || uf;
            const result = { cidade, uf: estadoSigla, estado: uf };
            reverseGeocodeCache.set(cacheKey, result);
            return result;
        }
    } catch (error) {
        console.error('Erro no reverse geocoding:', error);
    }
    return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUSCA POR MUNIC√çPIO (REFATORADA COM FILTRO POR CIDADE CONDICIONAL) ‚Äî mantido igual
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buscarPorMunicipio() {
    const uf = document.getElementById('selectEstado').value;
    const codigoIBGE = document.getElementById('selectMunicipio').value;
    if (!uf || !codigoIBGE) {
        showNotification('Selecione estado e munic√≠pio', 'error');
        return;
    }

    const selectMunicipio = document.getElementById('selectMunicipio');
    const nomeMunicipio = selectMunicipio.options[selectMunicipio.selectedIndex]?.text || 'munic√≠pio selecionado';

    showSearchProgress(true);
    updateSearchProgress(5, 'Iniciando busca dupla...', `CNES oficial + OpenStreetMap para ${nomeMunicipio}`);
    buscaAtiva = true;

    try {
        // ‚îÄ‚îÄ 1. CNES est√°tico (r√°pido ‚Äî arquivo local no Vercel) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        updateSearchProgress(10, 'Carregando registro CNES oficial...', `data/cnes/${uf}.json`);
        const [unitsCNES, municipio] = await Promise.all([
            buscarCNESEstatico(uf, codigoIBGE, nomeMunicipio),
            getMunicipioData(uf, codigoIBGE, nomeMunicipio),
        ]);
        if (!buscaAtiva) return;

        // Mostra resultado do CNES imediatamente enquanto OSM processa
        if (unitsCNES.length > 0) {
            allUnits = unitsCNES;
            applyLocalFilters();
            updateSearchProgress(40, `CNES: ${unitsCNES.length} unidades carregadas`,
                'Enriquecendo com coordenadas via OpenStreetMap...');
        } else {
            updateSearchProgress(40, 'Dados CNES indispon√≠veis (arquivo n√£o gerado ainda)',
                'Usando apenas OpenStreetMap...');
        }

        // ‚îÄ‚îÄ 2. OpenStreetMap (enriquece com GPS, telefone, website) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let unitsOSM = [];
        if (municipio && municipio.latitude && municipio.longitude) {
            updateSearchProgress(50, 'Consultando OpenStreetMap...', `${municipio.nome} ‚Äî coordenadas GPS`);
            try {
                unitsOSM = await buscarUnidadesNoMunicipio(municipio, uf);
            } catch (e) {
                console.warn('OSM falhou, usando apenas CNES:', e.message);
                showNotification('OpenStreetMap indispon√≠vel. Resultados apenas do CNES oficial.', 'info');
            }
        }
        if (!buscaAtiva) return;

        // ‚îÄ‚îÄ 3. Mescla e deduplica ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // CNES primeiro (dados oficiais) + OSM depois (enriquecimento)
        // deduplicar() usa o c√≥digo CNES como chave prim√°ria e
        // transfere lat/lon/telefone/website do OSM para o registro CNES.
        const todasUnidades = [...unitsCNES, ...unitsOSM];
        if (todasUnidades.length === 0) {
            updateSearchProgress(100, 'Nenhuma unidade SUS encontrada',
                'Execute o script gerar_dados_cnes.py para gerar os arquivos est√°ticos');
            setTimeout(() => showSearchProgress(false), 3000);
            showNotification(
                'Nenhuma unidade SUS encontrada. Os arquivos CNES est√°ticos podem n√£o ter sido gerados ainda. '
                + 'Veja as instru√ß√µes no README.', 'error');
            return;
        }

        allUnits = deduplicar(todasUnidades);
        if (!buscaAtiva) return;
        applyLocalFilters();

        const nCNES = allUnits.filter(u => u.fonte === 'CNES').length;
        const nOSM  = allUnits.filter(u => u.fonte !== 'CNES').length;
        const comGPS = allUnits.filter(u => u.lat).length;
        updateSearchProgress(100, 'Busca conclu√≠da!',
            `${allUnits.length} unidades (CNES: ${nCNES}, OSM: ${nOSM}) ‚Ä¢ ${comGPS} com GPS`);

        // Atualiza o card de busca por proximidade com o munic√≠pio pesquisado
        document.getElementById('geoStatus').textContent =
            `üèôÔ∏è √öltimo munic√≠pio pesquisado: ${municipio?.nome || nomeMunicipio}/${uf} ‚Ä¢ ${allUnits.length} unidade${allUnits.length !== 1 ? 's' : ''} encontrada${allUnits.length !== 1 ? 's' : ''}`;

        setTimeout(() => {
            showSearchProgress(false);
            showNotification(
                `${allUnits.length} unidades SUS em ${municipio?.nome || nomeMunicipio}`, 'success');
        }, 800);

    } catch (error) {
        console.error('Erro na busca por munic√≠pio:', error);
        buscaAtiva = false;
        showSearchProgress(false);
        showNotification('Erro ao buscar unidades: ' + (error.message || 'falha na conex√£o'), 'error');
    }
}

async function getMunicipioData(uf, codigoIBGE, nomeMunicipio) {
    if (municipiosPorEstado[uf]) {
        const mun = municipiosPorEstado[uf].find(m => m.id === codigoIBGE);
        if (mun && mun.latitude && mun.longitude) return mun;
    }

    try {
        const nomeBusca = encodeURIComponent(`${nomeMunicipio}, ${uf}, Brasil`);
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/search?q=${nomeBusca}&format=json&limit=1&countrycodes=br&polygon_geojson=0&addressdetails=1`;
        const response = await fetch(url, {
            headers: { 'User-Agent': `SaudeBR-Localizador/4.5 (${CONFIG.NOMINATIM.EMAIL})` }
        });
        if (!response.ok) return null;
        const data = await response.json();
        if (data.length > 0) {
            // Extrair bounding box [minlat, maxlat, minlon, maxlon] ‚Üí [sul, norte, oeste, leste]
            let bbox = null;
            if (data[0].boundingbox && data[0].boundingbox.length === 4) {
                const bb = data[0].boundingbox.map(parseFloat);
                bbox = [bb[0], bb[1], bb[2], bb[3]];
            }
            const mun = {
                id: codigoIBGE,
                nome: nomeMunicipio,
                latitude: parseFloat(data[0].lat),
                longitude: parseFloat(data[0].lon),
                osmId: data[0].osm_id,
                osmType: data[0].osm_type,
                geojson: data[0].geojson,
                bbox
            };
            if (!municipiosPorEstado[uf]) municipiosPorEstado[uf] = [];
            const index = municipiosPorEstado[uf].findIndex(m => m.id === codigoIBGE);
            if (index >= 0) municipiosPorEstado[uf][index] = mun;
            else municipiosPorEstado[uf].push(mun);
            return mun;
        }
    } catch (error) {
        console.warn('Erro ao buscar coordenadas do munic√≠pio:', error);
    }
    return null;
}

// Fun√ß√£o auxiliar: constr√≥i a query Overpass para um escopo.
// escopo pode ser:
//   ‚Ä¢ "area(NNNN)->.a;"   ‚Üí busca dentro de rela√ß√£o administrativa
//   ‚Ä¢ ""                  ‚Üí __AREA__ ser√° substitu√≠do pelo bbox "sul,oeste,norte,leste"
function buildHealthQuery(escopo, areaVar) {
    // Sem relation[...]: quase n√£o existe no OSM brasileiro e √© muito custoso.
    // timeout reduzido para 45 s; "qt" = quadtile sort (mais r√°pido server-side).
    return `
[out:json][timeout:45];
${escopo}
(
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${areaVar});
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${areaVar});
  node["amenity"~"^(${INCLUIR_TIPOS})$"](${areaVar});
  way["amenity"~"^(${INCLUIR_TIPOS})$"](${areaVar});
);
out center tags qt;
    `.trim();
}

async function buscarUnidadesNoMunicipio(municipio, uf) {
    let elementos = [];
    let usandoArea = false;

    // ‚îÄ‚îÄ‚îÄ PASSO 1: rela√ß√£o administrativa OSM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // A rela√ß√£o administrativa √© a forma mais precisa: busca apenas dentro do
    // pol√≠gono real do munic√≠pio, sem ru√≠do de cidades vizinhas.
    if (municipio.osmId && municipio.osmType === 'relation') {
        const osmIdNum = parseInt(municipio.osmId, 10);
        const areaId   = 3600000000 + osmIdNum;          // padr√£o Overpass para relations
        updateSearchProgress(30, 'Consultando √°rea municipal...', `Rela√ß√£o OSM #${osmIdNum}`);
        const queryArea = buildHealthQuery(`area(${areaId})->.a;`, 'area.a');
        try {
            const dados = await consultarOverpass(queryArea);
            elementos    = dados.elements || [];
            usandoArea   = elementos.length > 0;
            if (usandoArea) updateSearchProgress(50, '√Årea municipal OK', `${elementos.length} candidatos`);
        } catch (e) {
            console.warn('Falha na rela√ß√£o administrativa:', e.message || e);
        }
    }

    // ‚îÄ‚îÄ‚îÄ PASSO 2: fallback por bounding box ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Usado quando: munic√≠pio sem rela√ß√£o OSM, ou rela√ß√£o n√£o produziu resultados.
    // O bbox do Nominatim √© preciso; se n√£o dispon√≠vel, calcula raio de 25 km.
    if (elementos.length === 0) {
        updateSearchProgress(35, 'Usando bounding box...', 'Calculando √°rea do munic√≠pio');
        const lat = municipio.latitude;
        const lon = municipio.longitude;
        let sul, norte, oeste, leste;
        if (municipio.bbox && municipio.bbox.length === 4) {
            [sul, norte, oeste, leste] = municipio.bbox;
        } else {
            const raio = 25;
            const dLat = raio / 111;
            const dLon = raio / (111 * Math.cos(lat * Math.PI / 180));
            sul   = (lat - dLat).toFixed(6);
            norte = (lat + dLat).toFixed(6);
            oeste = (lon - dLon).toFixed(6);
            leste = (lon + dLon).toFixed(6);
        }
        const bboxStr  = `${sul},${oeste},${norte},${leste}`;
        const queryBbox = buildHealthQuery('', bboxStr);
        try {
            const dados = await consultarOverpass(queryBbox);
            elementos    = dados.elements || [];
            if (elementos.length > 0) updateSearchProgress(50, 'Candidatos encontrados (bbox)', `${elementos.length} itens`);
        } catch (e) {
            console.warn('Overpass bbox falhou:', e.message || e);
        }
    }

    if (elementos.length === 0) return [];

    updateSearchProgress(55, 'Filtrando e classificando...', `${elementos.length} candidatos`);

    // ‚îÄ‚îÄ‚îÄ PASSO 3: processar em paralelo SEM reverseGeocode individual ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Quando usandoArea = true  ‚Üí aceita todos (o Overpass j√° limitou ao munic√≠pio).
    // Quando usandoArea = false ‚Üí aceita unidades cujo addr:city bate com o nome
    //                             OU (sem addr:city) estejam dentro de 30km do centro,
    //                             evitando centenas de chamadas Nominatim por elemento.
    const raioAceitacaoKm = 30;
    const BATCH = 50;
    const unidades = [];

    for (let i = 0; i < elementos.length; i += BATCH) {
        if (!buscaAtiva) return [];
        const batch = elementos.slice(i, i + BATCH);

        const promises = batch.map(async (el) => {
            const tags = el.tags || {};
            const elLat = el.lat ?? el.center?.lat;
            const elLon = el.lon ?? el.center?.lon;
            if (!elLat || !elLon) return null;

            if (!usandoArea) {
                // Filtro espacial leve: descarta unidades fora do raio de aceita√ß√£o
                const dist = calcularDistancia(municipio.latitude, municipio.longitude, elLat, elLon);
                if (dist > raioAceitacaoKm) return null;

                // Verifica cidade somente se addr:city estiver dispon√≠vel na tag
                // (evita flood de requisi√ß√µes Nominatim)
                const addrCity = norm(tags['addr:city'] || '');
                if (addrCity && addrCity !== norm(municipio.nome)) return null;
            }

            return montarUnidade(tags, elLat, elLon, el.id,
                el.type === 'node' ? 'node' : (el.type === 'relation' ? 'relation' : 'way'),
                uf, municipio.nome);
        });

        const results = await Promise.all(promises);
        for (const u of results) { if (u) unidades.push(u); }

        const pct = 55 + Math.round(((i + BATCH) / elementos.length) * 40);
        updateSearchProgress(Math.min(pct, 95), 'Processando...', `${unidades.length} unidades SUS v√°lidas`);
    }

    return deduplicar(unidades);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERFACE - FILTROS SEQUENCIAIS (mantido igual)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFilter() {
    const body = document.getElementById('filterBody');
    const arrow = document.getElementById('filterArrow');
    const btn = document.getElementById('filterToggleBtn');
    body.classList.toggle('open');
    arrow.classList.toggle('open');
    btn.querySelector('span').textContent = body.classList.contains('open') ? 'Recolher' : 'Expandir';
}

async function carregarEstados() {
    const select = document.getElementById('selectEstado');
    try {
        const response = await fetch(`${CONFIG.IBGE}/estados?orderBy=nome`);
        estados = await response.json();
        estados.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(est => {
            const opt = document.createElement('option');
            opt.value = est.sigla;
            opt.textContent = `${est.sigla} ‚Äî ${est.nome}`;
            select.appendChild(opt);
        });
    } catch (error) {
        console.error('Erro ao carregar estados:', error);
        showNotification('Erro ao carregar estados', 'error');
    }
}

async function onEstadoChange() {
    const select = document.getElementById('selectEstado');
    const grupoMun = document.getElementById('grupoMunicipio');
    const selectMun = document.getElementById('selectMunicipio');
    const uf = select.value;

    if (!uf) {
        grupoMun.style.display = 'none';
        selectMun.disabled = true;
        selectMun.innerHTML = '<option value="">‚Äî Selecione o estado primeiro ‚Äî</option>';
        document.getElementById('grupoBairro').style.display = 'none';
        document.getElementById('grupoNivel').style.display = 'none';
        document.getElementById('grupoAcolhimento').style.display = 'none';
        document.getElementById('grupoGestao').style.display = 'none';
        return;
    }

    grupoMun.style.display = 'block';
    selectMun.disabled = true;
    selectMun.innerHTML = '<option value="">Carregando munic√≠pios...</option>';

    try {
        const response = await fetch(`${CONFIG.IBGE}/estados/${uf}/municipios?orderBy=nome`);
        const municipios = await response.json();
        municipiosPorEstado[uf] = municipios.map(m => ({
            id: String(m.id),
            nome: m.nome,
            latitude: null,
            longitude: null,
            osmId: null,
            osmType: null,
            geojson: null,
            bbox: null
        }));
        selectMun.innerHTML = '<option value="">‚Äî Selecione um munic√≠pio ‚Äî</option>';
        municipiosPorEstado[uf].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(mun => {
            const opt = document.createElement('option');
            opt.value = mun.id;
            opt.textContent = mun.nome;
            selectMun.appendChild(opt);
        });
        selectMun.disabled = false;
    } catch (error) {
        console.error('Erro ao carregar munic√≠pios:', error);
        showNotification('Erro ao carregar munic√≠pios', 'error');
        selectMun.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

function onMunicipioChange() {
    const selectMun = document.getElementById('selectMunicipio');
    if (selectMun.value) {
        document.getElementById('grupoBairro').style.display = 'block';
        document.getElementById('grupoNivel').style.display = 'block';
        document.getElementById('grupoAcolhimento').style.display = 'block';
        document.getElementById('grupoGestao').style.display = 'block';
    } else {
        document.getElementById('grupoBairro').style.display = 'none';
        document.getElementById('grupoNivel').style.display = 'none';
        document.getElementById('grupoAcolhimento').style.display = 'none';
        document.getElementById('grupoGestao').style.display = 'none';
    }
}

function limparFiltros() {
    document.getElementById('selectEstado').value = '';
    document.getElementById('selectMunicipio').innerHTML = '<option value="">‚Äî Selecione o estado primeiro ‚Äî</option>';
    document.getElementById('selectMunicipio').disabled = true;
    document.getElementById('grupoMunicipio').style.display = 'none';
    document.getElementById('grupoBairro').style.display = 'none';
    document.getElementById('grupoNivel').style.display = 'none';
    document.getElementById('grupoAcolhimento').style.display = 'none';
    document.getElementById('grupoGestao').style.display = 'none';
    document.getElementById('inputBairro').value = '';
    document.getElementById('selectNivel').value = '';
    document.getElementById('selectAcolhimento').value = '';
    document.getElementById('selectGestao').value = '';
    allUnits = [];
    filteredUnits = [];
    // Restaura o texto padr√£o do card de busca por proximidade
    document.getElementById('geoStatus').textContent =
        'Detecta automaticamente sua localiza√ß√£o via GPS e busca unidades no raio (km) configurado abaixo:';
    renderResults();
    showNotification('Filtros limpos', 'success');
}

function applyLocalFilters() {
    const bairro      = document.getElementById('inputBairro').value.toLowerCase().trim();
    const nivel       = document.getElementById('selectNivel').value;
    const acolhimento = document.getElementById('selectAcolhimento').value;
    const gestao      = document.getElementById('selectGestao').value;

    filteredUnits = allUnits.filter(u => {
        if (bairro && u.bairro && !u.bairro.toLowerCase().includes(bairro)) return false;
        if (nivel       && u.nivel       !== nivel)       return false;
        if (acolhimento && u.acolhimento !== acolhimento) return false;
        if (gestao      && u.gestao      !== gestao)      return false;
        return true;
    });

    // ‚îÄ‚îÄ‚îÄ Ordena√ß√£o por modo de busca ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Geolocaliza√ß√£o ‚Üí agrupa por n√≠vel e, dentro de cada n√≠vel, por dist√¢ncia
    // Munic√≠pio      ‚Üí agrupa por n√≠vel e, dentro de cada n√≠vel, por nome A‚ÜíZ
    //
    // N√≠veis: primaria=1 (Aten√ß√£o B√°sica), secundaria=2 (M√©dia Complexidade),
    //         terciaria=3 (Alta Complexidade)
    const nivelOrdem  = { primaria: 1, secundaria: 2, terciaria: 3 };
    const modoGeo     = filteredUnits.some(u => u.distancia != null && u.distancia >= 0);

    filteredUnits.sort((a, b) => {
        // 1¬∫ crit√©rio: n√≠vel de complexidade crescente (Prim√°rio ‚Üí Secund√°rio ‚Üí Terci√°rio)
        const nivelDiff = (nivelOrdem[a.nivel] || 9) - (nivelOrdem[b.nivel] || 9);
        if (nivelDiff !== 0) return nivelDiff;

        // 2¬∫ crit√©rio:
        //   ‚Ä¢ Modo geogr√°fico ‚Üí dist√¢ncia crescente (mais pr√≥xima primeiro)
        //   ‚Ä¢ Modo munic√≠pio  ‚Üí nome em ordem alfab√©tica (A ‚Üí Z)
        if (modoGeo) {
            return (a.distancia ?? 9999) - (b.distancia ?? 9999);
        }
        return norm(a.nome).localeCompare(norm(b.nome));
    });

    renderResults();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERIZA√á√ÉO COM LAZY LOADING
//
//  Problema anterior: container.innerHTML = htmlGigante renderizava todos os
//  cards de uma vez. Para 360 resultados no Rio, isso congela a thread
//  principal por at√© 2 s em celulares de entrada.
//
//  Solu√ß√£o: renderiza apenas os primeiros BATCH_SIZE cards de cada grupo.
//  Um IntersectionObserver monitora um sentinela invis√≠vel no fim de cada
//  grupo e, quando ele aparece na tela, carrega o pr√≥ximo lote.
//  O usu√°rio s√≥ percebe o carregamento incremental se rolar r√°pido ‚Äî
//  na pr√°tica, a interface responde instantaneamente.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RENDER_BATCH = 20;   // cards iniciais por grupo
const RENDER_MORE  = 20;   // cards adicionais por scroll

// IntersectionObserver reutilizado entre renderiza√ß√µes
let _lazyObserver = null;

function renderResults() {
    updateDashboard();

    // Desconecta observer anterior para evitar vazamentos
    if (_lazyObserver) { _lazyObserver.disconnect(); _lazyObserver = null; }

    const container = document.getElementById('resultsSection');
    if (filteredUnits.length === 0) {
        container.innerHTML = `
            <div class="status-box">
                <span class="status-icon">üîç</span>
                <h3>Nenhuma unidade encontrada</h3>
                <p>Tente ajustar os filtros ou realizar uma nova busca.</p>
            </div>
        `;
        return;
    }

    const groups = {
        'primaria':   filteredUnits.filter(u => u.nivel === 'primaria'),
        'secundaria': filteredUnits.filter(u => u.nivel === 'secundaria'),
        'terciaria':  filteredUnits.filter(u => u.nivel === 'terciaria')
    };

    // Cabe√ßalho com bot√µes de exporta√ß√£o
    const header = document.createElement('div');
    header.className = 'results-header';
    header.innerHTML = `
        <div>
            <h2 class="results-title">
                Resultados
                <span class="results-count">${filteredUnits.length}</span>
            </h2>
        </div>
        <div class="export-row">
            <button class="btn btn-amber btn-sm" onclick="exportToExcel()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                </svg>
                Exportar Excel
            </button>
            <button class="btn btn-navy btn-sm" onclick="visualizarPDF()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                </svg>
                Visualizar PDF
            </button>
        </div>
    `;

    // Limpa e re-popula o container usando DocumentFragment (uma s√≥ opera√ß√£o DOM)
    const fragment = document.createDocumentFragment();
    fragment.appendChild(header);

    const groupConfigs = [
        { key: 'primaria',   label: 'Aten√ß√£o Prim√°ria',   color: '#00A878', icon: 'üè†',
          desc: 'UBS ¬∑ Postos de Sa√∫de ¬∑ Cl√≠nicas da Fam√≠lia ¬∑ ESF/PSF ¬∑ CAPS/CAPS-AD' },
        { key: 'secundaria', label: 'Aten√ß√£o Secund√°ria',  color: '#1565C0', icon: 'üî¨',
          desc: 'UPAs 24h ¬∑ AME ¬∑ CEO ¬∑ Policl√≠nicas ¬∑ Unidades Mistas ¬∑ CER' },
        { key: 'terciaria',  label: 'Aten√ß√£o Terci√°ria',   color: '#E53935', icon: 'üè®',
          desc: 'Hospitais Gerais ¬∑ Universit√°rios ¬∑ Santas Casas ¬∑ Especializados ¬∑ Reabilita√ß√£o' }
    ];

    // Cria o IntersectionObserver compartilhado para todos os grupos
    _lazyObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            const sentinel = entry.target;
            _lazyObserver.unobserve(sentinel);

            const grid      = sentinel.dataset.grid;
            const groupKey  = sentinel.dataset.groupKey;
            const rendered  = parseInt(sentinel.dataset.rendered, 10);
            const color     = sentinel.dataset.color;

            const gridEl    = document.getElementById(grid);
            if (!gridEl) return;

            // Unidades deste grupo (j√° filtradas e ordenadas em filteredUnits)
            const allInGroup = filteredUnits.filter(u => u.nivel === groupKey);
            const next       = allInGroup.slice(rendered, rendered + RENDER_MORE);

            if (next.length === 0) return;

            // Renderiza o pr√≥ximo lote
            const frag = document.createDocumentFragment();
            next.forEach((u, i) => {
                const tmp = document.createElement('div');
                tmp.innerHTML = renderUnitCard(u, color, rendered + i);
                frag.appendChild(tmp.firstElementChild);
            });

            const newRendered = rendered + next.length;

            // Se ainda h√° mais, adiciona novo sentinela
            if (newRendered < allInGroup.length) {
                const newSentinel = _makeSentinel(grid, groupKey, newRendered, color);
                frag.appendChild(newSentinel);
                _lazyObserver.observe(newSentinel);
            }

            // Remove o sentinela antigo e insere o novo conte√∫do
            sentinel.remove();
            gridEl.appendChild(frag);
        });
    }, { rootMargin: '200px' });   // pr√©-carrega 200 px antes de aparecer na tela

    groupConfigs.forEach(cfg => {
        if (!groups[cfg.key] || groups[cfg.key].length === 0) return;
        fragment.appendChild(renderGroup(cfg, groups[cfg.key]));
    });

    container.innerHTML = '';
    container.appendChild(fragment);
}

function _makeSentinel(gridId, groupKey, rendered, color) {
    const s = document.createElement('div');
    s.className = 'lazy-sentinel';
    s.dataset.grid     = gridId;
    s.dataset.groupKey = groupKey;
    s.dataset.rendered = rendered;
    s.dataset.color    = color;
    s.style.cssText    = 'height:1px;grid-column:1/-1;';
    return s;
}

function renderGroup(config, units) {
    const groupId = `group-${config.key}`;
    const modoGeo = units.some(u => u.distancia != null && u.distancia >= 0);
    const sortInfo = modoGeo
        ? 'üìç Ordenadas por proximidade (mais pr√≥xima primeiro)'
        : 'üî§ Ordenadas por nome (A ‚Üí Z)';

    // Renderiza apenas o primeiro lote ‚Äî o resto vir√° pelo IntersectionObserver
    const primeiroLote = units.slice(0, RENDER_BATCH);
    let cardsHTML = primeiroLote.map((u, idx) => renderUnitCard(u, config.color, idx)).join('');

    const section = document.createElement('div');
    section.className = 'group-section';
    section.innerHTML = `
        <div class="group-header" onclick="toggleGroup('${groupId}')">
            <div class="group-header-left">
                <span class="group-pill" style="background: ${config.color}22; color: ${config.color};">${config.icon}</span>
                <div>
                    <div class="group-name">${config.label}</div>
                    <div class="group-meta">
                        ${units.length} unidade${units.length !== 1 ? 's' : ''} encontrada${units.length !== 1 ? 's' : ''}
                        &nbsp;&middot;&nbsp;<span style="font-size:0.7rem;color:var(--teal);">${sortInfo}</span>
                    </div>
                    <div style="font-size:0.68rem;color:var(--text-light);margin-top:2px;">${config.desc || ''}</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="group-count">${units.length}</div>
                <span class="group-arrow" id="${groupId}-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
                </span>
            </div>
        </div>
        <div class="group-body" id="${groupId}">
            <div class="cards-grid" id="${groupId}-grid">
                ${cardsHTML}
            </div>
        </div>
    `;

    // Se h√° mais cards al√©m do primeiro lote, adiciona sentinela e registra observer
    if (units.length > RENDER_BATCH) {
        const gridEl   = section.querySelector(`#${groupId}-grid`);
        const sentinel = _makeSentinel(`${groupId}-grid`, config.key, RENDER_BATCH, config.color);
        gridEl.appendChild(sentinel);
        // Observer ser√° registrado depois que a section for inserida no DOM,
        // por isso usamos requestAnimationFrame para garantir visibilidade
        requestAnimationFrame(() => {
            if (_lazyObserver) _lazyObserver.observe(sentinel);
        });
    }

    return section;
}

function renderUnitCard(unit, accentColor, idx) {
    const gestaoClass = {
        'Municipal': 'municipal',
        'Estadual': 'estadual',
        'Federal': 'federal'
    }[unit.gestao] || 'municipal';
    
    let tagsHTML = '';
    if (unit.gestao) {
        tagsHTML += `<span class="unit-tag unit-tag-${gestaoClass}">${unit.gestao}</span>`;
    }
    const acolhimentoClass = {
        'ambulatorial': 'ambulatorial',
        'urgencia': 'urgencia',
        'maternidade': 'maternidade',
        'especializado': 'especializado',
        'samu': 'urgencia'
    }[unit.acolhimento] || 'ambulatorial';
    tagsHTML += `<span class="unit-tag unit-tag-${acolhimentoClass}">${getTextoAcolhimento(unit.acolhimento)}</span>`;
    if (unit.distancia !== null && unit.distancia !== undefined) {
        tagsHTML += `<span class="unit-tag unit-distance">${unit.distancia.toFixed(1)} km</span>`;
    }
    if (unit.cnes) {
        tagsHTML += `<span class="unit-tag" style="background: #0B1F3A; color: white;">CNES ${unit.cnes}</span>`;
    }

    let nomeExibido = unit.nome;
    if (unit.perfil === 'UPA' && unit.bairro) {
        if (!norm(unit.nome).includes(norm(unit.bairro))) {
            nomeExibido = `${unit.nome} (${unit.bairro})`;
        }
    }

    let actionsHTML = '';
    if (unit.mapsLink) {
        // Google Maps: pin vermelho com ponto branco central
        actionsHTML += `
            <button class="btn-icon maps" onclick="window.open('${unit.mapsLink}', '_blank')" title="Ver no Google Maps">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#EA4335"/>
                    <circle cx="12" cy="9" r="2.5" fill="white"/>
                </svg>
            </button>
        `;
    }

    const searchQuery = encodeURIComponent(`${unit.nome} ${unit.cidade || ''} ${unit.uf || ''} sa√∫de`);
    const infoUrl = `https://www.google.com/search?q=${searchQuery}`;
    // Google Search: "G" multicolorido estilizado
    actionsHTML += `
        <button class="btn-icon search" onclick="window.open('${infoUrl}', '_blank')" title="Pesquisar no Google">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" fill="white"/>
                <path d="M20.5 12.2h-8.5v2.8h4.9c-.5 2.3-2.4 3.9-4.9 3.9-3 0-5.4-2.4-5.4-5.4 0-3 2.4-5.4 5.4-5.4 1.4 0 2.7.5 3.6 1.4l2-2c-1.4-1.3-3.4-2.2-5.6-2.2-4.6 0-8.2 3.7-8.2 8.2s3.6 8.2 8.2 8.2c4.7 0 7.9-3.3 7.9-8 0-.5-.1-.9-.2-1.3l-.2-.2z" fill="#4285F4"/>
                <path d="M6.2 13.6l-.7 2.6-2.5.1c-.8-1.4-1.2-3-1.2-4.8 0-1.7.4-3.3 1.1-4.7l2.2.4.9 2.5c-.2.6-.3 1.2-.3 1.8 0 .7.2 1.5.5 2.1z" fill="#FBBC05"/>
                <path d="M12 5.2c1.6 0 3 .5 4.1 1.4l2-2C16.5 3.2 14.4 2.2 12 2.2c-3.8 0-7 2.2-8.6 5.4l3.2 2.5c.8-2.3 3-3.9 5.4-3.9z" fill="#EA4335"/>
            </svg>
        </button>
    `;

    if (unit.telefone) {
        const telLigacao = limparNumeroParaLigacao(unit.telefone);
        // Telefone: handset branco sobre fundo verde
        actionsHTML += `
            <button class="btn-icon phone" onclick="window.location.href='tel:${telLigacao}'" title="Ligar: ${unit.telefoneFormatado}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1C10.6 21 3 13.4 3 4c0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z" fill="white"/>
                </svg>
            </button>
        `;
    }

    const whatsappLink = gerarLinkCompartilhamentoWhatsApp(unit);
    // WhatsApp: logo oficial (bal√£o com fone) branco sobre fundo verde
    actionsHTML += `
        <button class="btn-icon whatsapp" onclick="window.open('${whatsappLink}', '_blank')" title="Compartilhar no WhatsApp">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M17.5 14.4c-.3-.1-1.7-.8-1.9-.9-.3-.1-.4-.1-.6.1-.2.3-.7.9-.9 1.1-.2.2-.3.2-.6.1-.3-.1-1.2-.4-2.3-1.4-.9-.8-1.4-1.7-1.6-2-.2-.3 0-.4.1-.6l.4-.5c.1-.2.2-.3.3-.5.1-.2 0-.4 0-.5C9.9 9 9.3 7.6 9 7c-.3-.5-.5-.5-.6-.5h-.5c-.2 0-.5.1-.7.3C7 7 6 8 6 9.9c0 2 1.4 3.8 1.6 4.1.2.3 2.8 4.3 6.8 6 1 .4 1.7.6 2.3.8.9.3 1.8.2 2.5.1.7-.1 2.2-.9 2.5-1.7.3-.8.3-1.5.2-1.7-.1-.2-.3-.3-.4-.4l-4-.7z" fill="white"/>
                <path d="M20.5 3.5C18.2 1.2 15.2 0 12 0 5.4 0 0 5.4 0 12c0 2.1.6 4.2 1.6 6L0 24l6.3-1.6C8.1 23.4 10 24 12 24c6.6 0 12-5.4 12-12 0-3.2-1.2-6.2-3.5-8.5zM12 22c-1.8 0-3.6-.5-5.1-1.4l-.4-.2-3.7 1 1-3.6-.2-.4C2.5 15.8 2 13.9 2 12 2 6.5 6.5 2 12 2s10 4.5 10 10-4.5 10-10 10z" fill="white"/>
            </svg>
        </button>
    `;

    if (unit.email) {
        // Email: envelope branco sobre fundo vermelho (Gmail-like)
        actionsHTML += `
            <button class="btn-icon email" onclick="window.location.href='mailto:${unit.email}'" title="Enviar e-mail">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M20 4H4C2.9 4 2 4.9 2 6v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="white"/>
                </svg>
            </button>
        `;
    }

    return `
        <div class="unit-card" data-unit-idx="${idx}">
            <div class="unit-card-accent" style="background: ${accentColor};"></div>
            <div class="unit-card-inner">
                <div class="unit-card-header">
                    <h3 class="unit-name">${nomeExibido}</h3>
                </div>
                ${unit.perfil ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>${unit.perfil}</span>
                    </div>
                ` : ''}
                ${unit.cidade && unit.uf ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${unit.cidade} - ${unit.uf}</span>
                    </div>
                ` : ''}
                ${unit.enderecoCompleto || unit.endereco ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${unit.enderecoCompleto || unit.endereco} ${unit.bairro ? ' - ' + unit.bairro : ''}</span>
                    </div>
                ` : ''}
                ${unit.telefoneFormatado ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <span>${unit.telefoneFormatado}</span>
                    </div>
                ` : ''}
                ${unit.email ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span>${unit.email}</span>
                    </div>
                ` : ''}
                ${unit.cnes && !tagsHTML.includes('CNES') ? `<div class="unit-cnes">CNES: ${unit.cnes}</div>` : ''}
                <div class="unit-tags">${tagsHTML}</div>
                ${actionsHTML ? `<div class="unit-actions">${actionsHTML}</div>` : ''}
            </div>
        </div>
    `;
}

function toggleGroup(groupId) {
    const body = document.getElementById(groupId);
    const arrow = document.getElementById(`${groupId}-arrow`);
    body.classList.toggle('open');
    arrow.classList.toggle('open');
}

function updateDashboard() {
    document.getElementById('statTotal').textContent = filteredUnits.length;
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria').length;
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria').length;
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria').length;
    const urgencia = filteredUnits.filter(u => u.acolhimento === 'urgencia').length;
    const maternidade = filteredUnits.filter(u => u.acolhimento === 'maternidade').length;
    const especializado = filteredUnits.filter(u => u.acolhimento === 'especializado').length;
    const ambulatorial = filteredUnits.filter(u => u.acolhimento === 'ambulatorial').length;
    document.getElementById('statPrimaria').textContent = primaria;
    document.getElementById('statSecundaria').textContent = secundaria;
    document.getElementById('statTerciaria').textContent = terciaria;
    document.getElementById('statUrgencia').textContent = urgencia;
    document.getElementById('statMaternidade').textContent = maternidade;
    document.getElementById('statEspecializado').textContent = especializado;
    document.getElementById('statAmbulatorial').textContent = ambulatorial;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORTA√á√ÉO EXCEL (mantida igual)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportToExcel() {
    if (filteredUnits.length === 0) {
        showNotification('Nenhuma unidade para exportar', 'error');
        return;
    }
    const data = filteredUnits.map(u => ({
        'Nome': u.nome,
        'Perfil': u.perfil,
        'N√≠vel de Aten√ß√£o': u.nivel === 'primaria' ? 'Prim√°ria' : u.nivel === 'secundaria' ? 'Secund√°ria' : 'Terci√°ria',
        'Tipo de Acolhimento': getTextoAcolhimento(u.acolhimento),
        'Cidade': u.cidade,
        'UF': u.uf,
        'Bairro': u.bairro || '',
        'Endere√ßo': u.endereco || '',
        'Telefone': u.telefoneFormatado || u.telefone || '',
        'E-mail': u.email || '',
        'Gest√£o': u.gestao || '',
        'CNES': u.cnes || '',
        'Dist√¢ncia (km)': u.distancia ? u.distancia.toFixed(2) : '',
        'Latitude': u.lat || '',
        'Longitude': u.lon || '',
        'Website': u.website || ''
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Unidades de Sa√∫de');
    const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showNotification(`Arquivo Excel exportado: ${fileName}`, 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PDF (com cidade/UF nos cards) ‚Äî mantido igual
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gerarPaginaHTML(units, tituloNivel, iconeNivel, corClasse, paginaAtual, totalPaginas, totalUnidades, dataAtual) {
    const cardsHTML = units.map(u => {
        const endereco = u.enderecoCompleto || u.endereco || '';
        const bairro = u.bairro ? ` - ${u.bairro}` : '';
        const telefone = u.telefoneFormatado || u.telefone || 'N√£o informado';
        const acolhimentoClass = u.acolhimento || 'ambulatorial';
        const acolhimentoTexto = getTextoAcolhimento(u.acolhimento);
        const distancia = u.distancia ? `<div class="pdf-unit-detail"><span>üß≠</span> <span>${u.distancia.toFixed(1)} km</span></div>` : '';
        const cnes = u.cnes ? `<div style="font-size:0.55rem; margin-top:2px;">CNES: ${u.cnes}</div>` : '';
        // Linha de cidade/UF
        const localizacao = (u.cidade && u.uf) ? `<div class="pdf-unit-detail"><span>üèôÔ∏è</span> <span>${u.cidade} - ${u.uf}</span></div>` : '';
        // Mapeia acolhimento para classe CSS (urgente, ambulatorial, maternidade, especializado)
        let badgeClass = '';
        if (u.acolhimento === 'urgencia') badgeClass = 'urgente';
        else if (u.acolhimento === 'ambulatorial') badgeClass = 'ambulatorial';
        else if (u.acolhimento === 'maternidade') badgeClass = 'maternidade';
        else if (u.acolhimento === 'especializado') badgeClass = 'especializado';
        else badgeClass = 'ambulatorial';

        return `
            <div class="pdf-unit-card">
                <div class="pdf-unit-name">${u.nome}</div>
                <div class="pdf-unit-detail"><span>üìç</span> <span>${endereco}${bairro}</span></div>
                ${localizacao}
                <div class="pdf-unit-detail"><span>üìû</span> <span>${telefone}</span></div>
                ${u.email ? `<div class="pdf-unit-detail"><span>üìß</span> <span>${u.email}</span></div>` : ''}
                <div class="pdf-unit-detail"><span>üè•</span> <span>${u.perfil}</span></div>
                ${distancia}
                <span class="pdf-unit-badge ${badgeClass}">${acolhimentoTexto}</span>
                ${cnes}
                <div style="display:flex;gap:5px;margin-top:6px;flex-wrap:wrap;">
                    ${u.mapsLink ? `<a href="${u.mapsLink}" style="display:inline-flex;align-items:center;gap:3px;font-size:0.58rem;font-weight:600;color:#EA4335;text-decoration:none;background:#FFF0EF;border-radius:5px;padding:3px 7px;">
                      <svg width="10" height="10" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#EA4335"/><circle cx="12" cy="9" r="2.5" fill="white"/></svg>Maps</a>` : ''}
                    ${u.telefone ? `<a href="tel:${u.telefone}" style="display:inline-flex;align-items:center;gap:3px;font-size:0.58rem;font-weight:600;color:#fff;text-decoration:none;background:#25D366;border-radius:5px;padding:3px 7px;">
                      <svg width="10" height="10" viewBox="0 0 24 24"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1C10.6 21 3 13.4 3 4c0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z" fill="white"/></svg>Ligar</a>` : ''}
                    ${u.website ? `<a href="${u.website}" style="display:inline-flex;align-items:center;gap:3px;font-size:0.58rem;font-weight:600;color:#4285F4;text-decoration:none;background:#E8F0FE;border-radius:5px;padding:3px 7px;">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#4285F4" stroke-width="2.5"><circle cx="12" cy="12" r="9"/><path d="M12 3c-2.5 3-4 5.5-4 9s1.5 6 4 9M12 3c2.5 3 4 5.5 4 9s-1.5 6-4 9M3 12h18"/></svg>Site</a>` : ''}
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="pdf-page" style="width: 800px; background: white; font-family: 'Outfit', 'Fira Sans', sans-serif; padding: 10px; box-sizing: border-box;">
            <div class="pdf-header" style="background: linear-gradient(135deg, #0B1F3A, #132D50); color: white; padding: 8px 12px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="font-size: 1.2rem; font-weight: 800; margin:0;">Sa√∫de<span style="color: #00C896;"> - BR</span> ‚Äî Unidades P√∫blicas de Sa√∫de</h1>
                    <p style="font-size: 0.6rem; opacity:0.8;">Dados do OpenStreetMap ‚Ä¢ Apenas unidades p√∫blicas</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.1rem; font-weight:800; color:#00C896;">${totalUnidades}</div>
                    <div style="font-size:0.5rem; opacity:0.7;">Total de Unidades</div>
                </div>
            </div>
            <div class="pdf-nivel-header" style="display: flex; align-items: center; gap: 6px; background: ${corClasse === 'primaria' ? 'linear-gradient(135deg, #00A878, #00C896)' : corClasse === 'secundaria' ? 'linear-gradient(135deg, #1565C0, #2196f3)' : 'linear-gradient(135deg, #E53935, #f44336)'}; color: white; padding: 6px 10px; border-radius: 6px; margin: 8px 0;">
                <span style="font-size: 1.2rem;">${iconeNivel}</span>
                <span style="flex:1; font-weight:700; font-size:0.8rem;">${tituloNivel}</span>
                <span style="font-weight:800; font-size:1rem;">${units.length}</span>
            </div>
            <div class="pdf-cards-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">${cardsHTML}</div>
            <div class="pdf-footer" style="display: flex; justify-content: space-between; font-size: 0.55rem; color: #5A6E85; border-top: 1px solid #D8E2EE; padding-top: 4px; margin-top: 8px;">
                <span>üîç Gerado pelo Sa√∫de-BR Localizador de Unidades de Sa√∫de</span>
                <span>P√°gina ${paginaAtual} de ${totalPaginas} ‚Ä¢ ${dataAtual}</span>
            </div>
        </div>
    `;
}

const pdfStyles = `
    <style>
        .pdf-unit-card {
            background: #f8fafd;
            border: 1px solid #D8E2EE;
            border-radius: 6px;
            padding: 6px;
            font-size: 0.65rem;
            break-inside: avoid;
            page-break-inside: avoid;
        }
        .pdf-unit-name {
            font-weight: 700;
            font-size: 0.75rem;
            color: #0B1F3A;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pdf-unit-detail {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.6rem;
            color: #5A6E85;
            margin-bottom: 2px;
        }
        .pdf-unit-detail span:first-child { min-width: 14px; }
        .pdf-unit-badge {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.55rem;
            font-weight: 600;
            margin-top: 3px;
        }
        .pdf-unit-badge.urgente { background: #FDECEA; color: #E53935; }
        .pdf-unit-badge.ambulatorial { background: #E8F8F3; color: #00A878; }
        .pdf-unit-badge.maternidade { background: #F3E5F5; color: #6A1B9A; }
        .pdf-unit-badge.especializado { background: #FFF8EC; color: #C07A00; }
    </style>
`;

async function gerarPDFCompleto() {
    const dataAtual = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria');
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria');
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria');
    const grupos = [
        { units: primaria, titulo: 'Aten√ß√£o Prim√°ria', icone: 'üè†', cor: 'primaria' },
        { units: secundaria, titulo: 'Aten√ß√£o Secund√°ria', icone: 'üî¨', cor: 'secundaria' },
        { units: terciaria, titulo: 'Aten√ß√£o Terci√°ria', icone: 'üè®', cor: 'terciaria' }
    ].filter(g => g.units.length > 0);
    const CARDS_POR_PAGINA = 8;
    const paginasHTML = [];
    let paginaGlobal = 1;
    for (const grupo of grupos) {
        const units = grupo.units;
        for (let i = 0; i < units.length; i += CARDS_POR_PAGINA) {
            const fatia = units.slice(i, i + CARDS_POR_PAGINA);
            paginasHTML.push(gerarPaginaHTML(fatia, grupo.titulo, grupo.icone, grupo.cor, paginaGlobal, 0, filteredUnits.length, dataAtual));
            paginaGlobal++;
        }
    }
    const totalPaginas = paginasHTML.length;
    let htmlFinal = pdfStyles;
    for (let i = 0; i < paginasHTML.length; i++) {
        const item = paginasHTML[i];
        const htmlComNumero = item.replace('P√°gina 0 de 0', `P√°gina ${i+1} de ${totalPaginas}`);
        htmlFinal += htmlComNumero;
        if (i < paginasHTML.length - 1) htmlFinal += '<div style="page-break-before: always; height: 0;"></div>';
    }
    return htmlFinal;
}

async function visualizarPDF() {
    if (filteredUnits.length === 0) { showNotification('Nenhuma unidade para gerar PDF', 'error'); return; }
    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando visualiza√ß√£o do PDF...', 'Preparando conte√∫do');
    try {
        const html = await gerarPDFCompleto();
        document.getElementById('pdfModalBody').innerHTML = html;
        document.getElementById('pdfModal').classList.add('visible');
        showSearchProgress(false);
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar visualiza√ß√£o do PDF', 'error');
        showSearchProgress(false);
    }
}

function closePDFModal() { document.getElementById('pdfModal').classList.remove('visible'); }

async function downloadPDF() {
    if (filteredUnits.length === 0) return;
    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando PDF...', 'Processando p√°ginas');
    try {
        const { jsPDF } = window.jspdf;
        const htmlString = await gerarPDFCompleto();
        const container = document.createElement('div');
        container.innerHTML = htmlString;
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.top = '0';
        container.style.width = '800px';
        container.style.background = 'white';
        document.body.appendChild(container);
        const paginas = Array.from(container.children).filter(el => el.classList.contains('pdf-page'));
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
        for (let i = 0; i < paginas.length; i++) {
            updateSearchProgress(20 + Math.round((i / paginas.length) * 70), `Renderizando p√°gina ${i+1} de ${paginas.length}...`, 'Aguarde, pode levar alguns segundos');
            const pageDiv = paginas[i];
            pageDiv.style.width = '800px';
            pageDiv.style.height = 'auto';
            pageDiv.style.margin = '0';
            pageDiv.style.padding = '10px';
            const canvas = await html2canvas(pageDiv, { scale: 1.5, backgroundColor: '#ffffff', logging: false, allowTaint: true, useCORS: true, windowWidth: 800, windowHeight: pageDiv.scrollHeight });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const width = imgWidth * ratio;
            const height = imgHeight * ratio;
            const x = (pdfWidth - width) / 2;
            const y = (pdfHeight - height) / 2;
            if (i > 0) pdf.addPage();
            pdf.addImage(imgData, 'JPEG', x, y, width, height);
        }
        document.body.removeChild(container);
        const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        showSearchProgress(false);
        showNotification(`PDF baixado: ${fileName}`, 'success');
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar PDF', 'error');
        showSearchProgress(false);
    }
}

async function compartilharPDFWhatsApp() {
    if (filteredUnits.length === 0) { showNotification('Nenhuma unidade para compartilhar', 'error'); return; }
    showSearchProgress(true);
    updateSearchProgress(10, 'Preparando PDF para WhatsApp...', 'Gerando p√°ginas...');
    try {
        const { jsPDF } = window.jspdf;
        const htmlString = await gerarPDFCompleto();
        const container = document.createElement('div');
        container.innerHTML = htmlString;
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.top = '0';
        container.style.width = '800px';
        container.style.background = 'white';
        document.body.appendChild(container);
        const paginas = Array.from(container.children).filter(el => el.classList.contains('pdf-page'));
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });
        for (let i = 0; i < paginas.length; i++) {
            updateSearchProgress(20 + Math.round((i / paginas.length) * 70), `Renderizando p√°gina ${i+1} de ${paginas.length}...`, 'Convertendo imagem...');
            const pageDiv = paginas[i];
            pageDiv.style.width = '800px';
            pageDiv.style.height = 'auto';
            pageDiv.style.margin = '0';
            pageDiv.style.padding = '10px';
            const canvas = await html2canvas(pageDiv, { scale: 1.5, backgroundColor: '#ffffff', logging: false, allowTaint: true, useCORS: true, windowWidth: 800, windowHeight: pageDiv.scrollHeight });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const width = imgWidth * ratio;
            const height = imgHeight * ratio;
            const x = (pdfWidth - width) / 2;
            const y = (pdfHeight - height) / 2;
            if (i > 0) pdf.addPage();
            pdf.addImage(imgData, 'JPEG', x, y, width, height);
        }
        document.body.removeChild(container);
        const pdfBlob = pdf.output('blob');
        updateSearchProgress(95, 'Pronto!', 'Preparando compartilhamento...');
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], 'SaudeBR_Unidades.pdf', { type: 'application/pdf' })] })) {
            const file = new File([pdfBlob], 'SaudeBR_Unidades.pdf', { type: 'application/pdf' });
            await navigator.share({
                title: 'Relat√≥rio de Unidades de Sa√∫de',
                text: 'Confira as unidades de sa√∫de pr√≥ximas.',
                files: [file]
            });
            showNotification('Compartilhado com sucesso!', 'success');
        } else {
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const link = document.createElement('a');
            link.href = pdfUrl;
            link.download = 'SaudeBR_Unidades.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(pdfUrl);
            alert('‚úÖ PDF gerado com sucesso!\n\nPara compartilhar no WhatsApp:\n1Ô∏è‚É£ Clique em OK e aguarde o download\n2Ô∏è‚É£ Abra o WhatsApp\n3Ô∏è‚É£ Selecione a conversa desejada\n4Ô∏è‚É£ Clique no √≠cone üìé (anexar)\n5Ô∏è‚É£ Escolha "Documento"\n6Ô∏è‚É£ Selecione o arquivo baixado');
        }
        showSearchProgress(false);
        showNotification('PDF pronto para compartilhamento!', 'success');
    } catch (error) {
        console.error('Erro ao gerar PDF para WhatsApp:', error);
        showNotification('Erro ao gerar PDF para WhatsApp', 'error');
        showSearchProgress(false);
    }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL PIX ‚Äî Contribui√ß√£o do desenvolvedor
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function abrirModalPix() {
    document.getElementById('pixModal').classList.add('visible');
}
function fecharModalPix() {
    document.getElementById('pixModal').classList.remove('visible');
    const btn = document.getElementById('pixCopyBtn');
    btn.classList.remove('copied');
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copiar';
}
function fecharModalPixOverlay(e) {
    if (e.target === document.getElementById('pixModal')) fecharModalPix();
}
async function copiarChavePix() {
    const chave = document.getElementById('pixKeyText').textContent;
    try {
        await navigator.clipboard.writeText(chave);
    } catch {
        const ta = document.createElement('textarea');
        ta.value = chave; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
    }
    const btn = document.getElementById('pixCopyBtn');
    btn.classList.add('copied');
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>Copiado!';
    showNotification('Chave PIX copiada!', 'success');
    setTimeout(() => {
        btn.classList.remove('copied');
        btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copiar';
    }, 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INICIALIZA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    carregarEstados();
    console.log('Sa√∫de-BR Localizador de Unidades de Sa√∫de - SUS');
});

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('visible');
    });
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Sa√∫de P√∫blica SUS - Rio de Janeiro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ========== ESTILOS ORIGINAIS (COMPLETOS) ========== */
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-600: #475569;
            --gray-700: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-700);
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .hero-header {
            background: white; border-radius: 20px; padding: 40px; margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white; position: relative; overflow: hidden;
        }
        .hero-header::before {
            content: ''; position: absolute; top: -50%; right: -10%;
            width: 500px; height: 500px; background: rgba(255,255,255,0.1); border-radius: 50%;
        }
        .hero-content { position: relative; z-index: 2; }
        .hero-header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
        .hero-header .sus-badge {
            display: inline-block; background: rgba(255,255,255,0.2); 
            padding: 8px 16px; border-radius: 20px; font-size: 0.9rem;
            font-weight: 600; margin-bottom: 15px;
        }
        .hero-header p { font-size: 1.1rem; opacity: 0.95; margin-bottom: 25px; }
        .btn-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .btn {
            padding: 14px 28px; border: none; border-radius: 12px; font-weight: 700;
            cursor: pointer; font-size: 15px; transition: all 0.3s ease;
            display: inline-flex; align-items: center; gap: 8px; text-decoration: none;
        }
        .btn-primary { background: white; color: #059669; box-shadow: var(--shadow-md); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-location { background: #f59e0b; color: white; box-shadow: var(--shadow-md); }
        .btn-location:hover { background: #d97706; transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; box-shadow: var(--shadow-md); }
        .btn-success:hover { background: #047857; transform: translateY(-2px); }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow-md);
            border-left: 5px solid; transition: all 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .stat-card.total { border-color: var(--primary); }
        .stat-card.primaria { border-color: var(--success); }
        .stat-card.secundaria { border-color: var(--warning); }
        .stat-card.terciaria { border-color: var(--danger); }
        .stat-label {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            color: var(--gray-600); letter-spacing: 0.5px; margin-bottom: 8px;
        }
        .stat-value { font-size: 3rem; font-weight: 800; color: var(--gray-700); }
        .loader-section {
            background: white; padding: 30px; border-radius: 16px;
            box-shadow: var(--shadow-md); margin-bottom: 30px; display: none;
        }
        .loader-content {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .loader-text { font-weight: 700; color: var(--gray-700); font-size: 16px; }
        .loader-percent { font-weight: 800; color: var(--primary); font-size: 18px; }
        .progress-bar {
            height: 10px; background: var(--gray-200); border-radius: 10px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--success) 0%, #10b981 100%);
            transition: width 0.4s ease; border-radius: 10px;
        }
        .loader-details {
            margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--gray-200);
            font-size: 13px; color: var(--gray-600);
        }
        .filter-section {
            background: white; padding: 30px; border-radius: 16px;
            box-shadow: var(--shadow-md); margin-bottom: 30px;
        }
        .filter-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .filter-header h2 { font-size: 1.5rem; color: var(--gray-700); display: flex; gap: 10px; }
        .btn-clear {
            background: var(--danger); color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-clear:hover { background: #b91c1c; }
        .filter-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;
        }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-weight: 600; font-size: 14px; color: var(--gray-700); }
        .filter-input, .filter-select {
            padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 10px;
            font-size: 15px; font-family: 'Inter', sans-serif; transition: all 0.3s ease;
            background: white;
        }
        .filter-input:focus, .filter-select:focus {
            outline: none; border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        .results-section { display: flex; flex-direction: column; gap: 20px; }
        .category-card {
            background: white; border-radius: 16px; box-shadow: var(--shadow-md);
            overflow: hidden; transition: all 0.3s ease;
        }
        .category-header {
            padding: 20px 30px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--gray-200); transition: all 0.3s ease;
        }
        .category-header:hover { background: var(--gray-50); }
        .category-header.primaria { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; }
        .category-header.secundaria { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; }
        .category-header.terciaria { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; }
        .category-header.proximidade { background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); color: white; }
        .category-title {
            display: flex; align-items: center; gap: 15px; font-size: 1.3rem; font-weight: 700;
        }
        .category-count {
            background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; font-weight: 700;
        }
        .category-icon { font-size: 1.8rem; }
        .toggle-icon { font-size: 1.5rem; transition: transform 0.3s ease; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .category-content {
            max-height: 5000px; overflow: hidden; transition: max-height 0.4s ease;
        }
        .category-content.collapsed { max-height: 0; }
        .units-grid {
            padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .unit-card {
            background: var(--gray-50); padding: 20px; border-radius: 12px;
            border-left: 4px solid; transition: all 0.3s ease;
        }
        .unit-card.primaria { border-color: var(--success); }
        .unit-card.secundaria { border-color: var(--warning); }
        .unit-card.terciaria { border-color: var(--danger); }
        .unit-card.proximidade { border-color: #7c3aed; }
        .unit-card:hover {
            transform: translateX(5px); box-shadow: var(--shadow-md); background: white;
        }
        .unit-name { font-weight: 700; font-size: 1.1rem; color: var(--gray-700); margin-bottom: 12px; }
        .unit-info { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .info-row { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--gray-600); }
        .info-row.distance { 
            color: #7c3aed; font-weight: 700; font-size: 15px;
            background: rgba(124, 58, 237, 0.1); padding: 6px 10px; border-radius: 6px;
        }
        .info-icon { width: 20px; text-align: center; }
        .badge {
            display: inline-block; padding: 4px 12px; border-radius: 12px;
            font-size: 12px; font-weight: 700; color: white;
        }
        .badge.primaria { background: var(--success); }
        .badge.secundaria { background: var(--warning); }
        .badge.terciaria { background: var(--danger); }
        .badge.sus { background: #059669; }
        .unit-actions {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .unit-link {
            display: inline-flex; align-items: center; gap: 6px; color: var(--primary);
            text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.3s ease;
            padding: 8px 12px; background: rgba(30, 64, 175, 0.1); border-radius: 8px;
        }
        .unit-link:hover { color: var(--primary-light); background: rgba(30, 64, 175, 0.2); }
        .unit-link.maps { color: #7c3aed; background: rgba(124, 58, 237, 0.1); }
        .unit-link.maps:hover { background: rgba(124, 58, 237, 0.2); }
        .empty-state {
            background: white; padding: 60px; border-radius: 16px;
            box-shadow: var(--shadow-md); text-align: center;
        }
        .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }
        .empty-state h3 { font-size: 1.5rem; color: var(--gray-700); margin-bottom: 10px; }
        .empty-state p { color: var(--gray-600); }
        /* Modal de Permiss√£o de Localiza√ß√£o (novo) */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white; margin: 10% auto; padding: 30px;
            border-radius: 16px; width: 90%; max-width: 450px;
            box-shadow: var(--shadow-lg); text-align: center;
        }
        .modal-content h3 {
            font-size: 1.5rem; color: var(--gray-700); margin-bottom: 15px;
        }
        .modal-content p {
            color: var(--gray-600); margin-bottom: 25px; line-height: 1.5;
        }
        .modal-actions {
            display: flex; gap: 15px; justify-content: center;
        }
        .modal-actions button {
            padding: 12px 24px; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            font-size: 1rem;
        }
        .btn-permit {
            background: var(--success); color: white;
        }
        .btn-permit:hover {
            background: #047857; transform: translateY(-2px);
        }
        .btn-cancel {
            background: var(--gray-200); color: var(--gray-700);
        }
        .btn-cancel:hover {
            background: var(--gray-300); transform: translateY(-2px);
        }
        .close-modal {
            float: right; font-size: 1.8rem; cursor: pointer; color: var(--gray-600);
        }
        .close-modal:hover { color: var(--danger); }
        /* Modal de Busca Google (removido) ‚Äì n√£o ser√° mais utilizado */
        @media (max-width: 768px) {
            .hero-header { padding: 30px 20px; }
            .hero-header h1 { font-size: 1.8rem; }
            .hero-header p { font-size: 1rem; }
            .btn-group { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .stat-value { font-size: 2rem; }
            .filter-grid { grid-template-columns: 1fr; }
            .units-grid { grid-template-columns: 1fr; }
            .category-title { font-size: 1.1rem; }
            .filter-section { padding: 20px; }
            .modal-content { width: 95%; margin: 20% auto; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease; }
        .geo-warning {
            background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px;
            border-radius: 8px; margin: 15px 0; font-size: 14px; color: #92400e;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Hero Header -->
    <div class="hero-header fade-in">
        <div class="hero-content">
            <div class="sus-badge">üè• Sistema √önico de Sa√∫de - SUS</div>
            <h1>Unidades de Sa√∫de P√∫blica do Rio de Janeiro</h1>
            <p>Encontre unidades p√∫blicas e conveniadas ao SUS em todo o estado - Base de dados atualizada 2026</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="abrirModalMunicipios()">üîÑ Buscar Todas as Unidades</button>
                <button class="btn btn-location" onclick="buscarProximas()">üìç Buscar Perto de Mim</button>
                <button class="btn btn-success" id="btnExcel" onclick="baixarExcel()" style="display: none;">üìä Exportar para Excel</button>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader-section" id="loaderSection">
        <div class="loader-content">
            <span class="loader-text" id="loaderText">Iniciando coleta de dados...</span>
            <span class="loader-percent" id="loaderPercent">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="loader-details" id="loaderDetails">Preparando busca em unidades do SUS...</div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card total fade-in"><div class="stat-label">üìã Total de Unidades SUS</div><div class="stat-value" id="statTotal">0</div></div>
        <div class="stat-card primaria fade-in"><div class="stat-label">üè• Aten√ß√£o Prim√°ria</div><div class="stat-value" id="statPrimaria">0</div></div>
        <div class="stat-card secundaria fade-in"><div class="stat-label">üè• Aten√ß√£o Secund√°ria</div><div class="stat-value" id="statSecundaria">0</div></div>
        <div class="stat-card terciaria fade-in"><div class="stat-label">üè• Aten√ß√£o Terci√°ria</div><div class="stat-value" id="statTerciaria">0</div></div>
    </div>

    <!-- Filtros Avan√ßados -->
    <div class="filter-section fade-in">
        <div class="filter-header">
            <h2>üîç Filtros de Pesquisa</h2>
            <button class="btn-clear" onclick="limparFiltros()">üóëÔ∏è Limpar Filtros</button>
        </div>
        <div class="filter-grid">
            <div class="filter-group">
                <label for="filterNome">Nome da Unidade</label>
                <input type="text" id="filterNome" class="filter-input" placeholder="Digite o nome..." oninput="aplicarFiltros()">
            </div>
            <div class="filter-group">
                <label for="filterCidade">Cidade</label>
                <select id="filterCidade" class="filter-select" onchange="aplicarFiltros()"><option value="">Todas as cidades</option></select>
            </div>
            <div class="filter-group">
                <label for="filterBairro">Bairro</label>
                <select id="filterBairro" class="filter-select" onchange="aplicarFiltros()"><option value="">Todos os bairros</option></select>
            </div>
            <div class="filter-group">
                <label for="filterNivel">N√≠vel de Aten√ß√£o</label>
                <select id="filterNivel" class="filter-select" onchange="aplicarFiltros()">
                    <option value="">Todos os n√≠veis</option>
                    <option value="Prim√°ria">Aten√ß√£o Prim√°ria</option>
                    <option value="Secund√°ria">Aten√ß√£o Secund√°ria</option>
                    <option value="Terci√°ria">Aten√ß√£o Terci√°ria</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Resultados por Categoria -->
    <div class="results-section" id="resultsSection">
        <div class="empty-state">
            <div class="empty-state-icon">üìç</div>
            <h3>Nenhum dado carregado</h3>
            <p>Use "Buscar Todas as Unidades" para ver o banco completo ou "Buscar Perto de Mim" para encontrar unidades pr√≥ximas √† sua localiza√ß√£o</p>
        </div>
    </div>

    <!-- Modal de Permiss√£o de Localiza√ß√£o (NOVO) -->
    <div id="locationPermissionModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="fecharModalPermissao()">&times;</span>
            <h3>üìç Acesso √† Localiza√ß√£o</h3>
            <p>Para encontrar unidades de sa√∫de pr√≥ximas a voc√™, precisamos da sua localiza√ß√£o. Seu dispositivo solicitar√° permiss√£o em seguida.</p>
            <div class="modal-actions">
                <button class="btn-permit" onclick="solicitarLocalizacao()">Permitir</button>
                <button class="btn-cancel" onclick="fecharModalPermissao()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Novo Modal para Sele√ß√£o de Munic√≠pio -->
    <div id="municipioModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="fecharModalMunicipios()">&times;</span>
            <h3>üèôÔ∏è Selecione o Munic√≠pio</h3>
            <p>Escolha o munic√≠pio para buscar as unidades de sa√∫de dispon√≠veis:</p>
            <select id="selectMunicipio" class="filter-select">
                <option value="">Todos os munic√≠pios</option>
            </select>
            <div class="modal-actions">
                <button class="btn-permit" onclick="carregarDadosPorMunicipio()">Buscar</button>
                <button class="btn-cancel" onclick="fecharModalMunicipios()">Cancelar</button>
            </div>
        </div>
    </div>

</div>

<script>
    // ============================================================
    // SISTEMA DE SA√öDE P√öBLICA DO RIO DE JANEIRO - SUS
    // ============================================================
    // ‚úÖ Foco em unidades SUS (p√∫blicas e conveniadas)
    // ‚úÖ Busca por proximidade com geolocaliza√ß√£o (modal de permiss√£o funcional)
    // ‚úÖ Links abrem em nova aba (sem modal problem√°tico)
    // ‚úÖ Integra√ß√£o com API oficial CNES/DATASUS
    // ‚úÖ Modal para sele√ß√£o de munic√≠pio ao buscar todas as unidades
    // ‚úÖ Barra de progresso mais din√¢mica
    // ============================================================

    let dadosCompletos = [];
    let dadosFiltrados = [];
    let unidadesProximas = [];
    let localizacaoUsuario = null;
    const categoriaState = { 'Prim√°ria': true, 'Secund√°ria': true, 'Terci√°ria': true, 'Proximidade': true };

    const CNES_ENDPOINT = 'https://servicos.saude.gov.br/cnes/EstabelecimentoSaudeService/v1r0';
    const CNES_USERNAME = 'CNES.PUBLICO';
    const CNES_PASSWORD = 'cnes#2015public';

    const municipiosRJ = [
        { "codigo_ibge": "3300159", "nome": "Aperib√©", "latitude": "-21.6252", "longitude": "-42.1017" },
        { "codigo_ibge": "3300209", "nome": "Araruama", "latitude": "-22.8697", "longitude": "-42.3326" },
        { "codigo_ibge": "3300308", "nome": "Angra dos Reis", "latitude": "-23.0011", "longitude": "-44.3196" },
        { "codigo_ibge": "3300407", "nome": "Barra Mansa", "latitude": "-22.5481", "longitude": "-44.1752" },
        { "codigo_ibge": "3300456", "nome": "Belford Roxo", "latitude": "-22.764", "longitude": "-43.3992" },
        { "codigo_ibge": "3300506", "nome": "Bom Jardim", "latitude": "-22.1545", "longitude": "-42.4251" },
        { "codigo_ibge": "3300605", "nome": "Bom Jesus do Itabapoana", "latitude": "-21.1449", "longitude": "-41.6822" },
        { "codigo_ibge": "3300704", "nome": "Cabo Frio", "latitude": "-22.8894", "longitude": "-42.0286" },
        { "codigo_ibge": "3300803", "nome": "Cachoeiras de Macacu", "latitude": "-22.4658", "longitude": "-42.6523" },
        { "codigo_ibge": "3300902", "nome": "Cambuci", "latitude": "-21.5691", "longitude": "-41.9187" },
        { "codigo_ibge": "3301009", "nome": "Campos dos Goytacazes", "latitude": "-21.7622", "longitude": "-41.3181" },
        { "codigo_ibge": "3301108", "nome": "Cantagalo", "latitude": "-21.9797", "longitude": "-42.3664" },
        { "codigo_ibge": "3301207", "nome": "Carmo", "latitude": "-21.931", "longitude": "-42.6046" },
        { "codigo_ibge": "3301306", "nome": "Casimiro de Abreu", "latitude": "-22.4812", "longitude": "-42.2066" },
        { "codigo_ibge": "3301405", "nome": "Concei√ß√£o de Macabu", "latitude": "-22.0834", "longitude": "-41.8719" },
        { "codigo_ibge": "3301504", "nome": "Cordeiro", "latitude": "-22.0267", "longitude": "-42.3648" },
        { "codigo_ibge": "3301603", "nome": "Duque de Caxias", "latitude": "-22.7858", "longitude": "-43.3049" },
        { "codigo_ibge": "3301702", "nome": "Iguaba Grande", "latitude": "-22.6736", "longitude": "-42.6011" },
        { "codigo_ibge": "3301801", "nome": "Itabora√≠", "latitude": "-22.7606", "longitude": "-42.8456" },
        { "codigo_ibge": "3301900", "nome": "Macuco", "latitude": "-21.9813", "longitude": "-42.2533" },
        { "codigo_ibge": "3302007", "nome": "Itagua√≠", "latitude": "-22.8636", "longitude": "-43.7798" },
        { "codigo_ibge": "3302056", "nome": "Italva", "latitude": "-21.4296", "longitude": "-41.7014" },
        { "codigo_ibge": "3302106", "nome": "Itaocara", "latitude": "-21.6748", "longitude": "-42.0758" },
        { "codigo_ibge": "3302205", "nome": "Itaperuna", "latitude": "-21.1997", "longitude": "-41.8799" },
        { "codigo_ibge": "3302254", "nome": "Itatiaia", "latitude": "-22.4897", "longitude": "-44.5675" },
        { "codigo_ibge": "3302270", "nome": "Japeri", "latitude": "-22.6435", "longitude": "-43.6602" },
        { "codigo_ibge": "3302304", "nome": "Laje do Muria√©", "latitude": "-21.2091", "longitude": "-42.1271" },
        { "codigo_ibge": "3302403", "nome": "Maca√©", "latitude": "-22.3768", "longitude": "-41.7848" },
        { "codigo_ibge": "3302452", "nome": "Mag√©", "latitude": "-22.6632", "longitude": "-43.0315" },
        { "codigo_ibge": "3302502", "nome": "Mangaratiba", "latitude": "-22.9594", "longitude": "-44.0409" },
        { "codigo_ibge": "3302601", "nome": "Para√≠ba do Sul", "latitude": "-22.1585", "longitude": "-43.304" },
        { "codigo_ibge": "3302700", "nome": "Paty do Alferes", "latitude": "-22.4309", "longitude": "-43.4285" },
        { "codigo_ibge": "3302809", "nome": "Petr√≥polis", "latitude": "-22.520", "longitude": "-43.1926" },
        { "codigo_ibge": "3302908", "nome": "Pinheiral", "latitude": "-22.5172", "longitude": "-44.0022" },
        { "codigo_ibge": "3303005", "nome": "Pira√≠", "latitude": "-22.6215", "longitude": "-43.9081" },
        { "codigo_ibge": "3303104", "nome": "Queimados", "latitude": "-22.7103", "longitude": "-43.5613" },
        { "codigo_ibge": "3303203", "nome": "Quatis", "latitude": "-22.3236", "longitude": "-44.2003" },
        { "codigo_ibge": "3303302", "nome": "Nil√≥polis", "latitude": "-22.8057", "longitude": "-43.4233" },
        { "codigo_ibge": "3303401", "nome": "Nova Friburgo", "latitude": "-22.2932", "longitude": "-42.5377" },
        { "codigo_ibge": "3303500", "nome": "Nova Igua√ßu", "latitude": "-22.7556", "longitude": "-43.4603" },
        { "codigo_ibge": "3303609", "nome": "Paracambi", "latitude": "-22.6078", "longitude": "-43.7108" },
        { "codigo_ibge": "3303708", "nome": "Paraty", "latitude": "-23.2221", "longitude": "-44.7175" },
        { "codigo_ibge": "3303856", "nome": "Porci√∫ncula", "latitude": "-20.9632", "longitude": "-42.0465" },
        { "codigo_ibge": "3303955", "nome": "Rio das Ostras", "latitude": "-22.5174", "longitude": "-41.9475" },
        { "codigo_ibge": "3304003", "nome": "Rio de Janeiro", "latitude": "-22.9129", "longitude": "-43.2003" },
        { "codigo_ibge": "3304102", "nome": "Santa Maria Madalena", "latitude": "-22.3667", "longitude": "-42.3667" },
        { "codigo_ibge": "3304201", "nome": "S√£o Gon√ßalo", "latitude": "-22.8268", "longitude": "-43.0634" },
        { "codigo_ibge": "3304300", "nome": "S√£o Jo√£o da Barra", "latitude": "-21.6361", "longitude": "-41.0511" },
        { "codigo_ibge": "3304409", "nome": "S√£o Jo√£o de Meriti", "latitude": "-22.8058", "longitude": "-43.3729" },
        { "codigo_ibge": "3304508", "nome": "S√£o Jos√© de Ub√°", "latitude": "-21.4333", "longitude": "-42.9167" },
        { "codigo_ibge": "3304607", "nome": "S√£o Jos√© do Vale do Rio Preto", "latitude": "-22.3667", "longitude": "-42.3667" },
        { "codigo_ibge": "3304706", "nome": "S√£o Pedro da Aldeia", "latitude": "-22.8429", "longitude": "-42.1026" },
        { "codigo_ibge": "3304805", "nome": "S√£o Sebasti√£o do Alto", "latitude": "-21.9578", "longitude": "-42.1328" },
        { "codigo_ibge": "3304904", "nome": "Sapucaia", "latitude": "-21.9949", "longitude": "-42.9142" },
        { "codigo_ibge": "3305000", "nome": "Saquarema", "latitude": "-22.9292", "longitude": "-42.5099" },
        { "codigo_ibge": "3305109", "nome": "Silva Jardim", "latitude": "-22.6574", "longitude": "-42.3961" },
        { "codigo_ibge": "3305208", "nome": "Sumidouro", "latitude": "-22.0485", "longitude": "-42.6761" },
        { "codigo_ibge": "3305307", "nome": "Teres√≥polis", "latitude": "-22.4165", "longitude": "-42.9752" },
        { "codigo_ibge": "3305406", "nome": "Trajano de Moraes", "latitude": "-22.0638", "longitude": "-42.0643" },
        { "codigo_ibge": "3305505", "nome": "Tr√™s Rios", "latitude": "-22.1165", "longitude": "-43.2185" },
        { "codigo_ibge": "3305604", "nome": "Valen√ßa", "latitude": "-22.2445", "longitude": "-43.7129" },
        { "codigo_ibge": "3305703", "nome": "Vassouras", "latitude": "-22.4059", "longitude": "-43.6686" },
        { "codigo_ibge": "3305802", "nome": "Volta Redonda", "latitude": "-22.5202", "longitude": "-44.0996" },
        { "codigo_ibge": "3305901", "nome": "Rio das Flores", "latitude": "-22.1692", "longitude": "-43.5856" },
        { "codigo_ibge": "3306008", "nome": "Rio Claro", "latitude": "-22.720", "longitude": "-44.1419" },
        { "codigo_ibge": "3300100", "nome": "Areal", "latitude": "-22.2283", "longitude": "-43.1056" },
        { "codigo_ibge": "3300225", "nome": "Arma√ß√£o dos B√∫zios", "latitude": "-22.7528", "longitude": "-41.8846" },
        { "codigo_ibge": "3300233", "nome": "Arraial do Cabo", "latitude": "-22.9774", "longitude": "-42.0267" },
        { "codigo_ibge": "3300258", "nome": "Barra do Pira√≠", "latitude": "-22.4715", "longitude": "-43.8269" },
        { "codigo_ibge": "3300357", "nome": "Aperib√©", "latitude": "-21.6252", "longitude": "-42.1017" },
        { "codigo_ibge": "3300407", "nome": "Barra Mansa", "latitude": "-22.5481", "longitude": "-44.1752" },
        { "codigo_ibge": "3300456", "nome": "Belford Roxo", "latitude": "-22.764", "longitude": "-43.3992" },
        { "codigo_ibge": "3300506", "nome": "Bom Jardim", "latitude": "-22.1545", "longitude": "-42.4251" },
        { "codigo_ibge": "3300605", "nome": "Bom Jesus do Itabapoana", "latitude": "-21.1449", "longitude": "-41.6822" },
        { "codigo_ibge": "3300704", "nome": "Cabo Frio", "latitude": "-22.8894", "longitude": "-42.0286" },
        { "codigo_ibge": "3300803", "nome": "Cachoeiras de Macacu", "latitude": "-22.4658", "longitude": "-42.6523" },
        { "codigo_ibge": "3300902", "nome": "Cambuci", "latitude": "-21.5691", "longitude": "-41.9187" },
        { "codigo_ibge": "3300936", "nome": "Carapebus", "latitude": "-22.1821", "longitude": "-41.663" },
        { "codigo_ibge": "3300951", "nome": "Comendador Levy Gasparian", "latitude": "-22.0284", "longitude": "-43.309" },
        { "codigo_ibge": "3301009", "nome": "Campos dos Goytacazes", "latitude": "-21.7622", "longitude": "-41.3181" },
        { "codigo_ibge": "3301108", "nome": "Cantagalo", "latitude": "-21.9797", "longitude": "-42.3664" },
        { "codigo_ibge": "3301157", "nome": "Cardoso Moreira", "latitude": "-21.4848", "longitude": "-41.6157" },
        { "codigo_ibge": "3301207", "nome": "Carmo", "latitude": "-21.931", "longitude": "-42.6046" },
        { "codigo_ibge": "3301306", "nome": "Casimiro de Abreu", "latitude": "-22.4812", "longitude": "-42.2066" },
        { "codigo_ibge": "3301405", "nome": "Concei√ß√£o de Macabu", "latitude": "-22.0834", "longitude": "-41.8719" },
        { "codigo_ibge": "3301504", "nome": "Cordeiro", "latitude": "-22.0267", "longitude": "-42.3648" },
        { "codigo_ibge": "3301603", "nome": "Duque de Caxias", "latitude": "-22.7858", "longitude": "-43.3049" },
        { "codigo_ibge": "3301702", "nome": "Engenheiro Paulo de Frontin", "latitude": "-22.5495", "longitude": "-43.6827" },
        { "codigo_ibge": "3301801", "nome": "Guapimirim", "latitude": "-22.5342", "longitude": "-42.9895" },
        { "codigo_ibge": "3301850", "nome": "Iguaba Grande", "latitude": "-22.8492", "longitude": "-42.2289" },
        { "codigo_ibge": "3301876", "nome": "Itabora√≠", "latitude": "-22.7474", "longitude": "-42.8589" },
        { "codigo_ibge": "3301900", "nome": "Itagua√≠", "latitude": "-22.8636", "longitude": "-43.7798" },
        { "codigo_ibge": "3302007", "nome": "Italva", "latitude": "-21.4296", "longitude": "-41.7014" },
        { "codigo_ibge": "3302056", "nome": "Itaocara", "latitude": "-21.6748", "longitude": "-42.0758" },
        { "codigo_ibge": "3302106", "nome": "Itaperuna", "latitude": "-21.1997", "longitude": "-41.8799" },
        { "codigo_ibge": "3302205", "nome": "Itatiaia", "latitude": "-22.4897", "longitude": "-44.5675" },
        { "codigo_ibge": "3302254", "nome": "Japeri", "latitude": "-22.6435", "longitude": "-43.6602" },
        { "codigo_ibge": "3302270", "nome": "Laje do Muria√©", "latitude": "-21.2091", "longitude": "-42.1271" },
        { "codigo_ibge": "3302304", "nome": "Maca√©", "latitude": "-22.3768", "longitude": "-41.7848" },
        { "codigo_ibge": "3302403", "nome": "Macuco", "latitude": "-21.9813", "longitude": "-42.2533" },
        { "codigo_ibge": "3302452", "nome": "Mag√©", "latitude": "-22.6632", "longitude": "-43.0315" },
        { "codigo_ibge": "3302502", "nome": "Mangaratiba", "latitude": "-22.9594", "longitude": "-44.0409" },
        { "codigo_ibge": "3302601", "nome": "Maric√°", "latitude": "-22.9354", "longitude": "-42.8185" },
        { "codigo_ibge": "3302700", "nome": "Mendes", "latitude": "-22.5246", "longitude": "-43.7312" },
        { "codigo_ibge": "3302809", "nome": "Mesquita", "latitude": "-22.8028", "longitude": "-43.429" },
        { "codigo_ibge": "3302858", "nome": "Miguel Pereira", "latitude": "-22.4571", "longitude": "-43.4803" },
        { "codigo_ibge": "3302908", "nome": "Miracema", "latitude": "-21.4148", "longitude": "-42.1936" },
        { "codigo_ibge": "3303005", "nome": "Natividade", "latitude": "-21.039", "longitude": "-41.9819" },
        { "codigo_ibge": "3303104", "nome": "Nil√≥polis", "latitude": "-22.8057", "longitude": "-43.4233" },
        { "codigo_ibge": "3303203", "nome": "Niter√≥i", "latitude": "-22.8832", "longitude": "-43.1238" },
        { "codigo_ibge": "3303302", "nome": "Nova Friburgo", "latitude": "-22.2932", "longitude": "-42.5377" },
        { "codigo_ibge": "3303401", "nome": "Nova Igua√ßu", "latitude": "-22.7556", "longitude": "-43.4603" },
        { "codigo_ibge": "3303500", "nome": "Paracambi", "latitude": "-22.6078", "longitude": "-43.7108" },
        { "codigo_ibge": "3303609", "nome": "Para√≠ba do Sul", "latitude": "-22.1585", "longitude": "-43.304" },
        { "codigo_ibge": "3303708", "nome": "Paraty", "latitude": "-23.2221", "longitude": "-44.7175" },
        { "codigo_ibge": "3303807", "nome": "Paty do Alferes", "latitude": "-22.4309", "longitude": "-43.4285" },
        { "codigo_ibge": "3303856", "nome": "Petr√≥polis", "latitude": "-22.520", "longitude": "-43.1926" },
        { "codigo_ibge": "3303906", "nome": "Pinheiral", "latitude": "-22.5172", "longitude": "-44.0022" },
        { "codigo_ibge": "3303955", "nome": "Pira√≠", "latitude": "-22.6215", "longitude": "-43.9081" },
        { "codigo_ibge": "3304003", "nome": "Porci√∫ncula", "latitude": "-20.9632", "longitude": "-42.0465" },
        { "codigo_ibge": "3304102", "nome": "Porto Real", "latitude": "-22.4175", "longitude": "-44.2952" },
        { "codigo_ibge": "3304110", "nome": "Quatis", "latitude": "-22.4064", "longitude": "-44.264" },
        { "codigo_ibge": "3304128", "nome": "Queimados", "latitude": "-22.7103", "longitude": "-43.5613" },
        { "codigo_ibge": "3304144", "nome": "Quissam√£", "latitude": "-22.1031", "longitude": "-41.4724" },
        { "codigo_ibge": "3304151", "nome": "Resende", "latitude": "-22.4705", "longitude": "-44.4509" },
        { "codigo_ibge": "3304201", "nome": "Rio Bonito", "latitude": "-22.7085", "longitude": "-42.6099" },
        { "codigo_ibge": "3304300", "nome": "Rio Claro", "latitude": "-22.720", "longitude": "-44.1419" },
        { "codigo_ibge": "3304409", "nome": "Rio das Flores", "latitude": "-22.1692", "longitude": "-43.5856" },
        { "codigo_ibge": "3304508", "nome": "Rio das Ostras", "latitude": "-22.5174", "longitude": "-41.9475" },
        { "codigo_ibge": "3304524", "nome": "Rio de Janeiro", "latitude": "-22.9129", "longitude": "-43.2003" },
        { "codigo_ibge": "3304557", "nome": "Santa Maria Madalena", "latitude": "-21.9549", "longitude": "-42.0097" },
        { "codigo_ibge": "3304607", "nome": "Santo Ant√¥nio de P√°dua", "latitude": "-21.5394", "longitude": "-42.1802" },
        { "codigo_ibge": "3304706", "nome": "S√£o Fid√©lis", "latitude": "-21.6461", "longitude": "-41.7469" },
        { "codigo_ibge": "3304805", "nome": "S√£o Francisco de Itabapoana", "latitude": "-21.4702", "longitude": "-41.1191" },
        { "codigo_ibge": "3304904", "nome": "S√£o Gon√ßalo", "latitude": "-22.8268", "longitude": "-43.0634" },
        { "codigo_ibge": "3305000", "nome": "S√£o Jo√£o da Barra", "latitude": "-21.6361", "longitude": "-41.0511" },
        { "codigo_ibge": "3305109", "nome": "S√£o Jo√£o de Meriti", "latitude": "-22.8058", "longitude": "-43.3729" },
        { "codigo_ibge": "3305133", "nome": "S√£o Jos√© de Ub√°", "latitude": "-21.3663", "longitude": "-41.9441" },
        { "codigo_ibge": "3305158", "nome": "S√£o Jos√© do Vale do Rio Preto", "latitude": "-22.1516", "longitude": "-42.9244" },
        { "codigo_ibge": "3305208", "nome": "S√£o Pedro da Aldeia", "latitude": "-22.8429", "longitude": "-42.1026" },
        { "codigo_ibge": "3305307", "nome": "S√£o Sebasti√£o do Alto", "latitude": "-21.9578", "longitude": "-42.1328" },
        { "codigo_ibge": "3305406", "nome": "Sapucaia", "latitude": "-21.9949", "longitude": "-42.9142" },
        { "codigo_ibge": "3305505", "nome": "Saquarema", "latitude": "-22.9292", "longitude": "-42.5099" },
        { "codigo_ibge": "3305554", "nome": "Serop√©dica", "latitude": "-22.7524", "longitude": "-43.7064" },
        { "codigo_ibge": "3305604", "nome": "Silva Jardim", "latitude": "-22.6574", "longitude": "-42.3961" },
        { "codigo_ibge": "3305703", "nome": "Sumidouro", "latitude": "-22.0485", "longitude": "-42.6761" },
        { "codigo_ibge": "3305752", "nome": "Tangu√°", "latitude": "-22.7334", "longitude": "-42.7202" },
        { "codigo_ibge": "3305802", "nome": "Teres√≥polis", "latitude": "-22.4165", "longitude": "-42.9752" },
        { "codigo_ibge": "3305901", "nome": "Trajano de Moraes", "latitude": "-22.0638", "longitude": "-42.0643" },
        { "codigo_ibge": "3306008", "nome": "Tr√™s Rios", "latitude": "-22.1165", "longitude": "-43.2185" },
        { "codigo_ibge": "3306107", "nome": "Valen√ßa", "latitude": "-22.2445", "longitude": "-43.7129" },
        { "codigo_ibge": "3306156", "nome": "Varre-Sai", "latitude": "-20.9315", "longitude": "-41.8701" },
        { "codigo_ibge": "3306206", "nome": "Vassouras", "latitude": "-22.4059", "longitude": "-43.6686" },
        { "codigo_ibge": "3306305", "nome": "Volta Redonda", "latitude": "-22.5202", "longitude": "-44.0996" }
    ];

    // ---------- MODAIS ----------
    function abrirModalPermissao() {
        document.getElementById('locationPermissionModal').style.display = 'block';
    }
    function fecharModalPermissao() {
        document.getElementById('locationPermissionModal').style.display = 'none';
    }
    function abrirModalMunicipios() {
        const select = document.getElementById('selectMunicipio');
        select.innerHTML = '<option value="">Todos os munic√≠pios</option>';
        municipiosRJ.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(m => {
            select.innerHTML += `<option value="${m.codigo_ibge}">${m.nome}</option>`;
        });
        document.getElementById('municipioModal').style.display = 'block';
    }
    function fecharModalMunicipios() {
        document.getElementById('municipioModal').style.display = 'none';
    }
    window.onclick = function(event) {
        const modalPerm = document.getElementById('locationPermissionModal');
        const modalMun = document.getElementById('municipioModal');
        if (event.target == modalPerm) fecharModalPermissao();
        if (event.target == modalMun) fecharModalMunicipios();
    };

    // ---------- BUSCA POR PROXIMIDADE ----------
    function buscarProximas() {
        abrirModalPermissao();
    }

    function solicitarLocalizacao() {
        fecharModalPermissao(); // Fecha o modal

        if (!navigator.geolocation) {
            alert('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o');
            return;
        }

        // Exibe loader imediatamente
        document.getElementById('loaderSection').style.display = 'block';
        document.getElementById('loaderText').innerText = 'Obtendo sua localiza√ß√£o...';
        document.getElementById('loaderPercent').innerText = '10%';
        document.getElementById('progressFill').style.width = '10%';
        document.getElementById('loaderDetails').innerText = 'Solicitando acesso √† geolocaliza√ß√£o...';

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                localizacaoUsuario = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };

                document.getElementById('loaderText').innerText = 'Buscando unidades pr√≥ximas...';
                document.getElementById('loaderPercent').innerText = '40%';
                document.getElementById('progressFill').style.width = '40%';
                document.getElementById('loaderDetails').innerText = `Localiza√ß√£o: ${localizacaoUsuario.lat.toFixed(4)}, ${localizacaoUsuario.lon.toFixed(4)}`;

                await buscarUnidadesProximas();
            },
            (error) => {
                document.getElementById('loaderSection').style.display = 'none';
                let mensagem = 'Erro ao obter localiza√ß√£o';
                if (error.code === 1) mensagem = '‚ùå Permiss√£o de localiza√ß√£o negada. Por favor, permita o acesso √† localiza√ß√£o para usar esta funcionalidade.';
                else if (error.code === 2) mensagem = '‚ùå Localiza√ß√£o indispon√≠vel no momento.';
                else if (error.code === 3) mensagem = '‚ùå Tempo de busca esgotado.';
                alert(mensagem);
            }
        );
    }

    async function buscarUnidadesProximas() {
        const raio = 5000; // 5km
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);

        document.getElementById('loaderText').innerText = 'Consultando API CNES...';
        document.getElementById('loaderPercent').innerText = '60%';
        document.getElementById('progressFill').style.width = '60%';

        const data = await consultarCNES('', controller); // Fetch para todo RJ para proximidade
        clearTimeout(timeoutId);

        unidadesProximas = [];
        if (data && data.length > 0) {
            document.getElementById('loaderText').innerText = 'Processando unidades pr√≥ximas...';
            document.getElementById('loaderPercent').innerText = '80%';
            document.getElementById('progressFill').style.width = '80%';

            data.forEach(unidade => {
                const dist = calcularDistancia(localizacaoUsuario.lat, localizacaoUsuario.lon, unidade.lat, unidade.lon);
                if (dist <= 5) {
                    unidade.distancia = dist;
                    unidadesProximas.push(unidade);
                }
            });

            unidadesProximas.sort((a, b) => a.distancia - b.distancia);
        } else {
            document.getElementById('loaderSection').style.display = 'none';
            document.getElementById('resultsSection').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <h3>Erro ao carregar dados</h3>
                    <p>N√£o foi poss√≠vel consultar a API em tempo real. Verifique sua conex√£o ou tente novamente.</p>
                    <button class="btn btn-primary" onclick="buscarProximas()">Tentar Novamente</button>
                </div>
            `;
            return;
        }

        finalizarBuscaProximidade();
    }

    // ---------- CONSULTA CNES OFICIAL ----------
    async function consultarCNES(codigoMunicipio = '', controller = null) {
        let municipioXML = '';
        if (codigoMunicipio) {
            municipioXML = `<cnes:codigoMunicipio>${codigoMunicipio}</cnes:codigoMunicipio>`;
        }

        const soapXML = `
            <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:cnes="http://servicos.saude.gov.br/cnes/v1r0/estabelecimentoservice" xmlns:mun="http://servicos.saude.gov.br/schema/corporativo/v1r2/municipio" xmlns:uf="http://servicos.saude.gov.br/schema/corporativo/v1r1/uf">
                <soap:Header>
                    <wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">
                        <wsse:UsernameToken>
                            <wsse:Username>${CNES_USERNAME}</wsse:Username>
                            <wsse:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText">${CNES_PASSWORD}</wsse:Password>
                        </wsse:UsernameToken>
                    </wsse:Security>
                </soap:Header>
                <soap:Body>
                    <cnes:requestConsultarEstabelecimentoSaude>
                        <uf:UF>
                            <uf:siglaUF>RJ</uf:siglaUF>
                        </uf:UF>
                        <mun:Municipio>
                            ${municipioXML}
                        </mun:Municipio>
                    </cnes:requestConsultarEstabelecimentoSaude>
                </soap:Body>
            </soap:Envelope>
        `;

        const maxRetries = 3;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(CNES_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/soap+xml; charset=utf-8'
                    },
                    body: soapXML,
                    signal: controller ? controller.signal : null
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");

                // Atualizar progresso
                document.getElementById('loaderPercent').innerText = `${30 + attempt * 10}%`;
                document.getElementById('progressFill').style.width = `${30 + attempt * 10}%`;

                const unidades = [];
                const estabelecimentos = xmlDoc.getElementsByTagName("Estabelecimento");
                for (let est of estabelecimentos) {
                    const nome = est.getElementsByTagName("nomeFantasia")[0]?.textContent || est.getElementsByTagName("nomeEmpresarial")[0]?.textContent || 'N√£o informado';
                    const cidadeNode = est.getElementsByTagName("Municipio")[0];
                    const cidade = cidadeNode ? cidadeNode.getElementsByTagName("nomeMunicipio")[0]?.textContent || 'Rio de Janeiro' : 'Rio de Janeiro';
                    const bairro = est.getElementsByTagName("bairro")[0]?.textContent || 'N√£o informado';
                    const endereco = (est.getElementsByTagName("tipoLogradouro")[0]?.textContent || '') + ' ' + (est.getElementsByTagName("logradouro")[0]?.textContent || '') + ', ' + (est.getElementsByTagName("numero")[0]?.textContent || '');
                    const telefone = est.getElementsByTagName("numeroTelefone")[0]?.textContent || '';
                    const lat = parseFloat(est.getElementsByTagName("latitude")[0]?.textContent) || null;
                    const lon = parseFloat(est.getElementsByTagName("longitude")[0]?.textContent) || null;
                    const tipoEstabelecimentoNode = est.getElementsByTagName("tipoEstabelecimento")[0];
                    const tipo = tipoEstabelecimentoNode ? tipoEstabelecimentoNode.getElementsByTagName("descricaoTipoEstabelecimento")[0]?.textContent || 'Geral' : 'Geral';

                    let nivel = 'Prim√°ria';
                    if (tipo.toUpperCase().includes('HOSPITAL')) nivel = 'Terci√°ria';
                    else if (tipo.toUpperCase().includes('UPA') || tipo.toUpperCase().includes('POLICL√çNICA') || tipo.toUpperCase().includes('CAPS') || tipo.toUpperCase().includes('EMERG√äNCIA')) nivel = 'Secund√°ria';

                    let perfil = 'Geral';
                    if (tipo.toUpperCase().includes('MATERNIDADE')) perfil = 'Maternidade';
                    else if (tipo.toUpperCase().includes('INFANTIL')) perfil = 'Infantil';
                    else if (tipo.toUpperCase().includes('CAPS')) perfil = 'Sa√∫de Mental';
                    else if (tipo.toUpperCase().includes('CEO') || tipo.toUpperCase().includes('ODONTOL√ìGICO')) perfil = 'Odontol√≥gico';

                    unidades.push({
                        nome,
                        cidade,
                        bairro,
                        perfil,
                        nivel,
                        lat,
                        lon,
                        website: '',
                        telefone,
                        endereco,
                        link: `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.html?coUnidade=${est.getElementsByTagName("codigoCNES")[0]?.textContent || ''}`,
                        mapsLink: lat && lon ? `https://www.google.com/maps?q=${lat},${lon}` : ''
                    });
                }
                return unidades;
            } catch (e) {
                console.warn(`Tentativa ${attempt} falhou:`, e);
                if (attempt < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 2000 * attempt)); // Backoff
                }
            }
        }
        return [];
    }

    // ---------- CARREGAMENTO COMPLETO ----------
    async function carregarDadosPorMunicipio() {
        fecharModalMunicipios();
        const codigoMunicipio = document.getElementById('selectMunicipio').value;

        document.getElementById('loaderSection').style.display = 'block';
        document.getElementById('btnExcel').style.display = 'none';
        document.getElementById('resultsSection').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <h3>Carregando dados...</h3>
                <p>Buscando unidades SUS no munic√≠pio selecionado...</p>
            </div>
        `;

        dadosCompletos = [];
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000);

        document.getElementById('loaderText').innerText = 'Conectando √† API CNES...';
        document.getElementById('loaderPercent').innerText = '30%';
        document.getElementById('progressFill').style.width = '30%';

        dadosCompletos = await consultarCNES(codigoMunicipio, controller);
        clearTimeout(timeoutId);

        if (dadosCompletos.length === 0) {
            document.getElementById('loaderSection').style.display = 'none';
            document.getElementById('resultsSection').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <h3>Erro ao carregar dados</h3>
                    <p>N√£o foi poss√≠vel consultar a API em tempo real. Verifique sua conex√£o ou tente novamente.</p>
                    <button class="btn btn-primary" onclick="abrirModalMunicipios()">Tentar Novamente</button>
                </div>
            `;
            return;
        }

        document.getElementById('loaderText').innerText = 'Processando unidades...';
        document.getElementById('loaderPercent').innerText = '70%';
        document.getElementById('progressFill').style.width = '70%';

        finalizarCarregamento();
    }

    function finalizarCarregamento() {
        document.getElementById('loaderSection').style.display = 'none';
        document.getElementById('btnExcel').style.display = 'block';

        const mapa = new Map();
        dadosCompletos.forEach(u => {
            const chave = `${u.nome.toLowerCase()}_${u.cidade.toLowerCase()}_${u.bairro.toLowerCase()}`;
            if (!mapa.has(chave)) mapa.set(chave, u);
        });
        dadosCompletos = Array.from(mapa.values());
        dadosCompletos.sort((a,b) => a.nome.localeCompare(b.nome));

        dadosCompletos.forEach(u => {
            if (!u.link) u.link = `https://www.google.com/search?q=${encodeURIComponent(u.nome + ' ' + u.cidade + ' SUS')}`;
            if (!u.mapsLink && u.lat && u.lon) u.mapsLink = `https://www.google.com/maps?q=${u.lat},${u.lon}`;
        });

        atualizarEstatisticas();
        popularFiltros();
        aplicarFiltros();
    }

    function atualizarEstatisticas() {
        document.getElementById('statTotal').innerText = dadosCompletos.length;
        document.getElementById('statPrimaria').innerText = dadosCompletos.filter(u => u.nivel === 'Prim√°ria').length;
        document.getElementById('statSecundaria').innerText = dadosCompletos.filter(u => u.nivel === 'Secund√°ria').length;
        document.getElementById('statTerciaria').innerText = dadosCompletos.filter(u => u.nivel === 'Terci√°ria').length;
    }

    function popularFiltros() {
        const cidades = [...new Set(dadosCompletos.map(u => u.cidade))].sort();
        const selCid = document.getElementById('filterCidade');
        selCid.innerHTML = '<option value="">Todas as cidades</option>';
        cidades.forEach(c => selCid.innerHTML += `<option value="${c}">${c}</option>`);

        const bairros = [...new Set(dadosCompletos.map(u => u.bairro))].filter(b => b && b !== 'N√£o informado').sort();
        const selBai = document.getElementById('filterBairro');
        selBai.innerHTML = '<option value="">Todos os bairros</option>';
        bairros.forEach(b => selBai.innerHTML += `<option value="${b}">${b}</option>`);
    }

    function aplicarFiltros() {
        const fNome = document.getElementById('filterNome').value.toLowerCase();
        const fCid = document.getElementById('filterCidade').value;
        const fBai = document.getElementById('filterBairro').value;
        const fNiv = document.getElementById('filterNivel').value;

        dadosFiltrados = dadosCompletos.filter(u =>
            (!fNome || u.nome.toLowerCase().includes(fNome)) &&
            (!fCid || u.cidade === fCid) &&
            (!fBai || u.bairro === fBai) &&
            (!fNiv || u.nivel === fNiv)
        );
        renderizarResultados();
    }

    function limparFiltros() {
        document.getElementById('filterNome').value = '';
        document.getElementById('filterCidade').value = '';
        document.getElementById('filterBairro').value = '';
        document.getElementById('filterNivel').value = '';
        aplicarFiltros();
    }

    function renderizarResultados() {
        const results = document.getElementById('resultsSection');
        if (dadosFiltrados.length === 0) {
            results.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üîç</div><h3>Nenhuma unidade encontrada</h3><p>Tente ajustar os filtros de pesquisa</p></div>`;
            return;
        }

        const porNivel = {
            'Prim√°ria': dadosFiltrados.filter(u => u.nivel === 'Prim√°ria'),
            'Secund√°ria': dadosFiltrados.filter(u => u.nivel === 'Secund√°ria'),
            'Terci√°ria': dadosFiltrados.filter(u => u.nivel === 'Terci√°ria')
        };

        let html = '';
        Object.entries(porNivel).forEach(([nivel, unidades]) => {
            if (!unidades.length) return;
            const collapsed = !categoriaState[nivel];
            const classe = nivel.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            html += `<div class="category-card fade-in">
                <div class="category-header ${classe}" onclick="toggleCategoria('${nivel}')">
                    <div class="category-title">
                        <span class="category-icon">üè•</span>
                        <span>Aten√ß√£o ${nivel}</span>
                        <span class="category-count">${unidades.length}</span>
                    </div>
                    <span class="toggle-icon ${collapsed ? 'collapsed' : ''}">‚ñº</span>
                </div>
                <div class="category-content ${collapsed ? 'collapsed' : ''}" id="content-${nivel}">
                    <div class="units-grid">`;

            unidades.forEach(u => {
                html += `<div class="unit-card ${classe}">
                    <div class="unit-name">${u.nome}</div>
                    <div class="unit-info">
                        <div class="info-row"><span class="info-icon">üìç</span><span>${u.cidade} - ${u.bairro}</span></div>
                        ${u.endereco ? `<div class="info-row"><span class="info-icon">üè†</span><span>${u.endereco}</span></div>` : ''}
                        ${u.telefone ? `<div class="info-row"><span class="info-icon">üìû</span><span>${u.telefone}</span></div>` : ''}
                        <div class="info-row">
                            <span class="info-icon">üè∑Ô∏è</span>
                            <span class="badge ${classe}">${u.perfil}</span>
                            <span class="badge sus">SUS</span>
                        </div>
                    </div>
                    <div class="unit-actions">
                        ${u.mapsLink ? `<a href="${u.mapsLink}" target="_blank" class="unit-link maps">üó∫Ô∏è Ver no Mapa ‚Üí</a>` : ''}
                        <a href="${u.link}" target="_blank" class="unit-link">
                            ${u.website ? 'üåê Site' : 'üîç Buscar'} ‚Üí
                        </a>
                    </div>
                </div>`;
            });

            html += `</div></div></div>`;
        });

        results.innerHTML = html;

        document.getElementById('statTotal').innerText = dadosFiltrados.length;
        document.getElementById('statPrimaria').innerText = porNivel['Prim√°ria']?.length || 0;
        document.getElementById('statSecundaria').innerText = porNivel['Secund√°ria']?.length || 0;
        document.getElementById('statTerciaria').innerText = porNivel['Terci√°ria']?.length || 0;
    }

    function toggleCategoria(nivel) {
        categoriaState[nivel] = !categoriaState[nivel];
        const content = document.getElementById(`content-${nivel}`);
        const icon = content.previousElementSibling.querySelector('.toggle-icon');
        if (categoriaState[nivel]) {
            content.classList.remove('collapsed');
            icon.classList.remove('collapsed');
        } else {
            content.classList.add('collapsed');
            icon.classList.add('collapsed');
        }
    }

    function baixarExcel() {
        const exportar = dadosFiltrados.map(u => ({
            'Nome': u.nome,
            'Cidade': u.cidade,
            'Bairro': u.bairro,
            'Perfil': u.perfil,
            'N√≠vel': u.nivel,
            'Endere√ßo': u.endereco || 'N√£o informado',
            'Telefone': u.telefone || 'N√£o informado',
            'Website': u.website || 'N√£o informado',
            'Latitude': u.lat || '',
            'Longitude': u.lon || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportar);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Unidades SUS RJ");
        XLSX.writeFile(wb, `Unidades_SUS_RJ_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SaÃºdeBR â€” Localizador CNES de Unidades de SaÃºde PÃºblica</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --navy: #0B1F3A;
      --navy-mid: #132D50;
      --teal: #00A878;
      --teal-light: #00C896;
      --teal-pale: #E8F8F3;
      --amber: #F5A623;
      --amber-pale: #FFF8EC;
      --red: #E53935;
      --red-pale: #FDECEA;
      --blue: #1565C0;
      --blue-pale: #E8F0FE;
      --purple: #6A1B9A;
      --purple-pale: #F3E5F5;
      --bg: #EDF1F7;
      --surface: #FFFFFF;
      --border: #D8E2EE;
      --text: #0B1F3A;
      --text-muted: #5A6E85;
      --text-light: #8EA2B8;
      --shadow-sm: 0 2px 8px rgba(11,31,58,0.08);
      --shadow-md: 0 6px 20px rgba(11,31,58,0.12);
      --shadow-lg: 0 16px 48px rgba(11,31,58,0.16);
      --radius: 14px;
      --radius-sm: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€ */
    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, #1a4a7a 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-mark {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--teal), var(--teal-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,168,120,0.4);
    }
    .logo-mark svg { width: 28px; height: 28px; }
    .header-titles { flex: 1; }
    .header-titles h1 {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      color: #FFFFFF;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    .header-titles h1 span { color: var(--teal-light); }
    .header-titles p {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      font-weight: 300;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .header-badge {
      background: rgba(0,168,120,0.2);
      border: 1px solid rgba(0,168,120,0.4);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€ */
    .main-wrapper {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px 28px 60px;
    }

    /* â”€â”€â”€ FILTER PANEL â”€â”€â”€ */
    .filter-section {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .filter-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .filter-header:hover { background: var(--bg); }
    .filter-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .filter-header-icon {
      width: 36px; height: 36px;
      background: var(--teal-pale);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--teal);
    }
    .filter-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .filter-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    .filter-toggle-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .filter-toggle-btn:hover { background: var(--teal-pale); color: var(--teal); border-color: var(--teal); }
    .filter-toggle-arrow { transition: transform 0.3s; }
    .filter-toggle-arrow.open { transform: rotate(180deg); }

    .filter-body {
      border-top: 1px solid var(--border);
      padding: 24px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .filter-body.open { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--text);
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--teal);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0,168,120,0.1);
    }
    select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A6E85' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--radius-sm);
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-light) 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,168,120,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,168,120,0.4);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .btn-secondary:hover { background: #fff; border-color: var(--teal); color: var(--teal); }
    .btn-navy {
      background: var(--navy);
      color: #fff;
      box-shadow: 0 4px 12px rgba(11,31,58,0.25);
    }
    .btn-navy:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(11,31,58,0.35); }
    .btn-amber {
      background: linear-gradient(135deg, var(--amber) 0%, #F7BE50 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(245,166,35,0.35);
    }
    .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(245,166,35,0.45); }
    .btn-geo {
      background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21,101,192,0.3);
    }
    .btn-geo:hover { transform: translateY(-1px); }
    .btn-sm { padding: 7px 14px; font-size: 0.78rem; }
    .btn-icon { width: 34px; height: 34px; padding: 0; justify-content: center; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* â”€â”€â”€ GEO SECTION â”€â”€â”€ */
    .geo-section {
      background: linear-gradient(135deg, var(--blue-pale), #d8e8ff);
      border: 1px solid rgba(21,101,192,0.2);
      border-radius: var(--radius);
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .geo-info { flex: 1; }
    .geo-info h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--blue);
    }
    .geo-info p { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
    .geo-radius-row { display: flex; align-items: center; gap: 10px; }
    .geo-radius-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .geo-radius-input {
      width: 80px;
      background: #fff;
      border: 1.5px solid rgba(21,101,192,0.3);
      border-radius: 8px;
      padding: 7px 10px;
      font-family: 'Fira Sans', sans-serif;
      font-size: 0.88rem;
      text-align: center;
    }

    /* â”€â”€â”€ DASHBOARD CARDS â”€â”€â”€ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--teal));
    }
    .stat-card-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    .stat-card-value {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      line-height: 1;
      color: var(--navy);
      transition: all 0.5s;
    }
    .stat-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .stat-card-sublabel { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }

    /* â”€â”€â”€ RESULTS SECTION â”€â”€â”€ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .results-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .results-count {
      background: var(--teal-pale);
      color: var(--teal);
      font-size: 0.78rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 8px;
    }
    .export-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* â”€â”€â”€ GROUP SECTIONS â”€â”€â”€ */
    .group-section {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .group-header {
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .group-header:hover { background: var(--bg); }
    .group-header-left {
      display: flex; align-items: center; gap: 12px;
    }
    .group-pill {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.78rem;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .group-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--navy);
    }
    .group-meta { font-size: 0.78rem; color: var(--text-muted); }
    .group-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--navy);
      min-width: 60px;
      text-align: right;
    }
    .group-arrow { color: var(--text-muted); transition: transform 0.3s; }
    .group-arrow.open { transform: rotate(90deg); }

    .group-body {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: none;
    }
    .group-body.open { display: block; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    /* â”€â”€â”€ UNIT CARDS â”€â”€â”€ */
    .unit-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .unit-card:hover {
      border-color: var(--teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .unit-card-accent {
      position: absolute;
      top: 0; left: 0;
      width: 4px;
      height: 100%;
    }
    .unit-card-inner { padding-left: 8px; }
    .unit-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .unit-name {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--navy);
      line-height: 1.3;
    }
    .unit-type-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .unit-info-row svg { flex-shrink: 0; margin-top: 1px; color: var(--text-light); }
    .unit-cnes {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 10px;
      font-family: 'Outfit', sans-serif;
    }
    .unit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }
    .unit-tag {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .unit-tag-urgencia { background: var(--red-pale); color: var(--red); }
    .unit-tag-ambulatorial { background: var(--teal-pale); color: var(--teal); }
    .unit-tag-maternidade { background: var(--purple-pale); color: var(--purple); }
    .unit-tag-especializado { background: var(--amber-pale); color: #C07A00; }
    .unit-tag-federal { background: #E8F0FE; color: var(--blue); }
    .unit-tag-estadual { background: #FFF8EC; color: #9C6E00; }
    .unit-tag-municipal { background: var(--teal-pale); color: #006B4F; }
    .unit-tag-privado { background: var(--gray-200); color: var(--gray-700); }
    .unit-distance { background: var(--blue-pale); color: var(--blue); }
    .unit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 4px;
    }
    .unit-actions .btn-icon {
      background: var(--bg);
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      transition: all 0.2s;
    }
    .unit-actions .btn-icon:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-pale); }
    .unit-actions .btn-icon.whatsapp:hover { border-color: #25D366; color: #25D366; background: #E8FBF0; }
    .unit-actions .btn-icon.maps:hover { border-color: #EA4335; color: #EA4335; background: #FDECEA; }
    .unit-actions .btn-icon.search:hover { border-color: #4285F4; color: #4285F4; background: #E8F0FE; }

    /* â”€â”€â”€ LOADING / EMPTY / ERROR â”€â”€â”€ */
    .status-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 60px 40px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .status-box .status-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }
    .status-box h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .status-box p { font-size: 0.88rem; color: var(--text-muted); max-width: 400px; margin: 0 auto; }

    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--teal-pale);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-wrap {
      max-width: 360px;
      margin: 16px auto 0;
      background: var(--border);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    /* â”€â”€â”€ SEARCH PROGRESS CARD â”€â”€â”€ */
    .search-progress-card {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
      border-radius: var(--radius);
      padding: 20px 28px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 20px;
      border: 1px solid rgba(0,168,120,0.25);
      box-shadow: var(--shadow-md);
      animation: slideDown 0.3s ease;
    }
    .search-progress-card.visible { display: flex; }
    .search-progress-spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(0,200,150,0.25);
      border-top-color: var(--teal-light);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    .search-progress-info { flex: 1; min-width: 0; }
    .search-progress-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 0.92rem;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-progress-hint {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      min-height: 16px;
    }
    .search-progress-bar-wrap {
      flex: 1;
      max-width: 260px;
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
    }
    .search-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--teal), var(--teal-light));
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .search-progress-count {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--teal-light);
      min-width: 48px;
      text-align: right;
      flex-shrink: 0;
    }

    /* â”€â”€â”€ PDF PREVIEW MODAL â”€â”€â”€ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(11,31,58,0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.visible { display: flex; }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 1400px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover { background: var(--red-pale); color: var(--red); }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
      background: var(--bg);
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* â”€â”€â”€ NOTIFICATION â”€â”€â”€ */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--navy);
      color: #fff;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 340px;
    }
    .notification.success { background: var(--teal); }
    .notification.error { background: var(--red); }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* â”€â”€â”€ FOOTER â”€â”€â”€ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--text-light);
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .footer a { color: var(--teal); text-decoration: none; }

    /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
    @media (max-width: 640px) {
      .main-wrapper { padding: 16px 14px 40px; }
      .header-inner { padding: 14px 16px; }
      .header-titles h1 { font-size: 1.2rem; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: 1fr; }
      .geo-section { flex-direction: column; align-items: stretch; }
      .modal-content { max-height: 95vh; }
    }

    /* â”€â”€â”€ NIVEL COLORS â”€â”€â”€ */
    .nivel-primaria { --nivel-color: #00A878; }
    .nivel-secundaria { --nivel-color: #1565C0; }
    .nivel-terciaria { --nivel-color: #E53935; }
  </style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="header-inner">
    <div class="logo-mark">
      <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 4v20M4 14h20" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
        <circle cx="14" cy="14" r="12" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
      </svg>
    </div>
    <div class="header-titles">
      <h1>SaÃºde<span>BR</span> &mdash; Localizador CNES</h1>
      <p>Dados em tempo real via OpenStreetMap + Nominatim â€¢ Apenas unidades vinculadas ao SUS</p>
    </div>
    <span class="header-badge">ğŸŸ¢ Online</span>
  </div>
</header>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main-wrapper">

  <!-- â”€â”€â”€ FILTROS â”€â”€â”€ -->
  <div class="filter-section">
    <div class="filter-header" onclick="toggleFilter()">
      <div class="filter-header-left">
        <div class="filter-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </div>
        <div>
          <div class="filter-title">Filtros de Busca</div>
          <div class="filter-subtitle">Estado, municÃ­pio, perfil de atenÃ§Ã£o e formas de acolhimento</div>
        </div>
      </div>
      <button class="filter-toggle-btn" id="filterToggleBtn">
        <span>Expandir</span>
        <span class="filter-toggle-arrow" id="filterArrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </button>
    </div>

    <div class="filter-body" id="filterBody">
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Estado (UF)</label>
          <select class="form-control" id="selectEstado" onchange="onEstadoChange()">
            <option value="">â€” Selecione â€”</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">MunicÃ­pio</label>
          <select class="form-control" id="selectMunicipio" onchange="onMunicipioChange()" disabled>
            <option value="">â€” Selecione o estado primeiro â€”</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Bairro</label>
          <input type="text" class="form-control" id="inputBairro" placeholder="Ex: Centro, Jardim..." oninput="applyLocalFilters()">
        </div>
        <div class="form-group">
          <label class="form-label">Perfil / NÃ­vel de AtenÃ§Ã£o</label>
          <select class="form-control" id="selectNivel" onchange="applyLocalFilters()">
            <option value="">Todos os NÃ­veis</option>
            <option value="primaria">AtenÃ§Ã£o PrimÃ¡ria</option>
            <option value="secundaria">AtenÃ§Ã£o SecundÃ¡ria</option>
            <option value="terciaria">AtenÃ§Ã£o TerciÃ¡ria</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Forma de Acolhimento</label>
          <select class="form-control" id="selectAcolhimento" onchange="applyLocalFilters()">
            <option value="">Todas as Formas</option>
            <option value="ambulatorial">Atendimento Ambulatorial</option>
            <option value="urgencia">UrgÃªncia / EmergÃªncia</option>
            <option value="maternidade">Maternidade</option>
            <option value="especializado">Atendimento Especializado</option>
            <option value="samu">SAMU</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Esfera de GestÃ£o</label>
          <select class="form-control" id="selectGestao" onchange="applyLocalFilters()">
            <option value="">Todas</option>
            <option value="Municipal">Municipal</option>
            <option value="Estadual">Estadual</option>
            <option value="Federal">Federal</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="buscarPorMunicipio()" id="btnBuscarMunicipio">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          Buscar por MunicÃ­pio
        </button>
        <button class="btn btn-secondary" onclick="limparFiltros()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.57"/></svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ GEOLOCALIZAÃ‡ÃƒO â”€â”€â”€ -->
  <div class="geo-section">
    <div style="font-size: 1.8rem;">ğŸ“</div>
    <div class="geo-info">
      <h3>Busca por Proximidade GeogrÃ¡fica</h3>
      <p id="geoStatus">Detecta automaticamente sua localizaÃ§Ã£o via GPS e busca unidades no raio configurado.</p>
    </div>
    <div class="geo-radius-row">
      <span class="geo-radius-label">Raio (km):</span>
      <input type="number" class="geo-radius-input form-control" id="geoRaio" value="6" min="0.5" max="50" step="0.5">
    </div>
    <button class="btn btn-geo" onclick="usarGeolocalizacao()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>
      Buscar Perto de Mim
    </button>
  </div>

  <!-- â”€â”€â”€ SEARCH PROGRESS CARD â”€â”€â”€ -->
  <div class="search-progress-card" id="searchProgressCard">
    <div class="search-progress-spinner"></div>
    <div class="search-progress-info">
      <div class="search-progress-title" id="spTitle">Consultando OpenStreetMap...</div>
      <div class="search-progress-hint" id="spHint">Iniciando conexÃ£o...</div>
    </div>
    <div class="search-progress-bar-wrap">
      <div class="search-progress-bar" id="spBar" style="width:5%"></div>
    </div>
    <div class="search-progress-count" id="spCount">0</div>
  </div>

  <!-- â”€â”€â”€ DASHBOARD â”€â”€â”€ -->
  <div class="dashboard" id="dashboard">
    <div class="stat-card" style="--card-accent: var(--teal);">
      <div class="stat-card-icon" style="background: var(--teal-pale); color: var(--teal);">ğŸ¥</div>
      <div class="stat-card-value" id="statTotal">â€”</div>
      <div class="stat-card-label">Total de Unidades</div>
      <div class="stat-card-sublabel">encontradas</div>
    </div>
    <div class="stat-card" style="--card-accent: #00A878;">
      <div class="stat-card-icon" style="background: #E8F8F3; color: #00A878;">ğŸ </div>
      <div class="stat-card-value" id="statPrimaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o PrimÃ¡ria</div>
      <div class="stat-card-sublabel">UBS, Postos, ESF</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--blue);">
      <div class="stat-card-icon" style="background: var(--blue-pale); color: var(--blue);">ğŸ”¬</div>
      <div class="stat-card-value" id="statSecundaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o SecundÃ¡ria</div>
      <div class="stat-card-sublabel">PoliclÃ­nicas, UPA, CAPS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">ğŸ¨</div>
      <div class="stat-card-value" id="statTerciaria">â€”</div>
      <div class="stat-card-label">AtenÃ§Ã£o TerciÃ¡ria</div>
      <div class="stat-card-sublabel">Hospitais de referÃªncia</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--red);">
      <div class="stat-card-icon" style="background: var(--red-pale); color: var(--red);">ğŸš¨</div>
      <div class="stat-card-value" id="statUrgencia">â€”</div>
      <div class="stat-card-label">UrgÃªncia/EmergÃªncia</div>
      <div class="stat-card-sublabel">UPAs, PS</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--purple);">
      <div class="stat-card-icon" style="background: var(--purple-pale); color: var(--purple);">ğŸ¤±</div>
      <div class="stat-card-value" id="statMaternidade">â€”</div>
      <div class="stat-card-label">Maternidades</div>
      <div class="stat-card-sublabel">Parto e neonatal</div>
    </div>
    <div class="stat-card" style="--card-accent: var(--amber);">
      <div class="stat-card-icon" style="background: var(--amber-pale); color: var(--amber);">ğŸ¦´</div>
      <div class="stat-card-value" id="statEspecializado">â€”</div>
      <div class="stat-card-label">Especializado</div>
      <div class="stat-card-sublabel">Ortopedia, cardiologia</div>
    </div>
    <div class="stat-card" style="--card-accent: #9C27B0;">
      <div class="stat-card-icon" style="background: #F3E5F5; color: #9C27B0;">ğŸ›ï¸</div>
      <div class="stat-card-value" id="statAmbulatorial">â€”</div>
      <div class="stat-card-label">Ambulatorial</div>
      <div class="stat-card-sublabel">Consultas/exames</div>
    </div>
  </div>

  <!-- â”€â”€â”€ RESULTADOS â”€â”€â”€ -->
  <div id="resultsSection">
    <div class="status-box">
      <span class="status-icon">ğŸ”</span>
      <h3>Pronto para buscar</h3>
      <p>Selecione estado e municÃ­pio nos filtros e clique em <strong>Buscar por MunicÃ­pio</strong>, ou use <strong>Buscar Perto de Mim</strong> para detecÃ§Ã£o automÃ¡tica.</p>
    </div>
  </div>

</div><!-- /main-wrapper -->

<!-- â•â•â• PDF PREVIEW MODAL â•â•â• -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ“„ VisualizaÃ§Ã£o do RelatÃ³rio PDF</h3>
      <button class="modal-close" onclick="closePDFModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" id="pdfModalBody">
      <!-- PDF content will be injected here -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePDFModal()">Fechar</button>
      <button class="btn btn-whatsapp" onclick="compartilharPDFWhatsApp()">
        <span>ğŸ“±</span>
        Compartilhar WhatsApp
      </button>
      <button class="btn btn-primary" onclick="downloadPDF()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Baixar PDF
      </button>
    </div>
  </div>
</div>

<footer class="footer">
  Dados obtidos via <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a> e <a href="https://nominatim.org" target="_blank">Nominatim</a> â€” Fonte pÃºblica colaborativa &nbsp;|&nbsp; SaÃºdeBR Localizador v4.1
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURAÃ‡ÃƒO E CONSTANTES (CORRIGIDAS E REFORÃ‡ADAS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
    NOMINATIM: {
        ENDPOINT: 'https://nominatim.openstreetmap.org',
        EMAIL: 'contato@saudebr.gov.br' // Substitua por um email vÃ¡lido
    },
    IBGE: 'https://servicodados.ibge.gov.br/api/v1/localidades',
    OVERPASS: 'https://overpass-api.de/api/interpreter'
};

// Tipos de estabelecimentos a incluir (qualquer unidade de saÃºde)
const INCLUIR_TIPOS = 'hospital|clinic|health_post|health_centre|doctors|polyclinic|health|hospitals|medical|social_facility|nursing_home|birthing_center|healthcare';

// Tipos a excluir (farmÃ¡cias, laboratÃ³rios, etc.)
const EXCLUIR_TIPOS = 'pharmacy|dentist|optometrist|laboratory|sample_collection|physiotherapist|psychotherapist|audiologist|alternative|medical_imaging|blood_donation|veterinary';

// Palavras que indicam vÃ­nculo com o SUS (reforÃ§ado com termos de gestÃ£o pÃºblica)
const SUS_KEYWORDS = [
    'sus', 'pÃºblico', 'pÃºblica', 'municipal', 'estadual', 'federal', 
    'ubs', 'posto de saÃºde', 'unidade bÃ¡sica', 'centro de saÃºde',
    'hospital municipal', 'hospital estadual', 'hospital federal',
    'upa', 'policlÃ­nica municipal', 'cms', 'caps', 'samu', 'unidade de saÃºde',
    'secretaria municipal', 'secretaria de saÃºde', 'rede pÃºblica', 'saÃºde pÃºblica',
    'emergÃªncia', 'pronto-socorro', 'pronto atendimento', 'hospital pÃºblico',
    'centro de atenÃ§Ã£o', 'centro de especialidades', 'policlÃ­nica',
    'hospital geral', 'hospital regional', 'hospital universitÃ¡rio',
    'instituto', 'referÃªncia', 'complexo hospitalar', 'hospital de base',
    'hospital das clÃ­nicas', 'hospital escola', 'hospital dia',
    'maternidade', 'hospital da mulher', 'hospital infantil',
    // GestÃ£o pÃºblica explÃ­cita
    'prefeitura', 'governo do estado', 'governo federal', 'ministÃ©rio da saÃºde',
    'secretaria estadual', 'secretaria municipal', 'autarquia', 'fundaÃ§Ã£o pÃºblica'
];

// Palavras que indicam unidades privadas a serem excluÃ­das (ampliado)
const PRIVATE_KEYWORDS = [
    'particular', 'privado', 'privada', 'rede privada', 
    'clÃ­nica particular', 'laboratÃ³rio particular', 'empresa privada',
    'saÃºde suplementar', 'convÃªnio', 'plano de saÃºde', 'unimed',
    'hospital privado', 'hospital particular', 'hospital beneficente',
    'santa casa' // (algumas santas casas sÃ£o privadas filantrÃ³picas, mas vamos excluir por seguranÃ§a, a menos que tenham ref:CNES)
];

// Estado da aplicaÃ§Ã£o
let allUnits = [];
let filteredUnits = [];
let currentGeoPosition = null;
let estados = [];
let municipiosPorEstado = {};
let buscaAtiva = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FUNÃ‡Ã•ES AUXILIARES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function norm(str) {
    if (!str) return '';
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function deduplicar(unidades) {
    const unicos = new Map();
    unidades.forEach(u => {
        // Usar nome normalizado + coordenadas arredondadas para evitar duplicatas prÃ³ximas
        const chave = norm(u.nome) + u.lat.toFixed(4) + u.lon.toFixed(4);
        if (!unicos.has(chave)) unicos.set(chave, u);
    });
    return Array.from(unicos.values());
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function consultarOverpass(query) {
    const resp = await fetch(CONFIG.OVERPASS, {
        method: 'POST',
        body: query
    });
    if (!resp.ok) throw new Error('Overpass falhou');
    return await resp.json();
}

function showSearchProgress(visible) {
    const card = document.getElementById('searchProgressCard');
    if (visible) {
        card.classList.add('visible');
    } else {
        card.classList.remove('visible');
    }
}

function updateSearchProgress(percent, title, hint) {
    document.getElementById('spBar').style.width = `${percent}%`;
    document.getElementById('spTitle').textContent = title;
    document.getElementById('spHint').textContent = hint;
    document.getElementById('spCount').textContent = filteredUnits.length;
}

function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    
    const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
    notif.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
    
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.remove();
    }, 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLASSIFICAÃ‡ÃƒO REFORÃ‡ADA - VÃNCULO ABSOLUTO COM O SUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isVinculadoSUS(tags, nome) {
    const operador = norm(tags.operator || '');
    const descricao = norm(tags.description || '');
    const nomeNorm = norm(nome);
    const acesso = norm(tags.access || '');
    const ownership = norm(tags.ownership || '');
    
    // Se explicitamente privado, excluir imediatamente
    if (acesso === 'private' || ownership === 'private') return false;
    
    // Verificar palavras que indicam vÃ­nculo SUS (incluindo operador pÃºblico)
    for (const keyword of SUS_KEYWORDS) {
        if (operador.includes(keyword) || nomeNorm.includes(keyword) || descricao.includes(keyword) || ownership.includes(keyword)) {
            return true;
        }
    }
    
    // Verificar palavras que indicam privado (excluir)
    for (const keyword of PRIVATE_KEYWORDS) {
        if (operador.includes(keyword) || nomeNorm.includes(keyword) || ownership.includes(keyword)) {
            return false;
        }
    }
    
    // Se tem CNES, provavelmente Ã© SUS (mesmo que o nome nÃ£o deixe explÃ­cito)
    if (tags['ref:CNES'] || tags['ref:cnes']) return true;
    
    // Incluir estabelecimentos pÃºblicos por padrÃ£o, baseado em tipos
    const amenity = tags.amenity || '';
    const healthcare = tags.healthcare || '';
    const tiposPublicos = ['hospital', 'clinic', 'health_post', 'health_centre', 'doctors', 'social_facility', 'nursing_home', 'birthing_center'];
    
    if (tiposPublicos.includes(amenity) || tiposPublicos.includes(healthcare)) {
        // Se nÃ£o hÃ¡ indÃ­cio de privado, incluir (considera-se pÃºblico)
        return true;
    }
    
    return false;
}

function classificarNivel(tags, nome) {
    const healthcare = tags.healthcare || tags.amenity;
    const n = norm(nome + (tags.description || ''));
    const speciality = tags['healthcare:speciality'] || '';
    
    // ATENÃ‡ÃƒO PRIMÃRIA
    if (n.includes('ubs') || n.includes('posto de saude') || n.includes('unidade basica') ||
        n.includes('esf') || n.includes('saude da familia') || n.includes('psf') ||
        n.includes('centro de saude') || n.includes('cms') || healthcare === 'health_post' ||
        healthcare === 'health_centre' || n.includes('ambulatorio') || healthcare === 'clinic' ||
        n.includes('centro de saÃºde') || n.includes('policlinica')) {
        return {
            nivel: 'primaria',
            perfil: n.includes('ubs') ? 'UBS' : 
                    n.includes('posto') ? 'Posto de SaÃºde' :
                    n.includes('esf') ? 'ESF' :
                    n.includes('caps') ? 'CAPS' :
                    n.includes('ambulatorio') ? 'AmbulatÃ³rio' : 'Centro de SaÃºde'
        };
    }
    
    // ATENÃ‡ÃƒO SECUNDÃRIA
    if (n.includes('upa') || n.includes('policlinica') || n.includes('policlÃ­nica') ||
        n.includes('pronto atendimento') || n.includes('pronto socorro') ||
        n.includes('caps') || n.includes('cri') || n.includes('centro de atencao') ||
        healthcare === 'clinic' || n.includes('clinica especializada') || 
        n.includes('centro de especialidades') || speciality.includes('speciality')) {
        return {
            nivel: 'secundaria',
            perfil: n.includes('upa') ? 'UPA' :
                    n.includes('policlinica') ? 'PoliclÃ­nica' :
                    n.includes('pronto') ? 'Pronto Atendimento' :
                    n.includes('caps') ? 'CAPS' : 'ClÃ­nica Especializada'
        };
    }
    
    // ATENÃ‡ÃƒO TERCIÃRIA (Hospitais)
    if (healthcare === 'hospital' || n.includes('hospital') || n.includes('hosp')) {
        // Classificar por especialidade
        let perfil = 'Hospital Geral';
        let nivel = 'secundaria'; // default
        
        if (n.includes('maternidade') || n.includes('matern')) {
            perfil = 'Hospital Maternidade';
            nivel = 'terciaria';
        } else if (n.includes('infantil') || n.includes('crianca') || n.includes('pediatrico')) {
            perfil = 'Hospital Infantil';
            nivel = 'terciaria';
        } else if (n.includes('oncologia') || n.includes('cancer') || n.includes('inca')) {
            perfil = 'Hospital OncolÃ³gico';
            nivel = 'terciaria';
        } else if (n.includes('psiquiatria') || n.includes('mental')) {
            perfil = 'Hospital PsiquiÃ¡trico';
            nivel = 'terciaria';
        } else if (n.includes('ortopedia') || n.includes('trauma') || n.includes('cardiologia')) {
            perfil = 'Hospital Especializado';
            nivel = 'terciaria';
        } else if (n.includes('universitario') || n.includes('referencia') || n.includes('federal')) {
            perfil = 'Hospital de ReferÃªncia';
            nivel = 'terciaria';
        } else {
            // Se for hospital geral, pode ser secundÃ¡rio ou terciÃ¡rio dependendo do porte
            if (n.includes('geral') || n.includes('regional') || n.includes('central')) {
                nivel = 'secundaria';
            } else {
                nivel = 'secundaria'; // por padrÃ£o, secundÃ¡rio
            }
        }
        
        return { nivel, perfil };
    }
    
    // Default
    return {
        nivel: 'primaria',
        perfil: 'Unidade de SaÃºde'
    };
}

function determinarAcolhimento(u) {
    const n = norm(u.nome + u.perfil);
    
    if (n.includes('upa') || n.includes('urgencia') || n.includes('emergencia') || 
        n.includes('pronto socorro') || n.includes('pronto atendimento')) {
        return 'urgencia';
    }
    if (n.includes('maternidade') || n.includes('obstetricia') || n.includes('parto')) {
        return 'maternidade';
    }
    if (n.includes('ortopedia') || n.includes('cardiologia') || n.includes('oncologia') ||
        n.includes('especializado') || n.includes('referencia')) {
        return 'especializado';
    }
    if (n.includes('samu')) {
        return 'samu';
    }
    
    return 'ambulatorial';
}

function getTextoAcolhimento(acolhimento) {
    const textos = {
        'ambulatorial': 'Atendimento Ambulatorial',
        'urgencia': 'UrgÃªncia/EmergÃªncia',
        'maternidade': 'Maternidade',
        'especializado': 'Atendimento Especializado',
        'samu': 'SAMU'
    };
    return textos[acolhimento] || 'Atendimento Geral';
}

async function montarUnidade(tags, lat, lon, osmId, osmType, distancia = null) {
    const nome = (tags.name || tags['name:pt'] || '').trim();
    if (!nome) return null;
    
    // Verificar vÃ­nculo com SUS
    if (!isVinculadoSUS(tags, nome)) return null;
    
    const classif = classificarNivel(tags, nome);
    
    // Determinar gestÃ£o (federal, estadual, municipal) â€“ refinado
    const operador = (tags.operator || '').toLowerCase();
    let gestao = 'Municipal'; // padrÃ£o
    if (operador.includes('federal') || operador.includes('ministÃ©rio') || operador.includes('uniÃ£o')) gestao = 'Federal';
    else if (operador.includes('estadual') || operador.includes('governo do estado')) gestao = 'Estadual';
    else if (operador.includes('municipal') || operador.includes('prefeitura')) gestao = 'Municipal';
    // Se nÃ£o houver operador, mas tiver CNES, tentar inferir pelo nome
    else if (tags['ref:CNES'] || tags['ref:cnes']) {
        if (nome.includes('Federal')) gestao = 'Federal';
        else if (nome.includes('Estadual')) gestao = 'Estadual';
        else gestao = 'Municipal';
    }

    // Obter endereÃ§o completo
    let enderecoCompleto = [tags['addr:street'], tags['addr:housenumber'], tags['addr:neighbourhood']].filter(Boolean).join(', ');
    
    // Telefone
    let telefone = tags.phone || tags['contact:phone'] || '';
    
    // Email
    let email = tags.email || tags['contact:email'] || '';
    
    // Website
    let website = tags.website || tags['contact:website'] || '';
    
    return {
        nome,
        cidade: '',
        bairro: tags['addr:neighbourhood'] || tags['addr:suburb'] || '',
        perfil: classif.perfil,
        nivel: classif.nivel,
        lat,
        lon,
        telefone,
        email,
        endereco: enderecoCompleto,
        osmId,
        osmType,
        website,
        distancia,
        acolhimento: determinarAcolhimento({ nome, perfil: classif.perfil }),
        gestao,
        cnes: tags['ref:CNES'] || tags['ref:cnes'] || '',
        enderecoCompleto,
        telefoneFormatado: '',
        mapsLink: lat && lon ? `https://www.google.com/maps?q=${lat},${lon}` : '',
        cnesLink: tags['ref:CNES'] ? `https://cnes.datasus.gov.br/pages/estabelecimentos/ficha.jsp?pk=${tags['ref:CNES']}` : ''
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOLOCALIZAÃ‡ÃƒO E BUSCA POR PROXIMIDADE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function usarGeolocalizacao() {
    if (!navigator.geolocation) {
        showNotification('GeolocalizaÃ§Ã£o nÃ£o suportada pelo navegador', 'error');
        return;
    }

    showSearchProgress(true);
    updateSearchProgress(10, 'Obtendo sua localizaÃ§Ã£o...', 'Aguarde autorizaÃ§Ã£o GPS');
    buscaAtiva = true;

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            if (!buscaAtiva) return;
            
            currentGeoPosition = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };

            updateSearchProgress(20, 'LocalizaÃ§Ã£o obtida!', `Lat: ${currentGeoPosition.lat.toFixed(4)}, Lon: ${currentGeoPosition.lon.toFixed(4)}`);

            try {
                // Reverse geocoding para descobrir municÃ­pio
                const location = await reverseGeocode(currentGeoPosition.lat, currentGeoPosition.lon);
                
                if (!location || !location.cidade) {
                    throw new Error('NÃ£o foi possÃ­vel determinar sua localizaÃ§Ã£o');
                }

                updateSearchProgress(30, 'MunicÃ­pio detectado', location.cidade);
                
                // Buscar unidades prÃ³ximas
                const raio = parseFloat(document.getElementById('geoRaio').value) || 6;
                const units = await buscarUnidadesProximas(currentGeoPosition.lat, currentGeoPosition.lon, raio);
                
                if (!buscaAtiva) return;

                updateSearchProgress(85, 'Processando unidades...', `${units.length} unidades encontradas`);

                // Calcular distÃ¢ncias
                units.forEach(u => {
                    if (u.lat && u.lon) {
                        u.distancia = calcularDistancia(
                            currentGeoPosition.lat,
                            currentGeoPosition.lon,
                            u.lat,
                            u.lon
                        );
                    }
                });

                // Ordenar por distÃ¢ncia
                units.sort((a, b) => (a.distancia || 999) - (b.distancia || 999));

                // Enriquecer dados
                allUnits = await enrichUnitsData(units, location.cidade);
                
                if (!buscaAtiva) return;

                applyLocalFilters();

                updateSearchProgress(100, 'ConcluÃ­do!', `${allUnits.length} unidades no raio de ${raio}km`);

                setTimeout(() => {
                    showSearchProgress(false);
                    showNotification(`${allUnits.length} unidades encontradas prÃ³ximas a vocÃª`, 'success');
                    document.getElementById('geoStatus').textContent = 
                        `ğŸ“ Sua localizaÃ§Ã£o: ${location.cidade} â€¢ ${allUnits.length} unidades no raio de ${raio}km`;
                }, 800);

            } catch (error) {
                console.error('Erro na busca por proximidade:', error);
                showSearchProgress(false);
                showNotification('Erro: ' + error.message, 'error');
            }
        },
        (error) => {
            showSearchProgress(false);
            let msg = 'Erro ao obter localizaÃ§Ã£o';
            
            if (error.code === error.PERMISSION_DENIED) {
                msg = 'PermissÃ£o de localizaÃ§Ã£o negada';
            } else if (error.code === error.POSITION_UNAVAILABLE) {
                msg = 'LocalizaÃ§Ã£o indisponÃ­vel';
            } else if (error.code === error.TIMEOUT) {
                msg = 'Tempo esgotado ao obter localizaÃ§Ã£o';
            }
            
            showNotification(msg, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

async function buscarUnidadesProximas(lat, lon, raioKm) {
    const raioMetros = raioKm * 1000;
    
    // Query ampliada para incluir mais tipos, excluindo os indesejados
    const query = `
[out:json][timeout:45];
(
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](around:${raioMetros},${lat},${lon});
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](around:${raioMetros},${lat},${lon});
  node["amenity"~"^(${INCLUIR_TIPOS})$"](around:${raioMetros},${lat},${lon});
  way["amenity"~"^(${INCLUIR_TIPOS})$"](around:${raioMetros},${lat},${lon});
);
out center tags;
    `.trim();

    updateSearchProgress(40, 'Consultando OpenStreetMap...', 'Buscando unidades de saÃºde');

    try {
        const dados = await consultarOverpass(query);
        const elementos = dados.elements || [];
        
        if (!buscaAtiva) return [];
        
        updateSearchProgress(60, 'Processando resultados...', `${elementos.length} candidatos encontrados`);

        const unidades = [];
        
        for (let i = 0; i < elementos.length; i++) {
            if (!buscaAtiva) return unidades;
            
            const el = elementos[i];
            const tags = el.tags || {};
            const elLat = el.lat ?? el.center?.lat;
            const elLon = el.lon ?? el.center?.lon;
            
            if (!elLat || !elLon) continue;

            const distancia = calcularDistancia(lat, lon, elLat, elLon);
            if (distancia > raioKm) continue;

            const u = await montarUnidade(
                tags, elLat, elLon,
                el.id,
                el.type === 'node' ? 'node' : 'way',
                distancia
            );
            
            if (u) {
                unidades.push(u);
            }

            if (i % 10 === 0) {
                const pct = 60 + Math.round((i + 1) / elementos.length * 25);
                updateSearchProgress(pct, 'Processando...', `${unidades.length} unidades vÃ¡lidas encontradas`);
            }
        }

        return deduplicar(unidades);
        
    } catch (error) {
        console.error('Erro no Overpass:', error);
        throw error;
    }
}

async function reverseGeocode(lat, lon) {
    try {
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=pt-BR`;
        const response = await fetch(url, {
            headers: {
                'User-Agent': `SaudeBR-Localizador/4.1 (${CONFIG.NOMINATIM.EMAIL})`
            }
        });
        
        if (!response.ok) return null;
        
        const data = await response.json();
        
        if (data && data.address) {
            const cidade = data.address.city || data.address.town || data.address.municipality || data.address.county;
            const uf = data.address.state;
            const estadoSigla = data.address['ISO3166-2-lvl4']?.split('-')[1] || uf;
            
            return {
                cidade,
                uf: estadoSigla,
                estado: uf
            };
        }
    } catch (error) {
        console.error('Erro no reverse geocoding:', error);
    }
    
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUSCA POR MUNICÃPIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buscarPorMunicipio() {
    const uf = document.getElementById('selectEstado').value;
    const codigoIBGE = document.getElementById('selectMunicipio').value;
    
    if (!uf || !codigoIBGE) {
        showNotification('Selecione estado e municÃ­pio', 'error');
        return;
    }

    const selectMunicipio = document.getElementById('selectMunicipio');
    const nomeMunicipio = selectMunicipio.options[selectMunicipio.selectedIndex]?.text || 'municÃ­pio selecionado';
    
    showSearchProgress(true);
    updateSearchProgress(10, 'Consultando OpenStreetMap...', `Buscando em ${nomeMunicipio}/${uf}`);
    buscaAtiva = true;

    try {
        // Obter dados do municÃ­pio
        const municipio = await getMunicipioData(uf, codigoIBGE);
        
        if (!municipio || !municipio.latitude || !municipio.longitude) {
            throw new Error('NÃ£o foi possÃ­vel obter coordenadas do municÃ­pio');
        }

        updateSearchProgress(20, 'Localizando Ã¡rea do municÃ­pio...', `${municipio.nome} (${municipio.latitude.toFixed(4)}, ${municipio.longitude.toFixed(4)})`);

        // Buscar unidades no municÃ­pio
        const units = await buscarUnidadesNoMunicipio(municipio);
        
        if (!buscaAtiva) return;
        
        if (units.length === 0) {
            updateSearchProgress(100, 'Nenhuma unidade encontrada', 'Tente expandir a busca');
            setTimeout(() => showSearchProgress(false), 1500);
            showNotification('Nenhuma unidade encontrada neste municÃ­pio', 'warning');
            return;
        }

        updateSearchProgress(80, 'Processando unidades...', `${units.length} unidades encontradas`);

        // Enriquecer dados
        allUnits = await enrichUnitsData(units, municipio.nome);
        
        if (!buscaAtiva) return;

        applyLocalFilters();

        updateSearchProgress(100, 'ConcluÃ­do!', `${allUnits.length} unidades encontradas em ${municipio.nome}`);

        setTimeout(() => {
            showSearchProgress(false);
            showNotification(`${allUnits.length} unidades encontradas em ${municipio.nome}`, 'success');
        }, 800);

    } catch (error) {
        console.error('Erro na busca por municÃ­pio:', error);
        showSearchProgress(false);
        showNotification('Erro ao buscar unidades: ' + error.message, 'error');
    }
}

async function getMunicipioData(uf, codigoIBGE) {
    // Tentar obter do cache primeiro
    if (municipiosPorEstado[uf]) {
        const mun = municipiosPorEstado[uf].find(m => m.id === codigoIBGE);
        if (mun && mun.latitude && mun.longitude) {
            return mun;
        }
    }

    // Buscar coordenadas via Nominatim
    const nomeMunicipio = document.getElementById('selectMunicipio').options[
        document.getElementById('selectMunicipio').selectedIndex
    ]?.text;

    if (!nomeMunicipio) return null;

    try {
        const nomeBusca = encodeURIComponent(`${nomeMunicipio}, ${uf}, Brasil`);
        const url = `${CONFIG.NOMINATIM.ENDPOINT}/search?q=${nomeBusca}&format=json&limit=1&countrycodes=br`;
        
        const response = await fetch(url, {
            headers: {
                'User-Agent': `SaudeBR-Localizador/4.1 (${CONFIG.NOMINATIM.EMAIL})`
            }
        });
        
        if (!response.ok) return null;
        
        const data = await response.json();
        
        if (data.length > 0) {
            const mun = {
                id: codigoIBGE,
                nome: nomeMunicipio,
                latitude: parseFloat(data[0].lat),
                longitude: parseFloat(data[0].lon)
            };
            
            // Estimar Ã¡rea pelo bounding box
            if (data[0].boundingbox) {
                const bb = data[0].boundingbox.map(Number);
                const dLat = Math.abs(bb[1] - bb[0]);
                const dLon = Math.abs(bb[3] - bb[2]);
                mun.area_km2 = dLat * 111 * dLon * 111 * Math.cos(mun.latitude * Math.PI / 180);
            }
            
            // Salvar no cache
            if (!municipiosPorEstado[uf]) municipiosPorEstado[uf] = [];
            const index = municipiosPorEstado[uf].findIndex(m => m.id === codigoIBGE);
            if (index >= 0) {
                municipiosPorEstado[uf][index] = mun;
            } else {
                municipiosPorEstado[uf].push(mun);
            }
            
            return mun;
        }
    } catch (error) {
        console.warn('Erro ao buscar coordenadas do municÃ­pio:', error);
    }

    return null;
}

async function buscarUnidadesNoMunicipio(municipio) {
    // Primeiro tenta por Ã¡rea administrativa
    const nomesAlternativos = [municipio.nome, municipio.nome.replace(/^(SÃ£o|Santo|Santa) /, 'S. ')];
    
    let elementos = [];
    
    for (const nomeAlt of nomesAlternativos) {
        const query = `[out:json][timeout:60];
area["name"="${nomeAlt}"]["admin_level"~"^(7|8|9)$"]["boundary"="administrative"]->.mun;
(
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](area.mun);
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](area.mun);
  node["amenity"~"^(${INCLUIR_TIPOS})$"]["name"](area.mun);
  way["amenity"~"^(${INCLUIR_TIPOS})$"]["name"](area.mun);
);
out center tags;`;
        
        try {
            const dados = await consultarOverpass(query);
            elementos = dados.elements || [];
            if (elementos.length > 0) break;
        } catch (e) {
            console.warn('Overpass Ã¡rea falhou:', e);
        }
    }

    // Se nÃ£o encontrou por Ã¡rea, tenta por bounding box
    if (elementos.length === 0) {
        updateSearchProgress(35, 'Expandindo busca por coordenadas...', 'Usando bounding box');
        
        const raio = 0.25;
        const sul = (municipio.latitude - raio).toFixed(6);
        const norte = (municipio.latitude + raio).toFixed(6);
        const oeste = (municipio.longitude - raio).toFixed(6);
        const leste = (municipio.longitude + raio).toFixed(6);

        const query = `[out:json][timeout:60];
(
  node["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${sul},${oeste},${norte},${leste});
  way["healthcare"]["healthcare"!~"^(${EXCLUIR_TIPOS})$"](${sul},${oeste},${norte},${leste});
  node["amenity"~"^(${INCLUIR_TIPOS})$"]["name"](${sul},${oeste},${norte},${leste});
  way["amenity"~"^(${INCLUIR_TIPOS})$"]["name"](${sul},${oeste},${norte},${leste});
);
out center tags;`;
        
        try {
            const dados = await consultarOverpass(query);
            elementos = dados.elements || [];
        } catch (e) {
            console.warn('Overpass bbox falhou:', e);
        }
    }

    if (elementos.length === 0) {
        return [];
    }

    updateSearchProgress(50, 'Classificando unidades...', `${elementos.length} candidatos encontrados`);

    const raioKm = Math.max(15, municipio.area_km2 ? Math.sqrt(municipio.area_km2 / Math.PI) * 1.3 : 15);
    const unidades = [];

    for (let i = 0; i < elementos.length; i++) {
        if (!buscaAtiva) return unidades;
        
        const el = elementos[i];
        const tags = el.tags || {};
        const lat = el.lat ?? el.center?.lat;
        const lon = el.lon ?? el.center?.lon;
        
        if (!lat || !lon) continue;

        const dist = calcularDistancia(municipio.latitude, municipio.longitude, lat, lon);

        if (dist <= raioKm + 5) {
            const u = await montarUnidade(tags, lat, lon, el.id, el.type === 'node' ? 'node' : 'way');
            if (u) {
                u.cidade = municipio.nome;
                unidades.push(u);
            }
        }

        const pct = 50 + Math.round((i + 1) / elementos.length * 30);
        updateSearchProgress(pct, 'Processando...', `${unidades.length} unidades vÃ¡lidas encontradas`);
    }

    return deduplicar(unidades);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENRIQUECIMENTO DE DADOS (COM REVERSE GEOCODING)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function enrichUnitsData(units, cidadeRef) {
    // Primeiro, definir cidade e iniciar reverse geocoding para bairro
    for (const unit of units) {
        unit.cidade = unit.cidade || cidadeRef || '';
        
        // Se nÃ£o tiver endereÃ§o completo, tentar reverse geocoding
        if (!unit.enderecoCompleto && unit.lat && unit.lon) {
            agendarReverseGeocoding(unit);
        }
        
        // Formatar telefone
        if (unit.telefone) {
            const tel = unit.telefone.replace(/\D/g, '');
            if (tel.length >= 10) {
                const ddd = tel.substring(0, 2);
                const parte1 = tel.substring(2, tel.length - 4);
                const parte2 = tel.substring(tel.length - 4);
                unit.telefoneFormatado = `(${ddd}) ${parte1}-${parte2}`;
            } else {
                unit.telefoneFormatado = unit.telefone;
            }
        }
    }

    return units;
}

// Fila para reverse geocoding (evitar sobrecarga)
const reverseGeocodeQueue = [];
let reverseGeocodeRunning = false;

function agendarReverseGeocoding(unit) {
    reverseGeocodeQueue.push(unit);
    processReverseGeocodeQueue();
}

async function processReverseGeocodeQueue() {
    if (reverseGeocodeRunning) return;
    reverseGeocodeRunning = true;

    while (reverseGeocodeQueue.length > 0) {
        const unit = reverseGeocodeQueue.shift();
        if (!unit.lat || !unit.lon) continue;

        try {
            const url = `${CONFIG.NOMINATIM.ENDPOINT}/reverse?format=json&lat=${unit.lat}&lon=${unit.lon}&zoom=18&addressdetails=1&accept-language=pt-BR`;
            const response = await fetch(url, {
                headers: {
                    'User-Agent': `SaudeBR-Localizador/4.1 (${CONFIG.NOMINATIM.EMAIL})`
                }
            });
            if (response.ok) {
                const data = await response.json();
                const addr = data.address || {};
                unit.bairro = addr.neighbourhood || addr.suburb || addr.quarter || addr.hamlet || '';
                unit.endereco = [addr.road, addr.house_number].filter(Boolean).join(', ') || unit.endereco;
                unit.cidade = addr.city || addr.town || addr.municipality || unit.cidade;
                // Atualizar card se jÃ¡ estiver renderizado
                atualizarCard(unit);
            }
        } catch (e) {
            console.warn('Reverse geocoding falhou para unidade:', unit.nome);
        }

        // Aguardar 1 segundo entre requisiÃ§Ãµes para respeitar polÃ­tica de uso
        await sleep(1000);
    }

    reverseGeocodeRunning = false;
}

function atualizarCard(unit) {
    // Encontrar o card pelo Ã­ndice (nÃ£o implementado diretamente, mas pode ser feito)
    // Como Ã© complexo, vamos apenas re-renderizar os resultados apÃ³s um tempo
    _agendarAtualizacaoFiltros();
}

let _atualizacaoAgendada = null;
function _agendarAtualizacaoFiltros() {
    if (_atualizacaoAgendada) clearTimeout(_atualizacaoAgendada);
    _atualizacaoAgendada = setTimeout(() => {
        // Reaplicar filtros para atualizar cards
        applyLocalFilters();
    }, 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTERFACE - FILTROS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilter() {
    const body = document.getElementById('filterBody');
    const arrow = document.getElementById('filterArrow');
    const btn = document.getElementById('filterToggleBtn');
    
    body.classList.toggle('open');
    arrow.classList.toggle('open');
    
    if (body.classList.contains('open')) {
        btn.querySelector('span').textContent = 'Recolher';
    } else {
        btn.querySelector('span').textContent = 'Expandir';
    }
}

async function carregarEstados() {
    const select = document.getElementById('selectEstado');
    
    try {
        const response = await fetch(`${CONFIG.IBGE}/estados?orderBy=nome`);
        estados = await response.json();
        
        estados.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(est => {
            const opt = document.createElement('option');
            opt.value = est.sigla;
            opt.textContent = `${est.sigla} â€” ${est.nome}`;
            select.appendChild(opt);
        });
    } catch (error) {
        console.error('Erro ao carregar estados:', error);
        showNotification('Erro ao carregar estados', 'error');
    }
}

async function onEstadoChange() {
    const select = document.getElementById('selectEstado');
    const selectMun = document.getElementById('selectMunicipio');
    const uf = select.value;
    
    selectMun.innerHTML = '<option value="">Carregando municÃ­pios...</option>';
    selectMun.disabled = true;
    
    if (!uf) {
        selectMun.innerHTML = '<option value="">â€” Selecione o estado primeiro â€”</option>';
        return;
    }
    
    try {
        const response = await fetch(`${CONFIG.IBGE}/estados/${uf}/municipios?orderBy=nome`);
        const municipios = await response.json();
        
        municipiosPorEstado[uf] = municipios.map(m => ({
            id: String(m.id),
            nome: m.nome,
            latitude: null,
            longitude: null,
            area_km2: null
        }));
        
        selectMun.innerHTML = '<option value="">â€” Selecione um municÃ­pio â€”</option>';
        municipiosPorEstado[uf].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(mun => {
            const opt = document.createElement('option');
            opt.value = mun.id;
            opt.textContent = mun.nome;
            selectMun.appendChild(opt);
        });
        
        selectMun.disabled = false;
    } catch (error) {
        console.error('Erro ao carregar municÃ­pios:', error);
        showNotification('Erro ao carregar municÃ­pios', 'error');
        selectMun.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

function onMunicipioChange() {
    // Opcional
}

function limparFiltros() {
    document.getElementById('selectEstado').value = '';
    document.getElementById('selectMunicipio').value = '';
    document.getElementById('selectMunicipio').disabled = true;
    document.getElementById('selectMunicipio').innerHTML = '<option value="">â€” Selecione o estado primeiro â€”</option>';
    document.getElementById('inputBairro').value = '';
    document.getElementById('selectNivel').value = '';
    document.getElementById('selectAcolhimento').value = '';
    document.getElementById('selectGestao').value = '';
    
    allUnits = [];
    filteredUnits = [];
    renderResults();
    showNotification('Filtros limpos', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTROS LOCAIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyLocalFilters() {
    const bairro = document.getElementById('inputBairro').value.toLowerCase().trim();
    const nivel = document.getElementById('selectNivel').value;
    const acolhimento = document.getElementById('selectAcolhimento').value;
    const gestao = document.getElementById('selectGestao').value;
    
    filteredUnits = allUnits.filter(u => {
        // Filtro de bairro
        if (bairro && u.bairro && !u.bairro.toLowerCase().includes(bairro)) {
            return false;
        }
        
        // Filtro de nÃ­vel
        if (nivel && u.nivel !== nivel) {
            return false;
        }
        
        // Filtro de acolhimento
        if (acolhimento && u.acolhimento !== acolhimento) {
            return false;
        }
        
        // Filtro de gestÃ£o
        if (gestao && u.gestao !== gestao) {
            return false;
        }
        
        return true;
    });
    
    renderResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERIZAÃ‡ÃƒO DE RESULTADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults() {
    updateDashboard();
    
    const container = document.getElementById('resultsSection');
    
    if (filteredUnits.length === 0) {
        container.innerHTML = `
            <div class="status-box">
                <span class="status-icon">ğŸ”</span>
                <h3>Nenhuma unidade encontrada</h3>
                <p>Tente ajustar os filtros ou realizar uma nova busca.</p>
            </div>
        `;
        return;
    }
    
    // Agrupar por nÃ­vel
    const groups = {
        'primaria': filteredUnits.filter(u => u.nivel === 'primaria'),
        'secundaria': filteredUnits.filter(u => u.nivel === 'secundaria'),
        'terciaria': filteredUnits.filter(u => u.nivel === 'terciaria')
    };
    
    let html = `
        <div class="results-header">
            <div>
                <h2 class="results-title">
                    Resultados
                    <span class="results-count">${filteredUnits.length}</span>
                </h2>
            </div>
            <div class="export-row">
                <button class="btn btn-amber btn-sm" onclick="exportToExcel()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Exportar Excel
                </button>
                <button class="btn btn-navy btn-sm" onclick="visualizarPDF()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Visualizar PDF
                </button>
            </div>
        </div>
    `;
    
    // Renderizar grupos
    const groupConfigs = [
        { key: 'primaria', label: 'AtenÃ§Ã£o PrimÃ¡ria', color: '#00A878', icon: 'ğŸ ' },
        { key: 'secundaria', label: 'AtenÃ§Ã£o SecundÃ¡ria', color: '#1565C0', icon: 'ğŸ”¬' },
        { key: 'terciaria', label: 'AtenÃ§Ã£o TerciÃ¡ria', color: '#E53935', icon: 'ğŸ¨' }
    ];
    
    groupConfigs.forEach(cfg => {
        if (groups[cfg.key] && groups[cfg.key].length > 0) {
            html += renderGroup(cfg, groups[cfg.key]);
        }
    });
    
    container.innerHTML = html;
}

function renderGroup(config, units) {
    const groupId = `group-${config.key}`;
    
    let html = `
        <div class="group-section">
            <div class="group-header" onclick="toggleGroup('${groupId}')">
                <div class="group-header-left">
                    <span class="group-pill" style="background: ${config.color}22; color: ${config.color};">
                        ${config.icon}
                    </span>
                    <div>
                        <div class="group-name">${config.label}</div>
                        <div class="group-meta">${units.length} unidade${units.length !== 1 ? 's' : ''} encontrada${units.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="group-count">${units.length}</div>
                    <span class="group-arrow" id="${groupId}-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
                    </span>
                </div>
            </div>
            <div class="group-body" id="${groupId}">
                <div class="cards-grid">
                    ${units.map((u, idx) => renderUnitCard(u, config.color, idx)).join('')}
                </div>
            </div>
        </div>
    `;
    
    return html;
}

function renderUnitCard(unit, accentColor, idx) {
    const gestaoClass = {
        'Municipal': 'municipal',
        'Estadual': 'estadual',
        'Federal': 'federal'
    }[unit.gestao] || 'municipal';
    
    let tagsHTML = '';
    
    // Tag de gestÃ£o
    if (unit.gestao) {
        tagsHTML += `<span class="unit-tag unit-tag-${gestaoClass}">${unit.gestao}</span>`;
    }
    
    // Tag de acolhimento
    const acolhimentoClass = {
        'ambulatorial': 'ambulatorial',
        'urgencia': 'urgencia',
        'maternidade': 'maternidade',
        'especializado': 'especializado',
        'samu': 'urgencia'
    }[unit.acolhimento] || 'ambulatorial';
    
    tagsHTML += `<span class="unit-tag unit-tag-${acolhimentoClass}">${getTextoAcolhimento(unit.acolhimento)}</span>`;
    
    // Tag de distÃ¢ncia
    if (unit.distancia !== null && unit.distancia !== undefined) {
        tagsHTML += `<span class="unit-tag unit-distance">${unit.distancia.toFixed(1)} km</span>`;
    }
    
    // BotÃµes de aÃ§Ã£o
    let actionsHTML = '';
    
    // Google Maps
    if (unit.mapsLink) {
        actionsHTML += `
            <button class="btn-icon maps" onclick="window.open('${unit.mapsLink}', '_blank')" title="Ver no Google Maps">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                </svg>
            </button>
        `;
    }
    
    // Link CNES
    if (unit.cnesLink) {
        actionsHTML += `
            <button class="btn-icon search" onclick="window.open('${unit.cnesLink}', '_blank')" title="Ver no CNES">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
            </button>
        `;
    }
    
    // WhatsApp
    if (unit.telefone) {
        const telClean = unit.telefone.replace(/\D/g, '');
        const texto = encodeURIComponent(`*${unit.nome}*\nğŸ“ ${unit.enderecoCompleto || unit.endereco || ''}\nğŸ“ ${unit.telefoneFormatado || unit.telefone}\nğŸ¥ ${unit.perfil}\nğŸ”— ${unit.website || ''}`);
        const whatsappLink = `https://wa.me/55${telClean}?text=${texto}`;
        actionsHTML += `
            <button class="btn-icon whatsapp" onclick="window.open('${whatsappLink}', '_blank')" title="Contato WhatsApp">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
        `;
    }
    
    // Website / Google Search
    if (unit.website) {
        actionsHTML += `
            <button class="btn-icon search" onclick="window.open('${unit.website}', '_blank')" title="Buscar no Google">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
            </button>
        `;
    }
    
    // Email
    if (unit.email) {
        actionsHTML += `
            <button class="btn-icon" onclick="window.location.href='mailto:${unit.email}'" title="Enviar e-mail">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                </svg>
            </button>
        `;
    }
    
    return `
        <div class="unit-card" data-unit-idx="${idx}">
            <div class="unit-card-accent" style="background: ${accentColor};"></div>
            <div class="unit-card-inner">
                <div class="unit-card-header">
                    <h3 class="unit-name">${unit.nome}</h3>
                </div>
                
                ${unit.perfil ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>${unit.perfil}</span>
                    </div>
                ` : ''}
                
                ${unit.enderecoCompleto || unit.endereco ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${unit.enderecoCompleto || unit.endereco} ${unit.bairro ? ' - ' + unit.bairro : ''}</span>
                    </div>
                ` : ''}
                
                ${unit.telefoneFormatado ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <span>${unit.telefoneFormatado}</span>
                    </div>
                ` : ''}
                
                ${unit.email ? `
                    <div class="unit-info-row">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span>${unit.email}</span>
                    </div>
                ` : ''}
                
                ${unit.cnes ? `<div class="unit-cnes">CNES: ${unit.cnes}</div>` : ''}
                
                <div class="unit-tags">
                    ${tagsHTML}
                </div>
                
                ${actionsHTML ? `
                    <div class="unit-actions">
                        ${actionsHTML}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function toggleGroup(groupId) {
    const body = document.getElementById(groupId);
    const arrow = document.getElementById(`${groupId}-arrow`);
    
    body.classList.toggle('open');
    arrow.classList.toggle('open');
}

function updateDashboard() {
    document.getElementById('statTotal').textContent = filteredUnits.length;
    
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria').length;
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria').length;
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria').length;
    
    const urgencia = filteredUnits.filter(u => u.acolhimento === 'urgencia').length;
    const maternidade = filteredUnits.filter(u => u.acolhimento === 'maternidade').length;
    const especializado = filteredUnits.filter(u => u.acolhimento === 'especializado').length;
    const ambulatorial = filteredUnits.filter(u => u.acolhimento === 'ambulatorial').length;
    
    document.getElementById('statPrimaria').textContent = primaria;
    document.getElementById('statSecundaria').textContent = secundaria;
    document.getElementById('statTerciaria').textContent = terciaria;
    document.getElementById('statUrgencia').textContent = urgencia;
    document.getElementById('statMaternidade').textContent = maternidade;
    document.getElementById('statEspecializado').textContent = especializado;
    document.getElementById('statAmbulatorial').textContent = ambulatorial;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORTAÃ‡ÃƒO - EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportToExcel() {
    if (filteredUnits.length === 0) {
        showNotification('Nenhuma unidade para exportar', 'error');
        return;
    }
    
    const data = filteredUnits.map(u => ({
        'Nome': u.nome,
        'Perfil': u.perfil,
        'NÃ­vel de AtenÃ§Ã£o': u.nivel === 'primaria' ? 'PrimÃ¡ria' : u.nivel === 'secundaria' ? 'SecundÃ¡ria' : 'TerciÃ¡ria',
        'Tipo de Acolhimento': getTextoAcolhimento(u.acolhimento),
        'Cidade': u.cidade,
        'Bairro': u.bairro || '',
        'EndereÃ§o': u.endereco || '',
        'Telefone': u.telefoneFormatado || u.telefone || '',
        'E-mail': u.email || '',
        'GestÃ£o': u.gestao || '',
        'CNES': u.cnes || '',
        'DistÃ¢ncia (km)': u.distancia ? u.distancia.toFixed(2) : '',
        'Latitude': u.lat || '',
        'Longitude': u.lon || '',
        'Website': u.website || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Unidades de SaÃºde');
    
    const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification(`Arquivo Excel exportado: ${fileName}`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PDF - FORMATO A5 HORIZONTAL (TOTALMENTE INDEPENDENTE E LEVE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gerarPDFHTML_A5() {
    const dataAtual = new Date().toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // EstatÃ­sticas por nÃ­vel
    const primaria = filteredUnits.filter(u => u.nivel === 'primaria');
    const secundaria = filteredUnits.filter(u => u.nivel === 'secundaria');
    const terciaria = filteredUnits.filter(u => u.nivel === 'terciaria');
    
    // EstatÃ­sticas por acolhimento
    const acolhimentos = {
        ambulatorial: filteredUnits.filter(u => u.acolhimento === 'ambulatorial').length,
        urgencia: filteredUnits.filter(u => u.acolhimento === 'urgencia').length,
        maternidade: filteredUnits.filter(u => u.acolhimento === 'maternidade').length,
        especializado: filteredUnits.filter(u => u.acolhimento === 'especializado').length,
        samu: filteredUnits.filter(u => u.acolhimento === 'samu').length
    };

    // CSS especÃ­fico para o PDF (totalmente independente, otimizado para A5 horizontal)
    const pdfStyles = `
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Outfit', 'Fira Sans', sans-serif; background: #f5f7fa; padding: 10px; }
            .pdf-container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
            .pdf-header { background: linear-gradient(135deg, #0B1F3A, #132D50); color: white; padding: 18px; position: relative; }
            .pdf-header::before { content: ''; position: absolute; top: -50%; right: -10%; width: 300px; height: 300px; background: rgba(255,255,255,0.05); border-radius: 50%; }
            .pdf-header-content { position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; }
            .pdf-header-title h1 { font-size: 1.6rem; font-weight: 800; margin-bottom: 4px; }
            .pdf-header-title h1 span { color: #00C896; }
            .pdf-header-title p { opacity: 0.8; font-size: 0.75rem; }
            .pdf-header-badge { background: rgba(255,255,255,0.15); backdrop-filter: blur(8px); padding: 8px 12px; border-radius: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2); }
            .pdf-header-badge .total { font-size: 1.6rem; font-weight: 800; color: #00C896; }
            .pdf-header-badge .label { font-size: 0.65rem; opacity: 0.7; text-transform: uppercase; }
            .pdf-stats-row { display: flex; gap: 8px; padding: 16px; background: #f0f4f8; flex-wrap: wrap; }
            .pdf-stat-card { flex: 1; min-width: 90px; background: white; border-radius: 12px; padding: 10px; border-left: 4px solid; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
            .pdf-stat-card.primaria { border-color: #00A878; }
            .pdf-stat-card.secundaria { border-color: #1565C0; }
            .pdf-stat-card.terciaria { border-color: #E53935; }
            .pdf-stat-card.urgencia { border-color: #F5A623; }
            .pdf-stat-value { font-size: 1.3rem; font-weight: 800; color: #0B1F3A; }
            .pdf-stat-label { font-size: 0.6rem; color: #5A6E85; text-transform: uppercase; letter-spacing: 0.5px; }
            .pdf-acolhimento-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 16px; background: white; }
            .pdf-acolhimento-card { background: #f8fafd; border: 1px solid #D8E2EE; border-radius: 10px; padding: 10px; display: flex; align-items: center; gap: 6px; }
            .pdf-acolhimento-icon { width: 30px; height: 30px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
            .pdf-acolhimento-info h4 { font-size: 0.7rem; color: #0B1F3A; }
            .pdf-acolhimento-info p { font-size: 1rem; font-weight: 800; color: #00A878; }
            .pdf-nivel-section { padding: 0 16px 16px; }
            .pdf-nivel-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 12px; color: white; margin-bottom: 12px; }
            .pdf-nivel-header.primaria { background: linear-gradient(135deg, #00A878, #00C896); }
            .pdf-nivel-header.secundaria { background: linear-gradient(135deg, #1565C0, #2196f3); }
            .pdf-nivel-header.terciaria { background: linear-gradient(135deg, #E53935, #f44336); }
            .pdf-nivel-icon { font-size: 1.4rem; }
            .pdf-nivel-title { flex: 1; }
            .pdf-nivel-title h3 { font-size: 0.9rem; font-weight: 700; }
            .pdf-nivel-title p { font-size: 0.65rem; opacity: 0.9; }
            .pdf-nivel-count { font-size: 1.3rem; font-weight: 800; }
            .pdf-units-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .pdf-unit-card { background: #f8fafd; border: 1px solid #D8E2EE; border-radius: 10px; padding: 10px; page-break-inside: avoid; }
            .pdf-unit-name { font-size: 0.85rem; font-weight: 700; color: #0B1F3A; margin-bottom: 4px; }
            .pdf-unit-detail { display: flex; align-items: center; gap: 4px; font-size: 0.65rem; color: #5A6E85; margin-bottom: 3px; }
            .pdf-unit-detail span:first-child { min-width: 16px; }
            .pdf-unit-badge { display: inline-block; padding: 2px 6px; border-radius: 5px; font-size: 0.55rem; font-weight: 600; margin-top: 4px; }
            .pdf-unit-badge.urgente { background: #FDECEA; color: #E53935; }
            .pdf-unit-badge.ambulatorial { background: #E8F8F3; color: #00A878; }
            .pdf-unit-badge.maternidade { background: #F3E5F5; color: #6A1B9A; }
            .pdf-unit-badge.especializado { background: #FFF8EC; color: #C07A00; }
            .pdf-footer { background: #0B1F3A; color: white; padding: 12px 16px; display: flex; justify-content: space-between; font-size: 0.65rem; }
            .pdf-footer-left { opacity: 0.7; }
            .pdf-footer-right { text-align: right; }
            @media print { body { background: white; } .pdf-container { box-shadow: none; } }
        </style>
    `;

    let html = `
        <div class="pdf-container">
            <div class="pdf-header">
                <div class="pdf-header-content">
                    <div class="pdf-header-title">
                        <h1>SaÃºde<span>BR</span> â€” RelatÃ³rio de Unidades SUS</h1>
                        <p>Dados em tempo real â€¢ OpenStreetMap â€¢ Apenas unidades pÃºblicas</p>
                    </div>
                    <div class="pdf-header-badge">
                        <div class="total">${filteredUnits.length}</div>
                        <div class="label">Total de Unidades</div>
                        <div style="font-size: 0.55rem; margin-top: 2px;">${dataAtual}</div>
                    </div>
                </div>
            </div>

            <div class="pdf-stats-row">
                <div class="pdf-stat-card primaria">
                    <div class="pdf-stat-value">${primaria.length}</div>
                    <div class="pdf-stat-label">AtenÃ§Ã£o PrimÃ¡ria</div>
                </div>
                <div class="pdf-stat-card secundaria">
                    <div class="pdf-stat-value">${secundaria.length}</div>
                    <div class="pdf-stat-label">AtenÃ§Ã£o SecundÃ¡ria</div>
                </div>
                <div class="pdf-stat-card terciaria">
                    <div class="pdf-stat-value">${terciaria.length}</div>
                    <div class="pdf-stat-label">AtenÃ§Ã£o TerciÃ¡ria</div>
                </div>
                <div class="pdf-stat-card urgencia">
                    <div class="pdf-stat-value">${acolhimentos.urgencia}</div>
                    <div class="pdf-stat-label">UrgÃªncia/EmergÃªncia</div>
                </div>
            </div>

            <div class="pdf-acolhimento-grid">
                <div class="pdf-acolhimento-card">
                    <div class="pdf-acolhimento-icon">ğŸ©º</div>
                    <div class="pdf-acolhimento-info">
                        <h4>Ambulatorial</h4>
                        <p>${acolhimentos.ambulatorial}</p>
                    </div>
                </div>
                <div class="pdf-acolhimento-card">
                    <div class="pdf-acolhimento-icon">ğŸš¨</div>
                    <div class="pdf-acolhimento-info">
                        <h4>UrgÃªncia</h4>
                        <p>${acolhimentos.urgencia}</p>
                    </div>
                </div>
                <div class="pdf-acolhimento-card">
                    <div class="pdf-acolhimento-icon">ğŸ¤±</div>
                    <div class="pdf-acolhimento-info">
                        <h4>Maternidade</h4>
                        <p>${acolhimentos.maternidade}</p>
                    </div>
                </div>
                <div class="pdf-acolhimento-card">
                    <div class="pdf-acolhimento-icon">ğŸ”¬</div>
                    <div class="pdf-acolhimento-info">
                        <h4>Especializado</h4>
                        <p>${acolhimentos.especializado}</p>
                    </div>
                </div>
                <div class="pdf-acolhimento-card">
                    <div class="pdf-acolhimento-icon">ğŸš‘</div>
                    <div class="pdf-acolhimento-info">
                        <h4>SAMU</h4>
                        <p>${acolhimentos.samu}</p>
                    </div>
                </div>
            </div>
    `;

    // FunÃ§Ã£o para renderizar um grupo
    const renderGrupo = (unidades, nivel, titulo, subtitulo, icone, corClasse) => {
        if (unidades.length === 0) return '';
        let grupo = `
            <div class="pdf-nivel-section">
                <div class="pdf-nivel-header ${corClasse}">
                    <div class="pdf-nivel-icon">${icone}</div>
                    <div class="pdf-nivel-title">
                        <h3>${titulo}</h3>
                        <p>${subtitulo}</p>
                    </div>
                    <div class="pdf-nivel-count">${unidades.length}</div>
                </div>
                <div class="pdf-units-grid">
        `;
        unidades.forEach(u => {
            const acolhimentoClass = u.acolhimento || 'ambulatorial';
            const endereco = u.enderecoCompleto || u.endereco || '';
            const telefone = u.telefoneFormatado || u.telefone || 'NÃ£o informado';
            grupo += `
                <div class="pdf-unit-card">
                    <div class="pdf-unit-name">${u.nome}</div>
                    <div class="pdf-unit-detail"><span>ğŸ“</span> <span>${endereco} ${u.bairro ? ' - ' + u.bairro : ''}</span></div>
                    <div class="pdf-unit-detail"><span>ğŸ“</span> <span>${telefone}</span></div>
                    ${u.email ? `<div class="pdf-unit-detail"><span>ğŸ“§</span> <span>${u.email}</span></div>` : ''}
                    <div class="pdf-unit-detail"><span>ğŸ¥</span> <span>${u.perfil}</span></div>
                    ${u.distancia ? `<div class="pdf-unit-detail"><span>ğŸ§­</span> <span>${u.distancia.toFixed(1)} km</span></div>` : ''}
                    <span class="pdf-unit-badge ${acolhimentoClass}">${getTextoAcolhimento(u.acolhimento)}</span>
                    ${u.cnes ? `<div style="font-size:0.55rem; margin-top:3px;">CNES: ${u.cnes}</div>` : ''}
                </div>
            `;
        });
        grupo += `</div></div>`;
        return grupo;
    };

    html += renderGrupo(primaria, 'primaria', 'AtenÃ§Ã£o PrimÃ¡ria', 'UBS, Postos de SaÃºde, Centros de SaÃºde', 'ğŸ ', 'primaria');
    html += renderGrupo(secundaria, 'secundaria', 'AtenÃ§Ã£o SecundÃ¡ria', 'PoliclÃ­nicas, UPA, CAPS, ClÃ­nicas Especializadas', 'ğŸ”¬', 'secundaria');
    html += renderGrupo(terciaria, 'terciaria', 'AtenÃ§Ã£o TerciÃ¡ria', 'Hospitais de ReferÃªncia, Hospitais Especializados', 'ğŸ¨', 'terciaria');

    html += `
            <div class="pdf-footer">
                <div class="pdf-footer-left">ğŸ” RelatÃ³rio gerado pelo SaÃºdeBR Localizador</div>
                <div class="pdf-footer-right">ğŸ“… ${dataAtual}<br><span style="font-size:0.5rem;">Dados do OpenStreetMap</span></div>
            </div>
        </div>
    `;

    return pdfStyles + html;
}

async function visualizarPDF() {
    if (filteredUnits.length === 0) {
        showNotification('Nenhuma unidade para gerar PDF', 'error');
        return;
    }

    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando visualizaÃ§Ã£o do PDF...', 'Preparando conteÃºdo');

    try {
        const html = gerarPDFHTML_A5();
        document.getElementById('pdfModalBody').innerHTML = html;
        document.getElementById('pdfModal').classList.add('visible');
        showSearchProgress(false);
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar visualizaÃ§Ã£o do PDF', 'error');
        showSearchProgress(false);
    }
}

function closePDFModal() {
    document.getElementById('pdfModal').classList.remove('visible');
}

async function downloadPDF() {
    if (filteredUnits.length === 0) return;

    showSearchProgress(true);
    updateSearchProgress(10, 'Gerando PDF...', 'Processando imagem');

    try {
        const { jsPDF } = window.jspdf;
        
        const element = document.createElement('div');
        element.innerHTML = gerarPDFHTML_A5();
        element.style.width = '1100px'; // Largura para A5 horizontal
        element.style.padding = '15px';
        element.style.background = 'white';
        element.style.position = 'absolute';
        element.style.left = '-9999px';
        document.body.appendChild(element);

        updateSearchProgress(40, 'Renderizando...', 'Convertendo para imagem');

        const canvas = await html2canvas(element, {
            scale: 1.5, // Reduzido para tornar o PDF mais leve
            backgroundColor: '#ffffff',
            logging: false,
            allowTaint: true,
            useCORS: true
        });

        document.body.removeChild(element);

        const imgData = canvas.toDataURL('image/jpeg', 0.9); // JPEG com qualidade 90% para reduzir tamanho
        
        // Configurar PDF em A5 horizontal (148mm x 210mm)
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a5'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
        const width = imgWidth * ratio;
        const height = imgHeight * ratio;

        const x = (pdfWidth - width) / 2;
        const y = (pdfHeight - height) / 2;

        pdf.addImage(imgData, 'JPEG', x, y, width, height);
        
        const fileName = `SaudeBR_Unidades_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);

        showSearchProgress(false);
        showNotification(`PDF baixado: ${fileName}`, 'success');
        
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar PDF', 'error');
        showSearchProgress(false);
    }
}

async function compartilharPDFWhatsApp() {
    if (filteredUnits.length === 0) {
        showNotification('Nenhuma unidade para compartilhar', 'error');
        return;
    }

    showSearchProgress(true);
    updateSearchProgress(10, 'Preparando PDF para WhatsApp...', 'Aguarde');

    try {
        const { jsPDF } = window.jspdf;
        
        const element = document.createElement('div');
        element.innerHTML = gerarPDFHTML_A5();
        element.style.width = '1100px';
        element.style.padding = '15px';
        element.style.background = 'white';
        element.style.position = 'absolute';
        element.style.left = '-9999px';
        document.body.appendChild(element);

        updateSearchProgress(40, 'Renderizando...', 'Convertendo para imagem');

        const canvas = await html2canvas(element, {
            scale: 1.5,
            backgroundColor: '#ffffff',
            logging: false,
            allowTaint: true,
            useCORS: true
        });

        document.body.removeChild(element);

        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a5'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
        const width = imgWidth * ratio;
        const height = imgHeight * ratio;

        const x = (pdfWidth - width) / 2;
        const y = (pdfHeight - height) / 2;

        pdf.addImage(imgData, 'JPEG', x, y, width, height);
        
        const pdfBlob = pdf.output('blob');
        
        // Tentar usar Web Share API para compartilhar o arquivo (suportado em alguns navegadores)
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], 'relatorio.pdf', { type: 'application/pdf' })] })) {
            const file = new File([pdfBlob], 'SaudeBR_Unidades.pdf', { type: 'application/pdf' });
            await navigator.share({
                title: 'RelatÃ³rio de Unidades de SaÃºde',
                text: 'Confira as unidades de saÃºde prÃ³ximas.',
                files: [file]
            });
            showNotification('Compartilhado com sucesso!', 'success');
        } else {
            // Fallback: download com instruÃ§Ãµes claras
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const link = document.createElement('a');
            link.href = pdfUrl;
            link.download = 'SaudeBR_Unidades.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(pdfUrl);
            
            // Exibir instruÃ§Ãµes em um alerta mais amigÃ¡vel
            alert('âœ… PDF gerado com sucesso!\n\n' +
                  'Para compartilhar no WhatsApp:\n\n' +
                  '1ï¸âƒ£ Clique em OK e aguarde o download\n' +
                  '2ï¸âƒ£ Abra o WhatsApp\n' +
                  '3ï¸âƒ£ Selecione a conversa desejada\n' +
                  '4ï¸âƒ£ Clique no Ã­cone ğŸ“ (anexar)\n' +
                  '5ï¸âƒ£ Escolha "Documento"\n' +
                  '6ï¸âƒ£ Selecione o arquivo baixado');
        }

        showSearchProgress(false);
        
    } catch (error) {
        console.error('Erro ao gerar PDF para WhatsApp:', error);
        showNotification('Erro ao gerar PDF para WhatsApp', 'error');
        showSearchProgress(false);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INICIALIZAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
    carregarEstados();
    console.log('SaÃºdeBR Localizador CNES v4.1 (corrigido) iniciado');
});

// Fechar modais ao clicar fora
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('visible');
        }
    });
});
</script>

</body>
</html>
